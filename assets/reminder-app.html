<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Reminders — AI-powered reminder app with gamification</title>
    <meta name="description" content="An AI-powered reminder app with natural language input, organized displays, recurring reminders, notifications, and gamification." />
    <meta property="og:title" content="Smart Reminders — Stay organized, earn points" />
    <meta property="og:description" content="Create reminders using natural language, track your progress, and earn points for staying organized." />
    <meta name="keywords" content="reminders, todo, tasks, gamification, natural language, notifications, recurring" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #F8FAFC;
        color: #1E293B;
        -webkit-font-smoothing: antialiased;
      }
      #reminder-app-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }
      @media print {
        .no-print { display: none !important; }
        body { background: white; }
      }
    </style>
  </head>
  <body>
    <div id="reminder-app-root"></div>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgIGZvciAobGV0IGtleSBvZiBfX2dldE93blByb3BOYW1lcyhmcm9tKSkKICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzsKfTsKdmFyIF9fdG9FU00gPSAobW9kLCBpc05vZGVNb2RlLCB0YXJnZXQpID0+ICh0YXJnZXQgPSBtb2QgIT0gbnVsbCA/IF9fY3JlYXRlKF9fZ2V0UHJvdG9PZihtb2QpKSA6IHt9LCBfX2NvcHlQcm9wcygKICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAvLyBjb21wYXRpYmxlIHRyYW5zZm9ybSAoaS5lLiAiX19lc01vZHVsZSIgaGFzIG5vdCBiZWVuIHNldCksIHRoZW4gc2V0CiAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogIG1vZAopKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFZlcnNpb24gPSAiMTguMy4xIjsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0ICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdCk7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnQgPSB7fTsKICAgICAgICBmdW5jdGlvbiB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2NvbnN0cnVjdG9yID0gcHVibGljSW5zdGFuY2UuY29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gX2NvbnN0cnVjdG9yICYmIChfY29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgX2NvbnN0cnVjdG9yLm5hbWUpIHx8ICJSZWFjdENsYXNzIjsKICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBjb21wb25lbnROYW1lICsgIi4iICsgY2FsbGVyTmFtZTsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudFt3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvcigiQ2FuJ3QgY2FsbCAlcyBvbiBhIGNvbXBvbmVudCB0aGF0IGlzIG5vdCB5ZXQgbW91bnRlZC4gVGhpcyBpcyBhIG5vLW9wLCBidXQgaXQgbWlnaHQgaW5kaWNhdGUgYSBidWcgaW4geW91ciBhcHBsaWNhdGlvbi4gSW5zdGVhZCwgYXNzaWduIHRvIGB0aGlzLnN0YXRlYCBkaXJlY3RseSBvciBkZWZpbmUgYSBgc3RhdGUgPSB7fTtgIGNsYXNzIHByb3BlcnR5IHdpdGggdGhlIGRlc2lyZWQgc3RhdGUgaW4gdGhlICVzIGNvbXBvbmVudC4iLCBjYWxsZXJOYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBDaGVja3Mgd2hldGhlciBvciBub3QgdGhpcyBjb21wb3NpdGUgY29tcG9uZW50IGlzIG1vdW50ZWQuCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB3ZSB3YW50IHRvIHRlc3QuCiAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIG1vdW50ZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgICAqIEBwcm90ZWN0ZWQKICAgICAgICAgICAqIEBmaW5hbAogICAgICAgICAgICovCiAgICAgICAgICBpc01vdW50ZWQ6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEZvcmNlcyBhbiB1cGRhdGUuIFRoaXMgc2hvdWxkIG9ubHkgYmUgaW52b2tlZCB3aGVuIGl0IGlzIGtub3duIHdpdGgKICAgICAgICAgICAqIGNlcnRhaW50eSB0aGF0IHdlIGFyZSAqKm5vdCoqIGluIGEgRE9NIHRyYW5zYWN0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFlvdSBtYXkgd2FudCB0byBjYWxsIHRoaXMgd2hlbiB5b3Uga25vdyB0aGF0IHNvbWUgZGVlcGVyIGFzcGVjdCBvZiB0aGUKICAgICAgICAgICAqIGNvbXBvbmVudCdzIHN0YXRlIGhhcyBjaGFuZ2VkIGJ1dCBgc2V0U3RhdGVgIHdhcyBub3QgY2FsbGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoaXMgd2lsbCBub3QgaW52b2tlIGBzaG91bGRDb21wb25lbnRVcGRhdGVgLCBidXQgaXQgd2lsbCBpbnZva2UKICAgICAgICAgICAqIGBjb21wb25lbnRXaWxsVXBkYXRlYCBhbmQgYGNvbXBvbmVudERpZFVwZGF0ZWAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBjYWxsZXJOYW1lIG5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogUmVwbGFjZXMgYWxsIG9mIHRoZSBzdGF0ZS4gQWx3YXlzIHVzZSB0aGlzIG9yIGBzZXRTdGF0ZWAgdG8gbXV0YXRlIHN0YXRlLgogICAgICAgICAgICogWW91IHNob3VsZCB0cmVhdCBgdGhpcy5zdGF0ZWAgYXMgaW1tdXRhYmxlLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IGB0aGlzLnN0YXRlYCB3aWxsIGJlIGltbWVkaWF0ZWx5IHVwZGF0ZWQsIHNvCiAgICAgICAgICAgKiBhY2Nlc3NpbmcgYHRoaXMuc3RhdGVgIGFmdGVyIGNhbGxpbmcgdGhpcyBtZXRob2QgbWF5IHJldHVybiB0aGUgb2xkIHZhbHVlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBsZXRlU3RhdGUgTmV4dCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY29tcGxldGVTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFNldHMgYSBzdWJzZXQgb2YgdGhlIHN0YXRlLiBUaGlzIG9ubHkgZXhpc3RzIGJlY2F1c2UgX3BlbmRpbmdTdGF0ZSBpcwogICAgICAgICAgICogaW50ZXJuYWwuIFRoaXMgcHJvdmlkZXMgYSBtZXJnaW5nIHN0cmF0ZWd5IHRoYXQgaXMgbm90IGF2YWlsYWJsZSB0byBkZWVwCiAgICAgICAgICAgKiBwcm9wZXJ0aWVzIHdoaWNoIGlzIGNvbmZ1c2luZy4gVE9ETzogRXhwb3NlIHBlbmRpbmdTdGF0ZSBvciBkb24ndCB1c2UgaXQKICAgICAgICAgICAqIGR1cmluZyB0aGUgbWVyZ2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFydGlhbFN0YXRlIE5leHQgcGFydGlhbCBzdGF0ZSB0byBiZSBtZXJnZWQgd2l0aCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IE5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInNldFN0YXRlIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICAgIH0KICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24ocGFydGlhbFN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJmdW5jdGlvbiIgJiYgcGFydGlhbFN0YXRlICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUodGhpcywgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgfTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmZvcmNlVXBkYXRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGRlcHJlY2F0ZWRBUElzID0gewogICAgICAgICAgICBpc01vdW50ZWQ6IFsiaXNNb3VudGVkIiwgIkluc3RlYWQsIG1ha2Ugc3VyZSB0byBjbGVhbiB1cCBzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzLiJdLAogICAgICAgICAgICByZXBsYWNlU3RhdGU6IFsicmVwbGFjZVN0YXRlIiwgIlJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2Ugc2V0U3RhdGUgaW5zdGVhZCAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMvMzIzNikuIl0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nID0gZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5mbykgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29tcG9uZW50LnByb3RvdHlwZSwgbWV0aG9kTmFtZSwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuKCIlcyguLi4pIGlzIGRlcHJlY2F0ZWQgaW4gcGxhaW4gSmF2YVNjcmlwdCBSZWFjdCBjbGFzc2VzLiAlcyIsIGluZm9bMF0sIGluZm9bMV0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGZvciAodmFyIGZuTmFtZSBpbiBkZXByZWNhdGVkQVBJcykgewogICAgICAgICAgICBpZiAoZGVwcmVjYXRlZEFQSXMuaGFzT3duUHJvcGVydHkoZm5OYW1lKSkgewogICAgICAgICAgICAgIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyhmbk5hbWUsIGRlcHJlY2F0ZWRBUElzW2ZuTmFtZV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudER1bW15KCkgewogICAgICAgIH0KICAgICAgICBDb21wb25lbnREdW1teS5wcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgIGZ1bmN0aW9uIFB1cmVDb21wb25lbnQocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgfQogICAgICAgIHZhciBwdXJlQ29tcG9uZW50UHJvdG90eXBlID0gUHVyZUNvbXBvbmVudC5wcm90b3R5cGUgPSBuZXcgQ29tcG9uZW50RHVtbXkoKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHVyZUNvbXBvbmVudDsKICAgICAgICBhc3NpZ24ocHVyZUNvbXBvbmVudFByb3RvdHlwZSwgQ29tcG9uZW50LnByb3RvdHlwZSk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVmKCkgewogICAgICAgICAgdmFyIHJlZk9iamVjdCA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgT2JqZWN0LnNlYWwocmVmT2JqZWN0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWZPYmplY3Q7CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biwgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24sIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBjb25maWcuX19zZWxmICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQuc3RhdGVOb2RlICE9PSBjb25maWcuX19zZWxmKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50Myh0eXBlLCBjb25maWcsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICB2YXIgc2VsZiA9IG51bGw7CiAgICAgICAgICB2YXIgc291cmNlID0gbnVsbDsKICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYgPSBjb25maWcuX19zZWxmID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc2VsZjsKICAgICAgICAgICAgc291cmNlID0gY29uZmlnLl9fc291cmNlID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc291cmNlOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZEFycmF5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgJiYgdHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUFuZFJlcGxhY2VLZXkob2xkRWxlbWVudCwgbmV3S2V5KSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IFJlYWN0RWxlbWVudChvbGRFbGVtZW50LnR5cGUsIG5ld0tleSwgb2xkRWxlbWVudC5yZWYsIG9sZEVsZW1lbnQuX3NlbGYsIG9sZEVsZW1lbnQuX3NvdXJjZSwgb2xkRWxlbWVudC5fb3duZXIsIG9sZEVsZW1lbnQucHJvcHMpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudChlbGVtZW50LCBjb25maWcsIGNoaWxkcmVuKSB7CiAgICAgICAgICBpZiAoZWxlbWVudCA9PT0gbnVsbCB8fCBlbGVtZW50ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdC5jbG9uZUVsZW1lbnQoLi4uKTogVGhlIGFyZ3VtZW50IG11c3QgYmUgYSBSZWFjdCBlbGVtZW50LCBidXQgeW91IHBhc3NlZCAiICsgZWxlbWVudCArICIuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICB2YXIgcHJvcHMgPSBhc3NpZ24oe30sIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHJlZiA9IGVsZW1lbnQucmVmOwogICAgICAgICAgdmFyIHNlbGYgPSBlbGVtZW50Ll9zZWxmOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSAmJiBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjb25maWdbcHJvcE5hbWVdID09PSB2b2lkIDAgJiYgZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudChvYmplY3QpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgfQogICAgICAgIHZhciBTRVBBUkFUT1IgPSAiLiI7CiAgICAgICAgdmFyIFNVQlNFUEFSQVRPUiA9ICI6IjsKICAgICAgICBmdW5jdGlvbiBlc2NhcGUoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUoIiIgKyBlbGVtZW50LmtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5kZXgudG9TdHJpbmcoMzYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuYW1lU29GYXIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBjaGlsZHJlbjsKICAgICAgICAgIGlmICh0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgY2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludm9rZUNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT09IG51bGwpIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGRyZW4uJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW52b2tlQ2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbWFwcGVkQ2hpbGQgPSBjYWxsYmFjayhfY2hpbGQpOwogICAgICAgICAgICB2YXIgY2hpbGRLZXkgPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SICsgZ2V0RWxlbWVudEtleShfY2hpbGQsIDApIDogbmFtZVNvRmFyOwogICAgICAgICAgICBpZiAoaXNBcnJheShtYXBwZWRDaGlsZCkpIHsKICAgICAgICAgICAgICB2YXIgZXNjYXBlZENoaWxkS2V5ID0gIiI7CiAgICAgICAgICAgICAgaWYgKGNoaWxkS2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVzY2FwZWRDaGlsZEtleSA9IGVzY2FwZVVzZXJQcm92aWRlZEtleShjaGlsZEtleSkgKyAiLyI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hcEludG9BcnJheShtYXBwZWRDaGlsZCwgYXJyYXksIGVzY2FwZWRDaGlsZEtleSwgIiIsIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1hcHBlZENoaWxkICE9IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChtYXBwZWRDaGlsZC5rZXkgJiYgKCFfY2hpbGQgfHwgX2NoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWFwcGVkQ2hpbGQua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQgPSBjbG9uZUFuZFJlcGxhY2VLZXkoCiAgICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkLAogICAgICAgICAgICAgICAgICAvLyBLZWVwIGJvdGggdGhlIChtYXBwZWQpIGFuZCBvbGQga2V5cyBpZiB0aGV5IGRpZmZlciwganVzdCBhcwogICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZUFsbENoaWxkcmVuIHVzZWQgdG8gZG8gZm9yIG9iamVjdHMgYXMgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgZXNjYXBlZFByZWZpeCArIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgUmVhY3QuUG9ydGFsIGRvZXNuJ3QgaGF2ZSBhIGtleQogICAgICAgICAgICAgICAgICAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkgPyAoCiAgICAgICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBleGlzdGluZyBlbGVtZW50J3Mga2V5IGNhbiBiZSBhIG51bWJlcgogICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1pbnRlcm5hbC9zYWZlLXN0cmluZy1jb2VyY2lvbgogICAgICAgICAgICAgICAgICAgIGVzY2FwZVVzZXJQcm92aWRlZEtleSgiIiArIG1hcHBlZENoaWxkLmtleSkgKyAiLyIKICAgICAgICAgICAgICAgICAgKSA6ICIiKSArIGNoaWxkS2V5CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcnJheS5wdXNoKG1hcHBlZENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIHZhciBuZXh0TmFtZTsKICAgICAgICAgIHZhciBzdWJ0cmVlQ291bnQgPSAwOwogICAgICAgICAgdmFyIG5leHROYW1lUHJlZml4ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiA6IG5hbWVTb0ZhciArIFNVQlNFUEFSQVRPUjsKICAgICAgICAgIGlmIChpc0FycmF5KGNoaWxkcmVuKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgICAgICBuZXh0TmFtZSA9IG5leHROYW1lUHJlZml4ICsgZ2V0RWxlbWVudEtleShjaGlsZCwgaSk7CiAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihjaGlsZHJlbik7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBpdGVyYWJsZUNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gPT09IGl0ZXJhYmxlQ2hpbGRyZW4uZW50cmllcykgewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuKCJVc2luZyBNYXBzIGFzIGNoaWxkcmVuIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSBhbiBhcnJheSBvZiBrZXllZCBSZWFjdEVsZW1lbnRzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChpdGVyYWJsZUNoaWxkcmVuKTsKICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICB2YXIgaWkgPSAwOwogICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gc3RlcC52YWx1ZTsKICAgICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpaSsrKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlblN0cmluZyA9IFN0cmluZyhjaGlsZHJlbik7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRyZW5TdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjaGlsZHJlbikuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkcmVuU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdWJ0cmVlQ291bnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgbWFwSW50b0FycmF5KGNoaWxkcmVuLCByZXN1bHQsICIiLCAiIiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBjaGlsZCwgY291bnQrKyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvdW50Q2hpbGRyZW4oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbisrOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yRWFjaENoaWxkcmVuKGNoaWxkcmVuLCBmb3JFYWNoRnVuYywgZm9yRWFjaENvbnRleHQpIHsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yRWFjaEZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZvckVhY2hDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9BcnJheShjaGlsZHJlbikgewogICAgICAgICAgcmV0dXJuIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICB9KSB8fCBbXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25seUNoaWxkKGNoaWxkcmVuKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50KGNoaWxkcmVuKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LkNoaWxkcmVuLm9ubHkgZXhwZWN0ZWQgdG8gcmVjZWl2ZSBhIHNpbmdsZSBSZWFjdCBlbGVtZW50IGNoaWxkLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250ZXh0KGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgIC8vIEFzIGEgd29ya2Fyb3VuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNvbmN1cnJlbnQgcmVuZGVyZXJzLCB3ZSBjYXRlZ29yaXplCiAgICAgICAgICAgIC8vIHNvbWUgcmVuZGVyZXJzIGFzIHByaW1hcnkgYW5kIG90aGVycyBhcyBzZWNvbmRhcnkuIFdlIG9ubHkgZXhwZWN0CiAgICAgICAgICAgIC8vIHRoZXJlIHRvIGJlIHR3byBjb25jdXJyZW50IHJlbmRlcmVycyBhdCBtb3N0OiBSZWFjdCBOYXRpdmUgKHByaW1hcnkpIGFuZAogICAgICAgICAgICAvLyBGYWJyaWMgKHNlY29uZGFyeSk7IFJlYWN0IERPTSAocHJpbWFyeSkgYW5kIFJlYWN0IEFSVCAoc2Vjb25kYXJ5KS4KICAgICAgICAgICAgLy8gU2Vjb25kYXJ5IHJlbmRlcmVycyBzdG9yZSB0aGVpciBjb250ZXh0IHZhbHVlcyBvbiBzZXBhcmF0ZSBmaWVsZHMuCiAgICAgICAgICAgIF9jdXJyZW50VmFsdWU6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgLy8gVXNlZCB0byB0cmFjayBob3cgbWFueSBjb25jdXJyZW50IHJlbmRlcmVycyB0aGlzIGNvbnRleHQgY3VycmVudGx5CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIHdpdGhpbiBpbiBhIHNpbmdsZSByZW5kZXJlci4gU3VjaCBhcyBwYXJhbGxlbCBzZXJ2ZXIgcmVuZGVyaW5nLgogICAgICAgICAgICBfdGhyZWFkQ291bnQ6IDAsCiAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBjaXJjdWxhcgogICAgICAgICAgICBQcm92aWRlcjogbnVsbCwKICAgICAgICAgICAgQ29uc3VtZXI6IG51bGwsCiAgICAgICAgICAgIC8vIEFkZCB0aGVzZSB0byB1c2Ugc2FtZSBoaWRkZW4gY2xhc3MgaW4gVk0gYXMgU2VydmVyQ29udGV4dAogICAgICAgICAgICBfZGVmYXVsdFZhbHVlOiBudWxsLAogICAgICAgICAgICBfZ2xvYmFsTmFtZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QUk9WSURFUl9UWVBFLAogICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IGZhbHNlOwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIENvbnN1bWVyID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ29uc3VtZXIsIHsKICAgICAgICAgICAgICBQcm92aWRlcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlcikgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLlByb3ZpZGVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Qcm92aWRlcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Qcm92aWRlcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9Qcm92aWRlcikgewogICAgICAgICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gX1Byb3ZpZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9jdXJyZW50VmFsdWUyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTIgPSBfY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF90aHJlYWRDb3VudDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX3RocmVhZENvdW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX3RocmVhZENvdW50ID0gX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgQ29uc3VtZXI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dC5Db25zdW1lci5Db25zdW1lcj4gaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuQ29uc3VtZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihkaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybigiU2V0dGluZyBgZGlzcGxheU5hbWVgIG9uIENvbnRleHQuQ29uc3VtZXIgaGFzIG5vIGVmZmVjdC4gWW91IHNob3VsZCBzZXQgaXQgZGlyZWN0bHkgb24gdGhlIGNvbnRleHQgd2l0aCBDb250ZXh0LmRpc3BsYXlOYW1lID0gJyVzJy4iLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29udGV4dC5Db25zdW1lciA9IENvbnN1bWVyOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgVW5pbml0aWFsaXplZCA9IC0xOwogICAgICAgIHZhciBQZW5kaW5nID0gMDsKICAgICAgICB2YXIgUmVzb2x2ZWQgPSAxOwogICAgICAgIHZhciBSZWplY3RlZCA9IDI7CiAgICAgICAgZnVuY3Rpb24gbGF6eUluaXRpYWxpemVyKHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgdmFyIGN0b3IgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IGN0b3IoKTsKICAgICAgICAgICAgdGhlbmFibGUudGhlbihmdW5jdGlvbihtb2R1bGVPYmplY3QyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fc3RhdHVzID0gUmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fcmVzdWx0ID0gbW9kdWxlT2JqZWN0MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVqZWN0ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3N0YXR1cyA9IFJlamVjdGVkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3Jlc3VsdCA9IGVycm9yMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBwYXlsb2FkOwogICAgICAgICAgICAgIHBlbmRpbmcuX3N0YXR1cyA9IFBlbmRpbmc7CiAgICAgICAgICAgICAgcGVuZGluZy5fcmVzdWx0ID0gdGhlbmFibGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFJlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVPYmplY3QgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobW9kdWxlT2JqZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSlcblxuRGlkIHlvdSBhY2NpZGVudGFsbHkgcHV0IGN1cmx5IGJyYWNlcyBhcm91bmQgdGhlIGltcG9ydD8iLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCEoImRlZmF1bHQiIGluIG1vZHVsZU9iamVjdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSkiLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kdWxlT2JqZWN0LmRlZmF1bHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhenkoY3RvcikgewogICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgIC8vIFdlIHVzZSB0aGVzZSBmaWVsZHMgdG8gc3RvcmUgdGhlIHJlc3VsdC4KICAgICAgICAgICAgX3N0YXR1czogVW5pbml0aWFsaXplZCwKICAgICAgICAgICAgX3Jlc3VsdDogY3RvcgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBsYXp5VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0xBWllfVFlQRSwKICAgICAgICAgICAgX3BheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgIF9pbml0OiBsYXp5SW5pdGlhbGl6ZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGxhenlUeXBlLCB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3RGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBkZWZhdWx0UHJvcHNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gbmV3RGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJkZWZhdWx0UHJvcHMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHByb3BUeXBlczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb3BUeXBlczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld1Byb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgcHJvcFR5cGVzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IG5ld1Byb3BUeXBlczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAicHJvcFR5cGVzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXp5VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yd2FyZFJlZjMocmVuZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCAmJiByZW5kZXIuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSkgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFLAogICAgICAgICAgICByZW5kZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghcmVuZGVyLm5hbWUgJiYgIXJlbmRlci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICByZW5kZXIuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW8odHlwZSwgY29tcGFyZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSkgewogICAgICAgICAgICAgIGVycm9yKCJtZW1vOiBUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIGNvbXBvbmVudC4gSW5zdGVhZCByZWNlaXZlZDogJXMiLCB0eXBlID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9NRU1PX1RZUEUsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGNvbXBhcmU6IGNvbXBhcmUgPT09IHZvaWQgMCA/IG51bGwgOiBjb21wYXJlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXR5cGUubmFtZSAmJiAhdHlwZS5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICB0eXBlLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGlzcGF0Y2hlcigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlQ29udGV4dChDb250ZXh0KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb250ZXh0Ll9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVhbENvbnRleHQgPSBDb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICAgIGlmIChyZWFsQ29udGV4dC5Db25zdW1lciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LkNvbnN1bWVyKSBpcyBub3Qgc3VwcG9ydGVkLCBtYXkgY2F1c2UgYnVncywgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFsQ29udGV4dC5Qcm92aWRlciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LlByb3ZpZGVyKSBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDb250ZXh0KENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTdGF0ZTIoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjIoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRWZmZWN0MihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZU1lbW8yKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VUcmFuc2l0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJZCgpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUlkKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgfQogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHguc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudDIpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQyLnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhcyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB5b3VyIGNvZGUgYXQgIiArIGZpbGVOYW1lICsgIjoiICsgbGluZU51bWJlciArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhlbGVtZW50UHJvcHMpIHsKICAgICAgICAgIGlmIChlbGVtZW50UHJvcHMgIT09IG51bGwgJiYgZWxlbWVudFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKGVsZW1lbnRQcm9wcy5fX3NvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpIHsKICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5hbWUgPSB0eXBlb2YgcGFyZW50VHlwZSA9PT0gInN0cmluZyIgPyBwYXJlbnRUeXBlIDogcGFyZW50VHlwZS5kaXNwbGF5TmFtZSB8fCBwYXJlbnRUeXBlLm5hbWU7CiAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICBpZiAoIWVsZW1lbnQuX3N0b3JlIHx8IGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCB8fCBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9IGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSk7CiAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICB2YXIgY2hpbGRPd25lciA9ICIiOwogICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIgIT09IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQpIHsKICAgICAgICAgICAgY2hpbGRPd25lciA9ICIgSXQgd2FzIHBhc3NlZCBhIGNoaWxkIGZyb20gIiArIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShlbGVtZW50Ll9vd25lci50eXBlKSArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuJXMlcyBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nLCBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvLCBjaGlsZE93bmVyKTsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDaGlsZEtleXMobm9kZSwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNBcnJheShub2RlKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlW2ldOwogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChjaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoY2hpbGQsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkRWxlbWVudChub2RlKSkgewogICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgIGlmICghdmFsaWRUeXBlKSB7CiAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhwcm9wcyk7CiAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHR5cGVTdHJpbmc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHR5cGUpKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJhcnJheSI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSAhPT0gdm9pZCAwICYmIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgIGluZm8gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5jcmVhdGVFbGVtZW50OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50ID0gY3JlYXRlRWxlbWVudDMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgdmFsaWRhdGVGcmFnbWVudFByb3BzKGVsZW1lbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uKHR5cGUpIHsKICAgICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZSk7CiAgICAgICAgICB2YWxpZGF0ZWRGYWN0b3J5LnR5cGUgPSB0eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5KSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSB0cnVlOwogICAgICAgICAgICAgIHdhcm4oIlJlYWN0LmNyZWF0ZUZhY3RvcnkoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gQ29uc2lkZXIgdXNpbmcgSlNYIG9yIHVzZSBSZWFjdC5jcmVhdGVFbGVtZW50KCkgZGlyZWN0bHkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodmFsaWRhdGVkRmFjdG9yeSwgInR5cGUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdhcm4oIkZhY3RvcnkudHlwZSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdGhlIGNsYXNzIGRpcmVjdGx5IGJlZm9yZSBwYXNzaW5nIGl0IHRvIGNyZWF0ZUZhY3RvcnkuIik7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInR5cGUiLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiB0eXBlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVkRmFjdG9yeTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb24oZWxlbWVudCwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IGNsb25lRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMobmV3RWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzY29wZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuKCJEZXRlY3RlZCBhIGxhcmdlIG51bWJlciBvZiB1cGRhdGVzIGluc2lkZSBzdGFydFRyYW5zaXRpb24uIElmIHRoaXMgaXMgZHVlIHRvIGEgc3Vic2NyaXB0aW9uIHBsZWFzZSByZS13cml0ZSBpdCB0byB1c2UgUmVhY3QgcHJvdmlkZWQgaG9va3MuIE90aGVyd2lzZSBjb25jdXJyZW50IG1vZGUgZ3VhcmFudGVlcyBhcmUgb2ZmIHRoZSB0YWJsZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IGZhbHNlOwogICAgICAgIHZhciBlbnF1ZXVlVGFza0ltcGwgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGVucXVldWVUYXNrKHRhc2spIHsKICAgICAgICAgIGlmIChlbnF1ZXVlVGFza0ltcGwgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgcmVxdWlyZVN0cmluZyA9ICgicmVxdWlyZSIgKyBNYXRoLnJhbmRvbSgpKS5zbGljZSgwLCA3KTsKICAgICAgICAgICAgICB2YXIgbm9kZVJlcXVpcmUgPSBtb2R1bGUgJiYgbW9kdWxlW3JlcXVpcmVTdHJpbmddOwogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IG5vZGVSZXF1aXJlLmNhbGwobW9kdWxlLCAidGltZXJzIikuc2V0SW1tZWRpYXRlOwogICAgICAgICAgICB9IGNhdGNoIChfZXJyKSB7CiAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBoYXZlIGEgTWVzc2FnZUNoYW5uZWwgaW1wbGVtZW50YXRpb24sIHNvIGVucXVldWluZyB0YXNrcyB2aWEgYXdhaXQgYWN0KGFzeW5jICgpID0+IC4uLikgd2lsbCBmYWlsLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZSBhdCBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzIGlmIHlvdSBlbmNvdW50ZXIgdGhpcyB3YXJuaW5nLiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKHZvaWQgMCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVucXVldWVUYXNrSW1wbCh0YXNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIGFjdFNjb3BlRGVwdGggPSAwOwogICAgICAgIHZhciBkaWRXYXJuTm9Bd2FpdEFjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGFjdChjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJldkFjdFNjb3BlRGVwdGggPSBhY3RTY29wZURlcHRoOwogICAgICAgICAgICBhY3RTY29wZURlcHRoKys7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2SXNCYXRjaGluZ0xlZ2FjeSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHRydWU7CiAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2soKTsKICAgICAgICAgICAgICBpZiAoIXByZXZJc0JhdGNoaW5nTGVnYWN5ICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUocXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gcHJldklzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCAmJiB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcmVzdWx0LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGVSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgdmFyIHdhc0F3YWl0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgd2FzQXdhaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHRoZW5hYmxlUmVzdWx0LnRoZW4oZnVuY3Rpb24ocmV0dXJuVmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlMiwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2Fybk5vQXdhaXRBY3QgJiYgdHlwZW9mIFByb21pc2UgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXNBd2FpdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuTm9Bd2FpdEFjdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiWW91IGNhbGxlZCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aXRob3V0IGF3YWl0LiBUaGlzIGNvdWxkIGxlYWQgdG8gdW5leHBlY3RlZCB0ZXN0aW5nIGJlaGF2aW91ciwgaW50ZXJsZWF2aW5nIG11bHRpcGxlIGFjdCBjYWxscyBhbmQgbWl4aW5nIHRoZWlyIHNjb3Blcy4gWW91IHNob3VsZCAtIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pOyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGVuYWJsZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3F1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChfcXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShfcXVldWUpOwogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlMiA9IHsKICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZXZBY3RTY29wZURlcHRoICE9PSBhY3RTY29wZURlcHRoIC0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3Ugc2VlbSB0byBoYXZlIG92ZXJsYXBwaW5nIGFjdCgpIGNhbGxzLCB0aGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEJlIHN1cmUgdG8gYXdhaXQgcHJldmlvdXMgYWN0KCkgY2FsbHMgYmVmb3JlIG1ha2luZyBhIG5ldyBvbmUuICIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdFNjb3BlRGVwdGggPSBwcmV2QWN0U2NvcGVEZXB0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIGVucXVldWVUYXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAocXVldWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmbHVzaEFjdFF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGbHVzaGluZykgewogICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBxdWV1ZSA9IHF1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlRWxlbWVudCQxID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjbG9uZUVsZW1lbnQkMSA9IGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjcmVhdGVGYWN0b3J5ID0gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBDaGlsZHJlbiA9IHsKICAgICAgICAgIG1hcDogbWFwQ2hpbGRyZW4sCiAgICAgICAgICBmb3JFYWNoOiBmb3JFYWNoQ2hpbGRyZW4sCiAgICAgICAgICBjb3VudDogY291bnRDaGlsZHJlbiwKICAgICAgICAgIHRvQXJyYXksCiAgICAgICAgICBvbmx5OiBvbmx5Q2hpbGQKICAgICAgICB9OwogICAgICAgIGV4cG9ydHMuQ2hpbGRyZW4gPSBDaGlsZHJlbjsKICAgICAgICBleHBvcnRzLkNvbXBvbmVudCA9IENvbXBvbmVudDsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLlByb2ZpbGVyID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICBleHBvcnRzLlB1cmVDb21wb25lbnQgPSBQdXJlQ29tcG9uZW50OwogICAgICAgIGV4cG9ydHMuU3RyaWN0TW9kZSA9IFJFQUNUX1NUUklDVF9NT0RFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMuY2xvbmVFbGVtZW50ID0gY2xvbmVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVDb250ZXh0ID0gY3JlYXRlQ29udGV4dDsKICAgICAgICBleHBvcnRzLmNyZWF0ZUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVGYWN0b3J5ID0gY3JlYXRlRmFjdG9yeTsKICAgICAgICBleHBvcnRzLmNyZWF0ZVJlZiA9IGNyZWF0ZVJlZjsKICAgICAgICBleHBvcnRzLmZvcndhcmRSZWYgPSBmb3J3YXJkUmVmMzsKICAgICAgICBleHBvcnRzLmlzVmFsaWRFbGVtZW50ID0gaXNWYWxpZEVsZW1lbnQ7CiAgICAgICAgZXhwb3J0cy5sYXp5ID0gbGF6eTsKICAgICAgICBleHBvcnRzLm1lbW8gPSBtZW1vOwogICAgICAgIGV4cG9ydHMuc3RhcnRUcmFuc2l0aW9uID0gc3RhcnRUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMudXNlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVzZUNvbnRleHQgPSB1c2VDb250ZXh0OwogICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VEZWZlcnJlZFZhbHVlID0gdXNlRGVmZXJyZWRWYWx1ZTsKICAgICAgICBleHBvcnRzLnVzZUVmZmVjdCA9IHVzZUVmZmVjdDI7CiAgICAgICAgZXhwb3J0cy51c2VJZCA9IHVzZUlkOwogICAgICAgIGV4cG9ydHMudXNlSW1wZXJhdGl2ZUhhbmRsZSA9IHVzZUltcGVyYXRpdmVIYW5kbGU7CiAgICAgICAgZXhwb3J0cy51c2VJbnNlcnRpb25FZmZlY3QgPSB1c2VJbnNlcnRpb25FZmZlY3Q7CiAgICAgICAgZXhwb3J0cy51c2VMYXlvdXRFZmZlY3QgPSB1c2VMYXlvdXRFZmZlY3Q7CiAgICAgICAgZXhwb3J0cy51c2VNZW1vID0gdXNlTWVtbzI7CiAgICAgICAgZXhwb3J0cy51c2VSZWR1Y2VyID0gdXNlUmVkdWNlcjsKICAgICAgICBleHBvcnRzLnVzZVJlZiA9IHVzZVJlZjI7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMjsKICAgICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlID0gdXNlU3luY0V4dGVybmFsU3RvcmU7CiAgICAgICAgZXhwb3J0cy51c2VUcmFuc2l0aW9uID0gdXNlVHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnZlcnNpb24gPSBSZWFjdFZlcnNpb247CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvaW5kZXguanMKdmFyIHJlcXVpcmVfcmVhY3QgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZnJhbWVZaWVsZE1zID0gNTsKICAgICAgICBmdW5jdGlvbiBwdXNoKGhlYXAsIG5vZGUpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgaGVhcC5wdXNoKG5vZGUpOwogICAgICAgICAgc2lmdFVwKGhlYXAsIG5vZGUsIGluZGV4KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVlayhoZWFwKSB7CiAgICAgICAgICByZXR1cm4gaGVhcC5sZW5ndGggPT09IDAgPyBudWxsIDogaGVhcFswXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wKGhlYXApIHsKICAgICAgICAgIGlmIChoZWFwLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdCA9IGhlYXBbMF07CiAgICAgICAgICB2YXIgbGFzdCA9IGhlYXAucG9wKCk7CiAgICAgICAgICBpZiAobGFzdCAhPT0gZmlyc3QpIHsKICAgICAgICAgICAgaGVhcFswXSA9IGxhc3Q7CiAgICAgICAgICAgIHNpZnREb3duKGhlYXAsIGxhc3QsIDApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0VXAoaGVhcCwgbm9kZSwgaSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaTsKICAgICAgICAgIHdoaWxlIChpbmRleCA+IDApIHsKICAgICAgICAgICAgdmFyIHBhcmVudEluZGV4ID0gaW5kZXggLSAxID4+PiAxOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gaGVhcFtwYXJlbnRJbmRleF07CiAgICAgICAgICAgIGlmIChjb21wYXJlKHBhcmVudCwgbm9kZSkgPiAwKSB7CiAgICAgICAgICAgICAgaGVhcFtwYXJlbnRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcGFyZW50OwogICAgICAgICAgICAgIGluZGV4ID0gcGFyZW50SW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNpZnREb3duKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICB2YXIgaGFsZkxlbmd0aCA9IGxlbmd0aCA+Pj4gMTsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGhhbGZMZW5ndGgpIHsKICAgICAgICAgICAgdmFyIGxlZnRJbmRleCA9IChpbmRleCArIDEpICogMiAtIDE7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gaGVhcFtsZWZ0SW5kZXhdOwogICAgICAgICAgICB2YXIgcmlnaHRJbmRleCA9IGxlZnRJbmRleCArIDE7CiAgICAgICAgICAgIHZhciByaWdodCA9IGhlYXBbcmlnaHRJbmRleF07CiAgICAgICAgICAgIGlmIChjb21wYXJlKGxlZnQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIGxlZnQpIDwgMCkgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSByaWdodDsKICAgICAgICAgICAgICAgIGhlYXBbcmlnaHRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IGxlZnQ7CiAgICAgICAgICAgICAgICBoZWFwW2xlZnRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgICAgaW5kZXggPSBsZWZ0SW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJpZ2h0SW5kZXggPCBsZW5ndGggJiYgY29tcGFyZShyaWdodCwgbm9kZSkgPCAwKSB7CiAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSByaWdodDsKICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBpbmRleCA9IHJpZ2h0SW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYSwgYikgewogICAgICAgICAgdmFyIGRpZmYgPSBhLnNvcnRJbmRleCAtIGIuc29ydEluZGV4OwogICAgICAgICAgcmV0dXJuIGRpZmYgIT09IDAgPyBkaWZmIDogYS5pZCAtIGIuaWQ7CiAgICAgICAgfQogICAgICAgIHZhciBJbW1lZGlhdGVQcmlvcml0eSA9IDE7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gMjsKICAgICAgICB2YXIgTm9ybWFsUHJpb3JpdHkgPSAzOwogICAgICAgIHZhciBMb3dQcmlvcml0eSA9IDQ7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IDU7CiAgICAgICAgZnVuY3Rpb24gbWFya1Rhc2tFcnJvcmVkKHRhc2ssIG1zKSB7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNQZXJmb3JtYW5jZU5vdyA9IHR5cGVvZiBwZXJmb3JtYW5jZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gImZ1bmN0aW9uIjsKICAgICAgICBpZiAoaGFzUGVyZm9ybWFuY2VOb3cpIHsKICAgICAgICAgIHZhciBsb2NhbFBlcmZvcm1hbmNlID0gcGVyZm9ybWFuY2U7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25vdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxQZXJmb3JtYW5jZS5ub3coKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBsb2NhbERhdGUgPSBEYXRlOwogICAgICAgICAgdmFyIGluaXRpYWxUaW1lID0gbG9jYWxEYXRlLm5vdygpOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsRGF0ZS5ub3coKSAtIGluaXRpYWxUaW1lOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIG1heFNpZ25lZDMxQml0SW50ID0gMTA3Mzc0MTgyMzsKICAgICAgICB2YXIgSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQgPSAtMTsKICAgICAgICB2YXIgVVNFUl9CTE9DS0lOR19QUklPUklUWV9USU1FT1VUID0gMjUwOwogICAgICAgIHZhciBOT1JNQUxfUFJJT1JJVFlfVElNRU9VVCA9IDVlMzsKICAgICAgICB2YXIgTE9XX1BSSU9SSVRZX1RJTUVPVVQgPSAxZTQ7CiAgICAgICAgdmFyIElETEVfUFJJT1JJVFlfVElNRU9VVCA9IG1heFNpZ25lZDMxQml0SW50OwogICAgICAgIHZhciB0YXNrUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGltZXJRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0YXNrSWRDb3VudGVyID0gMTsKICAgICAgICB2YXIgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIHZhciBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgdmFyIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxTZXRUaW1lb3V0ID0gdHlwZW9mIHNldFRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBzZXRUaW1lb3V0IDogbnVsbDsKICAgICAgICB2YXIgbG9jYWxDbGVhclRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogbnVsbDsKICAgICAgICB2YXIgbG9jYWxTZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAidW5kZWZpbmVkIiA/IHNldEltbWVkaWF0ZSA6IG51bGw7CiAgICAgICAgdmFyIGlzSW5wdXRQZW5kaW5nID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcgIT09IHZvaWQgMCAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZyAhPT0gdm9pZCAwID8gbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcuYmluZChuYXZpZ2F0b3Iuc2NoZWR1bGluZykgOiBudWxsOwogICAgICAgIGZ1bmN0aW9uIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciB0aW1lciA9IHBlZWsodGltZXJRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAodGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRpbWVyLmNhbGxiYWNrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVyLnN0YXJ0VGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgICB0aW1lci5zb3J0SW5kZXggPSB0aW1lci5leHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgdGltZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aW1lciA9IHBlZWsodGltZXJRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRpbWVvdXQoY3VycmVudFRpbWUpIHsKICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCkgewogICAgICAgICAgICBpZiAocGVlayh0YXNrUXVldWUpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWsodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hXb3JrKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGlmIChpc0hvc3RUaW1lb3V0U2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGluZykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgICAgIG1hcmtUYXNrRXJyb3JlZChjdXJyZW50VGFzaywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5pc1F1ZXVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5pdGlhbFRpbWUyOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWsodGFza1F1ZXVlKTsKICAgICAgICAgIHdoaWxlIChjdXJyZW50VGFzayAhPT0gbnVsbCAmJiAhZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA+IGN1cnJlbnRUaW1lICYmICghaGFzVGltZVJlbWFpbmluZyB8fCBzaG91bGRZaWVsZFRvSG9zdCgpKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGN1cnJlbnRUYXNrLmNhbGxiYWNrOwogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gY3VycmVudFRhc2sucHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgICB2YXIgZGlkVXNlckNhbGxiYWNrVGltZW91dCA9IGN1cnJlbnRUYXNrLmV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICAgIHZhciBjb250aW51YXRpb25DYWxsYmFjayA9IGNhbGxiYWNrKGRpZFVzZXJDYWxsYmFja1RpbWVvdXQpOwogICAgICAgICAgICAgIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRpbnVhdGlvbkNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5jYWxsYmFjayA9IGNvbnRpbnVhdGlvbkNhbGxiYWNrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRhc2sgPT09IHBlZWsodGFza1F1ZXVlKSkgewogICAgICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrKHRhc2tRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWsodGltZXJRdWV1ZSk7CiAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RUaW1lb3V0KGhhbmRsZVRpbWVvdXQsIGZpcnN0VGltZXIuc3RhcnRUaW1lIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5KHByaW9yaXR5TGV2ZWwsIGV2ZW50SGFuZGxlcikgewogICAgICAgICAgc3dpdGNoIChwcmlvcml0eUxldmVsKSB7CiAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBldmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9uZXh0KGV2ZW50SGFuZGxlcikgewogICAgICAgICAgdmFyIHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnRQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBldmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV93cmFwQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHZhciBwYXJlbnRQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwYXJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgdmFyIHN0YXJ0VGltZTI7CiAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJvYmplY3QiICYmIG9wdGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRlbGF5ID0gb3B0aW9ucy5kZWxheTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgJiYgZGVsYXkgPiAwKSB7CiAgICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lICsgZGVsYXk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGltZW91dDsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gVVNFUl9CTE9DS0lOR19QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSURMRV9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBMT1dfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aW1lb3V0ID0gTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBzdGFydFRpbWUyICsgdGltZW91dDsKICAgICAgICAgIHZhciBuZXdUYXNrID0gewogICAgICAgICAgICBpZDogdGFza0lkQ291bnRlcisrLAogICAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCwKICAgICAgICAgICAgc3RhcnRUaW1lOiBzdGFydFRpbWUyLAogICAgICAgICAgICBleHBpcmF0aW9uVGltZSwKICAgICAgICAgICAgc29ydEluZGV4OiAtMQogICAgICAgICAgfTsKICAgICAgICAgIGlmIChzdGFydFRpbWUyID4gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBzdGFydFRpbWUyOwogICAgICAgICAgICBwdXNoKHRpbWVyUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAocGVlayh0YXNrUXVldWUpID09PSBudWxsICYmIG5ld1Rhc2sgPT09IHBlZWsodGltZXJRdWV1ZSkpIHsKICAgICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBzdGFydFRpbWUyIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3VGFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcGF1c2VFeGVjdXRpb24oKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uKCkgewogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUoKSB7CiAgICAgICAgICByZXR1cm4gcGVlayh0YXNrUXVldWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjayh0YXNrKSB7CiAgICAgICAgICB0YXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgfQogICAgICAgIHZhciBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgIHZhciBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgdmFyIGZyYW1lSW50ZXJ2YWwgPSBmcmFtZVlpZWxkTXM7CiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IC0xOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFlpZWxkVG9Ib3N0KCkgewogICAgICAgICAgdmFyIHRpbWVFbGFwc2VkID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIGlmICh0aW1lRWxhcHNlZCA8IGZyYW1lSW50ZXJ2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RQYWludCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VGcmFtZVJhdGUoZnBzKSB7CiAgICAgICAgICBpZiAoZnBzIDwgMCB8fCBmcHMgPiAxMjUpIHsKICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXSgiZm9yY2VGcmFtZVJhdGUgdGFrZXMgYSBwb3NpdGl2ZSBpbnQgYmV0d2VlbiAwIGFuZCAxMjUsIGZvcmNpbmcgZnJhbWUgcmF0ZXMgaGlnaGVyIHRoYW4gMTI1IGZwcyBpcyBub3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcHMgPiAwKSB7CiAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBNYXRoLmZsb29yKDFlMyAvIGZwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2NoZWR1bGVkSG9zdENhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgIHN0YXJ0VGltZSA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB2YXIgaGFzVGltZVJlbWFpbmluZyA9IHRydWU7CiAgICAgICAgICAgIHZhciBoYXNNb3JlV29yayA9IHRydWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaGFzTW9yZVdvcmsgPSBzY2hlZHVsZWRIb3N0Q2FsbGJhY2soaGFzVGltZVJlbWFpbmluZywgY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChoYXNNb3JlV29yaykgewogICAgICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgIGlmICh0eXBlb2YgbG9jYWxTZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0SW1tZWRpYXRlKHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgIHZhciBwb3J0ID0gY2hhbm5lbC5wb3J0MjsKICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9ydC5wb3N0TWVzc2FnZShudWxsKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0VGltZW91dChwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUsIDApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICBpZiAoIWlzTWVzc2FnZUxvb3BSdW5uaW5nKSB7CiAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RUaW1lb3V0KGNhbGxiYWNrLCBtcykgewogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IGxvY2FsU2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXhwb3J0cy51bnN0YWJsZV9ub3coKSk7CiAgICAgICAgICB9LCBtcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbEhvc3RUaW1lb3V0KCkgewogICAgICAgICAgbG9jYWxDbGVhclRpbWVvdXQodGFza1RpbWVvdXRJRCk7CiAgICAgICAgICB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgfQogICAgICAgIHZhciB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSByZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIHVuc3RhYmxlX1Byb2ZpbGluZyA9IG51bGw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JZGxlUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfTG93UHJpb3JpdHkgPSBMb3dQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Qcm9maWxpbmcgPSB1bnN0YWJsZV9Qcm9maWxpbmc7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Vc2VyQmxvY2tpbmdQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sgPSB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uID0gdW5zdGFibGVfY29udGludWVFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9mb3JjZUZyYW1lUmF0ZSA9IGZvcmNlRnJhbWVSYXRlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwgPSB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlID0gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9uZXh0ID0gdW5zdGFibGVfbmV4dDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uID0gdW5zdGFibGVfcGF1c2VFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkgPSB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrID0gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3Nob3VsZFlpZWxkID0gc2hvdWxkWWllbGRUb0hvc3Q7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV93cmFwQ2FsbGJhY2sgPSB1bnN0YWJsZV93cmFwQ2FsbGJhY2s7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDMgPSByZXF1aXJlX3JlYWN0KCk7CiAgICAgICAgdmFyIFNjaGVkdWxlciA9IHJlcXVpcmVfc2NoZWR1bGVyKCk7CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gUmVhY3QzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIHZhciBzdXBwcmVzc1dhcm5pbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzZXRTdXBwcmVzc1dhcm5pbmcobmV3U3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN1cHByZXNzV2FybmluZyA9IG5ld1N1cHByZXNzV2FybmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybihmb3JtYXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJ3YXJuIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlcnJvcihmb3JtYXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0ICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdCk7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBGdW5jdGlvbkNvbXBvbmVudCA9IDA7CiAgICAgICAgdmFyIENsYXNzQ29tcG9uZW50ID0gMTsKICAgICAgICB2YXIgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCA9IDI7CiAgICAgICAgdmFyIEhvc3RSb290ID0gMzsKICAgICAgICB2YXIgSG9zdFBvcnRhbCA9IDQ7CiAgICAgICAgdmFyIEhvc3RDb21wb25lbnQgPSA1OwogICAgICAgIHZhciBIb3N0VGV4dCA9IDY7CiAgICAgICAgdmFyIEZyYWdtZW50ID0gNzsKICAgICAgICB2YXIgTW9kZSA9IDg7CiAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgdmFyIENvbnRleHRQcm92aWRlciA9IDEwOwogICAgICAgIHZhciBGb3J3YXJkUmVmID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgYXR0cmlidXRlIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBhdHRyaWJ1dGVOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIHByb3AgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBDU1MgcHJvcGVydHkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIEhUTUwgbWFya3VwIHVzZXMgYSB2YWx1ZSBvZiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJGb3JtIGZpZWxkIHZhbHVlcyAodmFsdWUsIGNoZWNrZWQsIGRlZmF1bHRWYWx1ZSwgb3IgZGVmYXVsdENoZWNrZWQgcHJvcHMpIG11c3QgYmUgc3RyaW5ncywgbm90ICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVTRVJWRUQgPSAwOwogICAgICAgIHZhciBTVFJJTkcgPSAxOwogICAgICAgIHZhciBCT09MRUFOSVNIX1NUUklORyA9IDI7CiAgICAgICAgdmFyIEJPT0xFQU4gPSAzOwogICAgICAgIHZhciBPVkVSTE9BREVEX0JPT0xFQU4gPSA0OwogICAgICAgIHZhciBOVU1FUklDID0gNTsKICAgICAgICB2YXIgUE9TSVRJVkVfTlVNRVJJQyA9IDY7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgPSAiOkEtWl9hLXpcXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9DSEFSID0gQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJcXC0uMC05XFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICAgICAgdmFyIFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYID0gbmV3IFJlZ0V4cCgiXlsiICsgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgdmFyIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZVNhZmUoYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWC50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lOiBgJXNgIiwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUubGVuZ3RoID4gMiAmJiAobmFtZVswXSA9PT0gIm8iIHx8IG5hbWVbMF0gPT09ICJPIikgJiYgKG5hbWVbMV0gPT09ICJuIiB8fCBuYW1lWzFdID09PSAiTiIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICBjYXNlICJzeW1ib2wiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICJib29sZWFuIjogewogICAgICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIXByb3BlcnR5SW5mby5hY2NlcHRzQm9vbGVhbnM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXgyID0gbmFtZS50b0xvd2VyQ2FzZSgpLnNsaWNlKDAsIDUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeDIgIT09ICJkYXRhLSIgJiYgcHJlZml4MiAhPT0gImFyaWEtIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChwcm9wZXJ0eUluZm8udHlwZSkgewogICAgICAgICAgICAgIGNhc2UgQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBPVkVSTE9BREVEX0JPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgIGNhc2UgTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSBQT1NJVElWRV9OVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA8IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHJvcGVydHlJbmZvKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KG5hbWUpID8gcHJvcGVydGllc1tuYW1lXSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFByb3BlcnR5SW5mb1JlY29yZChuYW1lLCB0eXBlLCBtdXN0VXNlUHJvcGVydHksIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSwgc2FuaXRpemVVUkwyLCByZW1vdmVFbXB0eVN0cmluZykgewogICAgICAgICAgdGhpcy5hY2NlcHRzQm9vbGVhbnMgPSB0eXBlID09PSBCT09MRUFOSVNIX1NUUklORyB8fCB0eXBlID09PSBCT09MRUFOIHx8IHR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTjsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IGF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIHRoaXMubXVzdFVzZVByb3BlcnR5ID0gbXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgdGhpcy5wcm9wZXJ0eU5hbWUgPSBuYW1lOwogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuc2FuaXRpemVVUkwgPSBzYW5pdGl6ZVVSTDI7CiAgICAgICAgICB0aGlzLnJlbW92ZUVtcHR5U3RyaW5nID0gcmVtb3ZlRW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJlc2VydmVkUHJvcHMgPSBbCiAgICAgICAgICAiY2hpbGRyZW4iLAogICAgICAgICAgImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIC8vIFRPRE86IFRoaXMgcHJldmVudHMgdGhlIGFzc2lnbm1lbnQgb2YgZGVmYXVsdFZhbHVlIHRvIHJlZ3VsYXIKICAgICAgICAgIC8vIGVsZW1lbnRzIChub3QganVzdCBpbnB1dHMpLiBOb3cgdGhhdCBSZWFjdERPTUlucHV0IGFzc2lnbnMgdG8gdGhlCiAgICAgICAgICAvLyBkZWZhdWx0VmFsdWUgcHJvcGVydHkgLS0gZG8gd2UgbmVlZCB0aGlzPwogICAgICAgICAgImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgImlubmVySFRNTCIsCiAgICAgICAgICAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciLAogICAgICAgICAgInN0eWxlIgogICAgICAgIF07CiAgICAgICAgcmVzZXJ2ZWRQcm9wcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBSRVNFUlZFRCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgW1siYWNjZXB0Q2hhcnNldCIsICJhY2NlcHQtY2hhcnNldCJdLCBbImNsYXNzTmFtZSIsICJjbGFzcyJdLCBbImh0bWxGb3IiLCAiZm9yIl0sIFsiaHR0cEVxdWl2IiwgImh0dHAtZXF1aXYiXV0uZm9yRWFjaChmdW5jdGlvbihfcmVmKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IF9yZWZbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmWzFdOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJjb250ZW50RWRpdGFibGUiLCAiZHJhZ2dhYmxlIiwgInNwZWxsQ2hlY2siLCAidmFsdWUiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImF1dG9SZXZlcnNlIiwgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLCAiZm9jdXNhYmxlIiwgInByZXNlcnZlQWxwaGEiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAiYXN5bmMiLAogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBwcmV2ZW50cyBpdCBmcm9tIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIERPTQogICAgICAgICAgLy8gb24gdGhlIGNsaWVudCBzaWRlIGJlY2F1c2UgdGhlIGJyb3dzZXJzIGFyZSBpbmNvbnNpc3RlbnQuIEluc3RlYWQgd2UgY2FsbCBmb2N1cygpLgogICAgICAgICAgImF1dG9Gb2N1cyIsCiAgICAgICAgICAiYXV0b1BsYXkiLAogICAgICAgICAgImNvbnRyb2xzIiwKICAgICAgICAgICJkZWZhdWx0IiwKICAgICAgICAgICJkZWZlciIsCiAgICAgICAgICAiZGlzYWJsZWQiLAogICAgICAgICAgImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgICJoaWRkZW4iLAogICAgICAgICAgImxvb3AiLAogICAgICAgICAgIm5vTW9kdWxlIiwKICAgICAgICAgICJub1ZhbGlkYXRlIiwKICAgICAgICAgICJvcGVuIiwKICAgICAgICAgICJwbGF5c0lubGluZSIsCiAgICAgICAgICAicmVhZE9ubHkiLAogICAgICAgICAgInJlcXVpcmVkIiwKICAgICAgICAgICJyZXZlcnNlZCIsCiAgICAgICAgICAic2NvcGVkIiwKICAgICAgICAgICJzZWFtbGVzcyIsCiAgICAgICAgICAvLyBNaWNyb2RhdGEKICAgICAgICAgICJpdGVtU2NvcGUiCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjaGVja2VkIiwKICAgICAgICAgIC8vIE5vdGU6IGBvcHRpb24uc2VsZWN0ZWRgIGlzIG5vdCB1cGRhdGVkIGlmIGBzZWxlY3QubXVsdGlwbGVgIGlzCiAgICAgICAgICAvLyBkaXNhYmxlZCB3aXRoIGByZW1vdmVBdHRyaWJ1dGVgLiBXZSBoYXZlIHNwZWNpYWwgbG9naWMgZm9yIGhhbmRsaW5nIHRoaXMuCiAgICAgICAgICAibXVsdGlwbGUiLAogICAgICAgICAgIm11dGVkIiwKICAgICAgICAgICJzZWxlY3RlZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2FwdHVyZSIsCiAgICAgICAgICAiZG93bmxvYWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE9WRVJMT0FERURfQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNvbHMiLAogICAgICAgICAgInJvd3MiLAogICAgICAgICAgInNpemUiLAogICAgICAgICAgInNwYW4iCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFBPU0lUSVZFX05VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsicm93U3BhbiIsICJzdGFydCJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE5VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIENBTUVMSVpFID0gL1tcLVw6XShbYS16XSkvZzsKICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW5bMV0udG9VcHBlckNhc2UoKTsKICAgICAgICB9OwogICAgICAgIFsKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IiwKICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiLAogICAgICAgICAgImFyYWJpYy1mb3JtIiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCIsCiAgICAgICAgICAiY2FwLWhlaWdodCIsCiAgICAgICAgICAiY2xpcC1wYXRoIiwKICAgICAgICAgICJjbGlwLXJ1bGUiLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItcHJvZmlsZSIsCiAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSIsCiAgICAgICAgICAiZW5hYmxlLWJhY2tncm91bmQiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1ydWxlIiwKICAgICAgICAgICJmbG9vZC1jb2xvciIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSIsCiAgICAgICAgICAiZm9udC1mYW1pbHkiLAogICAgICAgICAgImZvbnQtc2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplLWFkanVzdCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIiwKICAgICAgICAgICJmb250LXN0eWxlIiwKICAgICAgICAgICJmb250LXZhcmlhbnQiLAogICAgICAgICAgImZvbnQtd2VpZ2h0IiwKICAgICAgICAgICJnbHlwaC1uYW1lIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiLAogICAgICAgICAgImhvcml6LW9yaWdpbi14IiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciIsCiAgICAgICAgICAibWFya2VyLWVuZCIsCiAgICAgICAgICAibWFya2VyLW1pZCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJwYWludC1vcmRlciIsCiAgICAgICAgICAicGFub3NlLTEiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IiwKICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciLAogICAgICAgICAgInN0b3AtY29sb3IiLAogICAgICAgICAgInN0b3Atb3BhY2l0eSIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS13aWR0aCIsCiAgICAgICAgICAidGV4dC1hbmNob3IiLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIiwKICAgICAgICAgICJ1bmljb2RlLXJhbmdlIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iLAogICAgICAgICAgInYtYWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1oYW5naW5nIiwKICAgICAgICAgICJ2LWlkZW9ncmFwaGljIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCIsCiAgICAgICAgICAidmVydC1hZHYteSIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teSIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiLAogICAgICAgICAgInhtbG5zOnhsaW5rIiwKICAgICAgICAgICJ4LWhlaWdodCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhsaW5rOmFjdHVhdGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiLAogICAgICAgICAgInhsaW5rOnJvbGUiLAogICAgICAgICAgInhsaW5rOnNob3ciLAogICAgICAgICAgInhsaW5rOnRpdGxlIiwKICAgICAgICAgICJ4bGluazp0eXBlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhtbDpiYXNlIiwKICAgICAgICAgICJ4bWw6bGFuZyIsCiAgICAgICAgICAieG1sOnNwYWNlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInRhYkluZGV4IiwgImNyb3NzT3JpZ2luIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciB4bGlua0hyZWYgPSAieGxpbmtIcmVmIjsKICAgICAgICBwcm9wZXJ0aWVzW3hsaW5rSHJlZl0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgInhsaW5rSHJlZiIsCiAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgInhsaW5rOmhyZWYiLAogICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgWyJzcmMiLCAiaHJlZiIsICJhY3Rpb24iLCAiZm9ybUFjdGlvbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGlzSmF2YVNjcmlwdFByb3RvY29sID0gL15bXHUwMDAwLVx1MDAxRiBdKmpbXHJcblx0XSphW1xyXG5cdF0qdltcclxuXHRdKmFbXHJcblx0XSpzW1xyXG5cdF0qY1tcclxuXHRdKnJbXHJcblx0XSppW1xyXG5cdF0qcFtcclxuXHRdKnRbXHJcblx0XSpcOi9pOwogICAgICAgIHZhciBkaWRXYXJuID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2FuaXRpemVVUkwodXJsKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybiAmJiBpc0phdmFTY3JpcHRQcm90b2NvbC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICBkaWRXYXJuID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiQSBmdXR1cmUgdmVyc2lvbiBvZiBSZWFjdCB3aWxsIGJsb2NrIGphdmFzY3JpcHQ6IFVSTHMgYXMgYSBzZWN1cml0eSBwcmVjYXV0aW9uLiBVc2UgZXZlbnQgaGFuZGxlcnMgaW5zdGVhZCBpZiB5b3UgY2FuLiBJZiB5b3UgbmVlZCB0byBnZW5lcmF0ZSB1bnNhZmUgSFRNTCB0cnkgdXNpbmcgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgaW5zdGVhZC4gUmVhY3Qgd2FzIHBhc3NlZCAlcy4iLCBKU09OLnN0cmluZ2lmeSh1cmwpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTCgiIiArIGV4cGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgICB2YXIgc3RyaW5nVmFsdWUgPSBudWxsOwogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJpbmdWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlID09PSBudWxsID8gZXhwZWN0ZWQgOiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZ1ZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW5vZGUuaGFzQXR0cmlidXRlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCB2YWx1ZSwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICBpZiAoc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyB8fCBwcm9wZXJ0eUluZm8gPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUsICIiICsgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbXVzdFVzZVByb3BlcnR5ID0gcHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIGlmIChtdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdHlwZSA9PT0gQk9PTEVBTiA/IGZhbHNlIDogIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWU7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gQk9PTEVBTiB8fCBfdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOICYmIHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTChhdHRyaWJ1dGVWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlTlMoYXR0cmlidXRlTmFtZXNwYWNlLCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geC5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoY3Rvciwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgb3duZXIgPSBmaWJlci5fZGVidWdPd25lciA/IGZpYmVyLl9kZWJ1Z093bmVyLnR5cGUgOiBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIkxhenkiKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUucmVuZGVyKTsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpbmZvICs9IGRlc2NyaWJlRmliZXIobm9kZSk7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeC5tZXNzYWdlICsgIlxuIiArIHguc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUkMShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lIHx8IChmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lJDEodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJDYWNoZSI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUkMShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICBjYXNlIERlaHlkcmF0ZWRGcmFnbWVudDoKICAgICAgICAgICAgICByZXR1cm4gIkRlaHlkcmF0ZWRGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDoKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHJldHVybiAiUm9vdCI7CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUZXh0IjsKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuICJNb2RlIjsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiU2NvcGUiOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlRyYWNpbmdNYXJrZXIiOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIHZhciBjdXJyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBjdXJyZW50Ll9kZWJ1Z093bmVyOwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgdHlwZW9mIG93bmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlclN0YWNrSW5EZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2QoY3VycmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBmaWJlciA9PT0gbnVsbCA/IG51bGwgOiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2OwogICAgICAgICAgICBjdXJyZW50ID0gZmliZXI7CiAgICAgICAgICAgIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUmVuZGVyaW5nKHJlbmRlcmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1JlbmRlcmluZyA9IHJlbmRlcmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUb1N0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGhhc1JlYWRPbmx5VmFsdWUgPSB7CiAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgICAgIGltYWdlOiB0cnVlLAogICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgICByZXNldDogdHJ1ZSwKICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcyh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIShoYXNSZWFkT25seVZhbHVlW3Byb3BzLnR5cGVdIHx8IHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLm9uSW5wdXQgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMudmFsdWUgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYHZhbHVlYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdFZhbHVlYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy5jaGVja2VkID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGBjaGVja2VkYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdENoZWNrZWRgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgIHZhciB0eXBlID0gZWxlbS50eXBlOwogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICh0eXBlID09PSAiY2hlY2tib3giIHx8IHR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaFRyYWNrZXIobm9kZSkgewogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDaGVja2FibGUobm9kZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLmNoZWNrZWQgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB2YWx1ZUZpZWxkKTsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9ICIiICsgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXQyID0gZGVzY3JpcHRvci5nZXQsIHNldDIgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Mi5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICBzZXQyLmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgdHJhY2tlciA9IHsKICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGV0YWNoVHJhY2tlcihub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB0cmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFjayhub2RlKSB7CiAgICAgICAgICBpZiAoZ2V0VHJhY2tlcihub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRUcmFja2VyKG5vZGUpOwogICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpOwogICAgICAgICAgaWYgKG5leHRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnQoZG9jKSB7CiAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICBpZiAodHlwZW9mIGRvYyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZG9jLmFjdGl2ZUVsZW1lbnQgfHwgZG9jLmJvZHk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYm9keTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ29udHJvbGxlZChwcm9wcykgewogICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgcmV0dXJuIHVzZXNDaGVja2VkID8gcHJvcHMuY2hlY2tlZCAhPSBudWxsIDogcHJvcHMudmFsdWUgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICBkZWZhdWx0Q2hlY2tlZDogdm9pZCAwLAogICAgICAgICAgICBkZWZhdWx0VmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgY2hlY2tlZDogY2hlY2tlZCAhPSBudWxsID8gY2hlY2tlZCA6IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsQ2hlY2tlZAogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gaG9zdFByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoImlucHV0IiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5DaGVja2VkRGVmYXVsdENoZWNrZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYW4gaW5wdXQgb2YgdHlwZSAlcyB3aXRoIGJvdGggY2hlY2tlZCBhbmQgZGVmYXVsdENoZWNrZWQgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgY2hlY2tlZCBwcm9wLCBvciB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiLCBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpIHx8ICJBIGNvbXBvbmVudCIsIHByb3BzLnR5cGUpOwogICAgICAgICAgICAgIGRpZFdhcm5DaGVja2VkRGVmYXVsdENoZWNrZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYW4gaW5wdXQgb2YgdHlwZSAlcyB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gSW5wdXQgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gcHJvcHMuZGVmYXVsdFZhbHVlID09IG51bGwgPyAiIiA6IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgaW5pdGlhbENoZWNrZWQ6IHByb3BzLmNoZWNrZWQgIT0gbnVsbCA/IHByb3BzLmNoZWNrZWQgOiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCwKICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlICE9IG51bGwgPyBwcm9wcy52YWx1ZSA6IGRlZmF1bHRWYWx1ZSksCiAgICAgICAgICAgIGNvbnRyb2xsZWQ6IGlzQ29udHJvbGxlZChwcm9wcykKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciBjaGVja2VkID0gcHJvcHMuY2hlY2tlZDsKICAgICAgICAgIGlmIChjaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCAiY2hlY2tlZCIsIGNoZWNrZWQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29udHJvbGxlZCA9IGlzQ29udHJvbGxlZChwcm9wcyk7CiAgICAgICAgICAgIGlmICghbm9kZS5fd3JhcHBlclN0YXRlLmNvbnRyb2xsZWQgJiYgY29udHJvbGxlZCAmJiAhZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCkgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbXBvbmVudCBpcyBjaGFuZ2luZyBhbiB1bmNvbnRyb2xsZWQgaW5wdXQgdG8gYmUgY29udHJvbGxlZC4gVGhpcyBpcyBsaWtlbHkgY2F1c2VkIGJ5IHRoZSB2YWx1ZSBjaGFuZ2luZyBmcm9tIHVuZGVmaW5lZCB0byBhIGRlZmluZWQgdmFsdWUsIHdoaWNoIHNob3VsZCBub3QgaGFwcGVuLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgY29tcG9uZW50LiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVW5jb250cm9sbGVkVG9Db250cm9sbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZS5fd3JhcHBlclN0YXRlLmNvbnRyb2xsZWQgJiYgIWNvbnRyb2xsZWQgJiYgIWRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYSBjb250cm9sbGVkIGlucHV0IHRvIGJlIHVuY29udHJvbGxlZC4gVGhpcyBpcyBsaWtlbHkgY2F1c2VkIGJ5IHRoZSB2YWx1ZSBjaGFuZ2luZyBmcm9tIGEgZGVmaW5lZCB0byB1bmRlZmluZWQsIHdoaWNoIHNob3VsZCBub3QgaGFwcGVuLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgY29tcG9uZW50LiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdXBkYXRlQ2hlY2tlZChlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICB2YXIgdmFsdWUgPSBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKTsKICAgICAgICAgIHZhciB0eXBlID0gcHJvcHMudHlwZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gMCAmJiBub2RlLnZhbHVlID09PSAiIiB8fCAvLyBXZSBleHBsaWNpdGx5IHdhbnQgdG8gY29lcmNlIHRvIG51bWJlciBoZXJlIGlmIHBvc3NpYmxlLgogICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZQogICAgICAgICAgICAgIG5vZGUudmFsdWUgIT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudmFsdWUgIT09IHRvU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInN1Ym1pdCIgfHwgdHlwZSA9PT0gInJlc2V0IikgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZSgidmFsdWUiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkoInZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgdmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJkZWZhdWx0VmFsdWUiKSkgewogICAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCBwcm9wcy50eXBlLCBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLmRlZmF1bHRWYWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGVja2VkID09IG51bGwgJiYgcHJvcHMuZGVmYXVsdENoZWNrZWQgIT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhIXByb3BzLmRlZmF1bHRDaGVja2VkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIoZWxlbWVudCwgcHJvcHMsIGlzSHlkcmF0aW5nMikgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpIHx8IHByb3BzLmhhc093blByb3BlcnR5KCJkZWZhdWx0VmFsdWUiKSkgewogICAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICAgIHZhciBpc0J1dHRvbiA9IHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCI7CiAgICAgICAgICAgIGlmIChpc0J1dHRvbiAmJiAocHJvcHMudmFsdWUgPT09IHZvaWQgMCB8fCBwcm9wcy52YWx1ZSA9PT0gbnVsbCkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluaXRpYWxWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nMikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpbml0aWFsVmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gaW5pdGlhbFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IG5vZGUubmFtZTsKICAgICAgICAgIGlmIChuYW1lICE9PSAiIikgewogICAgICAgICAgICBub2RlLm5hbWUgPSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICFub2RlLmRlZmF1bHRDaGVja2VkOwogICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdXBkYXRlV3JhcHBlcihub2RlLCBwcm9wcyk7CiAgICAgICAgICB1cGRhdGVOYW1lZENvdXNpbnMobm9kZSwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVOYW1lZENvdXNpbnMocm9vdE5vZGUsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHByb3BzLm5hbWU7CiAgICAgICAgICBpZiAocHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIHF1ZXJ5Um9vdCA9IHJvb3ROb2RlOwogICAgICAgICAgICB3aGlsZSAocXVlcnlSb290LnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBxdWVyeVJvb3QgPSBxdWVyeVJvb3QucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihuYW1lLCAibmFtZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBncm91cCA9IHF1ZXJ5Um9vdC5xdWVyeVNlbGVjdG9yQWxsKCJpbnB1dFtuYW1lPSIgKyBKU09OLnN0cmluZ2lmeSgiIiArIG5hbWUpICsgJ11bdHlwZT0icmFkaW8iXScpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyb3VwLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG90aGVyTm9kZSA9IGdyb3VwW2ldOwogICAgICAgICAgICAgIGlmIChvdGhlck5vZGUgPT09IHJvb3ROb2RlIHx8IG90aGVyTm9kZS5mb3JtICE9PSByb290Tm9kZS5mb3JtKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG90aGVyUHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKG90aGVyTm9kZSk7CiAgICAgICAgICAgICAgaWYgKCFvdGhlclByb3BzKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0RE9NSW5wdXQ6IE1peGluZyBSZWFjdCBhbmQgbm9uLVJlYWN0IHJhZGlvIGlucHV0cyB3aXRoIHRoZSBzYW1lIGBuYW1lYCBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChvdGhlck5vZGUpOwogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIob3RoZXJOb2RlLCBvdGhlclByb3BzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZWZhdWx0VmFsdWUobm9kZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gRm9jdXNlZCBudW1iZXIgaW5wdXRzIHN5bmNocm9uaXplIG9uIGJsdXIuIFNlZSBDaGFuZ2VFdmVudFBsdWdpbi5qcwogICAgICAgICAgICB0eXBlICE9PSAibnVtYmVyIiB8fCBnZXRBY3RpdmVFbGVtZW50KG5vZGUub3duZXJEb2N1bWVudCkgIT09IG5vZGUKICAgICAgICAgICkgewogICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5kZWZhdWx0VmFsdWUgIT09IHRvU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbiA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZENoaWxkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wcyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJvYmplY3QiICYmIHByb3BzLmNoaWxkcmVuICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdDMuQ2hpbGRyZW4uZm9yRWFjaChwcm9wcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIGNoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IGluZmVyIHRoZSBvcHRpb24gdmFsdWUgb2YgY29tcGxleCBjaGlsZHJlbi4gUGFzcyBhIGB2YWx1ZWAgcHJvcCBvciB1c2UgYSBwbGFpbiBzdHJpbmcgYXMgY2hpbGRyZW4gdG8gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZElubmVySFRNTCkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJQYXNzIGEgYHZhbHVlYCBwcm9wIGlmIHlvdSBzZXQgZGFuZ2Vyb3VzbHlJbm5lckhUTUwgc28gUmVhY3Qga25vd3Mgd2hpY2ggdmFsdWUgc2hvdWxkIGJlIHNlbGVjdGVkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMuc2VsZWN0ZWQgIT0gbnVsbCAmJiAhZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24pIHsKICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIG9uIDxzZWxlY3Q+IGluc3RlYWQgb2Ygc2V0dGluZyBgc2VsZWN0ZWRgIG9uIDxvcHRpb24+LiIpOwogICAgICAgICAgICAgIGRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsIHRvU3RyaW5nKGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5KHByb3BzW3Byb3BOYW1lXSk7CiAgICAgICAgICAgICAgaWYgKHByb3BzLm11bHRpcGxlICYmICFwcm9wTmFtZUlzQXJyYXkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYCVzYCBwcm9wIHN1cHBsaWVkIHRvIDxzZWxlY3Q+IG11c3QgYmUgYW4gYXJyYXkgaWYgYG11bHRpcGxlYCBpcyB0cnVlLiVzIiwgcHJvcE5hbWUsIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFwcm9wcy5tdWx0aXBsZSAmJiBwcm9wTmFtZUlzQXJyYXkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYCVzYCBwcm9wIHN1cHBsaWVkIHRvIDxzZWxlY3Q+IG11c3QgYmUgYSBzY2FsYXIgdmFsdWUgaWYgYG11bHRpcGxlYCBpcyBmYWxzZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU9wdGlvbnMobm9kZSwgbXVsdGlwbGUsIHByb3BWYWx1ZSwgc2V0RGVmYXVsdFNlbGVjdGVkKSB7CiAgICAgICAgICB2YXIgb3B0aW9uczIgPSBub2RlLm9wdGlvbnM7CiAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWVzID0gcHJvcFZhbHVlOwogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZSA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGVjdGVkVmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc2VsZWN0ZWRWYWx1ZVsiJCIgKyBzZWxlY3RlZFZhbHVlc1tpXV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBvcHRpb25zMi5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBzZWxlY3RlZFZhbHVlLmhhc093blByb3BlcnR5KCIkIiArIG9wdGlvbnMyW19pXS52YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyW19pXS5zZWxlY3RlZCAhPT0gc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5zZWxlY3RlZCA9IHNlbGVjdGVkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWQgJiYgc2V0RGVmYXVsdFNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zMltfaV0uZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfc2VsZWN0ZWRWYWx1ZSA9IHRvU3RyaW5nKGdldFRvU3RyaW5nVmFsdWUocHJvcFZhbHVlKSk7CiAgICAgICAgICAgIHZhciBkZWZhdWx0U2VsZWN0ZWQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBfaTIgPSAwOyBfaTIgPCBvcHRpb25zMi5sZW5ndGg7IF9pMisrKSB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyW19pMl0udmFsdWUgPT09IF9zZWxlY3RlZFZhbHVlKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgb3B0aW9uczJbX2kyXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGVmYXVsdFNlbGVjdGVkID09PSBudWxsICYmICFvcHRpb25zMltfaTJdLmRpc2FibGVkKSB7CiAgICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQgPSBvcHRpb25zMltfaTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFNlbGVjdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFNlbGVjdGVkLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UHJvcHMkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RVcGRhdGVXcmFwcGVyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgd2FzTXVsdGlwbGUgPSBub2RlLl93cmFwcGVyU3RhdGUud2FzTXVsdGlwbGU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUud2FzTXVsdGlwbGUgPSAhIXByb3BzLm11bHRpcGxlOwogICAgICAgICAgdmFyIHZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLm11bHRpcGxlID8gW10gOiAiIiwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoaWxkcmVuOiB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gaG9zdFByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcygidGV4dGFyZWEiLCBwcm9wcyk7CiAgICAgICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdm9pZCAwICYmIHByb3BzLmRlZmF1bHRWYWx1ZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuVmFsRGVmYXVsdFZhbCkgewogICAgICAgICAgICAgIGVycm9yKCIlcyBjb250YWlucyBhIHRleHRhcmVhIHdpdGggYm90aCB2YWx1ZSBhbmQgZGVmYXVsdFZhbHVlIHByb3BzLiBUZXh0YXJlYSBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCB0ZXh0YXJlYSBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmIChpbml0aWFsVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbiwgZGVmYXVsdFZhbHVlID0gcHJvcHMuZGVmYXVsdFZhbHVlOwogICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgaW5zdGVhZCBvZiBzZXR0aW5nIGNoaWxkcmVuIG9uIDx0ZXh0YXJlYT4uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklmIHlvdSBzdXBwbHkgYGRlZmF1bHRWYWx1ZWAgb24gYSA8dGV4dGFyZWE+LCBkbyBub3QgcGFzcyBjaGlsZHJlbi4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiPHRleHRhcmVhPiBjYW4gb25seSBoYXZlIGF0IG1vc3Qgb25lIGNoaWxkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuID0gY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSBjaGlsZHJlbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5pdGlhbFZhbHVlID0gZGVmYXVsdFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlID0gewogICAgICAgICAgICBpbml0aWFsVmFsdWU6IGdldFRvU3RyaW5nVmFsdWUoaW5pdGlhbFZhbHVlKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKTsKICAgICAgICAgIHZhciBkZWZhdWx0VmFsdWUgPSBnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLmRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSB0b1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gbm9kZS52YWx1ZSkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMuZGVmYXVsdFZhbHVlID09IG51bGwgJiYgbm9kZS5kZWZhdWx0VmFsdWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gdG9TdHJpbmcoZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdGV4dENvbnRlbnQgPSBub2RlLnRleHRDb250ZW50OwogICAgICAgICAgaWYgKHRleHRDb250ZW50ID09PSBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0ZXh0Q29udGVudCAhPT0gIiIgJiYgdGV4dENvbnRlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdGV4dENvbnRlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICB2YXIgSFRNTF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI7CiAgICAgICAgdmFyIE1BVEhfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTgvTWF0aC9NYXRoTUwiOwogICAgICAgIHZhciBTVkdfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIjsKICAgICAgICBmdW5jdGlvbiBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSkgewogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgInN2ZyI6CiAgICAgICAgICAgICAgcmV0dXJuIFNWR19OQU1FU1BBQ0U7CiAgICAgICAgICAgIGNhc2UgIm1hdGgiOgogICAgICAgICAgICAgIHJldHVybiBNQVRIX05BTUVTUEFDRTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENoaWxkTmFtZXNwYWNlKHBhcmVudE5hbWVzcGFjZSwgdHlwZSkgewogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PSBudWxsIHx8IHBhcmVudE5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJlbnROYW1lc3BhY2UgPT09IFNWR19OQU1FU1BBQ0UgJiYgdHlwZSA9PT0gImZvcmVpZ25PYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVNaWNyb3NvZnRVbnNhZmVMb2NhbEZ1bmN0aW9uID0gZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgaWYgKHR5cGVvZiBNU0FwcCAhPT0gInVuZGVmaW5lZCIgJiYgTVNBcHAuZXhlY1Vuc2FmZUxvY2FsRnVuY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFyZzAsIGFyZzEsIGFyZzIsIGFyZzMpIHsKICAgICAgICAgICAgICBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jKGFyZzAsIGFyZzEsIGFyZzIsIGFyZzMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgcmV1c2FibGVTVkdDb250YWluZXI7CiAgICAgICAgdmFyIHNldElubmVySFRNTCA9IGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24oZnVuY3Rpb24obm9kZSwgaHRtbCkgewogICAgICAgICAgaWYgKG5vZGUubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIGlmICghKCJpbm5lckhUTUwiIGluIG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV1c2FibGVTVkdDb250YWluZXIgPSByZXVzYWJsZVNWR0NvbnRhaW5lciB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lci5pbm5lckhUTUwgPSAiPHN2Zz4iICsgaHRtbC52YWx1ZU9mKCkudG9TdHJpbmcoKSArICI8L3N2Zz4iOwogICAgICAgICAgICAgIHZhciBzdmdOb2RlID0gcmV1c2FibGVTVkdDb250YWluZXIuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAobm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUNoaWxkKG5vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChzdmdOb2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoc3ZnTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIEVMRU1FTlRfTk9ERSA9IDE7CiAgICAgICAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgICAgICAgdmFyIENPTU1FTlRfTk9ERSA9IDg7CiAgICAgICAgdmFyIERPQ1VNRU5UX05PREUgPSA5OwogICAgICAgIHZhciBET0NVTUVOVF9GUkFHTUVOVF9OT0RFID0gMTE7CiAgICAgICAgdmFyIHNldFRleHRDb250ZW50ID0gZnVuY3Rpb24obm9kZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQpIHsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICYmIGZpcnN0Q2hpbGQgPT09IG5vZGUubGFzdENoaWxkICYmIGZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQubm9kZVZhbHVlID0gdGV4dDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0OwogICAgICAgIH07CiAgICAgICAgdmFyIHNob3J0aGFuZFRvTG9uZ2hhbmQgPSB7CiAgICAgICAgICBhbmltYXRpb246IFsiYW5pbWF0aW9uRGVsYXkiLCAiYW5pbWF0aW9uRGlyZWN0aW9uIiwgImFuaW1hdGlvbkR1cmF0aW9uIiwgImFuaW1hdGlvbkZpbGxNb2RlIiwgImFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50IiwgImFuaW1hdGlvbk5hbWUiLCAiYW5pbWF0aW9uUGxheVN0YXRlIiwgImFuaW1hdGlvblRpbWluZ0Z1bmN0aW9uIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kOiBbImJhY2tncm91bmRBdHRhY2htZW50IiwgImJhY2tncm91bmRDbGlwIiwgImJhY2tncm91bmRDb2xvciIsICJiYWNrZ3JvdW5kSW1hZ2UiLCAiYmFja2dyb3VuZE9yaWdpbiIsICJiYWNrZ3JvdW5kUG9zaXRpb25YIiwgImJhY2tncm91bmRQb3NpdGlvblkiLCAiYmFja2dyb3VuZFJlcGVhdCIsICJiYWNrZ3JvdW5kU2l6ZSJdLAogICAgICAgICAgYmFja2dyb3VuZFBvc2l0aW9uOiBbImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSJdLAogICAgICAgICAgYm9yZGVyOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIiwgImJvcmRlckltYWdlT3V0c2V0IiwgImJvcmRlckltYWdlUmVwZWF0IiwgImJvcmRlckltYWdlU2xpY2UiLCAiYm9yZGVySW1hZ2VTb3VyY2UiLCAiYm9yZGVySW1hZ2VXaWR0aCIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlckxlZnRXaWR0aCIsICJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tFbmQ6IFsiYm9yZGVyQmxvY2tFbmRDb2xvciIsICJib3JkZXJCbG9ja0VuZFN0eWxlIiwgImJvcmRlckJsb2NrRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckJsb2NrU3RhcnQ6IFsiYm9yZGVyQmxvY2tTdGFydENvbG9yIiwgImJvcmRlckJsb2NrU3RhcnRTdHlsZSIsICJib3JkZXJCbG9ja1N0YXJ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlckJvdHRvbTogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJCb3R0b21XaWR0aCJdLAogICAgICAgICAgYm9yZGVyQ29sb3I6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyVG9wQ29sb3IiXSwKICAgICAgICAgIGJvcmRlckltYWdlOiBbImJvcmRlckltYWdlT3V0c2V0IiwgImJvcmRlckltYWdlUmVwZWF0IiwgImJvcmRlckltYWdlU2xpY2UiLCAiYm9yZGVySW1hZ2VTb3VyY2UiLCAiYm9yZGVySW1hZ2VXaWR0aCJdLAogICAgICAgICAgYm9yZGVySW5saW5lRW5kOiBbImJvcmRlcklubGluZUVuZENvbG9yIiwgImJvcmRlcklubGluZUVuZFN0eWxlIiwgImJvcmRlcklubGluZUVuZFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVTdGFydDogWyJib3JkZXJJbmxpbmVTdGFydENvbG9yIiwgImJvcmRlcklubGluZVN0YXJ0U3R5bGUiLCAiYm9yZGVySW5saW5lU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyTGVmdDogWyJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlckxlZnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiBbImJvcmRlckJvdHRvbUxlZnRSYWRpdXMiLCAiYm9yZGVyQm90dG9tUmlnaHRSYWRpdXMiLCAiYm9yZGVyVG9wTGVmdFJhZGl1cyIsICJib3JkZXJUb3BSaWdodFJhZGl1cyJdLAogICAgICAgICAgYm9yZGVyUmlnaHQ6IFsiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlclJpZ2h0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlclN0eWxlOiBbImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlclRvcFN0eWxlIl0sCiAgICAgICAgICBib3JkZXJUb3A6IFsiYm9yZGVyVG9wQ29sb3IiLCAiYm9yZGVyVG9wU3R5bGUiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcldpZHRoOiBbImJvcmRlckJvdHRvbVdpZHRoIiwgImJvcmRlckxlZnRXaWR0aCIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBjb2x1bW5SdWxlOiBbImNvbHVtblJ1bGVDb2xvciIsICJjb2x1bW5SdWxlU3R5bGUiLCAiY29sdW1uUnVsZVdpZHRoIl0sCiAgICAgICAgICBjb2x1bW5zOiBbImNvbHVtbkNvdW50IiwgImNvbHVtbldpZHRoIl0sCiAgICAgICAgICBmbGV4OiBbImZsZXhCYXNpcyIsICJmbGV4R3JvdyIsICJmbGV4U2hyaW5rIl0sCiAgICAgICAgICBmbGV4RmxvdzogWyJmbGV4RGlyZWN0aW9uIiwgImZsZXhXcmFwIl0sCiAgICAgICAgICBmb250OiBbImZvbnRGYW1pbHkiLCAiZm9udEZlYXR1cmVTZXR0aW5ncyIsICJmb250S2VybmluZyIsICJmb250TGFuZ3VhZ2VPdmVycmlkZSIsICJmb250U2l6ZSIsICJmb250U2l6ZUFkanVzdCIsICJmb250U3RyZXRjaCIsICJmb250U3R5bGUiLCAiZm9udFZhcmlhbnQiLCAiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiIsICJmb250V2VpZ2h0IiwgImxpbmVIZWlnaHQiXSwKICAgICAgICAgIGZvbnRWYXJpYW50OiBbImZvbnRWYXJpYW50QWx0ZXJuYXRlcyIsICJmb250VmFyaWFudENhcHMiLCAiZm9udFZhcmlhbnRFYXN0QXNpYW4iLCAiZm9udFZhcmlhbnRMaWdhdHVyZXMiLCAiZm9udFZhcmlhbnROdW1lcmljIiwgImZvbnRWYXJpYW50UG9zaXRpb24iXSwKICAgICAgICAgIGdhcDogWyJjb2x1bW5HYXAiLCAicm93R2FwIl0sCiAgICAgICAgICBncmlkOiBbImdyaWRBdXRvQ29sdW1ucyIsICJncmlkQXV0b0Zsb3ciLCAiZ3JpZEF1dG9Sb3dzIiwgImdyaWRUZW1wbGF0ZUFyZWFzIiwgImdyaWRUZW1wbGF0ZUNvbHVtbnMiLCAiZ3JpZFRlbXBsYXRlUm93cyJdLAogICAgICAgICAgZ3JpZEFyZWE6IFsiZ3JpZENvbHVtbkVuZCIsICJncmlkQ29sdW1uU3RhcnQiLCAiZ3JpZFJvd0VuZCIsICJncmlkUm93U3RhcnQiXSwKICAgICAgICAgIGdyaWRDb2x1bW46IFsiZ3JpZENvbHVtbkVuZCIsICJncmlkQ29sdW1uU3RhcnQiXSwKICAgICAgICAgIGdyaWRDb2x1bW5HYXA6IFsiY29sdW1uR2FwIl0sCiAgICAgICAgICBncmlkR2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRSb3c6IFsiZ3JpZFJvd0VuZCIsICJncmlkUm93U3RhcnQiXSwKICAgICAgICAgIGdyaWRSb3dHYXA6IFsicm93R2FwIl0sCiAgICAgICAgICBncmlkVGVtcGxhdGU6IFsiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBsaXN0U3R5bGU6IFsibGlzdFN0eWxlSW1hZ2UiLCAibGlzdFN0eWxlUG9zaXRpb24iLCAibGlzdFN0eWxlVHlwZSJdLAogICAgICAgICAgbWFyZ2luOiBbIm1hcmdpbkJvdHRvbSIsICJtYXJnaW5MZWZ0IiwgIm1hcmdpblJpZ2h0IiwgIm1hcmdpblRvcCJdLAogICAgICAgICAgbWFya2VyOiBbIm1hcmtlckVuZCIsICJtYXJrZXJNaWQiLCAibWFya2VyU3RhcnQiXSwKICAgICAgICAgIG1hc2s6IFsibWFza0NsaXAiLCAibWFza0NvbXBvc2l0ZSIsICJtYXNrSW1hZ2UiLCAibWFza01vZGUiLCAibWFza09yaWdpbiIsICJtYXNrUG9zaXRpb25YIiwgIm1hc2tQb3NpdGlvblkiLCAibWFza1JlcGVhdCIsICJtYXNrU2l6ZSJdLAogICAgICAgICAgbWFza1Bvc2l0aW9uOiBbIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSJdLAogICAgICAgICAgb3V0bGluZTogWyJvdXRsaW5lQ29sb3IiLCAib3V0bGluZVN0eWxlIiwgIm91dGxpbmVXaWR0aCJdLAogICAgICAgICAgb3ZlcmZsb3c6IFsib3ZlcmZsb3dYIiwgIm92ZXJmbG93WSJdLAogICAgICAgICAgcGFkZGluZzogWyJwYWRkaW5nQm90dG9tIiwgInBhZGRpbmdMZWZ0IiwgInBhZGRpbmdSaWdodCIsICJwYWRkaW5nVG9wIl0sCiAgICAgICAgICBwbGFjZUNvbnRlbnQ6IFsiYWxpZ25Db250ZW50IiwgImp1c3RpZnlDb250ZW50Il0sCiAgICAgICAgICBwbGFjZUl0ZW1zOiBbImFsaWduSXRlbXMiLCAianVzdGlmeUl0ZW1zIl0sCiAgICAgICAgICBwbGFjZVNlbGY6IFsiYWxpZ25TZWxmIiwgImp1c3RpZnlTZWxmIl0sCiAgICAgICAgICB0ZXh0RGVjb3JhdGlvbjogWyJ0ZXh0RGVjb3JhdGlvbkNvbG9yIiwgInRleHREZWNvcmF0aW9uTGluZSIsICJ0ZXh0RGVjb3JhdGlvblN0eWxlIl0sCiAgICAgICAgICB0ZXh0RW1waGFzaXM6IFsidGV4dEVtcGhhc2lzQ29sb3IiLCAidGV4dEVtcGhhc2lzU3R5bGUiXSwKICAgICAgICAgIHRyYW5zaXRpb246IFsidHJhbnNpdGlvbkRlbGF5IiwgInRyYW5zaXRpb25EdXJhdGlvbiIsICJ0cmFuc2l0aW9uUHJvcGVydHkiLCAidHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uIl0sCiAgICAgICAgICB3b3JkV3JhcDogWyJvdmVyZmxvd1dyYXAiXQogICAgICAgIH07CiAgICAgICAgdmFyIGlzVW5pdGxlc3NOdW1iZXIgPSB7CiAgICAgICAgICBhbmltYXRpb25JdGVyYXRpb25Db3VudDogdHJ1ZSwKICAgICAgICAgIGFzcGVjdFJhdGlvOiB0cnVlLAogICAgICAgICAgYm9yZGVySW1hZ2VPdXRzZXQ6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVNsaWNlOiB0cnVlLAogICAgICAgICAgYm9yZGVySW1hZ2VXaWR0aDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXg6IHRydWUsCiAgICAgICAgICBib3hGbGV4R3JvdXA6IHRydWUsCiAgICAgICAgICBib3hPcmRpbmFsR3JvdXA6IHRydWUsCiAgICAgICAgICBjb2x1bW5Db3VudDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbnM6IHRydWUsCiAgICAgICAgICBmbGV4OiB0cnVlLAogICAgICAgICAgZmxleEdyb3c6IHRydWUsCiAgICAgICAgICBmbGV4UG9zaXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4U2hyaW5rOiB0cnVlLAogICAgICAgICAgZmxleE5lZ2F0aXZlOiB0cnVlLAogICAgICAgICAgZmxleE9yZGVyOiB0cnVlLAogICAgICAgICAgZ3JpZEFyZWE6IHRydWUsCiAgICAgICAgICBncmlkUm93OiB0cnVlLAogICAgICAgICAgZ3JpZFJvd0VuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dTcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1N0YXJ0OiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbjogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5FbmQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uU3BhbjogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TdGFydDogdHJ1ZSwKICAgICAgICAgIGZvbnRXZWlnaHQ6IHRydWUsCiAgICAgICAgICBsaW5lQ2xhbXA6IHRydWUsCiAgICAgICAgICBsaW5lSGVpZ2h0OiB0cnVlLAogICAgICAgICAgb3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIG9yZGVyOiB0cnVlLAogICAgICAgICAgb3JwaGFuczogdHJ1ZSwKICAgICAgICAgIHRhYlNpemU6IHRydWUsCiAgICAgICAgICB3aWRvd3M6IHRydWUsCiAgICAgICAgICB6SW5kZXg6IHRydWUsCiAgICAgICAgICB6b29tOiB0cnVlLAogICAgICAgICAgLy8gU1ZHLXJlbGF0ZWQgcHJvcGVydGllcwogICAgICAgICAgZmlsbE9wYWNpdHk6IHRydWUsCiAgICAgICAgICBmbG9vZE9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdG9wT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0cm9rZURhc2hhcnJheTogdHJ1ZSwKICAgICAgICAgIHN0cm9rZURhc2hvZmZzZXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VNaXRlcmxpbWl0OiB0cnVlLAogICAgICAgICAgc3Ryb2tlT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0cm9rZVdpZHRoOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBwcmVmaXhLZXkocHJlZml4Miwga2V5KSB7CiAgICAgICAgICByZXR1cm4gcHJlZml4MiArIGtleS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGtleS5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXhlcyA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlcy5mb3JFYWNoKGZ1bmN0aW9uKHByZWZpeDIpIHsKICAgICAgICAgICAgaXNVbml0bGVzc051bWJlcltwcmVmaXhLZXkocHJlZml4MiwgcHJvcCldID0gaXNVbml0bGVzc051bWJlcltwcm9wXTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGRhbmdlcm91c1N0eWxlVmFsdWUobmFtZSwgdmFsdWUsIGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgIHZhciBpc0VtcHR5ID0gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgICBpZiAoaXNFbXB0eSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkgJiYgdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiB2YWx1ZSAhPT0gMCAmJiAhKGlzVW5pdGxlc3NOdW1iZXIuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgaXNVbml0bGVzc051bWJlcltuYW1lXSkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlICsgInB4IjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDU1NQcm9wZXJ0eVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAoIiIgKyB2YWx1ZSkudHJpbSgpOwogICAgICAgIH0KICAgICAgICB2YXIgdXBwZXJjYXNlUGF0dGVybiA9IC8oW0EtWl0pL2c7CiAgICAgICAgdmFyIG1zUGF0dGVybiA9IC9ebXMtLzsKICAgICAgICBmdW5jdGlvbiBoeXBoZW5hdGVTdHlsZU5hbWUobmFtZSkgewogICAgICAgICAgcmV0dXJuIG5hbWUucmVwbGFjZSh1cHBlcmNhc2VQYXR0ZXJuLCAiLSQxIikudG9Mb3dlckNhc2UoKS5yZXBsYWNlKG1zUGF0dGVybiwgIi1tcy0iKTsKICAgICAgICB9CiAgICAgICAgdmFyIHdhcm5WYWxpZFN0eWxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgYmFkVmVuZG9yZWRTdHlsZU5hbWVQYXR0ZXJuID0gL14oPzp3ZWJraXR8bW96fG8pW0EtWl0vOwogICAgICAgICAgdmFyIG1zUGF0dGVybiQxID0gL14tbXMtLzsKICAgICAgICAgIHZhciBoeXBoZW5QYXR0ZXJuID0gLy0oLikvZzsKICAgICAgICAgIHZhciBiYWRTdHlsZVZhbHVlV2l0aFNlbWljb2xvblBhdHRlcm4gPSAvO1xzKiQvOwogICAgICAgICAgdmFyIHdhcm5lZFN0eWxlTmFtZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZVZhbHVlcyA9IHt9OwogICAgICAgICAgdmFyIHdhcm5lZEZvck5hTlZhbHVlID0gZmFsc2U7CiAgICAgICAgICB2YXIgd2FybmVkRm9ySW5maW5pdHlWYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShoeXBoZW5QYXR0ZXJuLCBmdW5jdGlvbihfLCBjaGFyYWN0ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gY2hhcmFjdGVyLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuSHlwaGVuYXRlZFN0eWxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgaWYgKHdhcm5lZFN0eWxlTmFtZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZU5hbWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoCiAgICAgICAgICAgICAgIlVuc3VwcG9ydGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwKICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgIC8vIEFzIEFuZGkgU21pdGggc3VnZ2VzdHMKICAgICAgICAgICAgICAvLyAoaHR0cDovL3d3dy5hbmRpc21pdGguY29tL2Jsb2cvMjAxMi8wMi9tb2Rlcm5penItcHJlZml4ZWQvKSwgYW4gYC1tc2AgcHJlZml4CiAgICAgICAgICAgICAgLy8gaXMgY29udmVydGVkIHRvIGxvd2VyY2FzZSBgbXNgLgogICAgICAgICAgICAgIGNhbWVsaXplKG5hbWUucmVwbGFjZShtc1BhdHRlcm4kMSwgIm1zLSIpKQogICAgICAgICAgICApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuQmFkVmVuZG9yZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJVbnN1cHBvcnRlZCB2ZW5kb3ItcHJlZml4ZWQgc3R5bGUgcHJvcGVydHkgJXMuIERpZCB5b3UgbWVhbiAlcz8iLCBuYW1lLCBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZVZhbHVlcy5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSkgJiYgd2FybmVkU3R5bGVWYWx1ZXNbdmFsdWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKGBTdHlsZSBwcm9wZXJ0eSB2YWx1ZXMgc2hvdWxkbid0IGNvbnRhaW4gYSBzZW1pY29sb24uIFRyeSAiJXM6ICVzIiBpbnN0ZWFkLmAsIG5hbWUsIHZhbHVlLnJlcGxhY2UoYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuLCAiIikpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZUlzTmFOID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHdhcm5lZEZvck5hTlZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvck5hTlZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoImBOYU5gIGlzIGFuIGludmFsaWQgdmFsdWUgZm9yIHRoZSBgJXNgIGNzcyBzdHlsZSBwcm9wZXJ0eS4iLCBuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc0luZmluaXR5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHdhcm5lZEZvckluZmluaXR5VmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkRm9ySW5maW5pdHlWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgSW5maW5pdHlgIGlzIGFuIGludmFsaWQgdmFsdWUgZm9yIHRoZSBgJXNgIGNzcyBzdHlsZSBwcm9wZXJ0eS4iLCBuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoIi0iKSA+IC0xKSB7CiAgICAgICAgICAgICAgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUobmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFkVmVuZG9yZWRTdHlsZU5hbWVQYXR0ZXJuLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB3YXJuQmFkVmVuZG9yZWRTdHlsZU5hbWUobmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgd2FyblN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmIChpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNOYU4obmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzRmluaXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgd2FyblN0eWxlVmFsdWVJc0luZmluaXR5KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSQxID0gd2FyblZhbGlkU3R5bGU7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKHN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgc2VyaWFsaXplZCA9ICIiOwogICAgICAgICAgICB2YXIgZGVsaW1pdGVyID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgICBpZiAoIXN0eWxlcy5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBzdHlsZXNbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICBpZiAoc3R5bGVWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNDdXN0b21Qcm9wZXJ0eSA9IHN0eWxlTmFtZS5pbmRleE9mKCItLSIpID09PSAwOwogICAgICAgICAgICAgICAgc2VyaWFsaXplZCArPSBkZWxpbWl0ZXIgKyAoaXNDdXN0b21Qcm9wZXJ0eSA/IHN0eWxlTmFtZSA6IGh5cGhlbmF0ZVN0eWxlTmFtZShzdHlsZU5hbWUpKSArICI6IjsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlVmFsdWUsIGlzQ3VzdG9tUHJvcGVydHkpOwogICAgICAgICAgICAgICAgZGVsaW1pdGVyID0gIjsiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VyaWFsaXplZCB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRWYWx1ZUZvclN0eWxlcyhub2RlLCBzdHlsZXMpIHsKICAgICAgICAgIHZhciBzdHlsZTIgPSBub2RlLnN0eWxlOwogICAgICAgICAgZm9yICh2YXIgc3R5bGVOYW1lIGluIHN0eWxlcykgewogICAgICAgICAgICBpZiAoIXN0eWxlcy5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Qcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgd2FyblZhbGlkU3R5bGUkMShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBkYW5nZXJvdXNTdHlsZVZhbHVlKHN0eWxlTmFtZSwgc3R5bGVzW3N0eWxlTmFtZV0sIGlzQ3VzdG9tUHJvcGVydHkpOwogICAgICAgICAgICBpZiAoc3R5bGVOYW1lID09PSAiZmxvYXQiKSB7CiAgICAgICAgICAgICAgc3R5bGVOYW1lID0gImNzc0Zsb2F0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDdXN0b21Qcm9wZXJ0eSkgewogICAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eShzdHlsZU5hbWUsIHN0eWxlVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0eWxlMltzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbHVlRW1wdHkodmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImJvb2xlYW4iIHx8IHZhbHVlID09PSAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXhwYW5kU2hvcnRoYW5kTWFwKHN0eWxlcykgewogICAgICAgICAgdmFyIGV4cGFuZGVkID0ge307CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgIHZhciBsb25naGFuZHMgPSBzaG9ydGhhbmRUb0xvbmdoYW5kW2tleV0gfHwgW2tleV07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbG9uZ2hhbmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZXhwYW5kZWRbbG9uZ2hhbmRzW2ldXSA9IGtleTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4cGFuZGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0U3R5bGVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbmV4dFN0eWxlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhwYW5kZWRVcGRhdGVzID0gZXhwYW5kU2hvcnRoYW5kTWFwKHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICAgIHZhciBleHBhbmRlZFN0eWxlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChuZXh0U3R5bGVzKTsKICAgICAgICAgICAgdmFyIHdhcm5lZEFib3V0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBleHBhbmRlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxLZXkgPSBleHBhbmRlZFVwZGF0ZXNba2V5XTsKICAgICAgICAgICAgICB2YXIgY29ycmVjdE9yaWdpbmFsS2V5ID0gZXhwYW5kZWRTdHlsZXNba2V5XTsKICAgICAgICAgICAgICBpZiAoY29ycmVjdE9yaWdpbmFsS2V5ICYmIG9yaWdpbmFsS2V5ICE9PSBjb3JyZWN0T3JpZ2luYWxLZXkpIHsKICAgICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3JpZ2luYWxLZXkgKyAiLCIgKyBjb3JyZWN0T3JpZ2luYWxLZXk7CiAgICAgICAgICAgICAgICBpZiAod2FybmVkQWJvdXRbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YXJuZWRBYm91dFt3YXJuaW5nS2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgYSBzdHlsZSBwcm9wZXJ0eSBkdXJpbmcgcmVyZW5kZXIgKCVzKSB3aGVuIGEgY29uZmxpY3RpbmcgcHJvcGVydHkgaXMgc2V0ICglcykgY2FuIGxlYWQgdG8gc3R5bGluZyBidWdzLiBUbyBhdm9pZCB0aGlzLCBkb24ndCBtaXggc2hvcnRoYW5kIGFuZCBub24tc2hvcnRoYW5kIHByb3BlcnRpZXMgZm9yIHRoZSBzYW1lIHZhbHVlOyBpbnN0ZWFkLCByZXBsYWNlIHRoZSBzaG9ydGhhbmQgd2l0aCBzZXBhcmF0ZSB2YWx1ZXMuIiwgaXNWYWx1ZUVtcHR5KHN0eWxlVXBkYXRlc1tvcmlnaW5hbEtleV0pID8gIlJlbW92aW5nIiA6ICJVcGRhdGluZyIsIG9yaWdpbmFsS2V5LCBjb3JyZWN0T3JpZ2luYWxLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgb21pdHRlZENsb3NlVGFncyA9IHsKICAgICAgICAgIGFyZWE6IHRydWUsCiAgICAgICAgICBiYXNlOiB0cnVlLAogICAgICAgICAgYnI6IHRydWUsCiAgICAgICAgICBjb2w6IHRydWUsCiAgICAgICAgICBlbWJlZDogdHJ1ZSwKICAgICAgICAgIGhyOiB0cnVlLAogICAgICAgICAgaW1nOiB0cnVlLAogICAgICAgICAgaW5wdXQ6IHRydWUsCiAgICAgICAgICBrZXlnZW46IHRydWUsCiAgICAgICAgICBsaW5rOiB0cnVlLAogICAgICAgICAgbWV0YTogdHJ1ZSwKICAgICAgICAgIHBhcmFtOiB0cnVlLAogICAgICAgICAgc291cmNlOiB0cnVlLAogICAgICAgICAgdHJhY2s6IHRydWUsCiAgICAgICAgICB3YnI6IHRydWUKICAgICAgICAgIC8vIE5PVEU6IG1lbnVpdGVtJ3MgY2xvc2UgdGFnIHNob3VsZCBiZSBvbWl0dGVkLCBidXQgdGhhdCBjYXVzZXMgcHJvYmxlbXMuCiAgICAgICAgfTsKICAgICAgICB2YXIgdm9pZEVsZW1lbnRUYWdzID0gYXNzaWduKHsKICAgICAgICAgIG1lbnVpdGVtOiB0cnVlCiAgICAgICAgfSwgb21pdHRlZENsb3NlVGFncyk7CiAgICAgICAgdmFyIEhUTUwgPSAiX19odG1sIjsKICAgICAgICBmdW5jdGlvbiBhc3NlcnRWYWxpZFByb3BzKHRhZywgcHJvcHMpIHsKICAgICAgICAgIGlmICghcHJvcHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZvaWRFbGVtZW50VGFnc1t0YWddKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsIHx8IHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGFnICsgIiBpcyBhIHZvaWQgZWxlbWVudCB0YWcgYW5kIG11c3QgbmVpdGhlciBoYXZlIGBjaGlsZHJlbmAgbm9yIHVzZSBgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAocHJvcHMuY2hpbGRyZW4gIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2FuIG9ubHkgc2V0IG9uZSBvZiBgY2hpbGRyZW5gIG9yIGBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPT0gIm9iamVjdCIgfHwgIShIVE1MIGluIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYCBtdXN0IGJlIGluIHRoZSBmb3JtIGB7X19odG1sOiAuLi59YC4gUGxlYXNlIHZpc2l0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kYW5nZXJvdXNseS1zZXQtaW5uZXItaHRtbCBmb3IgbW9yZSBpbmZvcm1hdGlvbi4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXByb3BzLnN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyAmJiBwcm9wcy5jb250ZW50RWRpdGFibGUgJiYgcHJvcHMuY2hpbGRyZW4gIT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbXBvbmVudCBpcyBgY29udGVudEVkaXRhYmxlYCBhbmQgY29udGFpbnMgYGNoaWxkcmVuYCBtYW5hZ2VkIGJ5IFJlYWN0LiBJdCBpcyBub3cgeW91ciByZXNwb25zaWJpbGl0eSB0byBndWFyYW50ZWUgdGhhdCBub25lIG9mIHRob3NlIG5vZGVzIGFyZSB1bmV4cGVjdGVkbHkgbW9kaWZpZWQgb3IgZHVwbGljYXRlZC4gVGhpcyBpcyBwcm9iYWJseSBub3QgaW50ZW50aW9uYWwuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5zdHlsZSAhPSBudWxsICYmIHR5cGVvZiBwcm9wcy5zdHlsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYHN0eWxlYCBwcm9wIGV4cGVjdHMgYSBtYXBwaW5nIGZyb20gc3R5bGUgcHJvcGVydGllcyB0byB2YWx1ZXMsIG5vdCBhIHN0cmluZy4gRm9yIGV4YW1wbGUsIHN0eWxlPXt7bWFyZ2luUmlnaHQ6IHNwYWNpbmcgKyAnZW0nfX0gd2hlbiB1c2luZyBKU1guIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ3VzdG9tQ29tcG9uZW50KHRhZ05hbWUsIHByb3BzKSB7CiAgICAgICAgICBpZiAodGFnTmFtZS5pbmRleE9mKCItIikgPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcHJvcHMuaXMgPT09ICJzdHJpbmciOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWdOYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImFubm90YXRpb24teG1sIjoKICAgICAgICAgICAgY2FzZSAiY29sb3ItcHJvZmlsZSI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZSI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1zcmMiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtdXJpIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLWZvcm1hdCI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1uYW1lIjoKICAgICAgICAgICAgY2FzZSAibWlzc2luZy1nbHlwaCI6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcG9zc2libGVTdGFuZGFyZE5hbWVzID0gewogICAgICAgICAgLy8gSFRNTAogICAgICAgICAgYWNjZXB0OiAiYWNjZXB0IiwKICAgICAgICAgIGFjY2VwdGNoYXJzZXQ6ICJhY2NlcHRDaGFyc2V0IiwKICAgICAgICAgICJhY2NlcHQtY2hhcnNldCI6ICJhY2NlcHRDaGFyc2V0IiwKICAgICAgICAgIGFjY2Vzc2tleTogImFjY2Vzc0tleSIsCiAgICAgICAgICBhY3Rpb246ICJhY3Rpb24iLAogICAgICAgICAgYWxsb3dmdWxsc2NyZWVuOiAiYWxsb3dGdWxsU2NyZWVuIiwKICAgICAgICAgIGFsdDogImFsdCIsCiAgICAgICAgICBhczogImFzIiwKICAgICAgICAgIGFzeW5jOiAiYXN5bmMiLAogICAgICAgICAgYXV0b2NhcGl0YWxpemU6ICJhdXRvQ2FwaXRhbGl6ZSIsCiAgICAgICAgICBhdXRvY29tcGxldGU6ICJhdXRvQ29tcGxldGUiLAogICAgICAgICAgYXV0b2NvcnJlY3Q6ICJhdXRvQ29ycmVjdCIsCiAgICAgICAgICBhdXRvZm9jdXM6ICJhdXRvRm9jdXMiLAogICAgICAgICAgYXV0b3BsYXk6ICJhdXRvUGxheSIsCiAgICAgICAgICBhdXRvc2F2ZTogImF1dG9TYXZlIiwKICAgICAgICAgIGNhcHR1cmU6ICJjYXB0dXJlIiwKICAgICAgICAgIGNlbGxwYWRkaW5nOiAiY2VsbFBhZGRpbmciLAogICAgICAgICAgY2VsbHNwYWNpbmc6ICJjZWxsU3BhY2luZyIsCiAgICAgICAgICBjaGFsbGVuZ2U6ICJjaGFsbGVuZ2UiLAogICAgICAgICAgY2hhcnNldDogImNoYXJTZXQiLAogICAgICAgICAgY2hlY2tlZDogImNoZWNrZWQiLAogICAgICAgICAgY2hpbGRyZW46ICJjaGlsZHJlbiIsCiAgICAgICAgICBjaXRlOiAiY2l0ZSIsCiAgICAgICAgICBjbGFzczogImNsYXNzTmFtZSIsCiAgICAgICAgICBjbGFzc2lkOiAiY2xhc3NJRCIsCiAgICAgICAgICBjbGFzc25hbWU6ICJjbGFzc05hbWUiLAogICAgICAgICAgY29sczogImNvbHMiLAogICAgICAgICAgY29sc3BhbjogImNvbFNwYW4iLAogICAgICAgICAgY29udGVudDogImNvbnRlbnQiLAogICAgICAgICAgY29udGVudGVkaXRhYmxlOiAiY29udGVudEVkaXRhYmxlIiwKICAgICAgICAgIGNvbnRleHRtZW51OiAiY29udGV4dE1lbnUiLAogICAgICAgICAgY29udHJvbHM6ICJjb250cm9scyIsCiAgICAgICAgICBjb250cm9sc2xpc3Q6ICJjb250cm9sc0xpc3QiLAogICAgICAgICAgY29vcmRzOiAiY29vcmRzIiwKICAgICAgICAgIGNyb3Nzb3JpZ2luOiAiY3Jvc3NPcmlnaW4iLAogICAgICAgICAgZGFuZ2Vyb3VzbHlzZXRpbm5lcmh0bWw6ICJkYW5nZXJvdXNseVNldElubmVySFRNTCIsCiAgICAgICAgICBkYXRhOiAiZGF0YSIsCiAgICAgICAgICBkYXRldGltZTogImRhdGVUaW1lIiwKICAgICAgICAgIGRlZmF1bHQ6ICJkZWZhdWx0IiwKICAgICAgICAgIGRlZmF1bHRjaGVja2VkOiAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgZGVmYXVsdHZhbHVlOiAiZGVmYXVsdFZhbHVlIiwKICAgICAgICAgIGRlZmVyOiAiZGVmZXIiLAogICAgICAgICAgZGlyOiAiZGlyIiwKICAgICAgICAgIGRpc2FibGVkOiAiZGlzYWJsZWQiLAogICAgICAgICAgZGlzYWJsZXBpY3R1cmVpbnBpY3R1cmU6ICJkaXNhYmxlUGljdHVyZUluUGljdHVyZSIsCiAgICAgICAgICBkaXNhYmxlcmVtb3RlcGxheWJhY2s6ICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgZG93bmxvYWQ6ICJkb3dubG9hZCIsCiAgICAgICAgICBkcmFnZ2FibGU6ICJkcmFnZ2FibGUiLAogICAgICAgICAgZW5jdHlwZTogImVuY1R5cGUiLAogICAgICAgICAgZW50ZXJrZXloaW50OiAiZW50ZXJLZXlIaW50IiwKICAgICAgICAgIGZvcjogImh0bWxGb3IiLAogICAgICAgICAgZm9ybTogImZvcm0iLAogICAgICAgICAgZm9ybW1ldGhvZDogImZvcm1NZXRob2QiLAogICAgICAgICAgZm9ybWFjdGlvbjogImZvcm1BY3Rpb24iLAogICAgICAgICAgZm9ybWVuY3R5cGU6ICJmb3JtRW5jVHlwZSIsCiAgICAgICAgICBmb3Jtbm92YWxpZGF0ZTogImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgIGZvcm10YXJnZXQ6ICJmb3JtVGFyZ2V0IiwKICAgICAgICAgIGZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiLAogICAgICAgICAgaGVhZGVyczogImhlYWRlcnMiLAogICAgICAgICAgaGVpZ2h0OiAiaGVpZ2h0IiwKICAgICAgICAgIGhpZGRlbjogImhpZGRlbiIsCiAgICAgICAgICBoaWdoOiAiaGlnaCIsCiAgICAgICAgICBocmVmOiAiaHJlZiIsCiAgICAgICAgICBocmVmbGFuZzogImhyZWZMYW5nIiwKICAgICAgICAgIGh0bWxmb3I6ICJodG1sRm9yIiwKICAgICAgICAgIGh0dHBlcXVpdjogImh0dHBFcXVpdiIsCiAgICAgICAgICAiaHR0cC1lcXVpdiI6ICJodHRwRXF1aXYiLAogICAgICAgICAgaWNvbjogImljb24iLAogICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICBpbWFnZXNpemVzOiAiaW1hZ2VTaXplcyIsCiAgICAgICAgICBpbWFnZXNyY3NldDogImltYWdlU3JjU2V0IiwKICAgICAgICAgIGlubmVyaHRtbDogImlubmVySFRNTCIsCiAgICAgICAgICBpbnB1dG1vZGU6ICJpbnB1dE1vZGUiLAogICAgICAgICAgaW50ZWdyaXR5OiAiaW50ZWdyaXR5IiwKICAgICAgICAgIGlzOiAiaXMiLAogICAgICAgICAgaXRlbWlkOiAiaXRlbUlEIiwKICAgICAgICAgIGl0ZW1wcm9wOiAiaXRlbVByb3AiLAogICAgICAgICAgaXRlbXJlZjogIml0ZW1SZWYiLAogICAgICAgICAgaXRlbXNjb3BlOiAiaXRlbVNjb3BlIiwKICAgICAgICAgIGl0ZW10eXBlOiAiaXRlbVR5cGUiLAogICAgICAgICAga2V5cGFyYW1zOiAia2V5UGFyYW1zIiwKICAgICAgICAgIGtleXR5cGU6ICJrZXlUeXBlIiwKICAgICAgICAgIGtpbmQ6ICJraW5kIiwKICAgICAgICAgIGxhYmVsOiAibGFiZWwiLAogICAgICAgICAgbGFuZzogImxhbmciLAogICAgICAgICAgbGlzdDogImxpc3QiLAogICAgICAgICAgbG9vcDogImxvb3AiLAogICAgICAgICAgbG93OiAibG93IiwKICAgICAgICAgIG1hbmlmZXN0OiAibWFuaWZlc3QiLAogICAgICAgICAgbWFyZ2lud2lkdGg6ICJtYXJnaW5XaWR0aCIsCiAgICAgICAgICBtYXJnaW5oZWlnaHQ6ICJtYXJnaW5IZWlnaHQiLAogICAgICAgICAgbWF4OiAibWF4IiwKICAgICAgICAgIG1heGxlbmd0aDogIm1heExlbmd0aCIsCiAgICAgICAgICBtZWRpYTogIm1lZGlhIiwKICAgICAgICAgIG1lZGlhZ3JvdXA6ICJtZWRpYUdyb3VwIiwKICAgICAgICAgIG1ldGhvZDogIm1ldGhvZCIsCiAgICAgICAgICBtaW46ICJtaW4iLAogICAgICAgICAgbWlubGVuZ3RoOiAibWluTGVuZ3RoIiwKICAgICAgICAgIG11bHRpcGxlOiAibXVsdGlwbGUiLAogICAgICAgICAgbXV0ZWQ6ICJtdXRlZCIsCiAgICAgICAgICBuYW1lOiAibmFtZSIsCiAgICAgICAgICBub21vZHVsZTogIm5vTW9kdWxlIiwKICAgICAgICAgIG5vbmNlOiAibm9uY2UiLAogICAgICAgICAgbm92YWxpZGF0ZTogIm5vVmFsaWRhdGUiLAogICAgICAgICAgb3BlbjogIm9wZW4iLAogICAgICAgICAgb3B0aW11bTogIm9wdGltdW0iLAogICAgICAgICAgcGF0dGVybjogInBhdHRlcm4iLAogICAgICAgICAgcGxhY2Vob2xkZXI6ICJwbGFjZWhvbGRlciIsCiAgICAgICAgICBwbGF5c2lubGluZTogInBsYXlzSW5saW5lIiwKICAgICAgICAgIHBvc3RlcjogInBvc3RlciIsCiAgICAgICAgICBwcmVsb2FkOiAicHJlbG9hZCIsCiAgICAgICAgICBwcm9maWxlOiAicHJvZmlsZSIsCiAgICAgICAgICByYWRpb2dyb3VwOiAicmFkaW9Hcm91cCIsCiAgICAgICAgICByZWFkb25seTogInJlYWRPbmx5IiwKICAgICAgICAgIHJlZmVycmVycG9saWN5OiAicmVmZXJyZXJQb2xpY3kiLAogICAgICAgICAgcmVsOiAicmVsIiwKICAgICAgICAgIHJlcXVpcmVkOiAicmVxdWlyZWQiLAogICAgICAgICAgcmV2ZXJzZWQ6ICJyZXZlcnNlZCIsCiAgICAgICAgICByb2xlOiAicm9sZSIsCiAgICAgICAgICByb3dzOiAicm93cyIsCiAgICAgICAgICByb3dzcGFuOiAicm93U3BhbiIsCiAgICAgICAgICBzYW5kYm94OiAic2FuZGJveCIsCiAgICAgICAgICBzY29wZTogInNjb3BlIiwKICAgICAgICAgIHNjb3BlZDogInNjb3BlZCIsCiAgICAgICAgICBzY3JvbGxpbmc6ICJzY3JvbGxpbmciLAogICAgICAgICAgc2VhbWxlc3M6ICJzZWFtbGVzcyIsCiAgICAgICAgICBzZWxlY3RlZDogInNlbGVjdGVkIiwKICAgICAgICAgIHNoYXBlOiAic2hhcGUiLAogICAgICAgICAgc2l6ZTogInNpemUiLAogICAgICAgICAgc2l6ZXM6ICJzaXplcyIsCiAgICAgICAgICBzcGFuOiAic3BhbiIsCiAgICAgICAgICBzcGVsbGNoZWNrOiAic3BlbGxDaGVjayIsCiAgICAgICAgICBzcmM6ICJzcmMiLAogICAgICAgICAgc3JjZG9jOiAic3JjRG9jIiwKICAgICAgICAgIHNyY2xhbmc6ICJzcmNMYW5nIiwKICAgICAgICAgIHNyY3NldDogInNyY1NldCIsCiAgICAgICAgICBzdGFydDogInN0YXJ0IiwKICAgICAgICAgIHN0ZXA6ICJzdGVwIiwKICAgICAgICAgIHN0eWxlOiAic3R5bGUiLAogICAgICAgICAgc3VtbWFyeTogInN1bW1hcnkiLAogICAgICAgICAgdGFiaW5kZXg6ICJ0YWJJbmRleCIsCiAgICAgICAgICB0YXJnZXQ6ICJ0YXJnZXQiLAogICAgICAgICAgdGl0bGU6ICJ0aXRsZSIsCiAgICAgICAgICB0eXBlOiAidHlwZSIsCiAgICAgICAgICB1c2VtYXA6ICJ1c2VNYXAiLAogICAgICAgICAgdmFsdWU6ICJ2YWx1ZSIsCiAgICAgICAgICB3aWR0aDogIndpZHRoIiwKICAgICAgICAgIHdtb2RlOiAid21vZGUiLAogICAgICAgICAgd3JhcDogIndyYXAiLAogICAgICAgICAgLy8gU1ZHCiAgICAgICAgICBhYm91dDogImFib3V0IiwKICAgICAgICAgIGFjY2VudGhlaWdodDogImFjY2VudEhlaWdodCIsCiAgICAgICAgICAiYWNjZW50LWhlaWdodCI6ICJhY2NlbnRIZWlnaHQiLAogICAgICAgICAgYWNjdW11bGF0ZTogImFjY3VtdWxhdGUiLAogICAgICAgICAgYWRkaXRpdmU6ICJhZGRpdGl2ZSIsCiAgICAgICAgICBhbGlnbm1lbnRiYXNlbGluZTogImFsaWdubWVudEJhc2VsaW5lIiwKICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgYWxsb3dyZW9yZGVyOiAiYWxsb3dSZW9yZGVyIiwKICAgICAgICAgIGFscGhhYmV0aWM6ICJhbHBoYWJldGljIiwKICAgICAgICAgIGFtcGxpdHVkZTogImFtcGxpdHVkZSIsCiAgICAgICAgICBhcmFiaWNmb3JtOiAiYXJhYmljRm9ybSIsCiAgICAgICAgICAiYXJhYmljLWZvcm0iOiAiYXJhYmljRm9ybSIsCiAgICAgICAgICBhc2NlbnQ6ICJhc2NlbnQiLAogICAgICAgICAgYXR0cmlidXRlbmFtZTogImF0dHJpYnV0ZU5hbWUiLAogICAgICAgICAgYXR0cmlidXRldHlwZTogImF0dHJpYnV0ZVR5cGUiLAogICAgICAgICAgYXV0b3JldmVyc2U6ICJhdXRvUmV2ZXJzZSIsCiAgICAgICAgICBhemltdXRoOiAiYXppbXV0aCIsCiAgICAgICAgICBiYXNlZnJlcXVlbmN5OiAiYmFzZUZyZXF1ZW5jeSIsCiAgICAgICAgICBiYXNlbGluZXNoaWZ0OiAiYmFzZWxpbmVTaGlmdCIsCiAgICAgICAgICAiYmFzZWxpbmUtc2hpZnQiOiAiYmFzZWxpbmVTaGlmdCIsCiAgICAgICAgICBiYXNlcHJvZmlsZTogImJhc2VQcm9maWxlIiwKICAgICAgICAgIGJib3g6ICJiYm94IiwKICAgICAgICAgIGJlZ2luOiAiYmVnaW4iLAogICAgICAgICAgYmlhczogImJpYXMiLAogICAgICAgICAgYnk6ICJieSIsCiAgICAgICAgICBjYWxjbW9kZTogImNhbGNNb2RlIiwKICAgICAgICAgIGNhcGhlaWdodDogImNhcEhlaWdodCIsCiAgICAgICAgICAiY2FwLWhlaWdodCI6ICJjYXBIZWlnaHQiLAogICAgICAgICAgY2xpcDogImNsaXAiLAogICAgICAgICAgY2xpcHBhdGg6ICJjbGlwUGF0aCIsCiAgICAgICAgICAiY2xpcC1wYXRoIjogImNsaXBQYXRoIiwKICAgICAgICAgIGNsaXBwYXRodW5pdHM6ICJjbGlwUGF0aFVuaXRzIiwKICAgICAgICAgIGNsaXBydWxlOiAiY2xpcFJ1bGUiLAogICAgICAgICAgImNsaXAtcnVsZSI6ICJjbGlwUnVsZSIsCiAgICAgICAgICBjb2xvcjogImNvbG9yIiwKICAgICAgICAgIGNvbG9yaW50ZXJwb2xhdGlvbjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbiI6ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uZmlsdGVyczogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyI6ICJjb2xvckludGVycG9sYXRpb25GaWx0ZXJzIiwKICAgICAgICAgIGNvbG9ycHJvZmlsZTogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICAiY29sb3ItcHJvZmlsZSI6ICJjb2xvclByb2ZpbGUiLAogICAgICAgICAgY29sb3JyZW5kZXJpbmc6ICJjb2xvclJlbmRlcmluZyIsCiAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIjogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgIGNvbnRlbnRzY3JpcHR0eXBlOiAiY29udGVudFNjcmlwdFR5cGUiLAogICAgICAgICAgY29udGVudHN0eWxldHlwZTogImNvbnRlbnRTdHlsZVR5cGUiLAogICAgICAgICAgY3Vyc29yOiAiY3Vyc29yIiwKICAgICAgICAgIGN4OiAiY3giLAogICAgICAgICAgY3k6ICJjeSIsCiAgICAgICAgICBkOiAiZCIsCiAgICAgICAgICBkYXRhdHlwZTogImRhdGF0eXBlIiwKICAgICAgICAgIGRlY2VsZXJhdGU6ICJkZWNlbGVyYXRlIiwKICAgICAgICAgIGRlc2NlbnQ6ICJkZXNjZW50IiwKICAgICAgICAgIGRpZmZ1c2Vjb25zdGFudDogImRpZmZ1c2VDb25zdGFudCIsCiAgICAgICAgICBkaXJlY3Rpb246ICJkaXJlY3Rpb24iLAogICAgICAgICAgZGlzcGxheTogImRpc3BsYXkiLAogICAgICAgICAgZGl2aXNvcjogImRpdmlzb3IiLAogICAgICAgICAgZG9taW5hbnRiYXNlbGluZTogImRvbWluYW50QmFzZWxpbmUiLAogICAgICAgICAgImRvbWluYW50LWJhc2VsaW5lIjogImRvbWluYW50QmFzZWxpbmUiLAogICAgICAgICAgZHVyOiAiZHVyIiwKICAgICAgICAgIGR4OiAiZHgiLAogICAgICAgICAgZHk6ICJkeSIsCiAgICAgICAgICBlZGdlbW9kZTogImVkZ2VNb2RlIiwKICAgICAgICAgIGVsZXZhdGlvbjogImVsZXZhdGlvbiIsCiAgICAgICAgICBlbmFibGViYWNrZ3JvdW5kOiAiZW5hYmxlQmFja2dyb3VuZCIsCiAgICAgICAgICAiZW5hYmxlLWJhY2tncm91bmQiOiAiZW5hYmxlQmFja2dyb3VuZCIsCiAgICAgICAgICBlbmQ6ICJlbmQiLAogICAgICAgICAgZXhwb25lbnQ6ICJleHBvbmVudCIsCiAgICAgICAgICBleHRlcm5hbHJlc291cmNlc3JlcXVpcmVkOiAiZXh0ZXJuYWxSZXNvdXJjZXNSZXF1aXJlZCIsCiAgICAgICAgICBmaWxsOiAiZmlsbCIsCiAgICAgICAgICBmaWxsb3BhY2l0eTogImZpbGxPcGFjaXR5IiwKICAgICAgICAgICJmaWxsLW9wYWNpdHkiOiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgZmlsbHJ1bGU6ICJmaWxsUnVsZSIsCiAgICAgICAgICAiZmlsbC1ydWxlIjogImZpbGxSdWxlIiwKICAgICAgICAgIGZpbHRlcjogImZpbHRlciIsCiAgICAgICAgICBmaWx0ZXJyZXM6ICJmaWx0ZXJSZXMiLAogICAgICAgICAgZmlsdGVydW5pdHM6ICJmaWx0ZXJVbml0cyIsCiAgICAgICAgICBmbG9vZG9wYWNpdHk6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgImZsb29kLW9wYWNpdHkiOiAiZmxvb2RPcGFjaXR5IiwKICAgICAgICAgIGZsb29kY29sb3I6ICJmbG9vZENvbG9yIiwKICAgICAgICAgICJmbG9vZC1jb2xvciI6ICJmbG9vZENvbG9yIiwKICAgICAgICAgIGZvY3VzYWJsZTogImZvY3VzYWJsZSIsCiAgICAgICAgICBmb250ZmFtaWx5OiAiZm9udEZhbWlseSIsCiAgICAgICAgICAiZm9udC1mYW1pbHkiOiAiZm9udEZhbWlseSIsCiAgICAgICAgICBmb250c2l6ZTogImZvbnRTaXplIiwKICAgICAgICAgICJmb250LXNpemUiOiAiZm9udFNpemUiLAogICAgICAgICAgZm9udHNpemVhZGp1c3Q6ICJmb250U2l6ZUFkanVzdCIsCiAgICAgICAgICAiZm9udC1zaXplLWFkanVzdCI6ICJmb250U2l6ZUFkanVzdCIsCiAgICAgICAgICBmb250c3RyZXRjaDogImZvbnRTdHJldGNoIiwKICAgICAgICAgICJmb250LXN0cmV0Y2giOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgZm9udHN0eWxlOiAiZm9udFN0eWxlIiwKICAgICAgICAgICJmb250LXN0eWxlIjogImZvbnRTdHlsZSIsCiAgICAgICAgICBmb250dmFyaWFudDogImZvbnRWYXJpYW50IiwKICAgICAgICAgICJmb250LXZhcmlhbnQiOiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgZm9udHdlaWdodDogImZvbnRXZWlnaHQiLAogICAgICAgICAgImZvbnQtd2VpZ2h0IjogImZvbnRXZWlnaHQiLAogICAgICAgICAgZm9ybWF0OiAiZm9ybWF0IiwKICAgICAgICAgIGZyb206ICJmcm9tIiwKICAgICAgICAgIGZ4OiAiZngiLAogICAgICAgICAgZnk6ICJmeSIsCiAgICAgICAgICBnMTogImcxIiwKICAgICAgICAgIGcyOiAiZzIiLAogICAgICAgICAgZ2x5cGhuYW1lOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgICJnbHlwaC1uYW1lIjogImdseXBoTmFtZSIsCiAgICAgICAgICBnbHlwaG9yaWVudGF0aW9uaG9yaXpvbnRhbDogImdseXBoT3JpZW50YXRpb25Ib3Jpem9udGFsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsIjogImdseXBoT3JpZW50YXRpb25Ib3Jpem9udGFsIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb252ZXJ0aWNhbDogImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24tdmVydGljYWwiOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgIGdseXBocmVmOiAiZ2x5cGhSZWYiLAogICAgICAgICAgZ3JhZGllbnR0cmFuc2Zvcm06ICJncmFkaWVudFRyYW5zZm9ybSIsCiAgICAgICAgICBncmFkaWVudHVuaXRzOiAiZ3JhZGllbnRVbml0cyIsCiAgICAgICAgICBoYW5naW5nOiAiaGFuZ2luZyIsCiAgICAgICAgICBob3JpemFkdng6ICJob3JpekFkdlgiLAogICAgICAgICAgImhvcml6LWFkdi14IjogImhvcml6QWR2WCIsCiAgICAgICAgICBob3Jpem9yaWdpbng6ICJob3Jpek9yaWdpblgiLAogICAgICAgICAgImhvcml6LW9yaWdpbi14IjogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICBpZGVvZ3JhcGhpYzogImlkZW9ncmFwaGljIiwKICAgICAgICAgIGltYWdlcmVuZGVyaW5nOiAiaW1hZ2VSZW5kZXJpbmciLAogICAgICAgICAgImltYWdlLXJlbmRlcmluZyI6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICBpbjI6ICJpbjIiLAogICAgICAgICAgaW46ICJpbiIsCiAgICAgICAgICBpbmxpc3Q6ICJpbmxpc3QiLAogICAgICAgICAgaW50ZXJjZXB0OiAiaW50ZXJjZXB0IiwKICAgICAgICAgIGsxOiAiazEiLAogICAgICAgICAgazI6ICJrMiIsCiAgICAgICAgICBrMzogImszIiwKICAgICAgICAgIGs0OiAiazQiLAogICAgICAgICAgazogImsiLAogICAgICAgICAga2VybmVsbWF0cml4OiAia2VybmVsTWF0cml4IiwKICAgICAgICAgIGtlcm5lbHVuaXRsZW5ndGg6ICJrZXJuZWxVbml0TGVuZ3RoIiwKICAgICAgICAgIGtlcm5pbmc6ICJrZXJuaW5nIiwKICAgICAgICAgIGtleXBvaW50czogImtleVBvaW50cyIsCiAgICAgICAgICBrZXlzcGxpbmVzOiAia2V5U3BsaW5lcyIsCiAgICAgICAgICBrZXl0aW1lczogImtleVRpbWVzIiwKICAgICAgICAgIGxlbmd0aGFkanVzdDogImxlbmd0aEFkanVzdCIsCiAgICAgICAgICBsZXR0ZXJzcGFjaW5nOiAibGV0dGVyU3BhY2luZyIsCiAgICAgICAgICAibGV0dGVyLXNwYWNpbmciOiAibGV0dGVyU3BhY2luZyIsCiAgICAgICAgICBsaWdodGluZ2NvbG9yOiAibGlnaHRpbmdDb2xvciIsCiAgICAgICAgICAibGlnaHRpbmctY29sb3IiOiAibGlnaHRpbmdDb2xvciIsCiAgICAgICAgICBsaW1pdGluZ2NvbmVhbmdsZTogImxpbWl0aW5nQ29uZUFuZ2xlIiwKICAgICAgICAgIGxvY2FsOiAibG9jYWwiLAogICAgICAgICAgbWFya2VyZW5kOiAibWFya2VyRW5kIiwKICAgICAgICAgICJtYXJrZXItZW5kIjogIm1hcmtlckVuZCIsCiAgICAgICAgICBtYXJrZXJoZWlnaHQ6ICJtYXJrZXJIZWlnaHQiLAogICAgICAgICAgbWFya2VybWlkOiAibWFya2VyTWlkIiwKICAgICAgICAgICJtYXJrZXItbWlkIjogIm1hcmtlck1pZCIsCiAgICAgICAgICBtYXJrZXJzdGFydDogIm1hcmtlclN0YXJ0IiwKICAgICAgICAgICJtYXJrZXItc3RhcnQiOiAibWFya2VyU3RhcnQiLAogICAgICAgICAgbWFya2VydW5pdHM6ICJtYXJrZXJVbml0cyIsCiAgICAgICAgICBtYXJrZXJ3aWR0aDogIm1hcmtlcldpZHRoIiwKICAgICAgICAgIG1hc2s6ICJtYXNrIiwKICAgICAgICAgIG1hc2tjb250ZW50dW5pdHM6ICJtYXNrQ29udGVudFVuaXRzIiwKICAgICAgICAgIG1hc2t1bml0czogIm1hc2tVbml0cyIsCiAgICAgICAgICBtYXRoZW1hdGljYWw6ICJtYXRoZW1hdGljYWwiLAogICAgICAgICAgbW9kZTogIm1vZGUiLAogICAgICAgICAgbnVtb2N0YXZlczogIm51bU9jdGF2ZXMiLAogICAgICAgICAgb2Zmc2V0OiAib2Zmc2V0IiwKICAgICAgICAgIG9wYWNpdHk6ICJvcGFjaXR5IiwKICAgICAgICAgIG9wZXJhdG9yOiAib3BlcmF0b3IiLAogICAgICAgICAgb3JkZXI6ICJvcmRlciIsCiAgICAgICAgICBvcmllbnQ6ICJvcmllbnQiLAogICAgICAgICAgb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIsCiAgICAgICAgICBvcmlnaW46ICJvcmlnaW4iLAogICAgICAgICAgb3ZlcmZsb3c6ICJvdmVyZmxvdyIsCiAgICAgICAgICBvdmVybGluZXBvc2l0aW9uOiAib3ZlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICAib3ZlcmxpbmUtcG9zaXRpb24iOiAib3ZlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICBvdmVybGluZXRoaWNrbmVzczogIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgICJvdmVybGluZS10aGlja25lc3MiOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgcGFpbnRvcmRlcjogInBhaW50T3JkZXIiLAogICAgICAgICAgInBhaW50LW9yZGVyIjogInBhaW50T3JkZXIiLAogICAgICAgICAgcGFub3NlMTogInBhbm9zZTEiLAogICAgICAgICAgInBhbm9zZS0xIjogInBhbm9zZTEiLAogICAgICAgICAgcGF0aGxlbmd0aDogInBhdGhMZW5ndGgiLAogICAgICAgICAgcGF0dGVybmNvbnRlbnR1bml0czogInBhdHRlcm5Db250ZW50VW5pdHMiLAogICAgICAgICAgcGF0dGVybnRyYW5zZm9ybTogInBhdHRlcm5UcmFuc2Zvcm0iLAogICAgICAgICAgcGF0dGVybnVuaXRzOiAicGF0dGVyblVuaXRzIiwKICAgICAgICAgIHBvaW50ZXJldmVudHM6ICJwb2ludGVyRXZlbnRzIiwKICAgICAgICAgICJwb2ludGVyLWV2ZW50cyI6ICJwb2ludGVyRXZlbnRzIiwKICAgICAgICAgIHBvaW50czogInBvaW50cyIsCiAgICAgICAgICBwb2ludHNhdHg6ICJwb2ludHNBdFgiLAogICAgICAgICAgcG9pbnRzYXR5OiAicG9pbnRzQXRZIiwKICAgICAgICAgIHBvaW50c2F0ejogInBvaW50c0F0WiIsCiAgICAgICAgICBwcmVmaXg6ICJwcmVmaXgiLAogICAgICAgICAgcHJlc2VydmVhbHBoYTogInByZXNlcnZlQWxwaGEiLAogICAgICAgICAgcHJlc2VydmVhc3BlY3RyYXRpbzogInByZXNlcnZlQXNwZWN0UmF0aW8iLAogICAgICAgICAgcHJpbWl0aXZldW5pdHM6ICJwcmltaXRpdmVVbml0cyIsCiAgICAgICAgICBwcm9wZXJ0eTogInByb3BlcnR5IiwKICAgICAgICAgIHI6ICJyIiwKICAgICAgICAgIHJhZGl1czogInJhZGl1cyIsCiAgICAgICAgICByZWZ4OiAicmVmWCIsCiAgICAgICAgICByZWZ5OiAicmVmWSIsCiAgICAgICAgICByZW5kZXJpbmdpbnRlbnQ6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgInJlbmRlcmluZy1pbnRlbnQiOiAicmVuZGVyaW5nSW50ZW50IiwKICAgICAgICAgIHJlcGVhdGNvdW50OiAicmVwZWF0Q291bnQiLAogICAgICAgICAgcmVwZWF0ZHVyOiAicmVwZWF0RHVyIiwKICAgICAgICAgIHJlcXVpcmVkZXh0ZW5zaW9uczogInJlcXVpcmVkRXh0ZW5zaW9ucyIsCiAgICAgICAgICByZXF1aXJlZGZlYXR1cmVzOiAicmVxdWlyZWRGZWF0dXJlcyIsCiAgICAgICAgICByZXNvdXJjZTogInJlc291cmNlIiwKICAgICAgICAgIHJlc3RhcnQ6ICJyZXN0YXJ0IiwKICAgICAgICAgIHJlc3VsdDogInJlc3VsdCIsCiAgICAgICAgICByZXN1bHRzOiAicmVzdWx0cyIsCiAgICAgICAgICByb3RhdGU6ICJyb3RhdGUiLAogICAgICAgICAgcng6ICJyeCIsCiAgICAgICAgICByeTogInJ5IiwKICAgICAgICAgIHNjYWxlOiAic2NhbGUiLAogICAgICAgICAgc2VjdXJpdHk6ICJzZWN1cml0eSIsCiAgICAgICAgICBzZWVkOiAic2VlZCIsCiAgICAgICAgICBzaGFwZXJlbmRlcmluZzogInNoYXBlUmVuZGVyaW5nIiwKICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgc2xvcGU6ICJzbG9wZSIsCiAgICAgICAgICBzcGFjaW5nOiAic3BhY2luZyIsCiAgICAgICAgICBzcGVjdWxhcmNvbnN0YW50OiAic3BlY3VsYXJDb25zdGFudCIsCiAgICAgICAgICBzcGVjdWxhcmV4cG9uZW50OiAic3BlY3VsYXJFeHBvbmVudCIsCiAgICAgICAgICBzcGVlZDogInNwZWVkIiwKICAgICAgICAgIHNwcmVhZG1ldGhvZDogInNwcmVhZE1ldGhvZCIsCiAgICAgICAgICBzdGFydG9mZnNldDogInN0YXJ0T2Zmc2V0IiwKICAgICAgICAgIHN0ZGRldmlhdGlvbjogInN0ZERldmlhdGlvbiIsCiAgICAgICAgICBzdGVtaDogInN0ZW1oIiwKICAgICAgICAgIHN0ZW12OiAic3RlbXYiLAogICAgICAgICAgc3RpdGNodGlsZXM6ICJzdGl0Y2hUaWxlcyIsCiAgICAgICAgICBzdG9wY29sb3I6ICJzdG9wQ29sb3IiLAogICAgICAgICAgInN0b3AtY29sb3IiOiAic3RvcENvbG9yIiwKICAgICAgICAgIHN0b3BvcGFjaXR5OiAic3RvcE9wYWNpdHkiLAogICAgICAgICAgInN0b3Atb3BhY2l0eSI6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICBzdHJpa2V0aHJvdWdocG9zaXRpb246ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtcG9zaXRpb24iOiAic3RyaWtldGhyb3VnaFBvc2l0aW9uIiwKICAgICAgICAgIHN0cmlrZXRocm91Z2h0aGlja25lc3M6ICJzdHJpa2V0aHJvdWdoVGhpY2tuZXNzIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXRoaWNrbmVzcyI6ICJzdHJpa2V0aHJvdWdoVGhpY2tuZXNzIiwKICAgICAgICAgIHN0cmluZzogInN0cmluZyIsCiAgICAgICAgICBzdHJva2U6ICJzdHJva2UiLAogICAgICAgICAgc3Ryb2tlZGFzaGFycmF5OiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgICJzdHJva2UtZGFzaGFycmF5IjogInN0cm9rZURhc2hhcnJheSIsCiAgICAgICAgICBzdHJva2VkYXNob2Zmc2V0OiAic3Ryb2tlRGFzaG9mZnNldCIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hvZmZzZXQiOiAic3Ryb2tlRGFzaG9mZnNldCIsCiAgICAgICAgICBzdHJva2VsaW5lY2FwOiAic3Ryb2tlTGluZWNhcCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVjYXAiOiAic3Ryb2tlTGluZWNhcCIsCiAgICAgICAgICBzdHJva2VsaW5lam9pbjogInN0cm9rZUxpbmVqb2luIiwKICAgICAgICAgICJzdHJva2UtbGluZWpvaW4iOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgc3Ryb2tlbWl0ZXJsaW1pdDogInN0cm9rZU1pdGVybGltaXQiLAogICAgICAgICAgInN0cm9rZS1taXRlcmxpbWl0IjogInN0cm9rZU1pdGVybGltaXQiLAogICAgICAgICAgc3Ryb2tld2lkdGg6ICJzdHJva2VXaWR0aCIsCiAgICAgICAgICAic3Ryb2tlLXdpZHRoIjogInN0cm9rZVdpZHRoIiwKICAgICAgICAgIHN0cm9rZW9wYWNpdHk6ICJzdHJva2VPcGFjaXR5IiwKICAgICAgICAgICJzdHJva2Utb3BhY2l0eSI6ICJzdHJva2VPcGFjaXR5IiwKICAgICAgICAgIHN1cHByZXNzY29udGVudGVkaXRhYmxld2FybmluZzogInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyIsCiAgICAgICAgICBzdXBwcmVzc2h5ZHJhdGlvbndhcm5pbmc6ICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciLAogICAgICAgICAgc3VyZmFjZXNjYWxlOiAic3VyZmFjZVNjYWxlIiwKICAgICAgICAgIHN5c3RlbWxhbmd1YWdlOiAic3lzdGVtTGFuZ3VhZ2UiLAogICAgICAgICAgdGFibGV2YWx1ZXM6ICJ0YWJsZVZhbHVlcyIsCiAgICAgICAgICB0YXJnZXR4OiAidGFyZ2V0WCIsCiAgICAgICAgICB0YXJnZXR5OiAidGFyZ2V0WSIsCiAgICAgICAgICB0ZXh0YW5jaG9yOiAidGV4dEFuY2hvciIsCiAgICAgICAgICAidGV4dC1hbmNob3IiOiAidGV4dEFuY2hvciIsCiAgICAgICAgICB0ZXh0ZGVjb3JhdGlvbjogInRleHREZWNvcmF0aW9uIiwKICAgICAgICAgICJ0ZXh0LWRlY29yYXRpb24iOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgdGV4dGxlbmd0aDogInRleHRMZW5ndGgiLAogICAgICAgICAgdGV4dHJlbmRlcmluZzogInRleHRSZW5kZXJpbmciLAogICAgICAgICAgInRleHQtcmVuZGVyaW5nIjogInRleHRSZW5kZXJpbmciLAogICAgICAgICAgdG86ICJ0byIsCiAgICAgICAgICB0cmFuc2Zvcm06ICJ0cmFuc2Zvcm0iLAogICAgICAgICAgdHlwZW9mOiAidHlwZW9mIiwKICAgICAgICAgIHUxOiAidTEiLAogICAgICAgICAgdTI6ICJ1MiIsCiAgICAgICAgICB1bmRlcmxpbmVwb3NpdGlvbjogInVuZGVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJ1bmRlcmxpbmUtcG9zaXRpb24iOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgdW5kZXJsaW5ldGhpY2tuZXNzOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgICJ1bmRlcmxpbmUtdGhpY2tuZXNzIjogInVuZGVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICB1bmljb2RlOiAidW5pY29kZSIsCiAgICAgICAgICB1bmljb2RlYmlkaTogInVuaWNvZGVCaWRpIiwKICAgICAgICAgICJ1bmljb2RlLWJpZGkiOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgdW5pY29kZXJhbmdlOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgICJ1bmljb2RlLXJhbmdlIjogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICB1bml0c3BlcmVtOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICAidW5pdHMtcGVyLWVtIjogInVuaXRzUGVyRW0iLAogICAgICAgICAgdW5zZWxlY3RhYmxlOiAidW5zZWxlY3RhYmxlIiwKICAgICAgICAgIHZhbHBoYWJldGljOiAidkFscGhhYmV0aWMiLAogICAgICAgICAgInYtYWxwaGFiZXRpYyI6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICB2YWx1ZXM6ICJ2YWx1ZXMiLAogICAgICAgICAgdmVjdG9yZWZmZWN0OiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgICJ2ZWN0b3ItZWZmZWN0IjogInZlY3RvckVmZmVjdCIsCiAgICAgICAgICB2ZXJzaW9uOiAidmVyc2lvbiIsCiAgICAgICAgICB2ZXJ0YWR2eTogInZlcnRBZHZZIiwKICAgICAgICAgICJ2ZXJ0LWFkdi15IjogInZlcnRBZHZZIiwKICAgICAgICAgIHZlcnRvcmlnaW54OiAidmVydE9yaWdpblgiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXgiOiAidmVydE9yaWdpblgiLAogICAgICAgICAgdmVydG9yaWdpbnk6ICJ2ZXJ0T3JpZ2luWSIsCiAgICAgICAgICAidmVydC1vcmlnaW4teSI6ICJ2ZXJ0T3JpZ2luWSIsCiAgICAgICAgICB2aGFuZ2luZzogInZIYW5naW5nIiwKICAgICAgICAgICJ2LWhhbmdpbmciOiAidkhhbmdpbmciLAogICAgICAgICAgdmlkZW9ncmFwaGljOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgICJ2LWlkZW9ncmFwaGljIjogInZJZGVvZ3JhcGhpYyIsCiAgICAgICAgICB2aWV3Ym94OiAidmlld0JveCIsCiAgICAgICAgICB2aWV3dGFyZ2V0OiAidmlld1RhcmdldCIsCiAgICAgICAgICB2aXNpYmlsaXR5OiAidmlzaWJpbGl0eSIsCiAgICAgICAgICB2bWF0aGVtYXRpY2FsOiAidk1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAidi1tYXRoZW1hdGljYWwiOiAidk1hdGhlbWF0aWNhbCIsCiAgICAgICAgICB2b2NhYjogInZvY2FiIiwKICAgICAgICAgIHdpZHRoczogIndpZHRocyIsCiAgICAgICAgICB3b3Jkc3BhY2luZzogIndvcmRTcGFjaW5nIiwKICAgICAgICAgICJ3b3JkLXNwYWNpbmciOiAid29yZFNwYWNpbmciLAogICAgICAgICAgd3JpdGluZ21vZGU6ICJ3cml0aW5nTW9kZSIsCiAgICAgICAgICAid3JpdGluZy1tb2RlIjogIndyaXRpbmdNb2RlIiwKICAgICAgICAgIHgxOiAieDEiLAogICAgICAgICAgeDI6ICJ4MiIsCiAgICAgICAgICB4OiAieCIsCiAgICAgICAgICB4Y2hhbm5lbHNlbGVjdG9yOiAieENoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB4aGVpZ2h0OiAieEhlaWdodCIsCiAgICAgICAgICAieC1oZWlnaHQiOiAieEhlaWdodCIsCiAgICAgICAgICB4bGlua2FjdHVhdGU6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgInhsaW5rOmFjdHVhdGUiOiAieGxpbmtBY3R1YXRlIiwKICAgICAgICAgIHhsaW5rYXJjcm9sZTogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICAieGxpbms6YXJjcm9sZSI6ICJ4bGlua0FyY3JvbGUiLAogICAgICAgICAgeGxpbmtocmVmOiAieGxpbmtIcmVmIiwKICAgICAgICAgICJ4bGluazpocmVmIjogInhsaW5rSHJlZiIsCiAgICAgICAgICB4bGlua3JvbGU6ICJ4bGlua1JvbGUiLAogICAgICAgICAgInhsaW5rOnJvbGUiOiAieGxpbmtSb2xlIiwKICAgICAgICAgIHhsaW5rc2hvdzogInhsaW5rU2hvdyIsCiAgICAgICAgICAieGxpbms6c2hvdyI6ICJ4bGlua1Nob3ciLAogICAgICAgICAgeGxpbmt0aXRsZTogInhsaW5rVGl0bGUiLAogICAgICAgICAgInhsaW5rOnRpdGxlIjogInhsaW5rVGl0bGUiLAogICAgICAgICAgeGxpbmt0eXBlOiAieGxpbmtUeXBlIiwKICAgICAgICAgICJ4bGluazp0eXBlIjogInhsaW5rVHlwZSIsCiAgICAgICAgICB4bWxiYXNlOiAieG1sQmFzZSIsCiAgICAgICAgICAieG1sOmJhc2UiOiAieG1sQmFzZSIsCiAgICAgICAgICB4bWxsYW5nOiAieG1sTGFuZyIsCiAgICAgICAgICAieG1sOmxhbmciOiAieG1sTGFuZyIsCiAgICAgICAgICB4bWxuczogInhtbG5zIiwKICAgICAgICAgICJ4bWw6c3BhY2UiOiAieG1sU3BhY2UiLAogICAgICAgICAgeG1sbnN4bGluazogInhtbG5zWGxpbmsiLAogICAgICAgICAgInhtbG5zOnhsaW5rIjogInhtbG5zWGxpbmsiLAogICAgICAgICAgeG1sc3BhY2U6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB5MTogInkxIiwKICAgICAgICAgIHkyOiAieTIiLAogICAgICAgICAgeTogInkiLAogICAgICAgICAgeWNoYW5uZWxzZWxlY3RvcjogInlDaGFubmVsU2VsZWN0b3IiLAogICAgICAgICAgejogInoiLAogICAgICAgICAgem9vbWFuZHBhbjogInpvb21BbmRQYW4iCiAgICAgICAgfTsKICAgICAgICB2YXIgYXJpYVByb3BlcnRpZXMgPSB7CiAgICAgICAgICAiYXJpYS1jdXJyZW50IjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1kZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1kZXRhaWxzIjogMCwKICAgICAgICAgICJhcmlhLWRpc2FibGVkIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1oaWRkZW4iOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWludmFsaWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWtleXNob3J0Y3V0cyI6IDAsCiAgICAgICAgICAiYXJpYS1sYWJlbCI6IDAsCiAgICAgICAgICAiYXJpYS1yb2xlZGVzY3JpcHRpb24iOiAwLAogICAgICAgICAgLy8gV2lkZ2V0IEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF1dG9jb21wbGV0ZSI6IDAsCiAgICAgICAgICAiYXJpYS1jaGVja2VkIjogMCwKICAgICAgICAgICJhcmlhLWV4cGFuZGVkIjogMCwKICAgICAgICAgICJhcmlhLWhhc3BvcHVwIjogMCwKICAgICAgICAgICJhcmlhLWxldmVsIjogMCwKICAgICAgICAgICJhcmlhLW1vZGFsIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpbGluZSI6IDAsCiAgICAgICAgICAiYXJpYS1tdWx0aXNlbGVjdGFibGUiOiAwLAogICAgICAgICAgImFyaWEtb3JpZW50YXRpb24iOiAwLAogICAgICAgICAgImFyaWEtcGxhY2Vob2xkZXIiOiAwLAogICAgICAgICAgImFyaWEtcHJlc3NlZCI6IDAsCiAgICAgICAgICAiYXJpYS1yZWFkb25seSI6IDAsCiAgICAgICAgICAiYXJpYS1yZXF1aXJlZCI6IDAsCiAgICAgICAgICAiYXJpYS1zZWxlY3RlZCI6IDAsCiAgICAgICAgICAiYXJpYS1zb3J0IjogMCwKICAgICAgICAgICJhcmlhLXZhbHVlbWF4IjogMCwKICAgICAgICAgICJhcmlhLXZhbHVlbWluIjogMCwKICAgICAgICAgICJhcmlhLXZhbHVlbm93IjogMCwKICAgICAgICAgICJhcmlhLXZhbHVldGV4dCI6IDAsCiAgICAgICAgICAvLyBMaXZlIFJlZ2lvbiBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1hdG9taWMiOiAwLAogICAgICAgICAgImFyaWEtYnVzeSI6IDAsCiAgICAgICAgICAiYXJpYS1saXZlIjogMCwKICAgICAgICAgICJhcmlhLXJlbGV2YW50IjogMCwKICAgICAgICAgIC8vIERyYWctYW5kLURyb3AgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtZHJvcGVmZmVjdCI6IDAsCiAgICAgICAgICAiYXJpYS1ncmFiYmVkIjogMCwKICAgICAgICAgIC8vIFJlbGF0aW9uc2hpcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IjogMCwKICAgICAgICAgICJhcmlhLWNvbGNvdW50IjogMCwKICAgICAgICAgICJhcmlhLWNvbGluZGV4IjogMCwKICAgICAgICAgICJhcmlhLWNvbHNwYW4iOiAwLAogICAgICAgICAgImFyaWEtY29udHJvbHMiOiAwLAogICAgICAgICAgImFyaWEtZGVzY3JpYmVkYnkiOiAwLAogICAgICAgICAgImFyaWEtZXJyb3JtZXNzYWdlIjogMCwKICAgICAgICAgICJhcmlhLWZsb3d0byI6IDAsCiAgICAgICAgICAiYXJpYS1sYWJlbGxlZGJ5IjogMCwKICAgICAgICAgICJhcmlhLW93bnMiOiAwLAogICAgICAgICAgImFyaWEtcG9zaW5zZXQiOiAwLAogICAgICAgICAgImFyaWEtcm93Y291bnQiOiAwLAogICAgICAgICAgImFyaWEtcm93aW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtcm93c3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1zZXRzaXplIjogMAogICAgICAgIH07CiAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMgPSB7fTsKICAgICAgICB2YXIgckFSSUEgPSBuZXcgUmVnRXhwKCJeKGFyaWEpLVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICB2YXIgckFSSUFDYW1lbCA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnR5KHRhZ05hbWUsIG5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwod2FybmVkUHJvcGVydGllcywgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllc1tuYW1lXSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQUNhbWVsLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgYXJpYU5hbWUgPSAiYXJpYS0iICsgbmFtZS5zbGljZSg0KS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBjb3JyZWN0TmFtZSA9IGFyaWFQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGFyaWFOYW1lKSA/IGFyaWFOYW1lIDogbnVsbDsKICAgICAgICAgICAgICBpZiAoY29ycmVjdE5hbWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gQVJJQSBhdHRyaWJ1dGVzIGZvbGxvdyB0aGUgcGF0dGVybiBhcmlhLSogYW5kIG11c3QgYmUgbG93ZXJjYXNlLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IGNvcnJlY3ROYW1lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBjb3JyZWN0TmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpID8gbG93ZXJDYXNlZE5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuYW1lICE9PSBzdGFuZGFyZE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JbnZhbGlkQVJJQVByb3BzKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnZhbGlkUHJvcHMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB2YWxpZGF0ZVByb3BlcnR5KHR5cGUsIGtleSk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpbnZhbGlkUHJvcHMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdW5rbm93blByb3BTdHJpbmcgPSBpbnZhbGlkUHJvcHMubWFwKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gImAiICsgcHJvcCArICJgIjsKICAgICAgICAgICAgfSkuam9pbigiLCAiKTsKICAgICAgICAgICAgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhcmlhIHByb3AgJXMgb24gPCVzPiB0YWcuIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2ludmFsaWQtYXJpYS1wcm9wcyIsIHVua25vd25Qcm9wU3RyaW5nLCB0eXBlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnZhbGlkUHJvcHMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcHMgJXMgb24gPCVzPiB0YWcuIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2ludmFsaWQtYXJpYS1wcm9wcyIsIHVua25vd25Qcm9wU3RyaW5nLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudCh0eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbHVlTnVsbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQxKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlICE9PSAiaW5wdXQiICYmIHR5cGUgIT09ICJ0ZXh0YXJlYSIgJiYgdHlwZSAhPT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzICE9IG51bGwgJiYgcHJvcHMudmFsdWUgPT09IG51bGwgJiYgIWRpZFdhcm5WYWx1ZU51bGwpIHsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVOdWxsID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInNlbGVjdCIgJiYgcHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IGFycmF5IHdoZW4gYG11bHRpcGxlYCBpcyBzZXQgdG8gYHRydWVgIHRvIGNsZWFyIHRoZSBjb21wb25lbnQgb3IgYHVuZGVmaW5lZGAgZm9yIHVuY29udHJvbGxlZCBjb21wb25lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiYHZhbHVlYCBwcm9wIG9uIGAlc2Agc2hvdWxkIG5vdCBiZSBudWxsLiBDb25zaWRlciB1c2luZyBhbiBlbXB0eSBzdHJpbmcgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWxpZGF0ZVByb3BlcnR5JDEgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciB3YXJuZWRQcm9wZXJ0aWVzJDEgPSB7fTsKICAgICAgICAgIHZhciBFVkVOVF9OQU1FX1JFR0VYID0gL15vbi4vOwogICAgICAgICAgdmFyIElOVkFMSURfRVZFTlRfTkFNRV9SRUdFWCA9IC9eb25bXkEtWl0vOwogICAgICAgICAgdmFyIHJBUklBJDEgPSBuZXcgUmVnRXhwKCJeKGFyaWEpLVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhciByQVJJQUNhbWVsJDEgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICB2YWxpZGF0ZVByb3BlcnR5JDEgPSBmdW5jdGlvbih0YWdOYW1lLCBuYW1lLCB2YWx1ZSwgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzJDEsIG5hbWUpICYmIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c2luIiB8fCBsb3dlckNhc2VkTmFtZSA9PT0gIm9uZm9jdXNvdXQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IHVzZXMgb25Gb2N1cyBhbmQgb25CbHVyIGluc3RlYWQgb2Ygb25Gb2N1c0luIGFuZCBvbkZvY3VzT3V0LiBBbGwgUmVhY3QgZXZlbnRzIGFyZSBub3JtYWxpemVkIHRvIGJ1YmJsZSwgc28gb25Gb2N1c0luIGFuZCBvbkZvY3VzT3V0IGFyZSBub3QgbmVlZGVkL3N1cHBvcnRlZCBieSBSZWFjdC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChldmVudFJlZ2lzdHJ5ICE9IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llczIgPSBldmVudFJlZ2lzdHJ5LnJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMsIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyID0gZXZlbnRSZWdpc3RyeS5wb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMi5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lID0gcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpID8gcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczJbbG93ZXJDYXNlZE5hbWVdIDogbnVsbDsKICAgICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBldmVudCBoYW5kbGVyIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoRVZFTlRfTkFNRV9SRUdFWC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVW5rbm93biBldmVudCBoYW5kbGVyIHByb3BlcnR5IGAlc2AuIEl0IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRVZFTlRfTkFNRV9SRUdFWC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgaWYgKElOVkFMSURfRVZFTlRfTkFNRV9SRUdFWC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBldmVudCBoYW5kbGVyIHByb3BlcnR5IGAlc2AuIFJlYWN0IGV2ZW50cyB1c2UgdGhlIGNhbWVsQ2FzZSBuYW1pbmcgY29udmVudGlvbiwgZm9yIGV4YW1wbGUgYG9uQ2xpY2tgLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQSQxLnRlc3QobmFtZSkgfHwgckFSSUFDYW1lbCQxLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpbm5lcmh0bWwiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkRpcmVjdGx5IHNldHRpbmcgcHJvcGVydHkgYGlubmVySFRNTGAgaXMgbm90IHBlcm1pdHRlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIGxvb2t1cCBkb2N1bWVudGF0aW9uIG9uIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJhcmlhIikgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgYGFyaWFgIGF0dHJpYnV0ZSBpcyByZXNlcnZlZCBmb3IgZnV0dXJlIHVzZSBpbiBSZWFjdC4gUGFzcyBpbmRpdmlkdWFsIGBhcmlhLWAgYXR0cmlidXRlcyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiaXMiICYmIHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB2b2lkIDAgJiYgdHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhIGAlc2AgZm9yIGEgc3RyaW5nIGF0dHJpYnV0ZSBgaXNgLiBJZiB0aGlzIGlzIGV4cGVjdGVkLCBjYXN0IHRoZSB2YWx1ZSB0byBhIHN0cmluZy4iLCB0eXBlb2YgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIE5hTiBmb3IgdGhlIGAlc2AgYXR0cmlidXRlLiBJZiB0aGlzIGlzIGV4cGVjdGVkLCBjYXN0IHRoZSB2YWx1ZSB0byBhIHN0cmluZy4iLCBuYW1lKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICAgIHZhciBpc1Jlc2VydmVkID0gcHJvcGVydHlJbmZvICE9PSBudWxsICYmIHByb3BlcnR5SW5mby50eXBlID09PSBSRVNFUlZFRDsKICAgICAgICAgICAgaWYgKHBvc3NpYmxlU3RhbmRhcmROYW1lcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gcG9zc2libGVTdGFuZGFyZE5hbWVzW2xvd2VyQ2FzZWROYW1lXTsKICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lICE9PSBuYW1lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBET00gcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzUmVzZXJ2ZWQgJiYgbmFtZSAhPT0gbG93ZXJDYXNlZE5hbWUpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgZG9lcyBub3QgcmVjb2duaXplIHRoZSBgJXNgIHByb3Agb24gYSBET00gZWxlbWVudC4gSWYgeW91IGludGVudGlvbmFsbHkgd2FudCBpdCB0byBhcHBlYXIgaW4gdGhlIERPTSBhcyBhIGN1c3RvbSBhdHRyaWJ1dGUsIHNwZWxsIGl0IGFzIGxvd2VyY2FzZSBgJXNgIGluc3RlYWQuIElmIHlvdSBhY2NpZGVudGFsbHkgcGFzc2VkIGl0IGZyb20gYSBwYXJlbnQgY29tcG9uZW50LCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIGVsZW1lbnQuIiwgbmFtZSwgbG93ZXJDYXNlZE5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gImJvb2xlYW4iICYmIHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ1JlY2VpdmVkIGAlc2AgZm9yIGEgbm9uLWJvb2xlYW4gYXR0cmlidXRlIGAlc2AuXG5cbklmIHlvdSB3YW50IHRvIHdyaXRlIGl0IHRvIHRoZSBET00sIHBhc3MgYSBzdHJpbmcgaW5zdGVhZDogJXM9IiVzIiBvciAlcz17dmFsdWUudG9TdHJpbmcoKX0uJywgdmFsdWUsIG5hbWUsIG5hbWUsIHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoJ1JlY2VpdmVkIGAlc2AgZm9yIGEgbm9uLWJvb2xlYW4gYXR0cmlidXRlIGAlc2AuXG5cbklmIHlvdSB3YW50IHRvIHdyaXRlIGl0IHRvIHRoZSBET00sIHBhc3MgYSBzdHJpbmcgaW5zdGVhZDogJXM9IiVzIiBvciAlcz17dmFsdWUudG9TdHJpbmcoKX0uXG5cbklmIHlvdSB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgb21pdCBpdCB3aXRoICVzPXtjb25kaXRpb24gJiYgdmFsdWV9LCBwYXNzICVzPXtjb25kaXRpb24gPyB2YWx1ZSA6IHVuZGVmaW5lZH0gaW5zdGVhZC4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1Jlc2VydmVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgodmFsdWUgPT09ICJmYWxzZSIgfHwgdmFsdWUgPT09ICJ0cnVlIikgJiYgcHJvcGVydHlJbmZvICE9PSBudWxsICYmIHByb3BlcnR5SW5mby50eXBlID09PSBCT09MRUFOKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIHRoZSBzdHJpbmcgYCVzYCBmb3IgdGhlIGJvb2xlYW4gYXR0cmlidXRlIGAlc2AuICVzIERpZCB5b3UgbWVhbiAlcz17JXN9PyIsIHZhbHVlLCBuYW1lLCB2YWx1ZSA9PT0gImZhbHNlIiA/ICJUaGUgYnJvd3NlciB3aWxsIGludGVycHJldCBpdCBhcyBhIHRydXRoeSB2YWx1ZS4iIDogJ0FsdGhvdWdoIHRoaXMgd29ya3MsIGl0IHdpbGwgbm90IHdvcmsgYXMgZXhwZWN0ZWQgaWYgeW91IHBhc3MgdGhlIHN0cmluZyAiZmFsc2UiLicsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIHdhcm5Vbmtub3duUHJvcGVydGllcyA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcHMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB2YWxpZGF0ZVByb3BlcnR5JDEodHlwZSwga2V5LCBwcm9wc1trZXldLCBldmVudFJlZ2lzdHJ5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIHVua25vd25Qcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IHVua25vd25Qcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAodW5rbm93blByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHZhbHVlIGZvciBwcm9wICVzIG9uIDwlcz4gdGFnLiBFaXRoZXIgcmVtb3ZlIGl0IGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgaXQgaW4gdGhlIERPTS4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvYXR0cmlidXRlLWJlaGF2aW9yICIsIHVua25vd25Qcm9wU3RyaW5nLCB0eXBlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHZhbHVlcyBmb3IgcHJvcHMgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgdGhlbSBmcm9tIHRoZSBlbGVtZW50LCBvciBwYXNzIGEgc3RyaW5nIG9yIG51bWJlciB2YWx1ZSB0byBrZWVwIHRoZW0gaW4gdGhlIERPTS4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvYXR0cmlidXRlLWJlaGF2aW9yICIsIHVua25vd25Qcm9wU3RyaW5nLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDIodHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudCh0eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgd2FyblVua25vd25Qcm9wZXJ0aWVzKHR5cGUsIHByb3BzLCBldmVudFJlZ2lzdHJ5KTsKICAgICAgICB9CiAgICAgICAgdmFyIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFID0gMTsKICAgICAgICB2YXIgSVNfTk9OX0RFTEVHQVRFRCA9IDEgPDwgMTsKICAgICAgICB2YXIgSVNfQ0FQVFVSRV9QSEFTRSA9IDEgPDwgMjsKICAgICAgICB2YXIgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMgPSBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSB8IElTX05PTl9ERUxFR0FURUQgfCBJU19DQVBUVVJFX1BIQVNFOwogICAgICAgIHZhciBjdXJyZW50UmVwbGF5aW5nRXZlbnQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNldFJlcGxheWluZ0V2ZW50KGV2ZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgY3VycmVudGx5IHJlcGxheWluZyBldmVudCB0byBiZSBudWxsLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50UmVwbGF5aW5nRXZlbnQgPSBldmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRSZXBsYXlpbmdFdmVudCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIG5vdCBiZSBudWxsLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50UmVwbGF5aW5nRXZlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlcGxheWluZ0V2ZW50KGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnQgPT09IGN1cnJlbnRSZXBsYXlpbmdFdmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBuYXRpdmVFdmVudC50YXJnZXQgfHwgbmF0aXZlRXZlbnQuc3JjRWxlbWVudCB8fCB3aW5kb3c7CiAgICAgICAgICBpZiAodGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50KSB7CiAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5jb3JyZXNwb25kaW5nVXNlRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0YXJnZXQubm9kZVR5cGUgPT09IFRFWFRfTk9ERSA/IHRhcmdldC5wYXJlbnROb2RlIDogdGFyZ2V0OwogICAgICAgIH0KICAgICAgICB2YXIgcmVzdG9yZUltcGwgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlVGFyZ2V0ID0gbnVsbDsKICAgICAgICB2YXIgcmVzdG9yZVF1ZXVlID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgIHZhciBpbnRlcm5hbEluc3RhbmNlID0gZ2V0SW5zdGFuY2VGcm9tTm9kZSh0YXJnZXQpOwogICAgICAgICAgaWYgKCFpbnRlcm5hbEluc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcmVzdG9yZUltcGwgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oKSBuZWVkcyB0byBiZSBjYWxsZWQgdG8gaGFuZGxlIGEgdGFyZ2V0IGZvciBjb250cm9sbGVkIGV2ZW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUpIHsKICAgICAgICAgICAgdmFyIF9wcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUoc3RhdGVOb2RlKTsKICAgICAgICAgICAgcmVzdG9yZUltcGwoaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZU5vZGUsIGludGVybmFsSW5zdGFuY2UudHlwZSwgX3Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKGltcGwpIHsKICAgICAgICAgIHJlc3RvcmVJbXBsID0gaW1wbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVN0YXRlUmVzdG9yZSh0YXJnZXQpIHsKICAgICAgICAgIGlmIChyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgIGlmIChyZXN0b3JlUXVldWUpIHsKICAgICAgICAgICAgICByZXN0b3JlUXVldWUucHVzaCh0YXJnZXQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZSA9IFt0YXJnZXRdOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN0b3JlVGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBuZWVkc1N0YXRlUmVzdG9yZSgpIHsKICAgICAgICAgIHJldHVybiByZXN0b3JlVGFyZ2V0ICE9PSBudWxsIHx8IHJlc3RvcmVRdWV1ZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN0YXRlSWZOZWVkZWQoKSB7CiAgICAgICAgICBpZiAoIXJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhcmdldCA9IHJlc3RvcmVUYXJnZXQ7CiAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0cyA9IHJlc3RvcmVRdWV1ZTsKICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVF1ZXVlID0gbnVsbDsKICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICBpZiAocXVldWVkVGFyZ2V0cykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlZFRhcmdldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldChxdWV1ZWRUYXJnZXRzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYmF0Y2hlZFVwZGF0ZXNJbXBsID0gZnVuY3Rpb24oZm4sIGJvb2trZWVwaW5nKSB7CiAgICAgICAgICByZXR1cm4gZm4oYm9va2tlZXBpbmcpOwogICAgICAgIH07CiAgICAgICAgdmFyIGZsdXNoU3luY0ltcGwgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHZhciBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGZpbmlzaEV2ZW50SGFuZGxlcigpIHsKICAgICAgICAgIHZhciBjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcyA9IG5lZWRzU3RhdGVSZXN0b3JlKCk7CiAgICAgICAgICBpZiAoY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMpIHsKICAgICAgICAgICAgZmx1c2hTeW5jSW1wbCgpOwogICAgICAgICAgICByZXN0b3JlU3RhdGVJZk5lZWRlZCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXRjaGVkVXBkYXRlcyhmbiwgYSwgYikgewogICAgICAgICAgaWYgKGlzSW5zaWRlRXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gdHJ1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBiYXRjaGVkVXBkYXRlc0ltcGwoZm4sIGEsIGIpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSBmYWxzZTsKICAgICAgICAgICAgZmluaXNoRXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oX2JhdGNoZWRVcGRhdGVzSW1wbCwgX2Rpc2NyZXRlVXBkYXRlc0ltcGwsIF9mbHVzaFN5bmNJbXBsKSB7CiAgICAgICAgICBiYXRjaGVkVXBkYXRlc0ltcGwgPSBfYmF0Y2hlZFVwZGF0ZXNJbXBsOwogICAgICAgICAgZmx1c2hTeW5jSW1wbCA9IF9mbHVzaFN5bmNJbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ludGVyYWN0aXZlKHRhZykgewogICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImJ1dHRvbiIgfHwgdGFnID09PSAiaW5wdXQiIHx8IHRhZyA9PT0gInNlbGVjdCIgfHwgdGFnID09PSAidGV4dGFyZWEiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRQcmV2ZW50TW91c2VFdmVudChuYW1lLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2siOgogICAgICAgICAgICBjYXNlICJvbkNsaWNrQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2siOgogICAgICAgICAgICBjYXNlICJvbkRvdWJsZUNsaWNrQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VEb3duIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd25DYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZU1vdmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZUNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlVXAiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlVXBDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZUVudGVyIjoKICAgICAgICAgICAgICByZXR1cm4gISEocHJvcHMuZGlzYWJsZWQgJiYgaXNJbnRlcmFjdGl2ZSh0eXBlKSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMaXN0ZW5lcihpbnN0LCByZWdpc3RyYXRpb25OYW1lKSB7CiAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gaW5zdC5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgaWYgKHByb3BzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpc3RlbmVyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIgJiYgdHlwZW9mIGxpc3RlbmVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYCIgKyByZWdpc3RyYXRpb25OYW1lICsgImAgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYSB2YWx1ZSBvZiBgIiArIHR5cGVvZiBsaXN0ZW5lciArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIHZhciBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIGlmIChjYW5Vc2VET00pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvcHRpb25zLCAicGFzc2l2ZSIsIHsKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja1Byb2QobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIHRoaXMub25FcnJvcihlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGludm9rZUd1YXJkZWRDYWxsYmFja1Byb2Q7CiAgICAgICAgewogICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZGlzcGF0Y2hFdmVudCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZmFrZU5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJyZWFjdCIpOwogICAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrRGV2KG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYGRvY3VtZW50YCBnbG9iYWwgd2FzIGRlZmluZWQgd2hlbiBSZWFjdCB3YXMgaW5pdGlhbGl6ZWQsIGJ1dCBpcyBub3QgZGVmaW5lZCBhbnltb3JlLiBUaGlzIGNhbiBoYXBwZW4gaW4gYSB0ZXN0IGVudmlyb25tZW50IGlmIGEgY29tcG9uZW50IHNjaGVkdWxlcyBhbiB1cGRhdGUgZnJvbSBhbiBhc3luY2hyb25vdXMgY2FsbGJhY2ssIGJ1dCB0aGUgdGVzdCBoYXMgYWxyZWFkeSBmaW5pc2hlZCBydW5uaW5nLiBUbyBzb2x2ZSB0aGlzLCB5b3UgY2FuIGVpdGhlciB1bm1vdW50IHRoZSBjb21wb25lbnQgYXQgdGhlIGVuZCBvZiB5b3VyIHRlc3QgKGFuZCBlbnN1cmUgdGhhdCBhbnkgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMgZ2V0IGNhbmNlbGVkIGluIGBjb21wb25lbnRXaWxsVW5tb3VudGApLCBvciB5b3UgY2FuIGNoYW5nZSB0aGUgdGVzdCBpdHNlbGYgdG8gYmUgYXN5bmNocm9ub3VzLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkV2ZW50Iik7CiAgICAgICAgICAgICAgdmFyIGRpZENhbGwgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgICAgICB2YXIgd2luZG93RXZlbnREZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW5kb3csICJldmVudCIpOwogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVBZnRlckRpc3BhdGNoKCkgewogICAgICAgICAgICAgICAgZmFrZU5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5ldmVudCAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Lmhhc093blByb3BlcnR5KCJldmVudCIpKSB7CiAgICAgICAgICAgICAgICAgIHdpbmRvdy5ldmVudCA9IHdpbmRvd0V2ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjazIoKSB7CiAgICAgICAgICAgICAgICBkaWRDYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgICAgICAgIGRpZEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvcjI7CiAgICAgICAgICAgICAgdmFyIGRpZFNldEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIGlzQ3Jvc3NPcmlnaW5FcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVdpbmRvd0Vycm9yKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBldmVudC5lcnJvcjsKICAgICAgICAgICAgICAgIGRpZFNldEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgPT09IG51bGwgJiYgZXZlbnQuY29sbm8gPT09IDAgJiYgZXZlbnQubGluZW5vID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGlzQ3Jvc3NPcmlnaW5FcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICBpZiAoZXJyb3IyICE9IG51bGwgJiYgdHlwZW9mIGVycm9yMiA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IyLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGlubmVyKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnRUeXBlID0gInJlYWN0LSIgKyAobmFtZSA/IG5hbWUgOiAiaW52b2tlZ3VhcmRlZGNhbGxiYWNrIik7CiAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgIGZha2VOb2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgIGV2dC5pbml0RXZlbnQoZXZ0VHlwZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICBmYWtlTm9kZS5kaXNwYXRjaEV2ZW50KGV2dCk7CiAgICAgICAgICAgICAgaWYgKHdpbmRvd0V2ZW50RGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdywgImV2ZW50Iiwgd2luZG93RXZlbnREZXNjcmlwdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRpZENhbGwgJiYgZGlkRXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU2V0RXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKGBBbiBlcnJvciB3YXMgdGhyb3duIGluc2lkZSBvbmUgb2YgeW91ciBjb21wb25lbnRzLCBidXQgUmVhY3QgZG9lc24ndCBrbm93IHdoYXQgaXQgd2FzLiBUaGlzIGlzIGxpa2VseSBkdWUgdG8gYnJvd3NlciBmbGFraW5lc3MuIFJlYWN0IGRvZXMgaXRzIGJlc3QgdG8gcHJlc2VydmUgdGhlICJQYXVzZSBvbiBleGNlcHRpb25zIiBiZWhhdmlvciBvZiB0aGUgRGV2VG9vbHMsIHdoaWNoIHJlcXVpcmVzIHNvbWUgREVWLW1vZGUgb25seSB0cmlja3MuIEl0J3MgcG9zc2libGUgdGhhdCB0aGVzZSBkb24ndCB3b3JrIGluIHlvdXIgYnJvd3Nlci4gVHJ5IHRyaWdnZXJpbmcgdGhlIGVycm9yIGluIHByb2R1Y3Rpb24gbW9kZSwgb3Igc3dpdGNoaW5nIHRvIGEgbW9kZXJuIGJyb3dzZXIuIElmIHlvdSBzdXNwZWN0IHRoYXQgdGhpcyBpcyBhY3R1YWxseSBhbiBpc3N1ZSB3aXRoIFJlYWN0LCBwbGVhc2UgZmlsZSBhbiBpc3N1ZS5gKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDcm9zc09yaWdpbkVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcigiQSBjcm9zcy1vcmlnaW4gZXJyb3Igd2FzIHRocm93bi4gUmVhY3QgZG9lc24ndCBoYXZlIGFjY2VzcyB0byB0aGUgYWN0dWFsIGVycm9yIG9iamVjdCBpbiBkZXZlbG9wbWVudC4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jcm9zc29yaWdpbi1lcnJvciBmb3IgbW9yZSBpbmZvcm1hdGlvbi4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgaWYgKCFkaWRDYWxsKSB7CiAgICAgICAgICAgICAgICByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGludm9rZUd1YXJkZWRDYWxsYmFja1Byb2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsJDEgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsOwogICAgICAgIHZhciBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBjYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgIHZhciByZXBvcnRlciA9IHsKICAgICAgICAgIG9uRXJyb3I6IGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICBoYXNFcnJvciA9IHRydWU7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICBjYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsJDEuYXBwbHkocmVwb3J0ZXIsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcihuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICBpZiAoIWhhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgcmV0aHJvd0Vycm9yID0gZXJyb3IyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldGhyb3dDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IHJldGhyb3dFcnJvcjsKICAgICAgICAgICAgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzQ2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICByZXR1cm4gaGFzRXJyb3I7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNhdWdodEVycm9yOwogICAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgICAgICBjYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBlcnJvcjI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNsZWFyQ2F1Z2h0RXJyb3Igd2FzIGNhbGxlZCBidXQgbm8gZXJyb3Igd2FzIGNhcHR1cmVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5Ll9yZWFjdEludGVybmFsczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzKGtleSkgewogICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHMgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0KGtleSwgdmFsdWUpIHsKICAgICAgICAgIGtleS5fcmVhY3RJbnRlcm5hbHMgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIE5vRmxhZ3MgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIFBlcmZvcm1lZFdvcmsgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFBsYWNlbWVudCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIFVwZGF0ZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIENoaWxkRGVsZXRpb24gPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYKICAgICAgICApOwogICAgICAgIHZhciBDb250ZW50UmVzZXQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgQ2FsbGJhY2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NAogICAgICAgICk7CiAgICAgICAgdmFyIERpZENhcHR1cmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTI4CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VDbGllbnRSZW5kZXIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICAyNTYKICAgICAgICApOwogICAgICAgIHZhciBSZWYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFNuYXBzaG90ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFZpc2liaWxpdHkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFN0b3JlQ29uc2lzdGVuY3kgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmIHwgU25hcHNob3QgfCBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgIHZhciBIb3N0RWZmZWN0TWFzayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY3CiAgICAgICAgKTsKICAgICAgICB2YXIgSW5jb21wbGV0ZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFNob3VsZENhcHR1cmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlID0gKAogICAgICAgICAgLyogKi8KICAgICAgICAgIDEzMTA3MgogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmtlZCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZlN0YXRpYyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dFN0YXRpYyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmVTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODM4ODYwOAogICAgICAgICk7CiAgICAgICAgdmFyIE1vdW50TGF5b3V0RGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBNb3VudFBhc3NpdmVEZXYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgQmVmb3JlTXV0YXRpb25NYXNrID0gKAogICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIFVwZGF0ZSBmbGFnIGZyb20gYmVmb3JlIG11dGF0aW9uIHBoYXNlIGJ5IHJlLWxhbmRpbmcgVmlzaWJpbGl0eQogICAgICAgICAgLy8gZmxhZyBsb2dpYyAoc2VlICMyMDA0MykKICAgICAgICAgIFVwZGF0ZSB8IFNuYXBzaG90IHwgMAogICAgICAgICk7CiAgICAgICAgdmFyIE11dGF0aW9uTWFzayA9IFBsYWNlbWVudCB8IFVwZGF0ZSB8IENoaWxkRGVsZXRpb24gfCBDb250ZW50UmVzZXQgfCBSZWYgfCBIeWRyYXRpbmcgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBMYXlvdXRNYXNrID0gVXBkYXRlIHwgQ2FsbGJhY2sgfCBSZWYgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgIHZhciBTdGF0aWNNYXNrID0gTGF5b3V0U3RhdGljIHwgUGFzc2l2ZVN0YXRpYyB8IFJlZlN0YXRpYzsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZmliZXI7CiAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgIGlmICgobm9kZS5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgbmVhcmVzdE1vdW50ZWQgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKG5vZGUucmV0dXJuKSB7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRhaW5lckZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgPyBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01vdW50ZWQoY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyRmliZXIpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoY29tcG9uZW50KTsKICAgICAgICAgIGlmICghZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0SXNNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChmaWJlcikgewogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmICghYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGEgPSBmaWJlcjsKICAgICAgICAgIHZhciBiID0gYWx0ZXJuYXRlOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudEEgPSBhLnJldHVybjsKICAgICAgICAgICAgaWYgKHBhcmVudEEgPT09IG51bGwpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGFyZW50QiA9IHBhcmVudEEuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAocGFyZW50QiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXh0UGFyZW50ID0gcGFyZW50QS5yZXR1cm47CiAgICAgICAgICAgICAgaWYgKG5leHRQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGEgPSBiID0gbmV4dFBhcmVudDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW50QS5jaGlsZCA9PT0gcGFyZW50Qi5jaGlsZCkgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEEuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgYXNzZXJ0SXNNb3VudGVkKHBhcmVudEEpOwogICAgICAgICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgYXNzZXJ0SXNNb3VudGVkKHBhcmVudEEpOwogICAgICAgICAgICAgICAgICByZXR1cm4gYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYS5yZXR1cm4gIT09IGIucmV0dXJuKSB7CiAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGRpZEZpbmRDaGlsZCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBfY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgX2NoaWxkID0gcGFyZW50Qi5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYSkgewogICAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYikgewogICAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWRpZEZpbmRDaGlsZCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNoaWxkIHdhcyBub3QgZm91bmQgaW4gZWl0aGVyIHBhcmVudCBzZXQuIFRoaXMgaW5kaWNhdGVzIGEgYnVnIGluIFJlYWN0IHJlbGF0ZWQgdG8gdGhlIHJldHVybiBwb2ludGVyLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEuYWx0ZXJuYXRlICE9PSBiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZXR1cm4gZmliZXJzIHNob3VsZCBhbHdheXMgYmUgZWFjaCBvdGhlcnMnIGFsdGVybmF0ZXMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChhLnRhZyAhPT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS5zdGF0ZU5vZGUuY3VycmVudCA9PT0gYSkgewogICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYWx0ZXJuYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudEhvc3RGaWJlcihwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJJbXBsKGN1cnJlbnRQYXJlbnQpIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJJbXBsKG5vZGUpIHsKICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjaGlsZCk7CiAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKHBhcmVudCkgewogICAgICAgICAgdmFyIGN1cnJlbnRQYXJlbnQgPSBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChwYXJlbnQpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQYXJlbnQgIT09IG51bGwgPyBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHNJbXBsKGN1cnJlbnRQYXJlbnQpIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY2hpbGQudGFnICE9PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjaGlsZCk7CiAgICAgICAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVDYWxsYmFjayA9IFNjaGVkdWxlci51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrOwogICAgICAgIHZhciBjYW5jZWxDYWxsYmFjayA9IFNjaGVkdWxlci51bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICB2YXIgc2hvdWxkWWllbGQgPSBTY2hlZHVsZXIudW5zdGFibGVfc2hvdWxkWWllbGQ7CiAgICAgICAgdmFyIHJlcXVlc3RQYWludCA9IFNjaGVkdWxlci51bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIG5vdyA9IFNjaGVkdWxlci51bnN0YWJsZV9ub3c7CiAgICAgICAgdmFyIGdldEN1cnJlbnRQcmlvcml0eUxldmVsID0gU2NoZWR1bGVyLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIHZhciBJbW1lZGlhdGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICB2YXIgVXNlckJsb2NraW5nUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5OwogICAgICAgIHZhciBMb3dQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Mb3dQcmlvcml0eTsKICAgICAgICB2YXIgSWRsZVByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX0lkbGVQcmlvcml0eTsKICAgICAgICB2YXIgdW5zdGFibGVfeWllbGRWYWx1ZSA9IFNjaGVkdWxlci51bnN0YWJsZV95aWVsZFZhbHVlOwogICAgICAgIHZhciB1bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZSA9IFNjaGVkdWxlci51bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZTsKICAgICAgICB2YXIgcmVuZGVyZXJJRCA9IG51bGw7CiAgICAgICAgdmFyIGluamVjdGVkSG9vayA9IG51bGw7CiAgICAgICAgdmFyIGluamVjdGVkUHJvZmlsaW5nSG9va3MgPSBudWxsOwogICAgICAgIHZhciBoYXNMb2dnZWRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBpc0RldlRvb2xzUHJlc2VudCA9IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiOwogICAgICAgIGZ1bmN0aW9uIGluamVjdEludGVybmFscyhpbnRlcm5hbHMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaG9vayA9IF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKICAgICAgICAgIGlmIChob29rLmlzRGlzYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWhvb2suc3VwcG9ydHNGaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBpbnN0YWxsZWQgdmVyc2lvbiBvZiBSZWFjdCBEZXZUb29scyBpcyB0b28gb2xkIGFuZCB3aWxsIG5vdCB3b3JrIHdpdGggdGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBSZWFjdC4gUGxlYXNlIHVwZGF0ZSBSZWFjdCBEZXZUb29scy4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgaW50ZXJuYWxzID0gYXNzaWduKHt9LCBpbnRlcm5hbHMsIHsKICAgICAgICAgICAgICAgIGdldExhbmVMYWJlbE1hcCwKICAgICAgICAgICAgICAgIGluamVjdFByb2ZpbGluZ0hvb2tzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVuZGVyZXJJRCA9IGhvb2suaW5qZWN0KGludGVybmFscyk7CiAgICAgICAgICAgIGluamVjdGVkSG9vayA9IGhvb2s7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzLiIsIGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChob29rLmNoZWNrRENFKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblNjaGVkdWxlUm9vdChyb290MywgY2hpbGRyZW4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIGNoaWxkcmVuKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdChyb290MywgZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gKHJvb3QzLmN1cnJlbnQuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lcikgewogICAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5OwogICAgICAgICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHNjaGVkdWxlclByaW9yaXR5LCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgdm9pZCAwLCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblBvc3RDb21taXRSb290KHJvb3QzKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Myk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0VW5tb3VudChmaWJlcikgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50KHJlbmRlcmVySUQsIGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMobmV3SXNTdHJpY3RNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW5zdGFibGVfeWllbGRWYWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuc3RhYmxlX3NldERpc2FibGVZaWVsZFZhbHVlKG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgc2V0U3VwcHJlc3NXYXJuaW5nKG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUocmVuZGVyZXJJRCwgbmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0UHJvZmlsaW5nSG9va3MocHJvZmlsaW5nSG9va3MpIHsKICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MgPSBwcm9maWxpbmdIb29rczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZUxhYmVsTWFwKCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxOwogICAgICAgICAgICBmb3IgKHZhciBpbmRleDIgPSAwOyBpbmRleDIgPCBUb3RhbExhbmVzOyBpbmRleDIrKykgewogICAgICAgICAgICAgIHZhciBsYWJlbCA9IGdldExhYmVsRm9yTGFuZShsYW5lKTsKICAgICAgICAgICAgICBtYXAuc2V0KGxhbmUsIGxhYmVsKTsKICAgICAgICAgICAgICBsYW5lICo9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyWWllbGRlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTm9Nb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBDb25jdXJyZW50TW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFByb2ZpbGVNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0TGVnYWN5TW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RFZmZlY3RzTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYKICAgICAgICApOwogICAgICAgIHZhciBjbHozMiA9IE1hdGguY2x6MzIgPyBNYXRoLmNsejMyIDogY2x6MzJGYWxsYmFjazsKICAgICAgICB2YXIgbG9nID0gTWF0aC5sb2c7CiAgICAgICAgdmFyIExOMiA9IE1hdGguTE4yOwogICAgICAgIGZ1bmN0aW9uIGNsejMyRmFsbGJhY2soeCkgewogICAgICAgICAgdmFyIGFzVWludCA9IHggPj4+IDA7CiAgICAgICAgICBpZiAoYXNVaW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAzMjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAzMSAtIChsb2coYXNVaW50KSAvIExOMiB8IDApIHwgMDsKICAgICAgICB9CiAgICAgICAgdmFyIFRvdGFsTGFuZXMgPSAzMTsKICAgICAgICB2YXIgTm9MYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBOb0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBTeW5jTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0SHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0TGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQyNDAKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU3ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTAgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjIxNDQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MjQyODgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMwMDIzNDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjc3NzIxNgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjcxMDg4NjQKICAgICAgICApOwogICAgICAgIHZhciBTb21lUmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICB2YXIgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICovCiAgICAgICAgICAxMzQyMTc3MjgKICAgICAgICApOwogICAgICAgIHZhciBOb25JZGxlTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NQogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMjY4NDM1NDU2CiAgICAgICAgKTsKICAgICAgICB2YXIgSWRsZUxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MzY4NzA5MTIKICAgICAgICApOwogICAgICAgIHZhciBPZmZzY3JlZW5MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNzM3NDE4MjQKICAgICAgICApOwogICAgICAgIGZ1bmN0aW9uIGdldExhYmVsRm9yTGFuZShsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChsYW5lICYgU3luY0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlN5bmMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91cyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0SHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdEh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0TGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbkh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgUmV0cnlMYW5lcykgewogICAgICAgICAgICAgIHJldHVybiAiUmV0cnkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiU2VsZWN0aXZlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vVGltZXN0YW1wID0gLTE7CiAgICAgICAgdmFyIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICB2YXIgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykpIHsKICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdExhbmU7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzOwogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBSZXRyeUxhbmVzOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlTGFuZTsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0TGFuZXMocm9vdDMsIHdpcExhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHBlbmRpbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBub25JZGxlUGVuZGluZ0xhbmVzID0gcGVuZGluZ0xhbmVzICYgTm9uSWRsZUxhbmVzOwogICAgICAgICAgaWYgKG5vbklkbGVQZW5kaW5nTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIG5vbklkbGVVbmJsb2NrZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmIChub25JZGxlVW5ibG9ja2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhub25JZGxlVW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBub25JZGxlUGluZ2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgICAgICAgaWYgKG5vbklkbGVQaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bmJsb2NrZWRMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgICAgaWYgKHVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXModW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChwaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3aXBMYW5lcyAhPT0gTm9MYW5lcyAmJiB3aXBMYW5lcyAhPT0gbmV4dExhbmVzICYmIC8vIElmIHdlIGFscmVhZHkgc3VzcGVuZGVkIHdpdGggYSBkZWxheSwgdGhlbiBpbnRlcnJ1cHRpbmcgaXMgZmluZS4gRG9uJ3QKICAgICAgICAgIC8vIGJvdGhlciB3YWl0aW5nIHVudGlsIHRoZSByb290IGlzIGNvbXBsZXRlLgogICAgICAgICAgKHdpcExhbmVzICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBuZXh0TGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgICAgdmFyIHdpcExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKHdpcExhbmVzKTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIFRlc3RzIHdoZXRoZXIgdGhlIG5leHQgbGFuZSBpcyBlcXVhbCBvciBsb3dlciBwcmlvcml0eSB0aGFuIHRoZSB3aXAKICAgICAgICAgICAgICAvLyBvbmUuIFRoaXMgd29ya3MgYmVjYXVzZSB0aGUgYml0cyBkZWNyZWFzZSBpbiBwcmlvcml0eSBhcyB5b3UgZ28gbGVmdC4KICAgICAgICAgICAgICBuZXh0TGFuZSA+PSB3aXBMYW5lIHx8IC8vIERlZmF1bHQgcHJpb3JpdHkgdXBkYXRlcyBzaG91bGQgbm90IGludGVycnVwdCB0cmFuc2l0aW9uIHVwZGF0ZXMuIFRoZQogICAgICAgICAgICAgIC8vIG9ubHkgZGlmZmVyZW5jZSBiZXR3ZWVuIGRlZmF1bHQgdXBkYXRlcyBhbmQgdHJhbnNpdGlvbiB1cGRhdGVzIGlzIHRoYXQKICAgICAgICAgICAgICAvLyBkZWZhdWx0IHVwZGF0ZXMgZG8gbm90IHN1cHBvcnQgcmVmcmVzaCB0cmFuc2l0aW9ucy4KICAgICAgICAgICAgICBuZXh0TGFuZSA9PT0gRGVmYXVsdExhbmUgJiYgKHdpcExhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHJldHVybiB3aXBMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKChuZXh0TGFuZXMgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0TGFuZXMgfD0gcGVuZGluZ0xhbmVzICYgRGVmYXVsdExhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW50YW5nbGVkTGFuZXMgPSByb290My5lbnRhbmdsZWRMYW5lczsKICAgICAgICAgIGlmIChlbnRhbmdsZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICAgIHZhciBsYW5lcyA9IG5leHRMYW5lcyAmIGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgICAgbmV4dExhbmVzIHw9IGVudGFuZ2xlbWVudHNbaW5kZXgyXTsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IGV2ZW50VGltZXNbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKGV2ZW50VGltZSA+IG1vc3RSZWNlbnRFdmVudFRpbWUpIHsKICAgICAgICAgICAgICBtb3N0UmVjZW50RXZlbnRUaW1lID0gZXZlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSkgewogICAgICAgICAgc3dpdGNoIChsYW5lKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDI1MDsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDVlMzsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIlNob3VsZCBoYXZlIGZvdW5kIG1hdGNoaW5nIGxhbmVzLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA9PT0gTm9UaW1lc3RhbXApIHsKICAgICAgICAgICAgICBpZiAoKGxhbmUgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMgfHwgKGxhbmUgJiBwaW5nZWRMYW5lcykgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gY29tcHV0ZUV4cGlyYXRpb25UaW1lKGxhbmUsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgfD0gbGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpIHsKICAgICAgICAgIHZhciBldmVyeXRoaW5nQnV0T2Zmc2NyZWVuID0gcm9vdDMucGVuZGluZ0xhbmVzICYgfk9mZnNjcmVlbkxhbmU7CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gZXZlcnl0aGluZ0J1dE9mZnNjcmVlbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChldmVyeXRoaW5nQnV0T2Zmc2NyZWVuICYgT2Zmc2NyZWVuTGFuZSkgewogICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1N5bmNMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0xhbmUpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc05vbklkbGVXb3JrKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgTm9uSWRsZUxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFJldHJ5TGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHZhciBVcmdlbnRMYW5lcyA9IFN5bmNMYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRMYW5lOwogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFVyZ2VudExhbmVzKSA9PT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgU3luY0RlZmF1bHRMYW5lcyA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBTeW5jRGVmYXVsdExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNFeHBpcmVkTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiByb290My5leHBpcmVkTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RyYW5zaXRpb25MYW5lKGxhbmUpIHsKICAgICAgICAgIHJldHVybiAobGFuZSAmIFRyYW5zaXRpb25MYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCkgewogICAgICAgICAgdmFyIGxhbmUgPSBuZXh0VHJhbnNpdGlvbkxhbmU7CiAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRUcmFuc2l0aW9uTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lID0gVHJhbnNpdGlvbkxhbmUxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFJldHJ5TGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFJldHJ5TGFuZTsKICAgICAgICAgIG5leHRSZXRyeUxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRSZXRyeUxhbmUgJiBSZXRyeUxhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gbGFuZXMgJiAtbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAzMSAtIGNsejMyKGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZVRvSW5kZXgobGFuZSkgewogICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU29tZUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIChhICYgYikgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3Vic2V0T2ZMYW5lcyhzZXQyLCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiAoc2V0MiAmIHN1YnNldCkgPT09IHN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVyZ2VMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSB8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUxhbmVzKHNldDIsIHN1YnNldCkgewogICAgICAgICAgcmV0dXJuIHNldDIgJiB+c3Vic2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnRlcnNlY3RMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAmIGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0xhbmVzKGxhbmUpIHsKICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJQcmlvcml0eUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IE5vTGFuZSAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVMYW5lTWFwKGluaXRpYWwpIHsKICAgICAgICAgIHZhciBsYW5lTWFwID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IFRvdGFsTGFuZXM7IGkrKykgewogICAgICAgICAgICBsYW5lTWFwLnB1c2goaW5pdGlhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZU1hcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCB1cGRhdGVMYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyB8PSB1cGRhdGVMYW5lOwogICAgICAgICAgaWYgKHVwZGF0ZUxhbmUgIT09IElkbGVMYW5lKSB7CiAgICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KHVwZGF0ZUxhbmUpOwogICAgICAgICAgZXZlbnRUaW1lc1tpbmRleDJdID0gZXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzIHw9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgJj0gfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMsIGV2ZW50VGltZSkgewogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgfD0gcm9vdDMuc3VzcGVuZGVkTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RGaW5pc2hlZChyb290MywgcmVtYWluaW5nTGFuZXMpIHsKICAgICAgICAgIHZhciBub0xvbmdlclBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5yZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyA9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMubXV0YWJsZVJlYWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLmVudGFuZ2xlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IG5vTG9uZ2VyUGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSA9IE5vTGFuZXM7CiAgICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIGVudGFuZ2xlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcm9vdEVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXMgfD0gZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSByb290RW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgLy8gSXMgdGhpcyBvbmUgb2YgdGhlIG5ld2x5IGVudGFuZ2xlZCBsYW5lcz8KICAgICAgICAgICAgICBsYW5lICYgZW50YW5nbGVkTGFuZXMgfCAvLyBJcyB0aGlzIGxhbmUgdHJhbnNpdGl2ZWx5IGVudGFuZ2xlZCB3aXRoIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdICYgZW50YW5nbGVkTGFuZXMKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciByZW5kZXJMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGxhbmU7CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlckxhbmUpIHsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICBsYW5lID0gVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgICAgbGFuZSA9IElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhbmUgPSBOb0xhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGxhbmUgJiAocm9vdDMuc3VzcGVuZGVkTGFuZXMgfCByZW5kZXJMYW5lczIpKSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBOb0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZXMpIHsKICAgICAgICAgIGlmICghaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSByb290My5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gbGFuZVRvSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgdXBkYXRlcnMgPSBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwW2luZGV4Ml07CiAgICAgICAgICAgIHVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICBpZiAodXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB1cGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCAhbWVtb2l6ZWRVcGRhdGVycy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBEaXNjcmV0ZUV2ZW50UHJpb3JpdHkgPSBTeW5jTGFuZTsKICAgICAgICB2YXIgQ29udGludW91c0V2ZW50UHJpb3JpdHkgPSBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgIHZhciBEZWZhdWx0RXZlbnRQcmlvcml0eSA9IERlZmF1bHRMYW5lOwogICAgICAgIHZhciBJZGxlRXZlbnRQcmlvcml0eSA9IElkbGVMYW5lOwogICAgICAgIHZhciBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KG5ld1ByaW9yaXR5KSB7CiAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBuZXdQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuV2l0aFByaW9yaXR5KHByaW9yaXR5LCBmbikgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmV2aW91c1ByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiID8gYSA6IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxvd2VyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSA9PT0gMCB8fCBhID4gYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hpZ2hlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IDAgJiYgYSA8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVzVG9FdmVudFByaW9yaXR5KGxhbmVzKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc05vbklkbGVXb3JrKGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSb290RGVoeWRyYXRlZChyb290MykgewogICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHJvb3QzLmN1cnJlbnQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUuaXNEZWh5ZHJhdGVkOwogICAgICAgIH0KICAgICAgICB2YXIgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZm4pIHsKICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5OwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMTsKICAgICAgICBmdW5jdGlvbiBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICB2YXIgcXVldWVkRGlzY3JldGVFdmVudHMgPSBbXTsKICAgICAgICB2YXIgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cyA9IFtdOwogICAgICAgIHZhciBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMgPSBbCiAgICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAgICJtb3VzZXVwIiwKICAgICAgICAgICJ0b3VjaGNhbmNlbCIsCiAgICAgICAgICAidG91Y2hlbmQiLAogICAgICAgICAgInRvdWNoc3RhcnQiLAogICAgICAgICAgImF1eGNsaWNrIiwKICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAicG9pbnRlcmNhbmNlbCIsCiAgICAgICAgICAicG9pbnRlcmRvd24iLAogICAgICAgICAgInBvaW50ZXJ1cCIsCiAgICAgICAgICAiZHJhZ2VuZCIsCiAgICAgICAgICAiZHJhZ3N0YXJ0IiwKICAgICAgICAgICJkcm9wIiwKICAgICAgICAgICJjb21wb3NpdGlvbmVuZCIsCiAgICAgICAgICAiY29tcG9zaXRpb25zdGFydCIsCiAgICAgICAgICAia2V5ZG93biIsCiAgICAgICAgICAia2V5cHJlc3MiLAogICAgICAgICAgImtleXVwIiwKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAidGV4dElucHV0IiwKICAgICAgICAgIC8vIEludGVudGlvbmFsbHkgY2FtZWxDYXNlCiAgICAgICAgICAiY29weSIsCiAgICAgICAgICAiY3V0IiwKICAgICAgICAgICJwYXN0ZSIsCiAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgImNoYW5nZSIsCiAgICAgICAgICAiY29udGV4dG1lbnUiLAogICAgICAgICAgInJlc2V0IiwKICAgICAgICAgICJzdWJtaXQiCiAgICAgICAgXTsKICAgICAgICBmdW5jdGlvbiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZXZlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzLmluZGV4T2YoZXZlbnRUeXBlKSA+IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJsb2NrZWRPbiwKICAgICAgICAgICAgZG9tRXZlbnROYW1lLAogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzLAogICAgICAgICAgICBuYXRpdmVFdmVudCwKICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyczogW3RhcmdldENvbnRhaW5lcl0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmRlbGV0ZShwb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5kZWxldGUoX3BvaW50ZXJJZCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChleGlzdGluZ1F1ZXVlZEV2ZW50LCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGV4aXN0aW5nUXVldWVkRXZlbnQgPT09IG51bGwgfHwgZXhpc3RpbmdRdWV1ZWRFdmVudC5uYXRpdmVFdmVudCAhPT0gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZmliZXIyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1ZXVlZEV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZXhpc3RpbmdRdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzIHw9IGV2ZW50U3lzdGVtRmxhZ3M7CiAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVycyA9IGV4aXN0aW5nUXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIGlmICh0YXJnZXRDb250YWluZXIgIT09IG51bGwgJiYgdGFyZ2V0Q29udGFpbmVycy5pbmRleE9mKHRhcmdldENvbnRhaW5lcikgPT09IC0xKSB7CiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMucHVzaCh0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXN0aW5nUXVldWVkRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOiB7CiAgICAgICAgICAgICAgdmFyIGZvY3VzRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRm9jdXMsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGZvY3VzRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6IHsKICAgICAgICAgICAgICB2YXIgZHJhZ0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRHJhZywgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgZHJhZ0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIG1vdXNlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkTW91c2UsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG1vdXNlRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjogewogICAgICAgICAgICAgIHZhciBwb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5zZXQocG9pbnRlcklkLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJzLmdldChwb2ludGVySWQpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHBvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQyID0gX3BvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLnNldChfcG9pbnRlcklkMiwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZ2V0KF9wb2ludGVySWQyKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBfcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShxdWV1ZWRUYXJnZXQudGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocXVldWVkVGFyZ2V0LnByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgIHZhciB1cGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxKCk7CiAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gewogICAgICAgICAgICBibG9ja2VkT246IG51bGwsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgcHJpb3JpdHk6IHVwZGF0ZVByaW9yaXR5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkodXBkYXRlUHJpb3JpdHksIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tpXS5wcmlvcml0eSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNwbGljZShpLCAwLCBxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBxdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgd2hpbGUgKHRhcmdldENvbnRhaW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyc1swXTsKICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KHF1ZXVlZEV2ZW50LmRvbUV2ZW50TmFtZSwgcXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gcXVldWVkRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRDbG9uZSA9IG5ldyBuYXRpdmVFdmVudC5jb25zdHJ1Y3RvcihuYXRpdmVFdmVudC50eXBlLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgICBzZXRSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgcmVzZXRSZXBsYXlpbmdFdmVudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMyA9IGdldEluc3RhbmNlRnJvbU5vZGUobmV4dEJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKF9maWJlcjMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKHF1ZXVlZEV2ZW50LCBrZXksIG1hcCkgewogICAgICAgICAgaWYgKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpKSB7CiAgICAgICAgICAgIG1hcC5kZWxldGUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVwbGF5VW5ibG9ja2VkRXZlbnRzKCkgewogICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IGZhbHNlOwogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRm9jdXMpKSB7CiAgICAgICAgICAgIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRHJhZykpIHsKICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRNb3VzZSkpIHsKICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50LCB1bmJsb2NrZWQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQpIHsKICAgICAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gdHJ1ZTsKICAgICAgICAgICAgICBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhTY2hlZHVsZXIudW5zdGFibGVfTm9ybWFsUHJpb3JpdHksIHJlcGxheVVuYmxvY2tlZEV2ZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlJZkJsb2NrZWRPbih1bmJsb2NrZWQpIHsKICAgICAgICAgIGlmIChxdWV1ZWREaXNjcmV0ZUV2ZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREaXNjcmV0ZUV2ZW50c1swXSwgdW5ibG9ja2VkKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBxdWV1ZWREaXNjcmV0ZUV2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IHF1ZXVlZERpc2NyZXRlRXZlbnRzW2ldOwogICAgICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRm9jdXMsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRHJhZywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkTW91c2UsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdW5ibG9jayA9IGZ1bmN0aW9uKHF1ZXVlZEV2ZW50MikgewogICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50MiwgdW5ibG9ja2VkKTsKICAgICAgICAgIH07CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzW19pXTsKICAgICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAocXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIG5leHRFeHBsaWNpdFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1swXTsKICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhdHRlbXB0RXhwbGljaXRIeWRyYXRpb25UYXJnZXQobmV4dEV4cGxpY2l0VGFyZ2V0KTsKICAgICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBfZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gc2V0RW5hYmxlZChlbmFibGVkKSB7CiAgICAgICAgICBfZW5hYmxlZCA9ICEhZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFbmFibGVkKCkgewogICAgICAgICAgcmV0dXJuIF9lbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFdmVudExpc3RlbmVyV3JhcHBlcldpdGhQcmlvcml0eSh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgdmFyIGV2ZW50UHJpb3JpdHkgPSBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJXcmFwcGVyOwogICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRGlzY3JldGVFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaENvbnRpbnVvdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyV3JhcHBlci5iaW5kKG51bGwsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaENvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKCFfZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBibG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFICYmIGlzRGlzY3JldGVFdmVudFRoYXRSZXF1aXJlc0h5ZHJhdGlvbihkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgIHdoaWxlIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmliZXIgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKGJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dEJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gYmxvY2tlZE9uKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIG51bGwsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHRhZyA9IG5lYXJlc3RNb3VudGVkLnRhZzsKICAgICAgICAgICAgICBpZiAodGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBuZWFyZXN0TW91bnRlZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRhaW5lckZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5lYXJlc3RNb3VudGVkICE9PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICBjYXNlICJjbG9zZSI6CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgY2FzZSAiaW52YWxpZCI6CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgY2FzZSAicGF1c2UiOgogICAgICAgICAgICBjYXNlICJwbGF5IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgY2FzZSAicmF0ZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInJlc2V0IjoKICAgICAgICAgICAgY2FzZSAicmVzaXplIjoKICAgICAgICAgICAgY2FzZSAic2Vla2VkIjoKICAgICAgICAgICAgY2FzZSAic3VibWl0IjoKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICBjYXNlICJ2b2x1bWVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnVwZGF0ZSI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImJsdXIiOgogICAgICAgICAgICBjYXNlICJmdWxsc2NyZWVuY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXMiOgogICAgICAgICAgICBjYXNlICJoYXNoY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicG9wc3RhdGUiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJzZWxlY3RzdGFydCI6CiAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdleGl0IjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ292ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJtb3ZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgY2FzZSAidG9nZ2xlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICBjYXNlICJtb3VzZWVudGVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2VsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJlbnRlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJsZWF2ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJtZXNzYWdlIjogewogICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eSA9IGdldEN1cnJlbnRQcmlvcml0eUxldmVsKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChzY2hlZHVsZXJQcmlvcml0eSkgewogICAgICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIElkbGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGZhbHNlKTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCB0cnVlKTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyLCBwYXNzaXZlKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCB7CiAgICAgICAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgICAgICAgIHBhc3NpdmUKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lciwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgewogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICB9CiAgICAgICAgdmFyIHJvb3QyID0gbnVsbDsKICAgICAgICB2YXIgc3RhcnRUZXh0ID0gbnVsbDsKICAgICAgICB2YXIgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplKG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByb290MiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgc3RhcnRUZXh0ID0gZ2V0VGV4dCgpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgICAgcm9vdDIgPSBudWxsOwogICAgICAgICAgc3RhcnRUZXh0ID0gbnVsbDsKICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERhdGEoKSB7CiAgICAgICAgICBpZiAoZmFsbGJhY2tUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgICB2YXIgc3RhcnRWYWx1ZSA9IHN0YXJ0VGV4dDsKICAgICAgICAgIHZhciBzdGFydExlbmd0aCA9IHN0YXJ0VmFsdWUubGVuZ3RoOwogICAgICAgICAgdmFyIGVuZDsKICAgICAgICAgIHZhciBlbmRWYWx1ZSA9IGdldFRleHQoKTsKICAgICAgICAgIHZhciBlbmRMZW5ndGggPSBlbmRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKHN0YXJ0ID0gMDsgc3RhcnQgPCBzdGFydExlbmd0aDsgc3RhcnQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydF0gIT09IGVuZFZhbHVlW3N0YXJ0XSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWluRW5kID0gc3RhcnRMZW5ndGggLSBzdGFydDsKICAgICAgICAgIGZvciAoZW5kID0gMTsgZW5kIDw9IG1pbkVuZDsgZW5kKyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRMZW5ndGggLSBlbmRdICE9PSBlbmRWYWx1ZVtlbmRMZW5ndGggLSBlbmRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzbGljZVRhaWwgPSBlbmQgPiAxID8gMSAtIGVuZCA6IHZvaWQgMDsKICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IGVuZFZhbHVlLnNsaWNlKHN0YXJ0LCBzbGljZVRhaWwpOwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGV4dCgpIHsKICAgICAgICAgIGlmICgidmFsdWUiIGluIHJvb3QyKSB7CiAgICAgICAgICAgIHJldHVybiByb290Mi52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290Mi50ZXh0Q29udGVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNoYXJDb2RlOwogICAgICAgICAgdmFyIGtleUNvZGUgPSBuYXRpdmVFdmVudC5rZXlDb2RlOwogICAgICAgICAgaWYgKCJjaGFyQ29kZSIgaW4gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgY2hhckNvZGUgPSBuYXRpdmVFdmVudC5jaGFyQ29kZTsKICAgICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAwICYmIGtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hhckNvZGUgPSBrZXlDb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAxMCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNoYXJDb2RlID49IDMyIHx8IGNoYXJDb2RlID09PSAxMykgewogICAgICAgICAgICByZXR1cm4gY2hhckNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWUoKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlKCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVTeW50aGV0aWNFdmVudChJbnRlcmZhY2UpIHsKICAgICAgICAgIGZ1bmN0aW9uIFN5bnRoZXRpY0Jhc2VFdmVudChyZWFjdE5hbWUsIHJlYWN0RXZlbnRUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgdGhpcy5fcmVhY3ROYW1lID0gcmVhY3ROYW1lOwogICAgICAgICAgICB0aGlzLl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgdGhpcy50eXBlID0gcmVhY3RFdmVudFR5cGU7CiAgICAgICAgICAgIHRoaXMubmF0aXZlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX3Byb3BOYW1lIGluIEludGVyZmFjZSkgewogICAgICAgICAgICAgIGlmICghSW50ZXJmYWNlLmhhc093blByb3BlcnR5KF9wcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplID0gSW50ZXJmYWNlW19wcm9wTmFtZV07CiAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZSkgewogICAgICAgICAgICAgICAgdGhpc1tfcHJvcE5hbWVdID0gbm9ybWFsaXplKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc1tfcHJvcE5hbWVdID0gbmF0aXZlRXZlbnRbX3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkICE9IG51bGwgPyBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkIDogbmF0aXZlRXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICBpZiAoZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NpZ24oU3ludGhldGljQmFzZUV2ZW50LnByb3RvdHlwZSwgewogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LmNhbmNlbEJ1YmJsZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBXZSByZWxlYXNlIGFsbCBkaXNwYXRjaGVkIGBTeW50aGV0aWNFdmVudGBzIGFmdGVyIGVhY2ggZXZlbnQgbG9vcCwgYWRkaW5nCiAgICAgICAgICAgICAqIHRoZW0gYmFjayBpbnRvIHRoZSBwb29sLiBUaGlzIGFsbG93cyBhIHdheSB0byBob2xkIG9udG8gYSByZWZlcmVuY2UgdGhhdAogICAgICAgICAgICAgKiB3b24ndCBiZSBhZGRlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwZXJzaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBpZiB0aGlzIGV2ZW50IHNob3VsZCBiZSByZWxlYXNlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBzaG91bGQgbm90IGJlIHJlbGVhc2VkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc1BlcnNpc3RlbnQ6IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBTeW50aGV0aWNCYXNlRXZlbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBFdmVudEludGVyZmFjZSA9IHsKICAgICAgICAgIGV2ZW50UGhhc2U6IDAsCiAgICAgICAgICBidWJibGVzOiAwLAogICAgICAgICAgY2FuY2VsYWJsZTogMCwKICAgICAgICAgIHRpbWVTdGFtcDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwogICAgICAgICAgfSwKICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IDAsCiAgICAgICAgICBpc1RydXN0ZWQ6IDAKICAgICAgICB9OwogICAgICAgIHZhciBTeW50aGV0aWNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVUlFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHZpZXc6IDAsCiAgICAgICAgICBkZXRhaWw6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVUlFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFVJRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBsYXN0TW92ZW1lbnRYOwogICAgICAgIHZhciBsYXN0TW92ZW1lbnRZOwogICAgICAgIHZhciBsYXN0TW91c2VFdmVudDsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVNb3VzZU1vdmVtZW50UG9seWZpbGxTdGF0ZShldmVudCkgewogICAgICAgICAgaWYgKGV2ZW50ICE9PSBsYXN0TW91c2VFdmVudCkgewogICAgICAgICAgICBpZiAobGFzdE1vdXNlRXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlbW92ZSIpIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gZXZlbnQuc2NyZWVuWCAtIGxhc3RNb3VzZUV2ZW50LnNjcmVlblg7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WSA9IGV2ZW50LnNjcmVlblkgLSBsYXN0TW91c2VFdmVudC5zY3JlZW5ZOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFggPSAwOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RNb3VzZUV2ZW50ID0gZXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBNb3VzZUV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBzY3JlZW5YOiAwLAogICAgICAgICAgc2NyZWVuWTogMCwKICAgICAgICAgIGNsaWVudFg6IDAsCiAgICAgICAgICBjbGllbnRZOiAwLAogICAgICAgICAgcGFnZVg6IDAsCiAgICAgICAgICBwYWdlWTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICBidXR0b246IDAsCiAgICAgICAgICBidXR0b25zOiAwLAogICAgICAgICAgcmVsYXRlZFRhcmdldDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnJlbGF0ZWRUYXJnZXQgPT09IHZvaWQgMCkgcmV0dXJuIGV2ZW50LmZyb21FbGVtZW50ID09PSBldmVudC5zcmNFbGVtZW50ID8gZXZlbnQudG9FbGVtZW50IDogZXZlbnQuZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgfSwKICAgICAgICAgIG1vdmVtZW50WDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCJtb3ZlbWVudFgiIGluIGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVNb3VzZU1vdmVtZW50UG9seWZpbGxTdGF0ZShldmVudCk7CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRYOwogICAgICAgICAgfSwKICAgICAgICAgIG1vdmVtZW50WTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCJtb3ZlbWVudFkiIGluIGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljTW91c2VFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KE1vdXNlRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBEcmFnRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGFUcmFuc2ZlcjogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNEcmFnRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChEcmFnRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBGb2N1c0V2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0ZvY3VzRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChGb2N1c0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQW5pbWF0aW9uRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBhbmltYXRpb25OYW1lOiAwLAogICAgICAgICAgZWxhcHNlZFRpbWU6IDAsCiAgICAgICAgICBwc2V1ZG9FbGVtZW50OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQW5pbWF0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDbGlwYm9hcmRFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGNsaXBib2FyZERhdGE6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiY2xpcGJvYXJkRGF0YSIgaW4gZXZlbnQgPyBldmVudC5jbGlwYm9hcmREYXRhIDogd2luZG93LmNsaXBib2FyZERhdGE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgZGF0YTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0lucHV0RXZlbnQgPSBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50OwogICAgICAgIHZhciBub3JtYWxpemVLZXkgPSB7CiAgICAgICAgICBFc2M6ICJFc2NhcGUiLAogICAgICAgICAgU3BhY2ViYXI6ICIgIiwKICAgICAgICAgIExlZnQ6ICJBcnJvd0xlZnQiLAogICAgICAgICAgVXA6ICJBcnJvd1VwIiwKICAgICAgICAgIFJpZ2h0OiAiQXJyb3dSaWdodCIsCiAgICAgICAgICBEb3duOiAiQXJyb3dEb3duIiwKICAgICAgICAgIERlbDogIkRlbGV0ZSIsCiAgICAgICAgICBXaW46ICJPUyIsCiAgICAgICAgICBNZW51OiAiQ29udGV4dE1lbnUiLAogICAgICAgICAgQXBwczogIkNvbnRleHRNZW51IiwKICAgICAgICAgIFNjcm9sbDogIlNjcm9sbExvY2siLAogICAgICAgICAgTW96UHJpbnRhYmxlS2V5OiAiVW5pZGVudGlmaWVkIgogICAgICAgIH07CiAgICAgICAgdmFyIHRyYW5zbGF0ZVRvS2V5ID0gewogICAgICAgICAgIjgiOiAiQmFja3NwYWNlIiwKICAgICAgICAgICI5IjogIlRhYiIsCiAgICAgICAgICAiMTIiOiAiQ2xlYXIiLAogICAgICAgICAgIjEzIjogIkVudGVyIiwKICAgICAgICAgICIxNiI6ICJTaGlmdCIsCiAgICAgICAgICAiMTciOiAiQ29udHJvbCIsCiAgICAgICAgICAiMTgiOiAiQWx0IiwKICAgICAgICAgICIxOSI6ICJQYXVzZSIsCiAgICAgICAgICAiMjAiOiAiQ2Fwc0xvY2siLAogICAgICAgICAgIjI3IjogIkVzY2FwZSIsCiAgICAgICAgICAiMzIiOiAiICIsCiAgICAgICAgICAiMzMiOiAiUGFnZVVwIiwKICAgICAgICAgICIzNCI6ICJQYWdlRG93biIsCiAgICAgICAgICAiMzUiOiAiRW5kIiwKICAgICAgICAgICIzNiI6ICJIb21lIiwKICAgICAgICAgICIzNyI6ICJBcnJvd0xlZnQiLAogICAgICAgICAgIjM4IjogIkFycm93VXAiLAogICAgICAgICAgIjM5IjogIkFycm93UmlnaHQiLAogICAgICAgICAgIjQwIjogIkFycm93RG93biIsCiAgICAgICAgICAiNDUiOiAiSW5zZXJ0IiwKICAgICAgICAgICI0NiI6ICJEZWxldGUiLAogICAgICAgICAgIjExMiI6ICJGMSIsCiAgICAgICAgICAiMTEzIjogIkYyIiwKICAgICAgICAgICIxMTQiOiAiRjMiLAogICAgICAgICAgIjExNSI6ICJGNCIsCiAgICAgICAgICAiMTE2IjogIkY1IiwKICAgICAgICAgICIxMTciOiAiRjYiLAogICAgICAgICAgIjExOCI6ICJGNyIsCiAgICAgICAgICAiMTE5IjogIkY4IiwKICAgICAgICAgICIxMjAiOiAiRjkiLAogICAgICAgICAgIjEyMSI6ICJGMTAiLAogICAgICAgICAgIjEyMiI6ICJGMTEiLAogICAgICAgICAgIjEyMyI6ICJGMTIiLAogICAgICAgICAgIjE0NCI6ICJOdW1Mb2NrIiwKICAgICAgICAgICIxNDUiOiAiU2Nyb2xsTG9jayIsCiAgICAgICAgICAiMjI0IjogIk1ldGEiCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBnZXRFdmVudEtleShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmtleSkgewogICAgICAgICAgICB2YXIga2V5ID0gbm9ybWFsaXplS2V5W25hdGl2ZUV2ZW50LmtleV0gfHwgbmF0aXZlRXZlbnQua2V5OwogICAgICAgICAgICBpZiAoa2V5ICE9PSAiVW5pZGVudGlmaWVkIikgewogICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpOwogICAgICAgICAgICByZXR1cm4gY2hhckNvZGUgPT09IDEzID8gIkVudGVyIiA6IFN0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBuYXRpdmVFdmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgIHJldHVybiB0cmFuc2xhdGVUb0tleVtuYXRpdmVFdmVudC5rZXlDb2RlXSB8fCAiVW5pZGVudGlmaWVkIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIG1vZGlmaWVyS2V5VG9Qcm9wID0gewogICAgICAgICAgQWx0OiAiYWx0S2V5IiwKICAgICAgICAgIENvbnRyb2w6ICJjdHJsS2V5IiwKICAgICAgICAgIE1ldGE6ICJtZXRhS2V5IiwKICAgICAgICAgIFNoaWZ0OiAic2hpZnRLZXkiCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb2RpZmllclN0YXRlR2V0dGVyKGtleUFyZykgewogICAgICAgICAgdmFyIHN5bnRoZXRpY0V2ZW50ID0gdGhpczsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHN5bnRoZXRpY0V2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmdldE1vZGlmaWVyU3RhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmdldE1vZGlmaWVyU3RhdGUoa2V5QXJnKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBrZXlQcm9wID0gbW9kaWZpZXJLZXlUb1Byb3Bba2V5QXJnXTsKICAgICAgICAgIHJldHVybiBrZXlQcm9wID8gISFuYXRpdmVFdmVudFtrZXlQcm9wXSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudE1vZGlmaWVyU3RhdGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBtb2RpZmllclN0YXRlR2V0dGVyOwogICAgICAgIH0KICAgICAgICB2YXIgS2V5Ym9hcmRFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAga2V5OiBnZXRFdmVudEtleSwKICAgICAgICAgIGNvZGU6IDAsCiAgICAgICAgICBsb2NhdGlvbjogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICByZXBlYXQ6IDAsCiAgICAgICAgICBsb2NhbGU6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICAvLyBMZWdhY3kgSW50ZXJmYWNlCiAgICAgICAgICBjaGFyQ29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9LAogICAgICAgICAga2V5Q29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9LAogICAgICAgICAgd2hpY2g6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNLZXlib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoS2V5Ym9hcmRFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFBvaW50ZXJFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcG9pbnRlcklkOiAwLAogICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICBoZWlnaHQ6IDAsCiAgICAgICAgICBwcmVzc3VyZTogMCwKICAgICAgICAgIHRhbmdlbnRpYWxQcmVzc3VyZTogMCwKICAgICAgICAgIHRpbHRYOiAwLAogICAgICAgICAgdGlsdFk6IDAsCiAgICAgICAgICB0d2lzdDogMCwKICAgICAgICAgIHBvaW50ZXJUeXBlOiAwLAogICAgICAgICAgaXNQcmltYXJ5OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1BvaW50ZXJFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFBvaW50ZXJFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRvdWNoRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHRvdWNoZXM6IDAsCiAgICAgICAgICB0YXJnZXRUb3VjaGVzOiAwLAogICAgICAgICAgY2hhbmdlZFRvdWNoZXM6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1RvdWNoRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChUb3VjaEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcHJvcGVydHlOYW1lOiAwLAogICAgICAgICAgZWxhcHNlZFRpbWU6IDAsCiAgICAgICAgICBwc2V1ZG9FbGVtZW50OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFRyYW5zaXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFdoZWVsRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRlbHRhWDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJkZWx0YVgiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFYIDogKAogICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhWGAgZm9yIFdlYmtpdCBhbmQgbm9ybWFsaXplIChyaWdodCBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFYIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWCA6IDAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFZIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWSA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVlgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFZIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWSA6ICgKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhYCBmb3IgSUU8OSBhbmQgbm9ybWFsaXplIChkb3duIGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAgICJ3aGVlbERlbHRhIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhIDogMAogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVo6IDAsCiAgICAgICAgICAvLyBCcm93c2VycyB3aXRob3V0ICJkZWx0YU1vZGUiIGlzIHJlcG9ydGluZyBpbiByYXcgd2hlZWwgZGVsdGEgd2hlcmUgb25lCiAgICAgICAgICAvLyBub3RjaCBvbiB0aGUgc2Nyb2xsIGlzIGFsd2F5cyArLy0gMTIwLCByb3VnaGx5IGVxdWl2YWxlbnQgdG8gcGl4ZWxzLgogICAgICAgICAgLy8gQSBnb29kIGFwcHJveGltYXRpb24gb2YgRE9NX0RFTFRBX0xJTkUgKDEpIGlzIDUlIG9mIHZpZXdwb3J0IHNpemUgb3IKICAgICAgICAgIC8vIH40MCBwaXhlbHMsIGZvciBET01fREVMVEFfU0NSRUVOICgyKSBpdCBpcyA4Ny41JSBvZiB2aWV3cG9ydCBzaXplLgogICAgICAgICAgZGVsdGFNb2RlOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1doZWVsRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChXaGVlbEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRU5EX0tFWUNPREVTID0gWzksIDEzLCAyNywgMzJdOwogICAgICAgIHZhciBTVEFSVF9LRVlDT0RFID0gMjI5OwogICAgICAgIHZhciBjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ID0gY2FuVXNlRE9NICYmICJDb21wb3NpdGlvbkV2ZW50IiBpbiB3aW5kb3c7CiAgICAgICAgdmFyIGRvY3VtZW50TW9kZSA9IG51bGw7CiAgICAgICAgaWYgKGNhblVzZURPTSAmJiAiZG9jdW1lbnRNb2RlIiBpbiBkb2N1bWVudCkgewogICAgICAgICAgZG9jdW1lbnRNb2RlID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgY2FuVXNlVGV4dElucHV0RXZlbnQgPSBjYW5Vc2VET00gJiYgIlRleHRFdmVudCIgaW4gd2luZG93ICYmICFkb2N1bWVudE1vZGU7CiAgICAgICAgdmFyIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhID0gY2FuVXNlRE9NICYmICghY2FuVXNlQ29tcG9zaXRpb25FdmVudCB8fCBkb2N1bWVudE1vZGUgJiYgZG9jdW1lbnRNb2RlID4gOCAmJiBkb2N1bWVudE1vZGUgPD0gMTEpOwogICAgICAgIHZhciBTUEFDRUJBUl9DT0RFID0gMzI7CiAgICAgICAgdmFyIFNQQUNFQkFSX0NIQVIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKFNQQUNFQkFSX0NPREUpOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkJlZm9yZUlucHV0IiwgWyJjb21wb3NpdGlvbmVuZCIsICJrZXlwcmVzcyIsICJ0ZXh0SW5wdXQiLCAicGFzdGUiXSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25FbmQiLCBbImNvbXBvc2l0aW9uZW5kIiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uU3RhcnQiLCBbImNvbXBvc2l0aW9uc3RhcnQiLCAiZm9jdXNvdXQiLCAia2V5ZG93biIsICJrZXlwcmVzcyIsICJrZXl1cCIsICJtb3VzZWRvd24iXSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25VcGRhdGUiLCBbImNvbXBvc2l0aW9udXBkYXRlIiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzU3BhY2VLZXlwcmVzcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gKG5hdGl2ZUV2ZW50LmN0cmxLZXkgfHwgbmF0aXZlRXZlbnQuYWx0S2V5IHx8IG5hdGl2ZUV2ZW50Lm1ldGFLZXkpICYmIC8vIGN0cmxLZXkgJiYgYWx0S2V5IGlzIGVxdWl2YWxlbnQgdG8gQWx0R3IsIGFuZCBpcyBub3QgYSBjb21tYW5kLgogICAgICAgICAgIShuYXRpdmVFdmVudC5jdHJsS2V5ICYmIG5hdGl2ZUV2ZW50LmFsdEtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25zdGFydCI6CiAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uU3RhcnQiOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uRW5kIjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblVwZGF0ZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmFsbGJhY2tDb21wb3NpdGlvblN0YXJ0KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIiAmJiBuYXRpdmVFdmVudC5rZXlDb2RlID09PSBTVEFSVF9LRVlDT0RFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIHJldHVybiBFTkRfS0VZQ09ERVMuaW5kZXhPZihuYXRpdmVFdmVudC5rZXlDb2RlKSAhPT0gLTE7CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5rZXlDb2RlICE9PSBTVEFSVF9LRVlDT0RFOwogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBkZXRhaWwgPSBuYXRpdmVFdmVudC5kZXRhaWw7CiAgICAgICAgICBpZiAodHlwZW9mIGRldGFpbCA9PT0gIm9iamVjdCIgJiYgImRhdGEiIGluIGRldGFpbCkgewogICAgICAgICAgICByZXR1cm4gZGV0YWlsLmRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNVc2luZ0tvcmVhbklNRShuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmxvY2FsZSA9PT0gImtvIjsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQ29tcG9zaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBldmVudFR5cGU7CiAgICAgICAgICB2YXIgZmFsbGJhY2tEYXRhOwogICAgICAgICAgaWYgKGNhblVzZUNvbXBvc2l0aW9uRXZlbnQpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gZ2V0Q29tcG9zaXRpb25FdmVudFR5cGUoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIH0gZWxzZSBpZiAoIWlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgIGV2ZW50VHlwZSA9ICJvbkNvbXBvc2l0aW9uU3RhcnQiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWV2ZW50VHlwZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSAmJiAhaXNVc2luZ0tvcmVhbklNRShuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgaWYgKCFpc0NvbXBvc2luZyAmJiBldmVudFR5cGUgPT09ICJvbkNvbXBvc2l0aW9uU3RhcnQiKSB7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBpbml0aWFsaXplKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09ICJvbkNvbXBvc2l0aW9uRW5kIikgewogICAgICAgICAgICAgIGlmIChpc0NvbXBvc2luZykgewogICAgICAgICAgICAgICAgZmFsbGJhY2tEYXRhID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCBldmVudFR5cGUpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNDb21wb3NpdGlvbkV2ZW50KGV2ZW50VHlwZSwgZG9tRXZlbnROYW1lLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGZhbGxiYWNrRGF0YSkgewogICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBmYWxsYmFja0RhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGN1c3RvbURhdGEgPSBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICBpZiAoY3VzdG9tRGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGN1c3RvbURhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5hdGl2ZUJlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIHZhciB3aGljaCA9IG5hdGl2ZUV2ZW50LndoaWNoOwogICAgICAgICAgICAgIGlmICh3aGljaCAhPT0gU1BBQ0VCQVJfQ09ERSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhhc1NwYWNlS2V5cHJlc3MgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBTUEFDRUJBUl9DSEFSOwogICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICAgIHZhciBjaGFycyA9IG5hdGl2ZUV2ZW50LmRhdGE7CiAgICAgICAgICAgICAgaWYgKGNoYXJzID09PSBTUEFDRUJBUl9DSEFSICYmIGhhc1NwYWNlS2V5cHJlc3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZhbGxiYWNrQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNvbXBvc2l0aW9uZW5kIiB8fCAhY2FuVXNlQ29tcG9zaXRpb25FdmVudCAmJiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBnZXREYXRhKCk7CiAgICAgICAgICAgICAgcmVzZXQoKTsKICAgICAgICAgICAgICBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBjaGFyczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmICghaXNLZXlwcmVzc0NvbW1hbmQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuY2hhciAmJiBuYXRpdmVFdmVudC5jaGFyLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmNoYXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hdGl2ZUV2ZW50LndoaWNoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKG5hdGl2ZUV2ZW50LndoaWNoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gdXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpID8gbnVsbCA6IG5hdGl2ZUV2ZW50LmRhdGE7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RCZWZvcmVJbnB1dEV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgY2hhcnM7CiAgICAgICAgICBpZiAoY2FuVXNlVGV4dElucHV0RXZlbnQpIHsKICAgICAgICAgICAgY2hhcnMgPSBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hhcnMgPSBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCAib25CZWZvcmVJbnB1dCIpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNJbnB1dEV2ZW50KCJvbkJlZm9yZUlucHV0IiwgImJlZm9yZWlucHV0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjaGFyczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICBleHRyYWN0Q29tcG9zaXRpb25FdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgfQogICAgICAgIHZhciBzdXBwb3J0ZWRJbnB1dFR5cGVzID0gewogICAgICAgICAgY29sb3I6IHRydWUsCiAgICAgICAgICBkYXRlOiB0cnVlLAogICAgICAgICAgZGF0ZXRpbWU6IHRydWUsCiAgICAgICAgICAiZGF0ZXRpbWUtbG9jYWwiOiB0cnVlLAogICAgICAgICAgZW1haWw6IHRydWUsCiAgICAgICAgICBtb250aDogdHJ1ZSwKICAgICAgICAgIG51bWJlcjogdHJ1ZSwKICAgICAgICAgIHBhc3N3b3JkOiB0cnVlLAogICAgICAgICAgcmFuZ2U6IHRydWUsCiAgICAgICAgICBzZWFyY2g6IHRydWUsCiAgICAgICAgICB0ZWw6IHRydWUsCiAgICAgICAgICB0ZXh0OiB0cnVlLAogICAgICAgICAgdGltZTogdHJ1ZSwKICAgICAgICAgIHVybDogdHJ1ZSwKICAgICAgICAgIHdlZWs6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGlzVGV4dElucHV0RWxlbWVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtICYmIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiKSB7CiAgICAgICAgICAgIHJldHVybiAhIXN1cHBvcnRlZElucHV0VHlwZXNbZWxlbS50eXBlXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gInRleHRhcmVhIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFdmVudFN1cHBvcnRlZChldmVudE5hbWVTdWZmaXgpIHsKICAgICAgICAgIGlmICghY2FuVXNlRE9NKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudE5hbWUgPSAib24iICsgZXZlbnROYW1lU3VmZml4OwogICAgICAgICAgdmFyIGlzU3VwcG9ydGVkID0gZXZlbnROYW1lIGluIGRvY3VtZW50OwogICAgICAgICAgaWYgKCFpc1N1cHBvcnRlZCkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShldmVudE5hbWUsICJyZXR1cm47Iik7CiAgICAgICAgICAgIGlzU3VwcG9ydGVkID0gdHlwZW9mIGVsZW1lbnRbZXZlbnROYW1lXSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpc1N1cHBvcnRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMSgpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25DaGFuZ2UiLCBbImNoYW5nZSIsICJjbGljayIsICJmb2N1c2luIiwgImZvY3Vzb3V0IiwgImlucHV0IiwgImtleWRvd24iLCAia2V5dXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIHRhcmdldCkgewogICAgICAgICAgZW5xdWV1ZVN0YXRlUmVzdG9yZSh0YXJnZXQpOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhpbnN0LCAib25DaGFuZ2UiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnQoIm9uQ2hhbmdlIiwgImNoYW5nZSIsIG51bGwsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2hhbmdlRXZlbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICJzZWxlY3QiIHx8IG5vZGVOYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImZpbGUiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGFjdGl2ZUVsZW1lbnRJbnN0LCBuYXRpdmVFdmVudCwgZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpKTsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKHJ1bkV2ZW50SW5CYXRjaCwgZGlzcGF0Y2hRdWV1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bkV2ZW50SW5CYXRjaChkaXNwYXRjaFF1ZXVlKSB7CiAgICAgICAgICBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCAwKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KTsKICAgICAgICAgIGlmICh1cGRhdGVWYWx1ZUlmQ2hhbmdlZCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNoYW5nZSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBpc0V2ZW50U3VwcG9ydGVkKCJpbnB1dCIpICYmICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gdGFyZ2V0OwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgYWN0aXZlRWxlbWVudC5hdHRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKSB7CiAgICAgICAgICBpZiAoIWFjdGl2ZUVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYWN0aXZlRWxlbWVudC5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVQcm9wZXJ0eUNoYW5nZShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnByb3BlcnR5TmFtZSAhPT0gInZhbHVlIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KSkgewogICAgICAgICAgICBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXZlbnRzRm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNpbiIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgICAgc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3Vzb3V0IikgewogICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInNlbGVjdGlvbmNoYW5nZSIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5dXAiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQoYWN0aXZlRWxlbWVudEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDbGlja0V2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0udHlwZSA9PT0gInJhZGlvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNsaWNrIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImlucHV0IiB8fCBkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIobm9kZSkgewogICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5fd3JhcHBlclN0YXRlOwogICAgICAgICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuY29udHJvbGxlZCB8fCBub2RlLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsICJudW1iZXIiLCBub2RlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICB2YXIgZ2V0VGFyZ2V0SW5zdEZ1bmMsIGhhbmRsZUV2ZW50RnVuYzsKICAgICAgICAgIGlmIChzaG91bGRVc2VDaGFuZ2VFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGlmIChpc0lucHV0RXZlbnRTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dE9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsOwogICAgICAgICAgICAgIGhhbmRsZUV2ZW50RnVuYyA9IGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRVc2VDbGlja0V2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvckNsaWNrRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0VGFyZ2V0SW5zdEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGluc3QgPSBnZXRUYXJnZXRJbnN0RnVuYyhkb21FdmVudE5hbWUsIHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhbmRsZUV2ZW50RnVuYykgewogICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXROb2RlLCB0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cih0YXJnZXROb2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMigpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VFbnRlciIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUxlYXZlIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJFbnRlciIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uUG9pbnRlckxlYXZlIiwgWyJwb2ludGVyb3V0IiwgInBvaW50ZXJvdmVyIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGlzT3ZlckV2ZW50ID0gZG9tRXZlbnROYW1lID09PSAibW91c2VvdmVyIiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciI7CiAgICAgICAgICB2YXIgaXNPdXRFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IjsKICAgICAgICAgIGlmIChpc092ZXJFdmVudCAmJiAhaXNSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgdmFyIHJlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVsYXRlZCkgewogICAgICAgICAgICAgIGlmIChnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShyZWxhdGVkKSB8fCBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChyZWxhdGVkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc091dEV2ZW50ICYmICFpc092ZXJFdmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2luOwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgd2luID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZG9jID0gbmF0aXZlRXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKGRvYykgewogICAgICAgICAgICAgIHdpbiA9IGRvYy5kZWZhdWx0VmlldyB8fCBkb2MucGFyZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdpbiA9IHdpbmRvdzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb207CiAgICAgICAgICB2YXIgdG87CiAgICAgICAgICBpZiAoaXNPdXRFdmVudCkgewogICAgICAgICAgICB2YXIgX3JlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnRvRWxlbWVudDsKICAgICAgICAgICAgZnJvbSA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRvID0gX3JlbGF0ZWQgPyBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShfcmVsYXRlZCkgOiBudWxsOwogICAgICAgICAgICBpZiAodG8gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRvKTsKICAgICAgICAgICAgICBpZiAodG8gIT09IG5lYXJlc3RNb3VudGVkIHx8IHRvLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiB0by50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICB0byA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcm9tID0gbnVsbDsKICAgICAgICAgICAgdG8gPSB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZyb20gPT09IHRvKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNNb3VzZUV2ZW50OwogICAgICAgICAgdmFyIGxlYXZlRXZlbnRUeXBlID0gIm9uTW91c2VMZWF2ZSI7CiAgICAgICAgICB2YXIgZW50ZXJFdmVudFR5cGUgPSAib25Nb3VzZUVudGVyIjsKICAgICAgICAgIHZhciBldmVudFR5cGVQcmVmaXggPSAibW91c2UiOwogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdXQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdmVyIikgewogICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNQb2ludGVyRXZlbnQ7CiAgICAgICAgICAgIGxlYXZlRXZlbnRUeXBlID0gIm9uUG9pbnRlckxlYXZlIjsKICAgICAgICAgICAgZW50ZXJFdmVudFR5cGUgPSAib25Qb2ludGVyRW50ZXIiOwogICAgICAgICAgICBldmVudFR5cGVQcmVmaXggPSAicG9pbnRlciI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnJvbU5vZGUgPSBmcm9tID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKGZyb20pOwogICAgICAgICAgdmFyIHRvTm9kZSA9IHRvID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKHRvKTsKICAgICAgICAgIHZhciBsZWF2ZSA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IobGVhdmVFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJsZWF2ZSIsIGZyb20sIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBsZWF2ZS50YXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgIGxlYXZlLnJlbGF0ZWRUYXJnZXQgPSB0b05vZGU7CiAgICAgICAgICB2YXIgZW50ZXIgPSBudWxsOwogICAgICAgICAgdmFyIG5hdGl2ZVRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAobmF0aXZlVGFyZ2V0SW5zdCA9PT0gdGFyZ2V0SW5zdCkgewogICAgICAgICAgICB2YXIgZW50ZXJFdmVudCA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IoZW50ZXJFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJlbnRlciIsIHRvLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBlbnRlckV2ZW50LnRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgICAgZW50ZXJFdmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICAgIGVudGVyID0gZW50ZXJFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmUsIGVudGVyLCBmcm9tLCB0byk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzKHgsIHkpIHsKICAgICAgICAgIHJldHVybiB4ID09PSB5ICYmICh4ICE9PSAwIHx8IDEgLyB4ID09PSAxIC8geSkgfHwgeCAhPT0geCAmJiB5ICE9PSB5OwogICAgICAgIH0KICAgICAgICB2YXIgb2JqZWN0SXMgPSB0eXBlb2YgT2JqZWN0LmlzID09PSAiZnVuY3Rpb24iID8gT2JqZWN0LmlzIDogaXM7CiAgICAgICAgZnVuY3Rpb24gc2hhbGxvd0VxdWFsKG9iakEsIG9iakIpIHsKICAgICAgICAgIGlmIChvYmplY3RJcyhvYmpBLCBvYmpCKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgICAgICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwogICAgICAgICAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5c0EubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRLZXkgPSBrZXlzQVtpXTsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8ICFvYmplY3RJcyhvYmpBW2N1cnJlbnRLZXldLCBvYmpCW2N1cnJlbnRLZXldKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWZOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNpYmxpbmdOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChyb290Mywgb2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGdldExlYWZOb2RlKHJvb3QzKTsKICAgICAgICAgIHZhciBub2RlU3RhcnQgPSAwOwogICAgICAgICAgdmFyIG5vZGVFbmQgPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIG5vZGVFbmQgPSBub2RlU3RhcnQgKyBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICBpZiAobm9kZVN0YXJ0IDw9IG9mZnNldCAmJiBub2RlRW5kID49IG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBvZmZzZXQgLSBub2RlU3RhcnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGVTdGFydCA9IG5vZGVFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IGdldExlYWZOb2RlKGdldFNpYmxpbmdOb2RlKG5vZGUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T2Zmc2V0cyhvdXRlck5vZGUpIHsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gb3V0ZXJOb2RlLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gb3duZXJEb2N1bWVudCAmJiBvd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uICYmIHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxlY3Rpb24uYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0ID0gc2VsZWN0aW9uLmFuY2hvck9mZnNldCwgZm9jdXNOb2RlID0gc2VsZWN0aW9uLmZvY3VzTm9kZSwgZm9jdXNPZmZzZXQgPSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhbmNob3JOb2RlLm5vZGVUeXBlOwogICAgICAgICAgICBmb2N1c05vZGUubm9kZVR5cGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpIHsKICAgICAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICAgICAgdmFyIHN0YXJ0ID0gLTE7CiAgICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5BbmNob3IgPSAwOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluRm9jdXMgPSAwOwogICAgICAgICAgdmFyIG5vZGUgPSBvdXRlck5vZGU7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBvdXRlcjogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlID09PSBhbmNob3JOb2RlICYmIChhbmNob3JPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGggKyBhbmNob3JPZmZzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmb2N1c05vZGUgJiYgKGZvY3VzT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aCArIGZvY3VzT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBsZW5ndGggKz0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLmZpcnN0Q2hpbGQpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGFuY2hvck5vZGUgJiYgKytpbmRleFdpdGhpbkFuY2hvciA9PT0gYW5jaG9yT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IGxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGZvY3VzTm9kZSAmJiArK2luZGV4V2l0aGluRm9jdXMgPT09IGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUubmV4dFNpYmxpbmcpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGFydCA9PT0gLTEgfHwgZW5kID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICBlbmQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldE9mZnNldHMobm9kZSwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIHZhciB3aW4gPSBkb2MgJiYgZG9jLmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICghd2luLmdldFNlbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IG5vZGUudGV4dENvbnRlbnQubGVuZ3RoOwogICAgICAgICAgdmFyIHN0YXJ0ID0gTWF0aC5taW4ob2Zmc2V0cy5zdGFydCwgbGVuZ3RoKTsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZCA9PT0gdm9pZCAwID8gc3RhcnQgOiBNYXRoLm1pbihvZmZzZXRzLmVuZCwgbGVuZ3RoKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uLmV4dGVuZCAmJiBzdGFydCA+IGVuZCkgewogICAgICAgICAgICB2YXIgdGVtcCA9IGVuZDsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICAgIHN0YXJ0ID0gdGVtcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgc3RhcnQpOwogICAgICAgICAgdmFyIGVuZE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgZW5kKTsKICAgICAgICAgIGlmIChzdGFydE1hcmtlciAmJiBlbmRNYXJrZXIpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAxICYmIHNlbGVjdGlvbi5hbmNob3JOb2RlID09PSBzdGFydE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbi5hbmNob3JPZmZzZXQgPT09IHN0YXJ0TWFya2VyLm9mZnNldCAmJiBzZWxlY3Rpb24uZm9jdXNOb2RlID09PSBlbmRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQgPT09IGVuZE1hcmtlci5vZmZzZXQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHN0YXJ0TWFya2VyLm5vZGUsIHN0YXJ0TWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgICAgICAgaWYgKHN0YXJ0ID4gZW5kKSB7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlKTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uZXh0ZW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByYW5nZS5zZXRFbmQoZW5kTWFya2VyLm5vZGUsIGVuZE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUZXh0Tm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZSkgewogICAgICAgICAgaWYgKCFvdXRlck5vZGUgfHwgIWlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZSA9PT0gaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKG91dGVyTm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKGlubmVyTm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZS5wYXJlbnROb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoImNvbnRhaW5zIiBpbiBvdXRlck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG91dGVyTm9kZS5jb250YWlucyhpbm5lck5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuICEhKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihpbm5lck5vZGUpICYgMTYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0luRG9jdW1lbnQobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5vd25lckRvY3VtZW50ICYmIGNvbnRhaW5zTm9kZShub2RlLm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTYW1lT3JpZ2luRnJhbWUoaWZyYW1lKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGlmcmFtZS5jb250ZW50V2luZG93LmxvY2F0aW9uLmhyZWYgPT09ICJzdHJpbmciOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QWN0aXZlRWxlbWVudERlZXAoKSB7CiAgICAgICAgICB2YXIgd2luID0gd2luZG93OwogICAgICAgICAgdmFyIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KCk7CiAgICAgICAgICB3aGlsZSAoZWxlbWVudCBpbnN0YW5jZW9mIHdpbi5IVE1MSUZyYW1lRWxlbWVudCkgewogICAgICAgICAgICBpZiAoaXNTYW1lT3JpZ2luRnJhbWUoZWxlbWVudCkpIHsKICAgICAgICAgICAgICB3aW4gPSBlbGVtZW50LmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQod2luLmRvY3VtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gInRleHQiIHx8IGVsZW0udHlwZSA9PT0gInNlYXJjaCIgfHwgZWxlbS50eXBlID09PSAidGVsIiB8fCBlbGVtLnR5cGUgPT09ICJ1cmwiIHx8IGVsZW0udHlwZSA9PT0gInBhc3N3b3JkIikgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgfHwgZWxlbS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCkgewogICAgICAgICAgdmFyIGZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGZvY3VzZWRFbGVtLAogICAgICAgICAgICBzZWxlY3Rpb25SYW5nZTogaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGZvY3VzZWRFbGVtKSA/IGdldFNlbGVjdGlvbihmb2N1c2VkRWxlbSkgOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU2VsZWN0aW9uKHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24pIHsKICAgICAgICAgIHZhciBjdXJGb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICB2YXIgcHJpb3JGb2N1c2VkRWxlbSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uZm9jdXNlZEVsZW07CiAgICAgICAgICB2YXIgcHJpb3JTZWxlY3Rpb25SYW5nZSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uc2VsZWN0aW9uUmFuZ2U7CiAgICAgICAgICBpZiAoY3VyRm9jdXNlZEVsZW0gIT09IHByaW9yRm9jdXNlZEVsZW0gJiYgaXNJbkRvY3VtZW50KHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgIGlmIChwcmlvclNlbGVjdGlvblJhbmdlICE9PSBudWxsICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICAgIHNldFNlbGVjdGlvbihwcmlvckZvY3VzZWRFbGVtLCBwcmlvclNlbGVjdGlvblJhbmdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYW5jZXN0b3JzID0gW107CiAgICAgICAgICAgIHZhciBhbmNlc3RvciA9IHByaW9yRm9jdXNlZEVsZW07CiAgICAgICAgICAgIHdoaWxlIChhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3Iubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgYW5jZXN0b3JzLnB1c2goewogICAgICAgICAgICAgICAgICBlbGVtZW50OiBhbmNlc3RvciwKICAgICAgICAgICAgICAgICAgbGVmdDogYW5jZXN0b3Iuc2Nyb2xsTGVmdCwKICAgICAgICAgICAgICAgICAgdG9wOiBhbmNlc3Rvci5zY3JvbGxUb3AKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcmlvckZvY3VzZWRFbGVtLmZvY3VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbmNlc3RvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9IGFuY2VzdG9yc1tpXTsKICAgICAgICAgICAgICBpbmZvLmVsZW1lbnQuc2Nyb2xsTGVmdCA9IGluZm8ubGVmdDsKICAgICAgICAgICAgICBpbmZvLmVsZW1lbnQuc2Nyb2xsVG9wID0gaW5mby50b3A7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGlucHV0KSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uOwogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gewogICAgICAgICAgICAgIHN0YXJ0OiBpbnB1dC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBlbmQ6IGlucHV0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gZ2V0T2Zmc2V0cyhpbnB1dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2VsZWN0aW9uIHx8IHsKICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgIGVuZDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKGlucHV0LCBvZmZzZXRzKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBvZmZzZXRzLnN0YXJ0OwogICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kOwogICAgICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uRW5kID0gTWF0aC5taW4oZW5kLCBpbnB1dC52YWx1ZS5sZW5ndGgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0T2Zmc2V0cyhpbnB1dCwgb2Zmc2V0cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbChsYXN0U2VsZWN0aW9uLCBjdXJyZW50U2VsZWN0aW9uKSkgewogICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhhY3RpdmVFbGVtZW50SW5zdCQxLCAib25TZWxlY3QiKTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvblNlbGVjdCIsICJzZWxlY3QiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGFjdGl2ZUVsZW1lbnQkMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSB0YXJnZXRJbnN0ID8gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KSA6IHdpbmRvdzsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIGlmIChpc1RleHRJbnB1dEVsZW1lbnQodGFyZ2V0Tm9kZSkgfHwgdGFyZ2V0Tm9kZS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIikgewogICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gdGFyZ2V0Tm9kZTsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICAgIGlmIChza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYWtlUHJlZml4TWFwKHN0eWxlUHJvcCwgZXZlbnROYW1lKSB7CiAgICAgICAgICB2YXIgcHJlZml4ZXMyID0ge307CiAgICAgICAgICBwcmVmaXhlczJbc3R5bGVQcm9wLnRvTG93ZXJDYXNlKCldID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBwcmVmaXhlczJbIldlYmtpdCIgKyBzdHlsZVByb3BdID0gIndlYmtpdCIgKyBldmVudE5hbWU7CiAgICAgICAgICBwcmVmaXhlczJbIk1veiIgKyBzdHlsZVByb3BdID0gIm1veiIgKyBldmVudE5hbWU7CiAgICAgICAgICByZXR1cm4gcHJlZml4ZXMyOwogICAgICAgIH0KICAgICAgICB2YXIgdmVuZG9yUHJlZml4ZXMgPSB7CiAgICAgICAgICBhbmltYXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25FbmQiKSwKICAgICAgICAgIGFuaW1hdGlvbml0ZXJhdGlvbjogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkl0ZXJhdGlvbiIpLAogICAgICAgICAgYW5pbWF0aW9uc3RhcnQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25TdGFydCIpLAogICAgICAgICAgdHJhbnNpdGlvbmVuZDogbWFrZVByZWZpeE1hcCgiVHJhbnNpdGlvbiIsICJUcmFuc2l0aW9uRW5kIikKICAgICAgICB9OwogICAgICAgIHZhciBwcmVmaXhlZEV2ZW50TmFtZXMgPSB7fTsKICAgICAgICB2YXIgc3R5bGUgPSB7fTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlOwogICAgICAgICAgaWYgKCEoIkFuaW1hdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25lbmQuYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uaXRlcmF0aW9uLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbnN0YXJ0LmFuaW1hdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKCJUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLnRyYW5zaXRpb25lbmQudHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoZXZlbnROYW1lKSB7CiAgICAgICAgICBpZiAocHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdOwogICAgICAgICAgfSBlbHNlIGlmICghdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZWZpeE1hcCA9IHZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV07CiAgICAgICAgICBmb3IgKHZhciBzdHlsZVByb3AgaW4gcHJlZml4TWFwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXhNYXAuaGFzT3duUHJvcGVydHkoc3R5bGVQcm9wKSAmJiBzdHlsZVByb3AgaW4gc3R5bGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0gPSBwcmVmaXhNYXBbc3R5bGVQcm9wXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICB9CiAgICAgICAgdmFyIEFOSU1BVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uZW5kIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9JVEVSQVRJT04gPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uaXRlcmF0aW9uIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9TVEFSVCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25zdGFydCIpOwogICAgICAgIHZhciBUUkFOU0lUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJ0cmFuc2l0aW9uZW5kIik7CiAgICAgICAgdmFyIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMgPSBbImFib3J0IiwgImF1eENsaWNrIiwgImNhbmNlbCIsICJjYW5QbGF5IiwgImNhblBsYXlUaHJvdWdoIiwgImNsaWNrIiwgImNsb3NlIiwgImNvbnRleHRNZW51IiwgImNvcHkiLCAiY3V0IiwgImRyYWciLCAiZHJhZ0VuZCIsICJkcmFnRW50ZXIiLCAiZHJhZ0V4aXQiLCAiZHJhZ0xlYXZlIiwgImRyYWdPdmVyIiwgImRyYWdTdGFydCIsICJkcm9wIiwgImR1cmF0aW9uQ2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImdvdFBvaW50ZXJDYXB0dXJlIiwgImlucHV0IiwgImludmFsaWQiLCAia2V5RG93biIsICJrZXlQcmVzcyIsICJrZXlVcCIsICJsb2FkIiwgImxvYWRlZERhdGEiLCAibG9hZGVkTWV0YWRhdGEiLCAibG9hZFN0YXJ0IiwgImxvc3RQb2ludGVyQ2FwdHVyZSIsICJtb3VzZURvd24iLCAibW91c2VNb3ZlIiwgIm1vdXNlT3V0IiwgIm1vdXNlT3ZlciIsICJtb3VzZVVwIiwgInBhc3RlIiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwb2ludGVyQ2FuY2VsIiwgInBvaW50ZXJEb3duIiwgInBvaW50ZXJNb3ZlIiwgInBvaW50ZXJPdXQiLCAicG9pbnRlck92ZXIiLCAicG9pbnRlclVwIiwgInByb2dyZXNzIiwgInJhdGVDaGFuZ2UiLCAicmVzZXQiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VibWl0IiwgInN1c3BlbmQiLCAidGltZVVwZGF0ZSIsICJ0b3VjaENhbmNlbCIsICJ0b3VjaEVuZCIsICJ0b3VjaFN0YXJ0IiwgInZvbHVtZUNoYW5nZSIsICJzY3JvbGwiLCAidG9nZ2xlIiwgInRvdWNoTW92ZSIsICJ3YWl0aW5nIiwgIndoZWVsIl07CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSkgewogICAgICAgICAgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuc2V0KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWFjdE5hbWUsIFtkb21FdmVudE5hbWVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudHMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBzaW1wbGVFdmVudFBsdWdpbkV2ZW50c1tpXTsKICAgICAgICAgICAgdmFyIGRvbUV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgY2FwaXRhbGl6ZWRFdmVudCA9IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnNsaWNlKDEpOwogICAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgIm9uIiArIGNhcGl0YWxpemVkRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fRU5ELCAib25BbmltYXRpb25FbmQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0lURVJBVElPTiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9TVEFSVCwgIm9uQW5pbWF0aW9uU3RhcnQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImRibGNsaWNrIiwgIm9uRG91YmxlQ2xpY2siKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3VzaW4iLCAib25Gb2N1cyIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNvdXQiLCAib25CbHVyIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KFRSQU5TSVRJT05fRU5ELCAib25UcmFuc2l0aW9uRW5kIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgcmVhY3ROYW1lID0gdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuZ2V0KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAocmVhY3ROYW1lID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0V2ZW50OwogICAgICAgICAgdmFyIHJlYWN0RXZlbnRUeXBlID0gZG9tRXZlbnROYW1lOwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmIChnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNLZXlib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJmb2N1cyI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImJsdXIiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuYnV0dG9uID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0RyYWdFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RvdWNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0VORDoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fSVRFUkFUSU9OOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9TVEFSVDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNBbmltYXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUUkFOU0lUSU9OX0VORDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVUlFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1doZWVsRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQ2xpcGJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY2N1bXVsYXRlVGFyZ2V0T25seSA9ICFpbkNhcHR1cmVQaGFzZSAmJiAvLyBUT0RPOiBpZGVhbGx5LCB3ZSdkIGV2ZW50dWFsbHkgYWRkIGFsbCBldmVudHMgZnJvbQogICAgICAgICAgICAvLyBub25EZWxlZ2F0ZWRFdmVudHMgbGlzdCBpbiBET01QbHVnaW5FdmVudFN5c3RlbS4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBjYW4gcmVtb3ZlIHRoaXMgc3BlY2lhbCBsaXN0LgogICAgICAgICAgICAvLyBUaGlzIGlzIGEgYnJlYWtpbmcgY2hhbmdlIHRoYXQgY2FuIHdhaXQgdW50aWwgUmVhY3QgMTguCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSA9PT0gInNjcm9sbCI7CiAgICAgICAgICAgIHZhciBfbGlzdGVuZXJzID0gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnQudHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5KTsKICAgICAgICAgICAgaWYgKF9saXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBfZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50OiBfZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IF9saXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50cygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDIoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQxKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzKCk7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucyA9IChldmVudFN5c3RlbUZsYWdzICYgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMpID09PSAwOwogICAgICAgICAgaWYgKHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMpIHsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBtZWRpYUV2ZW50VHlwZXMgPSBbImFib3J0IiwgImNhbnBsYXkiLCAiY2FucGxheXRocm91Z2giLCAiZHVyYXRpb25jaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAibG9hZGVkZGF0YSIsICJsb2FkZWRtZXRhZGF0YSIsICJsb2Fkc3RhcnQiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInByb2dyZXNzIiwgInJhdGVjaGFuZ2UiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VzcGVuZCIsICJ0aW1ldXBkYXRlIiwgInZvbHVtZWNoYW5nZSIsICJ3YWl0aW5nIl07CiAgICAgICAgdmFyIG5vbkRlbGVnYXRlZEV2ZW50cyA9IG5ldyBTZXQoWyJjYW5jZWwiLCAiY2xvc2UiLCAiaW52YWxpZCIsICJsb2FkIiwgInNjcm9sbCIsICJ0b2dnbGUiXS5jb25jYXQobWVkaWFFdmVudFR5cGVzKSk7CiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyLCB2b2lkIDAsIGV2ZW50KTsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZUl0ZW1zSW5PcmRlcihldmVudCwgZGlzcGF0Y2hMaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZTsKICAgICAgICAgIGlmIChpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICB2YXIgX2Rpc3BhdGNoTGlzdGVuZXJzJGkgPSBkaXNwYXRjaExpc3RlbmVyc1tpXSwgaW5zdGFuY2UgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5pbnN0YW5jZSwgY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmN1cnJlbnRUYXJnZXQsIGxpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyID0gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgdmFyIGlzUGFzc2l2ZUxpc3RlbmVyID0gdm9pZCAwOwogICAgICAgICAgaWYgKHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJ0b3VjaHN0YXJ0IiB8fCBkb21FdmVudE5hbWUgPT09ICJ0b3VjaG1vdmUiIHx8IGRvbUV2ZW50TmFtZSA9PT0gIndoZWVsIikgewogICAgICAgICAgICAgIGlzUGFzc2l2ZUxpc3RlbmVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgdmFyIHVuc3Vic2NyaWJlTGlzdGVuZXI7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBpZiAoaXNQYXNzaXZlTGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBncmFuZENvbnRhaW5lciA9PT0gdGFyZ2V0Q29udGFpbmVyIHx8IGdyYW5kQ29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgZ3JhbmRDb250YWluZXIucGFyZW50Tm9kZSA9PT0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3JJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGlmICgoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFKSA9PT0gMCAmJiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX05PTl9ERUxFR0FURUQpID09PSAwKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJOb2RlID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICBtYWluTG9vcDogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBub2RlVGFnID0gbm9kZS50YWc7CiAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFJvb3QgfHwgbm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihjb250YWluZXIyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kTm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChncmFuZE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZFRhZyA9IGdyYW5kTm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRUYWcgPT09IEhvc3RSb290IHx8IGdyYW5kVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZENvbnRhaW5lciA9IGdyYW5kTm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZ3JhbmROb2RlID0gZ3JhbmROb2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvbnRhaW5lcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHBhcmVudFRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBhbmNlc3Rvckluc3QgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWUgbWFpbkxvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hFdmVudHNGb3JQbHVnaW5zKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIGFuY2VzdG9ySW5zdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lciwKICAgICAgICAgICAgY3VycmVudFRhcmdldAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50VHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5LCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICE9PSBudWxsID8gcmVhY3ROYW1lICsgIkNhcHR1cmUiIDogbnVsbDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50TmFtZSA9IGluQ2FwdHVyZVBoYXNlID8gY2FwdHVyZU5hbWUgOiByZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHZhciBsYXN0SG9zdENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMi5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTIudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RIb3N0Q29tcG9uZW50ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChyZWFjdEV2ZW50TmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyLCBsYXN0SG9zdENvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWNjdW11bGF0ZVRhcmdldE9ubHkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgKyAiQ2FwdHVyZSI7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMyA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UzLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMy50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50KGluc3QpIHsKICAgICAgICAgIGlmIChpbnN0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICBpbnN0ID0gaW5zdC5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChpbnN0ICYmIGluc3QudGFnICE9PSBIb3N0Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGluc3RBLCBpbnN0QikgewogICAgICAgICAgdmFyIG5vZGVBID0gaW5zdEE7CiAgICAgICAgICB2YXIgbm9kZUIgPSBpbnN0QjsKICAgICAgICAgIHZhciBkZXB0aEEgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBub2RlQTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICBkZXB0aEErKzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aEIgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEIgPSBub2RlQjsgdGVtcEI7IHRlbXBCID0gZ2V0UGFyZW50KHRlbXBCKSkgewogICAgICAgICAgICBkZXB0aEIrKzsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEEgLSBkZXB0aEIgPiAwKSB7CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhCIC0gZGVwdGhBID4gMCkgewogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICAgIGRlcHRoQi0tOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoID0gZGVwdGhBOwogICAgICAgICAgd2hpbGUgKGRlcHRoLS0pIHsKICAgICAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQiB8fCBub2RlQiAhPT0gbnVsbCAmJiBub2RlQSA9PT0gbm9kZUIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVBOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZXZlbnQsIHRhcmdldCwgY29tbW9uLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBldmVudC5fcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0OwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBpbnN0YW5jZSwgYWx0ZXJuYXRlID0gX2luc3RhbmNlNC5hbHRlcm5hdGUsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTQuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2U0LnRhZzsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGVudGVyRXZlbnQsIGZyb20sIHRvKSB7CiAgICAgICAgICB2YXIgY29tbW9uID0gZnJvbSAmJiB0byA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20sIHRvKSA6IG51bGw7CiAgICAgICAgICBpZiAoZnJvbSAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20sIGNvbW1vbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRvICE9PSBudWxsICYmIGVudGVyRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBlbnRlckV2ZW50LCB0bywgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00gJiYgIWRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKHByb3BOYW1lLCBzZXJ2ZXJWYWx1ZSwgY2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VmFsdWUgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VmFsdWUpOwogICAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclZhbHVlKTsKICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9PT0gbm9ybWFsaXplZENsaWVudFZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIlByb3AgYCVzYCBkaWQgbm90IG1hdGNoLiBTZXJ2ZXI6ICVzIENsaWVudDogJXMiLCBwcm9wTmFtZSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZFNlcnZlclZhbHVlKSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZENsaWVudFZhbHVlKSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckV4dHJhQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWVzKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXJyb3IoIkV4dHJhIGF0dHJpYnV0ZXMgZnJvbSB0aGUgc2VydmVyOiAlcyIsIG5hbWVzKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihyZWdpc3RyYXRpb25OYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICBpZiAobGlzdGVuZXIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBub3JtYWxpemVIVE1MID0gZnVuY3Rpb24ocGFyZW50LCBodG1sKSB7CiAgICAgICAgICAgIHZhciB0ZXN0RWxlbWVudCA9IHBhcmVudC5uYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFID8gcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChwYXJlbnQudGFnTmFtZSkgOiBwYXJlbnQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50TlMocGFyZW50Lm5hbWVzcGFjZVVSSSwgcGFyZW50LnRhZ05hbWUpOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICByZXR1cm4gdGVzdEVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCA9IC9cclxuPy9nOwogICAgICAgIHZhciBOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVggPSAvXHUwMDAwfFx1RkZGRC9nOwogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShtYXJrdXApIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24obWFya3VwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXJrdXBTdHJpbmcgPSB0eXBlb2YgbWFya3VwID09PSAic3RyaW5nIiA/IG1hcmt1cCA6ICIiICsgbWFya3VwOwogICAgICAgICAgcmV0dXJuIG1hcmt1cFN0cmluZy5yZXBsYWNlKE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCwgIlxuIikucmVwbGFjZShOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVgsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHNlcnZlclRleHQsIGNsaWVudFRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShjbGllbnRUZXh0KTsKICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJUZXh0KTsKICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVGV4dCA9PT0gbm9ybWFsaXplZENsaWVudFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCdUZXh0IGNvbnRlbnQgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAiJXMiIENsaWVudDogIiVzIicsIG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0LCBub3JtYWxpemVkQ2xpZW50VGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSAmJiBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGV4dCBjb250ZW50IGRvZXMgbm90IG1hdGNoIHNlcnZlci1yZW5kZXJlZCBIVE1MLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQobm9kZSkgewogICAgICAgICAgbm9kZS5vbmNsaWNrID0gbm9vcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50Myh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQsIHBhcmVudE5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgdmFyIGRvbUVsZW1lbnQ7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlVVJJID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgbmFtZXNwYWNlVVJJID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgdHlwZSAhPT0gdHlwZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiPCVzIC8+IGlzIHVzaW5nIGluY29ycmVjdCBjYXNpbmcuIFVzZSBQYXNjYWxDYXNlIGZvciBSZWFjdCBjb21wb25lbnRzLCBvciBsb3dlcmNhc2UgZm9yIEhUTUwgZWxlbWVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlID09PSAic2NyaXB0IikgewogICAgICAgICAgICAgIHZhciBkaXYgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAiPHNjcmlwdD48XC9zY3JpcHQ+IjsKICAgICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGRpdi5maXJzdENoaWxkOwogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBkaXYucmVtb3ZlQ2hpbGQoZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSwgewogICAgICAgICAgICAgICAgaXM6IHByb3BzLmlzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gZG9tRWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICBub2RlLm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuc2l6ZSkgewogICAgICAgICAgICAgICAgICBub2RlLnNpemUgPSBwcm9wcy5zaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSSwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9tRWxlbWVudCkgPT09ICJbb2JqZWN0IEhUTUxVbmtub3duRWxlbWVudF0iICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFVua25vd25UYWdzLCB0eXBlKSkgewogICAgICAgICAgICAgICAgd2FybmVkVW5rbm93blRhZ3NbdHlwZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSB0YWcgPCVzPiBpcyB1bnJlY29nbml6ZWQgaW4gdGhpcyBicm93c2VyLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgUmVhY3QgY29tcG9uZW50LCBzdGFydCBpdHMgbmFtZSB3aXRoIGFuIHVwcGVyY2FzZSBsZXR0ZXIuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCwgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ2aWRlbyI6CiAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lZGlhRXZlbnRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChtZWRpYUV2ZW50VHlwZXNbaV0sIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcyk7CiAgICAgICAgICBzZXRJbml0aWFsRE9NUHJvcGVydGllcyh0YWcsIGRvbUVsZW1lbnQsIHJvb3RDb250YWluZXJFbGVtZW50LCBwcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMyhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgbGFzdFJhd1Byb3BzLCBuZXh0UmF3UHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgdmFyIGxhc3RQcm9wczsKICAgICAgICAgIHZhciBuZXh0UHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGxhc3RSYXdQcm9wczsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBuZXh0UmF3UHJvcHM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXN0UHJvcHMub25DbGljayAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbmV4dFByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBuZXh0UHJvcHMpOwogICAgICAgICAgdmFyIHByb3BLZXk7CiAgICAgICAgICB2YXIgc3R5bGVOYW1lOwogICAgICAgICAgdmFyIHN0eWxlVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbGFzdFByb3BzKSB7CiAgICAgICAgICAgIGlmIChuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgIWxhc3RQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBsYXN0UHJvcHNbcHJvcEtleV0gPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHZhciBsYXN0U3R5bGUgPSBsYXN0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFN0eWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdFN0eWxlLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCB8fCBwcm9wS2V5ID09PSBDSElMRFJFTikgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IG5leHRQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgdmFyIGxhc3RQcm9wID0gbGFzdFByb3BzICE9IG51bGwgPyBsYXN0UHJvcHNbcHJvcEtleV0gOiB2b2lkIDA7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IG5leHRQcm9wID09PSBsYXN0UHJvcCB8fCBuZXh0UHJvcCA9PSBudWxsICYmIGxhc3RQcm9wID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYXN0UHJvcCkgewogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgKCFuZXh0UHJvcCB8fCAhbmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gIiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmIGxhc3RQcm9wW3N0eWxlTmFtZV0gIT09IG5leHRQcm9wW3N0eWxlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gbmV4dFByb3Bbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZC5wdXNoKHByb3BLZXksIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSBuZXh0UHJvcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIGxhc3RIdG1sID0gbGFzdFByb3AgPyBsYXN0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEh0bWwgIT09IG5leHRIdG1sKSB7CiAgICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkICYmIGxhc3RQcm9wICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0UHJvcHNbU1RZTEVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2goU1RZTEUsIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzKSB7CiAgICAgICAgICBpZiAodGFnID09PSAiaW5wdXQiICYmIG5leHRSYXdQcm9wcy50eXBlID09PSAicmFkaW8iICYmIG5leHRSYXdQcm9wcy5uYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlQ2hlY2tlZChkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcG9zdFVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcHJvcE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKCFwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV0gfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJFbGVtZW50LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICB2YXIgZXh0cmFBdHRyaWJ1dGVOYW1lczsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2xvc2UiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGRvbUVsZW1lbnQuYXR0cmlidXRlczsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGF0dHJpYnV0ZXMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVzW19pXS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJ2YWx1ZSI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY2hlY2tlZCI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0ZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuYWRkKGF0dHJpYnV0ZXNbX2ldLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiByYXdQcm9wcykgewogICAgICAgICAgICBpZiAoIXJhd1Byb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gcmF3UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09ICIiICsgbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgIiIgKyBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFdhcm5EZXYgJiYgdHJ1ZSAmJiAvLyBDb252aW5jZSBGbG93IHdlJ3ZlIGNhbGN1bGF0ZWQgaXQgKGl0J3MgREVWLW9ubHkgaW4gdGhpcyBtZXRob2QuKQogICAgICAgICAgICB0eXBlb2YgaXNDdXN0b21Db21wb25lbnRUYWcgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgIHZhciBzZXJ2ZXJWYWx1ZSA9IHZvaWQgMDsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gaXNDdXN0b21Db21wb25lbnRUYWcgJiYgZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCA/IG51bGwgOiBnZXRQcm9wZXJ0eUluZm8ocHJvcEtleSk7CiAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSA9PT0gdHJ1ZSkgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyB8fCAvLyBDb250cm9sbGVkIGF0dHJpYnV0ZXMgYXJlIG5vdCB2YWxpZGF0ZWQKICAgICAgICAgICAgICAvLyBUT0RPOiBPbmx5IGlnbm9yZSB0aGVtIG9uIGNvbnRyb2xsZWQgdGFncy4KICAgICAgICAgICAgICBwcm9wS2V5ID09PSAidmFsdWUiIHx8IHByb3BLZXkgPT09ICJjaGVja2VkIiB8fCBwcm9wS2V5ID09PSAic2VsZWN0ZWQiKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICAgIHZhciBzZXJ2ZXJIVE1MID0gZG9tRWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRIVE1MID0gbm9ybWFsaXplSFRNTChkb21FbGVtZW50LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZEhUTUwgIT09IHNlcnZlckhUTUwpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVySFRNTCwgZXhwZWN0ZWRIVE1MKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgaWYgKGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkU3R5bGUgPSBjcmVhdGVEYW5nZXJvdXNTdHJpbmdGb3JTdHlsZXMobmV4dFByb3ApOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGRvbUVsZW1lbnQuZ2V0QXR0cmlidXRlKCJzdHlsZSIpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRTdHlsZSAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIGV4cGVjdGVkU3R5bGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiAhZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCkgewogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSkgewogICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaG91bGRJZ25vcmVBdHRyaWJ1dGUocHJvcEtleSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgJiYgIXNob3VsZFJlbW92ZUF0dHJpYnV0ZShwcm9wS2V5LCBuZXh0UHJvcCwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICAgIHZhciBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIG93bk5hbWVzcGFjZSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0YWcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChvd25OYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbnVsbCAmJiBzdGFuZGFyZE5hbWUgIT09IHByb3BLZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBkb250V2FybkN1c3RvbUVsZW1lbnQgPSBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0OwogICAgICAgICAgICAgICAgaWYgKCFkb250V2FybkN1c3RvbUVsZW1lbnQgJiYgbmV4dFByb3AgIT09IHNlcnZlclZhbHVlICYmICFpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSAtIFNob3VsZCBiZSBpbmZlcnJlZCBhcyBub3QgdW5kZWZpbmVkLgogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5zaXplID4gMCAmJiByYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMoZXh0cmFBdHRyaWJ1dGVOYW1lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlcihkb21FbGVtZW50LCByYXdQcm9wcywgdHJ1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByYXdQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0Tm9kZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIGlzRGlmZmVyZW50ID0gdGV4dE5vZGUubm9kZVZhbHVlICE9PSB0ZXh0OwogICAgICAgICAgcmV0dXJuIGlzRGlmZmVyZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgPCVzPiBpbiA8JXM+LiIsIGNoaWxkLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gdGhlIHRleHQgbm9kZSAiJXMiIGluIDwlcz4uJywgY2hpbGQubm9kZVZhbHVlLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Tm9kZSwgdGFnLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIDwlcz4gaW4gPCVzPi4iLCB0YWcsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0ZXh0ID09PSAiIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIHRleHQgbm9kZSBmb3IgIiVzIiBpbiA8JXM+LicsIHRleHQsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMyhkb21FbGVtZW50LCB0YWcsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQyKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHZhciB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgc3BlY2lhbFRhZ3MgPSBbImFkZHJlc3MiLCAiYXBwbGV0IiwgImFyZWEiLCAiYXJ0aWNsZSIsICJhc2lkZSIsICJiYXNlIiwgImJhc2Vmb250IiwgImJnc291bmQiLCAiYmxvY2txdW90ZSIsICJib2R5IiwgImJyIiwgImJ1dHRvbiIsICJjYXB0aW9uIiwgImNlbnRlciIsICJjb2wiLCAiY29sZ3JvdXAiLCAiZGQiLCAiZGV0YWlscyIsICJkaXIiLCAiZGl2IiwgImRsIiwgImR0IiwgImVtYmVkIiwgImZpZWxkc2V0IiwgImZpZ2NhcHRpb24iLCAiZmlndXJlIiwgImZvb3RlciIsICJmb3JtIiwgImZyYW1lIiwgImZyYW1lc2V0IiwgImgxIiwgImgyIiwgImgzIiwgImg0IiwgImg1IiwgImg2IiwgImhlYWQiLCAiaGVhZGVyIiwgImhncm91cCIsICJociIsICJodG1sIiwgImlmcmFtZSIsICJpbWciLCAiaW5wdXQiLCAiaXNpbmRleCIsICJsaSIsICJsaW5rIiwgImxpc3RpbmciLCAibWFpbiIsICJtYXJxdWVlIiwgIm1lbnUiLCAibWVudWl0ZW0iLCAibWV0YSIsICJuYXYiLCAibm9lbWJlZCIsICJub2ZyYW1lcyIsICJub3NjcmlwdCIsICJvYmplY3QiLCAib2wiLCAicCIsICJwYXJhbSIsICJwbGFpbnRleHQiLCAicHJlIiwgInNjcmlwdCIsICJzZWN0aW9uIiwgInNlbGVjdCIsICJzb3VyY2UiLCAic3R5bGUiLCAic3VtbWFyeSIsICJ0YWJsZSIsICJ0Ym9keSIsICJ0ZCIsICJ0ZW1wbGF0ZSIsICJ0ZXh0YXJlYSIsICJ0Zm9vdCIsICJ0aCIsICJ0aGVhZCIsICJ0aXRsZSIsICJ0ciIsICJ0cmFjayIsICJ1bCIsICJ3YnIiLCAieG1wIl07CiAgICAgICAgICB2YXIgaW5TY29wZVRhZ3MgPSBbCiAgICAgICAgICAgICJhcHBsZXQiLAogICAgICAgICAgICAiY2FwdGlvbiIsCiAgICAgICAgICAgICJodG1sIiwKICAgICAgICAgICAgInRhYmxlIiwKICAgICAgICAgICAgInRkIiwKICAgICAgICAgICAgInRoIiwKICAgICAgICAgICAgIm1hcnF1ZWUiLAogICAgICAgICAgICAib2JqZWN0IiwKICAgICAgICAgICAgInRlbXBsYXRlIiwKICAgICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAogICAgICAgICAgICAvLyBUT0RPOiBEaXN0aW5ndWlzaCBieSBuYW1lc3BhY2UgaGVyZSAtLSBmb3IgPHRpdGxlPiwgaW5jbHVkaW5nIGl0IGhlcmUKICAgICAgICAgICAgLy8gZXJycyBvbiB0aGUgc2lkZSBvZiBmZXdlciB3YXJuaW5ncwogICAgICAgICAgICAiZm9yZWlnbk9iamVjdCIsCiAgICAgICAgICAgICJkZXNjIiwKICAgICAgICAgICAgInRpdGxlIgogICAgICAgICAgXTsKICAgICAgICAgIHZhciBidXR0b25TY29wZVRhZ3MgPSBpblNjb3BlVGFncy5jb25jYXQoWyJidXR0b24iXSk7CiAgICAgICAgICB2YXIgaW1wbGllZEVuZFRhZ3MgPSBbImRkIiwgImR0IiwgImxpIiwgIm9wdGlvbiIsICJvcHRncm91cCIsICJwIiwgInJwIiwgInJ0Il07CiAgICAgICAgICB2YXIgZW1wdHlBbmNlc3RvckluZm8gPSB7CiAgICAgICAgICAgIGN1cnJlbnQ6IG51bGwsCiAgICAgICAgICAgIGZvcm1UYWc6IG51bGwsCiAgICAgICAgICAgIGFUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBidXR0b25UYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBub2JyVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgcFRhZ0luQnV0dG9uU2NvcGU6IG51bGwsCiAgICAgICAgICAgIGxpc3RJdGVtVGFnQXV0b2Nsb3Npbmc6IG51bGwsCiAgICAgICAgICAgIGRsSXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKG9sZEluZm8sIHRhZykgewogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gYXNzaWduKHt9LCBvbGRJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGluZm8gPSB7CiAgICAgICAgICAgICAgdGFnCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChpblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnV0dG9uU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcGVjaWFsVGFncy5pbmRleE9mKHRhZykgIT09IC0xICYmIHRhZyAhPT0gImFkZHJlc3MiICYmIHRhZyAhPT0gImRpdiIgJiYgdGFnICE9PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbmNlc3RvckluZm8uY3VycmVudCA9IGluZm87CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJmb3JtIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5mb3JtVGFnID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJidXR0b24iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJub2JyIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAibGkiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJkZCIgfHwgdGFnID09PSAiZHQiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpc1RhZ1ZhbGlkV2l0aFBhcmVudCA9IGZ1bmN0aW9uKHRhZywgcGFyZW50VGFnKSB7CiAgICAgICAgICAgIHN3aXRjaCAocGFyZW50VGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIm9wdGdyb3VwIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0Z3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0aCIgfHwgdGFnID09PSAidGQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0ciIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjb2wiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY2FwdGlvbiIgfHwgdGFnID09PSAiY29sZ3JvdXAiIHx8IHRhZyA9PT0gInRib2R5IiB8fCB0YWcgPT09ICJ0Zm9vdCIgfHwgdGFnID09PSAidGhlYWQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJiYXNlIiB8fCB0YWcgPT09ICJiYXNlZm9udCIgfHwgdGFnID09PSAiYmdzb3VuZCIgfHwgdGFnID09PSAibGluayIgfHwgdGFnID09PSAibWV0YSIgfHwgdGFnID09PSAidGl0bGUiIHx8IHRhZyA9PT0gIm5vc2NyaXB0IiB8fCB0YWcgPT09ICJub2ZyYW1lcyIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImhlYWQiIHx8IHRhZyA9PT0gImJvZHkiIHx8IHRhZyA9PT0gImZyYW1lc2V0IjsKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiZnJhbWUiOwogICAgICAgICAgICAgIGNhc2UgIiNkb2N1bWVudCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaHRtbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgIT09ICJoMSIgJiYgcGFyZW50VGFnICE9PSAiaDIiICYmIHBhcmVudFRhZyAhPT0gImgzIiAmJiBwYXJlbnRUYWcgIT09ICJoNCIgJiYgcGFyZW50VGFnICE9PSAiaDUiICYmIHBhcmVudFRhZyAhPT0gImg2IjsKICAgICAgICAgICAgICBjYXNlICJycCI6CiAgICAgICAgICAgICAgY2FzZSAicnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGltcGxpZWRFbmRUYWdzLmluZGV4T2YocGFyZW50VGFnKSA9PT0gLTE7CiAgICAgICAgICAgICAgY2FzZSAiYm9keSI6CiAgICAgICAgICAgICAgY2FzZSAiY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiY29sIjoKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICBjYXNlICJ0aCI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgPT0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEludmFsaWRBbmNlc3RvckZvclRhZyA9IGZ1bmN0aW9uKHRhZywgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiYWRkcmVzcyI6CiAgICAgICAgICAgICAgY2FzZSAiYXJ0aWNsZSI6CiAgICAgICAgICAgICAgY2FzZSAiYXNpZGUiOgogICAgICAgICAgICAgIGNhc2UgImJsb2NrcXVvdGUiOgogICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBjYXNlICJkaXIiOgogICAgICAgICAgICAgIGNhc2UgImRpdiI6CiAgICAgICAgICAgICAgY2FzZSAiZGwiOgogICAgICAgICAgICAgIGNhc2UgImZpZWxkc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmaWdjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJmaWd1cmUiOgogICAgICAgICAgICAgIGNhc2UgImZvb3RlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgIm1haW4iOgogICAgICAgICAgICAgIGNhc2UgIm1lbnUiOgogICAgICAgICAgICAgIGNhc2UgIm5hdiI6CiAgICAgICAgICAgICAgY2FzZSAib2wiOgogICAgICAgICAgICAgIGNhc2UgInAiOgogICAgICAgICAgICAgIGNhc2UgInNlY3Rpb24iOgogICAgICAgICAgICAgIGNhc2UgInN1bW1hcnkiOgogICAgICAgICAgICAgIGNhc2UgInVsIjoKICAgICAgICAgICAgICBjYXNlICJwcmUiOgogICAgICAgICAgICAgIGNhc2UgImxpc3RpbmciOgogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICBjYXNlICJociI6CiAgICAgICAgICAgICAgY2FzZSAieG1wIjoKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiZm9ybSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmZvcm1UYWcgfHwgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImxpIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJkZCI6CiAgICAgICAgICAgICAgY2FzZSAiZHQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImEiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJub2JyIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRpZFdhcm4kMSA9IHt9OwogICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oY2hpbGRUYWcsIGNoaWxkVGV4dCwgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIGFuY2VzdG9ySW5mbyA9IGFuY2VzdG9ySW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbzsKICAgICAgICAgICAgdmFyIHBhcmVudEluZm8gPSBhbmNlc3RvckluZm8uY3VycmVudDsKICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudEluZm8gJiYgcGFyZW50SW5mby50YWc7CiAgICAgICAgICAgIGlmIChjaGlsZFRleHQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZFRhZyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nOiB3aGVuIGNoaWxkVGV4dCBpcyBwYXNzZWQsIGNoaWxkVGFnIHNob3VsZCBiZSBudWxsIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkVGFnID0gIiN0ZXh0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudCA9IGlzVGFnVmFsaWRXaXRoUGFyZW50KGNoaWxkVGFnLCBwYXJlbnRUYWcpID8gbnVsbCA6IHBhcmVudEluZm87CiAgICAgICAgICAgIHZhciBpbnZhbGlkQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50ID8gbnVsbCA6IGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcoY2hpbGRUYWcsIGFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50T3JBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgfHwgaW52YWxpZEFuY2VzdG9yOwogICAgICAgICAgICBpZiAoIWludmFsaWRQYXJlbnRPckFuY2VzdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvclRhZyA9IGludmFsaWRQYXJlbnRPckFuY2VzdG9yLnRhZzsKICAgICAgICAgICAgdmFyIHdhcm5LZXkgPSAhIWludmFsaWRQYXJlbnQgKyAifCIgKyBjaGlsZFRhZyArICJ8IiArIGFuY2VzdG9yVGFnOwogICAgICAgICAgICBpZiAoZGlkV2FybiQxW3dhcm5LZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm4kMVt3YXJuS2V5XSA9IHRydWU7CiAgICAgICAgICAgIHZhciB0YWdEaXNwbGF5TmFtZSA9IGNoaWxkVGFnOwogICAgICAgICAgICB2YXIgd2hpdGVzcGFjZUluZm8gPSAiIjsKICAgICAgICAgICAgaWYgKGNoaWxkVGFnID09PSAiI3RleHQiKSB7CiAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdChjaGlsZFRleHQpKSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJUZXh0IG5vZGVzIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiV2hpdGVzcGFjZSB0ZXh0IG5vZGVzIjsKICAgICAgICAgICAgICAgIHdoaXRlc3BhY2VJbmZvID0gIiBNYWtlIHN1cmUgeW91IGRvbid0IGhhdmUgYW55IGV4dHJhIHdoaXRlc3BhY2UgYmV0d2VlbiB0YWdzIG9uIGVhY2ggbGluZSBvZiB5b3VyIHNvdXJjZSBjb2RlLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIjwiICsgY2hpbGRUYWcgKyAiPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGludmFsaWRQYXJlbnQpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmIChhbmNlc3RvclRhZyA9PT0gInRhYmxlIiAmJiBjaGlsZFRhZyA9PT0gInRyIikgewogICAgICAgICAgICAgICAgaW5mbyArPSAiIEFkZCBhIDx0Ym9keT4sIDx0aGVhZD4gb3IgPHRmb290PiB0byB5b3VyIGNvZGUgdG8gbWF0Y2ggdGhlIERPTSB0cmVlIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBjaGlsZCBvZiA8JXM+LiVzJXMiLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcsIHdoaXRlc3BhY2VJbmZvLCBpbmZvKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBkZXNjZW5kYW50IG9mIDwlcz4uIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDEgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgU1VTUEVOU0VfU1RBUlRfREFUQSA9ICIkIjsKICAgICAgICB2YXIgU1VTUEVOU0VfRU5EX0RBVEEgPSAiLyQiOwogICAgICAgIHZhciBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgPSAiJD8iOwogICAgICAgIHZhciBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBID0gIiQhIjsKICAgICAgICB2YXIgU1RZTEUkMSA9ICJzdHlsZSI7CiAgICAgICAgdmFyIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgIHZhciBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlOwogICAgICAgICAgdmFyIG5vZGVUeXBlID0gcm9vdENvbnRhaW5lckluc3RhbmNlLm5vZGVUeXBlOwogICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX05PREU6CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfRlJBR01FTlRfTk9ERTogewogICAgICAgICAgICAgIHR5cGUgPSBub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/ICIjZG9jdW1lbnQiIDogIiNmcmFnbWVudCI7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcm9vdENvbnRhaW5lckluc3RhbmNlLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSByb290MyA/IHJvb3QzLm5hbWVzcGFjZVVSSSA6IGdldENoaWxkTmFtZXNwYWNlKG51bGwsICIiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckluc3RhbmNlLnBhcmVudE5vZGUgOiByb290Q29udGFpbmVySW5zdGFuY2U7CiAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IGNvbnRhaW5lcjIubmFtZXNwYWNlVVJJIHx8IG51bGw7CiAgICAgICAgICAgICAgdHlwZSA9IGNvbnRhaW5lcjIudGFnTmFtZTsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShvd25OYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRUYWcgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKG51bGwsIHZhbGlkYXRlZFRhZyk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZEhvc3RDb250ZXh0KHBhcmVudEhvc3RDb250ZXh0LCB0eXBlLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudEhvc3RDb250ZXh0RGV2ID0gcGFyZW50SG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnRIb3N0Q29udGV4dERldi5uYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhwYXJlbnRIb3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUZvckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gaXNFbmFibGVkKCk7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCk7CiAgICAgICAgICB2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgc2V0RW5hYmxlZChmYWxzZSk7CiAgICAgICAgICByZXR1cm4gYWN0aXZlSW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0QWZ0ZXJDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgcmVzdG9yZVNlbGVjdGlvbihzZWxlY3Rpb25JbmZvcm1hdGlvbik7CiAgICAgICAgICBzZXRFbmFibGVkKGV2ZW50c0VuYWJsZWQpOwogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKHR5cGUsIG51bGwsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50Myh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMyID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXMyKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcGFyZW50Q29udGV4dCwgY2hpbGRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgfHwgZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICBwcmV2aW91c0NvbnRleHQgPSBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gaGF2ZSBhbiBpbnN0YW5jZSBieSB0aGlzIHBvaW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgICB2YXIgbWVyZ2VkQ29udGV4dCA9IHByb2Nlc3NDaGlsZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBwcmV2aW91c0NvbnRleHQpOwogICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gbWVyZ2VkQ29udGV4dDsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZXJnZWRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGaWJlck1vdW50ZWQoZmliZXIpIHx8IGZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHN1YnRyZWUgcGFyZW50IHRvIGJlIGEgbW91bnRlZCBjbGFzcyBjb21wb25lbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5jb250ZXh0OwogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gbm9kZS50eXBlOwogICAgICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlICE9PSBudWxsKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGb3VuZCB1bmV4cGVjdGVkIGRldGFjaGVkIHN1YnRyZWUgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTGVnYWN5Um9vdCA9IDA7CiAgICAgICAgdmFyIENvbmN1cnJlbnRSb290ID0gMTsKICAgICAgICB2YXIgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICB2YXIgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaWYgKHN5bmNRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBzeW5jUXVldWUgPSBbY2FsbGJhY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3luY1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gdHJ1ZTsKICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpIHsKICAgICAgICAgIGlmIChpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MpIHsKICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrcygpIHsKICAgICAgICAgIGlmICghaXNGbHVzaGluZ1N5bmNRdWV1ZSAmJiBzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzVXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgaXNTeW5jID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBzeW5jUXVldWU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2soaXNTeW5jKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgaWYgKHN5bmNRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3luY1F1ZXVlID0gc3luY1F1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayhJbW1lZGlhdGVQcmlvcml0eSwgZmx1c2hTeW5jQ2FsbGJhY2tzKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlUHJpb3JpdHkpOwogICAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmb3JrU3RhY2sgPSBbXTsKICAgICAgICB2YXIgZm9ya1N0YWNrSW5kZXggPSAwOwogICAgICAgIHZhciB0cmVlRm9ya1Byb3ZpZGVyID0gbnVsbDsKICAgICAgICB2YXIgdHJlZUZvcmtDb3VudCA9IDA7CiAgICAgICAgdmFyIGlkU3RhY2sgPSBbXTsKICAgICAgICB2YXIgaWRTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUNvbnRleHRQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0SWQgPSAxOwogICAgICAgIHZhciB0cmVlQ29udGV4dE92ZXJmbG93ID0gIiI7CiAgICAgICAgZnVuY3Rpb24gaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgcmV0dXJuICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JrZWQpICE9PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGb3Jrc0F0TGV2ZWwod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiB0cmVlRm9ya0NvdW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmVlSWQoKSB7CiAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGlkID0gaWRXaXRoTGVhZGluZ0JpdCAmIH5nZXRMZWFkaW5nQml0KGlkV2l0aExlYWRpbmdCaXQpOwogICAgICAgICAgcmV0dXJuIGlkLnRvU3RyaW5nKDMyKSArIG92ZXJmbG93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCB0b3RhbENoaWxkcmVuKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleCsrXSA9IHRyZWVGb3JrQ291bnQ7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya1Byb3ZpZGVyOwogICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSB0b3RhbENoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbiwgaW5kZXgyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRQcm92aWRlcjsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgYmFzZUlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGJhc2VPdmVyZmxvdyA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICB2YXIgYmFzZUxlbmd0aCA9IGdldEJpdExlbmd0aChiYXNlSWRXaXRoTGVhZGluZ0JpdCkgLSAxOwogICAgICAgICAgdmFyIGJhc2VJZCA9IGJhc2VJZFdpdGhMZWFkaW5nQml0ICYgfigxIDw8IGJhc2VMZW5ndGgpOwogICAgICAgICAgdmFyIHNsb3QgPSBpbmRleDIgKyAxOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIGJhc2VMZW5ndGg7CiAgICAgICAgICBpZiAobGVuZ3RoID4gMzApIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mT3ZlcmZsb3dCaXRzID0gYmFzZUxlbmd0aCAtIGJhc2VMZW5ndGggJSA1OwogICAgICAgICAgICB2YXIgbmV3T3ZlcmZsb3dCaXRzID0gKDEgPDwgbnVtYmVyT2ZPdmVyZmxvd0JpdHMpIC0gMTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93ID0gKGJhc2VJZCAmIG5ld092ZXJmbG93Qml0cykudG9TdHJpbmcoMzIpOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUlkID0gYmFzZUlkID4+IG51bWJlck9mT3ZlcmZsb3dCaXRzOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUxlbmd0aCA9IGJhc2VMZW5ndGggLSBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciByZXN0T2ZOZXdCaXRzID0gc2xvdCA8PCByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgaWQgPSByZXN0T2ZOZXdCaXRzIHwgcmVzdE9mQmFzZUlkOwogICAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSBuZXdPdmVyZmxvdyArIGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgcmVzdE9mTGVuZ3RoIHwgaWQ7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXdCaXRzID0gc2xvdCA8PCBiYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgX2lkID0gbmV3Qml0cyB8IGJhc2VJZDsKICAgICAgICAgICAgdmFyIF9vdmVyZmxvdyA9IGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgbGVuZ3RoIHwgX2lkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gX292ZXJmbG93OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gMTsKICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IDA7CiAgICAgICAgICAgIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Qml0TGVuZ3RoKG51bWJlcikgewogICAgICAgICAgcmV0dXJuIDMyIC0gY2x6MzIobnVtYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQyKSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQyLmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybigiY29tcG9uZW50V2lsbE1vdW50IGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBjb2RlIHdpdGggc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZE1vdW50LCBhbmQgc2V0IGluaXRpYWwgc3RhdGUgaW4gdGhlIGNvbnN0cnVjdG9yLlxuKiBSZW5hbWUgY29tcG9uZW50V2lsbE1vdW50IHRvIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXM0ID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB3YXJuKCJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogSWYgeW91J3JlIHVwZGF0aW5nIHN0YXRlIHdoZW5ldmVyIHByb3BzIGNoYW5nZSwgcmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBtZW1vaXphdGlvbiB0ZWNobmlxdWVzIG9yIG1vdmUgaXQgdG8gc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gTGVhcm4gbW9yZSBhdDogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rlcml2ZWQtc3RhdGVcbiogUmVuYW1lIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXM1ID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB3YXJuKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50Mi5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDIucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQyLnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50Mi5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50MiwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDIudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDIsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDIsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50Mi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDIuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gRnJhZ21lbnQpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZyYWdtZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCBmcmFnbWVudCk7CiAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KCIiICsgbmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRWxlbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIG51bGwsIG5ld0NoaWxkKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkMiA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZDIucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQzID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkMy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG9sZEZpYmVyICE9PSBudWxsID8gb2xkRmliZXIua2V5IDogbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBvbGRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoZWRGaWJlciA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG1hdGNoZWRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlcjIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlcjMgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMywgbmV3Q2hpbGQsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2Fybk9uSW52YWxpZEtleShjaGlsZCwga25vd25LZXlzLCByZXR1cm5GaWJlcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZCAhPT0gIm9iamVjdCIgfHwgY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBrbm93bktleXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgICAgd2FybkZvck1pc3NpbmdLZXkoY2hpbGQsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGNoaWxkLmtleTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXkgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGtub3duS2V5cyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzLmFkZChrZXkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICgha25vd25LZXlzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzLmFkZChrZXkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yKCJFbmNvdW50ZXJlZCB0d28gY2hpbGRyZW4gd2l0aCB0aGUgc2FtZSBrZXksIGAlc2AuIEtleXMgc2hvdWxkIGJlIHVuaXF1ZSBzbyB0aGF0IGNvbXBvbmVudHMgbWFpbnRhaW4gdGhlaXIgaWRlbnRpdHkgYWNyb3NzIHVwZGF0ZXMuIE5vbi11bmlxdWUga2V5cyBtYXkgY2F1c2UgY2hpbGRyZW4gdG8gYmUgZHVwbGljYXRlZCBhbmQvb3Igb21pdHRlZCBcdTIwMTQgdGhlIGJlaGF2aW9yIGlzIHVuc3VwcG9ydGVkIGFuZCBjb3VsZCBjaGFuZ2UgaW4gYSBmdXR1cmUgdmVyc2lvbi4iLCBrZXkpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGNoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGNoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkS2V5KGluaXQocGF5bG9hZCksIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZHJlbiwgbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBrbm93bktleXMgPSBudWxsOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ld0NoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAga25vd25LZXlzID0gd2Fybk9uSW52YWxpZEtleShjaGlsZCwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzTmV3RmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBuZXdJZHggPSAwOwogICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmIG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICBpZiAob2xkRmliZXIuaW5kZXggPiBuZXdJZHgpIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyOwogICAgICAgICAgICAgICAgb2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV3RmliZXIgPSB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChuZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIG9sZEZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXdJZHggPT09IG5ld0NoaWxkcmVuLmxlbmd0aCkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIgPSBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjIgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjIuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyMi5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXIyLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMiwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZDIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzMiA9IG5ld0lkeDsKICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkl0ZXJhdG9yKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW5JdGVyYWJsZSwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFuIG9iamVjdCBpcyBub3QgYW4gaXRlcmFibGUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIC8vICRGbG93Rml4TWUgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgdG9TdHJpbmdUYWcKICAgICAgICAgICAgICBuZXdDaGlsZHJlbkl0ZXJhYmxlW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICJHZW5lcmF0b3IiKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEdlbmVyYXRvcnMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIEdlbmVyYXRvcnMgYXMgY2hpbGRyZW4gaXMgdW5zdXBwb3J0ZWQgYW5kIHdpbGwgbGlrZWx5IHlpZWxkIHVuZXhwZWN0ZWQgcmVzdWx0cyBiZWNhdXNlIGVudW1lcmF0aW5nIGEgZ2VuZXJhdG9yIG11dGF0ZXMgaXQuIFlvdSBtYXkgY29udmVydCBpdCB0byBhbiBhcnJheSB3aXRoIGBBcnJheS5mcm9tKClgIG9yIHRoZSBgWy4uLnNwcmVhZF1gIG9wZXJhdG9yIGJlZm9yZSByZW5kZXJpbmcuIEtlZXAgaW4gbWluZCB5b3UgbWlnaHQgbmVlZCB0byBwb2x5ZmlsbCB0aGVzZSBmZWF0dXJlcyBmb3Igb2xkZXIgYnJvd3NlcnMuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRHZW5lcmF0b3JzID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkcmVuSXRlcmFibGUuZW50cmllcyA9PT0gaXRlcmF0b3JGbikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNYXBzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBNYXBzIGFzIGNoaWxkcmVuIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSBhbiBhcnJheSBvZiBrZXllZCBSZWFjdEVsZW1lbnRzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9uZXdDaGlsZHJlbiA9IGl0ZXJhdG9yRm4uY2FsbChuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgICBpZiAoX25ld0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgICAgICBmb3IgKDsgIV9zdGVwLmRvbmU7IF9zdGVwID0gX25ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBfc3RlcC52YWx1ZTsKICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gd2Fybk9uSW52YWxpZEtleShjaGlsZCwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXdDaGlsZHJlbiA9IGl0ZXJhdG9yRm4uY2FsbChuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgaWYgKG5ld0NoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFuIGl0ZXJhYmxlIG9iamVjdCBwcm92aWRlZCBubyBpdGVyYXRvci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgdmFyIG5leHRPbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpOwogICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICBpZiAob2xkRmliZXIuaW5kZXggPiBuZXdJZHgpIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyOwogICAgICAgICAgICAgICAgb2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV3RmliZXIgPSB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgc3RlcC52YWx1ZSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChuZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIG9sZEZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdGVwLmRvbmUpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjMgPSBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgc3RlcC52YWx1ZSwgbGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjMsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzMyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyNCA9IHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgc3RlcC52YWx1ZSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNC5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmRlbGV0ZShfbmV3RmliZXI0LmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjQua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXI0LCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3M0ID0gbmV3SWR4OwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3M0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50Rmlyc3RDaGlsZCAhPT0gbnVsbCAmJiBjdXJyZW50Rmlyc3RDaGlsZC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCk7CiAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCh0ZXh0Q29udGVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50LCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQudGFnID09PSBGcmFnbWVudCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcy5jaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZWxlbWVudFR5cGUgPT09IGVsZW1lbnRUeXBlIHx8IC8vIEtlZXAgdGhpcyBjaGVjayBpbmxpbmUgc28gaXQgb25seSBydW5zIG9uIHRoZSBmYWxzZSBwYXRoOgogICAgICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY2hpbGQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgaG90IHJlbG9hZGluZyBoYXMgZGlmZmVyZW50IHNlbWFudGljcyB0aGFuIHByb2QgYmVjYXVzZQogICAgICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9leGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9leGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY3JlYXRlZDQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBvcnRhbC5rZXk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEhvc3RQb3J0YWwgJiYgY2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IHBvcnRhbC5jb250YWluZXJJbmZvICYmIGNoaWxkLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiA9PT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBuZXdDaGlsZC5rZXkgPT09IG51bGw7CiAgICAgICAgICAgIGlmIChpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheShuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCAiIiArIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczI7CiAgICAgICAgfQogICAgICAgIHZhciByZWNvbmNpbGVDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcih0cnVlKTsKICAgICAgICB2YXIgbW91bnRDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcihmYWxzZSk7CiAgICAgICAgZnVuY3Rpb24gY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50Mi5jaGlsZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlc3VtaW5nIHdvcmsgbm90IHlldCBpbXBsZW1lbnRlZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50Q2hpbGQgPSBjdXJyZW50Q2hpbGQuc2libGluZzsKICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5zaWJsaW5nID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgbmV3Q2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgdmFyIGNoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3MoY2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVDdXJzb3IgPSBjcmVhdGVDdXJzb3IobnVsbCk7CiAgICAgICAgdmFyIHJlbmRlcmVyU2lnaWw7CiAgICAgICAgewogICAgICAgICAgcmVuZGVyZXJTaWdpbCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgIHZhciBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgIHZhciBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgIHZhciBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCkgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUHJvdmlkZXIocHJvdmlkZXJGaWJlciwgY29udGV4dCwgbmV4dFZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHB1c2godmFsdWVDdXJzb3IsIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHZvaWQgMCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IG51bGwgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSByZW5kZXJlclNpZ2lsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRGV0ZWN0ZWQgbXVsdGlwbGUgcmVuZGVyZXJzIGNvbmN1cnJlbnRseSByZW5kZXJpbmcgdGhlIHNhbWUgY29udGV4dCBwcm92aWRlci4gVGhpcyBpcyBjdXJyZW50bHkgdW5zdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciA9IHJlbmRlcmVyU2lnaWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUHJvdmlkZXIoY29udGV4dCwgcHJvdmlkZXJGaWJlcikgewogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHZhbHVlQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3AodmFsdWVDdXJzb3IsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50LCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgdmFyIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gbm9kZS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmICFpc1N1YnNldE9mTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5vZGUgIT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcm9wYWdhdGlvbiByb290IHdoZW4gc2NoZWR1bGluZyBjb250ZXh0IHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV4dEZpYmVyID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgbGlzdCA9IGZpYmVyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKGxpc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeSA9IGxpc3QuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIHdoaWxlIChkZXBlbmRlbmN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW5jeS5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGxpc3QubGFuZXMgPSBtZXJnZUxhbmVzKGxpc3QubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kubmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDb250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIudHlwZSA/IG51bGwgOiBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIHZhciBwYXJlbnRTdXNwZW5zZSA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBpZiAocGFyZW50U3VzcGVuc2UgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UganVzdCBjYW1lIGZyb20gYSBwYXJlbnQgc28gd2UgbXVzdCBoYXZlIGhhZCBhIHBhcmVudC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UubGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudFN1c3BlbnNlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfYWx0ZXJuYXRlID0gcGFyZW50U3VzcGVuc2UuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChfYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhfYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudFN1c3BlbnNlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgIHdoaWxlIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0RmliZXIgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gbmV4dEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBuZXh0RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RDb250ZXh0ID0gZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICBpZiAoZmlyc3RDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShkZXBlbmRlbmNpZXMubGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkQ29udGV4dChjb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb250ZXh0Ll9jdXJyZW50VmFsdWU7CiAgICAgICAgICBpZiAobGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID09PSBjb250ZXh0KSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvbnRleHRJdGVtID0gewogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgbWVtb2l6ZWRWYWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAobGFzdENvbnRleHREZXBlbmRlbmN5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlci5kZXBlbmRlbmNpZXMgPSB7CiAgICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY29udGV4dEl0ZW0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGxhc3RDb250ZXh0RGVwZW5kZW5jeS5uZXh0ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBbcXVldWVdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcy5wdXNoKHF1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoUXVldWVpbmdDb25jdXJyZW50VXBkYXRlcygpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29uY3VycmVudFF1ZXVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGNvbmN1cnJlbnRRdWV1ZXNbaV07CiAgICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBmaXJzdEludGVybGVhdmVkVXBkYXRlID0gbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKGxhc3RQZW5kaW5nVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbGFzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIHZhciB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QgPSBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdDsKICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChzb3VyY2VGaWJlciwgbGFuZSkgewogICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCAmJiAoc291cmNlRmliZXIuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBzb3VyY2VGaWJlcjsKICAgICAgICAgIHZhciBwYXJlbnQgPSBzb3VyY2VGaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBhcmVudC5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnQuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIGFsdGVybmF0ZSA9IHBhcmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgocGFyZW50LmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gcGFyZW50OwogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBVcGRhdGVTdGF0ZSA9IDA7CiAgICAgICAgdmFyIFJlcGxhY2VTdGF0ZSA9IDE7CiAgICAgICAgdmFyIEZvcmNlVXBkYXRlID0gMjsKICAgICAgICB2YXIgQ2FwdHVyZVVwZGF0ZSA9IDM7CiAgICAgICAgdmFyIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGU7CiAgICAgICAgdmFyIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplVXBkYXRlUXVldWUoZmliZXIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgYmFzZVN0YXRlOiBmaWJlci5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBzaGFyZWQ6IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVmZmVjdHM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGNsb25lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBldmVudFRpbWUsCiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIHRhZzogVXBkYXRlU3RhdGUsCiAgICAgICAgICAgIHBheWxvYWQ6IG51bGwsCiAgICAgICAgICAgIGNhbGxiYWNrOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9PT0gc2hhcmVkUXVldWUgJiYgIWRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIChzZXRTdGF0ZSwgcmVwbGFjZVN0YXRlLCBvciBmb3JjZVVwZGF0ZSkgd2FzIHNjaGVkdWxlZCBmcm9tIGluc2lkZSBhbiB1cGRhdGUgZnVuY3Rpb24uIFVwZGF0ZSBmdW5jdGlvbnMgc2hvdWxkIGJlIHB1cmUsIHdpdGggemVybyBzaWRlLWVmZmVjdHMuIENvbnNpZGVyIHVzaW5nIGNvbXBvbmVudERpZFVwZGF0ZSBvciBhIGNhbGxiYWNrLiIpOwogICAgICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNVbnNhZmVDbGFzc1JlbmRlclBoYXNlVXBkYXRlKCkpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICByZXR1cm4gdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBzaGFyZWRRdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxhbmVzID0gc2hhcmVkUXVldWUubGFuZXM7CiAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLmxhbmVzID0gbmV3UXVldWVMYW5lczsKICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjYXB0dXJlZFVwZGF0ZSkgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0ZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3TGFzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGUuZXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZS5sYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwpOwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWUgPSB7CiAgICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG5ld0ZpcnN0LAogICAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG5ld0xhc3QsCiAgICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIHByZXZTdGF0ZSwgbmV4dFByb3BzLCBpbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoICh1cGRhdGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgUmVwbGFjZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG5leHRTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYXB0dXJlVXBkYXRlOiB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVXBkYXRlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgX3BheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgX3BheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhc3NpZ24oe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcmNlVXBkYXRlOiB7CiAgICAgICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIHByb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICB2YXIgY3VycmVudExhc3RCYXNlVXBkYXRlID0gY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgIT09IGxhc3RCYXNlVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50TGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBxdWV1ZS5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0xhc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUV2ZW50VGltZSA9IHVwZGF0ZS5ldmVudFRpbWU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMyLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZSA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGVFdmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgbmV3U3RhdGUsIHByb3BzLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB1cGRhdGUuY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgLy8gSWYgdGhlIHVwZGF0ZSB3YXMgYWxyZWFkeSBjb21taXR0ZWQsIHdlIHNob3VsZCBub3QgcXVldWUgaXRzCiAgICAgICAgICAgICAgICAvLyBjYWxsYmFjayBhZ2Fpbi4KICAgICAgICAgICAgICAgIHVwZGF0ZS5sYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENhbGxiYWNrOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0cyA9IHF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcXVldWUuZWZmZWN0cyA9IFt1cGRhdGVdOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh1cGRhdGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgIGlmICh1cGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgICAgICAgIHZhciBfZmlyc3RQZW5kaW5nVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdXBkYXRlID0gX2ZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IG5ld0ZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLnNoYXJlZC5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIGludGVybGVhdmVkLmxhbmUpOwogICAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhuZXdMYW5lcyk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG5ld0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGFyZ3VtZW50IHBhc3NlZCBhcyBjYWxsYmFjay4gRXhwZWN0ZWQgYSBmdW5jdGlvbi4gSW5zdGVhZCAiICsgKCJyZWNlaXZlZDogIiArIGNhbGxiYWNrKSk7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpIHsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaGFzRm9yY2VVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgZmluaXNoZWRRdWV1ZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBlZmZlY3RzID0gZmluaXNoZWRRdWV1ZS5lZmZlY3RzOwogICAgICAgICAgZmluaXNoZWRRdWV1ZS5lZmZlY3RzID0gbnVsbDsKICAgICAgICAgIGlmIChlZmZlY3RzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWZmZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBlZmZlY3RzW2ldOwogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGVmZmVjdC5jYWxsYmFjazsKICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVmZmVjdC5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5PX0NPTlRFWFQgPSB7fTsKICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yJDEgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciByb290SW5zdGFuY2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICBmdW5jdGlvbiByZXF1aXJlZENvbnRleHQoYykgewogICAgICAgICAgaWYgKGMgPT09IE5PX0NPTlRFWFQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBob3N0IGNvbnRleHQgdG8gZXhpc3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250YWluZXIoKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIHJvb3RJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250YWluZXIoZmliZXIsIG5leHRSb290SW5zdGFuY2UpIHsKICAgICAgICAgIHB1c2gocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIG5leHRSb290SW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBOT19DT05URVhULCBmaWJlcik7CiAgICAgICAgICB2YXIgbmV4dFJvb3RDb250ZXh0ID0gZ2V0Um9vdEhvc3RDb250ZXh0KG5leHRSb290SW5zdGFuY2UpOwogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Um9vdENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRhaW5lcihmaWJlcikgewogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIHBvcChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0Q29udGV4dCgpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZ2V0Q2hpbGRIb3N0Q29udGV4dChjb250ZXh0LCBmaWJlci50eXBlKTsKICAgICAgICAgIGlmIChjb250ZXh0ID09PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgbmV4dENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIGlmIChjb250ZXh0RmliZXJTdGFja0N1cnNvci5jdXJyZW50ICE9PSBmaWJlcikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgRGVmYXVsdFN1c3BlbnNlQ29udGV4dCA9IDA7CiAgICAgICAgdmFyIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrID0gMTsKICAgICAgICB2YXIgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0ID0gMTsKICAgICAgICB2YXIgRm9yY2VTdXNwZW5zZUZhbGxiYWNrID0gMjsKICAgICAgICB2YXIgc3VzcGVuc2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihEZWZhdWx0U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICBmdW5jdGlvbiBoYXNTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgZmxhZykgewogICAgICAgICAgcmV0dXJuIChwYXJlbnRDb250ZXh0ICYgZmxhZykgIT09IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc2hhbGxvd0NvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgfCBzaGFsbG93Q29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzdWJ0cmVlQ29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgfCBzdWJ0cmVlQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN1c3BlbnNlQ29udGV4dChmaWJlciwgbmV3Q29udGV4dCkgewogICAgICAgICAgcHVzaChzdXNwZW5zZVN0YWNrQ3Vyc29yLCBuZXdDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFN1c3BlbnNlQ29udGV4dChmaWJlcikgewogICAgICAgICAgcG9wKHN1c3BlbnNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKHdvcmtJblByb2dyZXNzMiwgaGFzSW52aXNpYmxlUGFyZW50KSB7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEZpcnN0U3VzcGVuZGVkKHJvdykgewogICAgICAgICAgdmFyIG5vZGUgPSByb3c7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgPT09IG51bGwgfHwgaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhkZWh5ZHJhdGVkKSB8fCBpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhkZWh5ZHJhdGVkKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCAmJiAvLyByZXZlYWxPcmRlciB1bmRlZmluZWQgY2FuJ3QgYmUgdHJ1c3RlZCBiZWNhdXNlIGl0IGRvbid0CiAgICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2Ygd2hldGhlciBpdCBzdXNwZW5kZWQgb3Igbm90LgogICAgICAgICAgICBub2RlLm1lbW9pemVkUHJvcHMucmV2ZWFsT3JkZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKG5vZGUuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHJvdykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHJvdykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIE5vRmxhZ3MkMSA9ICgKICAgICAgICAgIC8qICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBIYXNFZmZlY3QgPSAoCiAgICAgICAgICAvKiAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIEluc2VydGlvbiA9ICgKICAgICAgICAgIC8qICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dCA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUGFzc2l2ZSQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzU291cmNlcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gd29ya0luUHJvZ3Jlc3NTb3VyY2VzW2ldOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbXV0YWJsZVNvdXJjZS5fd29ya0luUHJvZ3Jlc3NWZXJzaW9uUHJpbWFyeSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpIHsKICAgICAgICAgIHZhciBnZXRWZXJzaW9uID0gbXV0YWJsZVNvdXJjZS5fZ2V0VmVyc2lvbjsKICAgICAgICAgIHZhciB2ZXJzaW9uID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb25dOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YS5wdXNoKG11dGFibGVTb3VyY2UsIHZlcnNpb24pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIHZhciByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgUkVfUkVOREVSX0xJTUlUID0gMjU7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICB2YXIgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBtb3VudEhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYgPSBbaG9va05hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGhvb2tUeXBlc0Rldi5wdXNoKGhvb2tOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb29rVHlwZXNEZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYrKzsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2W2hvb2tUeXBlc1VwZGF0ZUluZGV4RGV2XSAhPT0gaG9va05hbWUpIHsKICAgICAgICAgICAgICAgIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGhvb2tOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGVwcyAhPT0gdm9pZCAwICYmIGRlcHMgIT09IG51bGwgJiYgIWlzQXJyYXkoZGVwcykpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCB0aGF0IGlzIG5vdCBhbiBhcnJheSAoaW5zdGVhZCwgcmVjZWl2ZWQgYCVzYCkuIFdoZW4gc3BlY2lmaWVkLCB0aGUgZmluYWwgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheS4iLCBjdXJyZW50SG9va05hbWVJbkRldiwgdHlwZW9mIGRlcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGN1cnJlbnRIb29rTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSk7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHRhYmxlID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kQ29sdW1uU3RhcnQgPSAzMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZEhvb2tOYW1lID0gaG9va1R5cGVzRGV2W2ldOwogICAgICAgICAgICAgICAgICB2YXIgbmV3SG9va05hbWUgPSBpID09PSBob29rVHlwZXNVcGRhdGVJbmRleERldiA/IGN1cnJlbnRIb29rTmFtZSA6IG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaSArIDEgKyAiLiAiICsgb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChyb3cubGVuZ3RoIDwgc2Vjb25kQ29sdW1uU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICByb3cgKz0gIiAiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvdyArPSBuZXdIb29rTmFtZSArICJcbiI7CiAgICAgICAgICAgICAgICAgIHRhYmxlICs9IHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBoYXMgZGV0ZWN0ZWQgYSBjaGFuZ2UgaW4gdGhlIG9yZGVyIG9mIEhvb2tzIGNhbGxlZCBieSAlcy4gVGhpcyB3aWxsIGxlYWQgdG8gYnVncyBhbmQgZXJyb3JzIGlmIG5vdCBmaXhlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHJlYWQgdGhlIFJ1bGVzIG9mIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3NcblxuICAgUHJldmlvdXMgcmVuZGVyICAgICAgICAgICAgTmV4dCByZW5kZXJcbiAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJXMgICBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5cbiIsIGNvbXBvbmVudE5hbWUsIHRhYmxlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnZhbGlkSG9va0Vycm9yKCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByZXZEZXBzID09PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCBkdXJpbmcgdGhpcyByZW5kZXIsIGJ1dCBub3QgZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIEV2ZW4gdGhvdWdoIHRoZSBmaW5hbCBhcmd1bWVudCBpcyBvcHRpb25hbCwgaXRzIHR5cGUgY2Fubm90IGNoYW5nZSBiZXR3ZWVuIHJlbmRlcnMuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzLmxlbmd0aCAhPT0gcHJldkRlcHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBmaW5hbCBhcmd1bWVudCBwYXNzZWQgdG8gJXMgY2hhbmdlZCBzaXplIGJldHdlZW4gcmVuZGVycy4gVGhlIG9yZGVyIGFuZCBzaXplIG9mIHRoaXMgYXJyYXkgbXVzdCByZW1haW4gY29uc3RhbnQuXG5cblByZXZpb3VzOiAlc1xuSW5jb21pbmc6ICVzIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsICJbIiArIHByZXZEZXBzLmpvaW4oIiwgIikgKyAiXSIsICJbIiArIG5leHREZXBzLmpvaW4oIiwgIikgKyAiXSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZXZEZXBzLmxlbmd0aCAmJiBpIDwgbmV4dERlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iamVjdElzKG5leHREZXBzW2ldLCBwcmV2RGVwc1tpXSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHNlY29uZEFyZywgbmV4dFJlbmRlckxhbmVzKSB7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IG5leHRSZW5kZXJMYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IGN1cnJlbnQyICE9PSBudWxsID8gY3VycmVudDIuX2RlYnVnSG9va1R5cGVzIDogbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mUmVSZW5kZXJzID0gMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgICAgICBpZiAobnVtYmVyT2ZSZVJlbmRlcnMgPj0gUkVfUkVOREVSX0xJTUlUKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRvbyBtYW55IHJlLXJlbmRlcnMuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlbmRlcnMgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW1iZXJPZlJlUmVuZGVycyArPSAxOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgIH0gd2hpbGUgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGhvb2tUeXBlc0RldjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRSZW5kZXJUb29GZXdIb29rcyA9IGN1cnJlbnRIb29rICE9PSBudWxsICYmIGN1cnJlbnRIb29rLm5leHQgIT09IG51bGw7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmIChjdXJyZW50Mi5mbGFncyAmIFN0YXRpY01hc2spICE9PSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgU3RhdGljTWFzaykgJiYgLy8gRGlzYWJsZSB0aGlzIHdhcm5pbmcgaW4gbGVnYWN5IG1vZGUsIGJlY2F1c2UgbGVnYWN5IFN1c3BlbnNlIGlzIHdlaXJkCiAgICAgICAgICAgIC8vIGFuZCBjcmVhdGVzIGZhbHNlIHBvc2l0aXZlcy4gVG8gbWFrZSB0aGlzIHdvcmsgaW4gbGVnYWN5IG1vZGUsIHdlJ2QKICAgICAgICAgICAgLy8gbmVlZCB0byBtYXJrIGZpYmVycyB0aGF0IGNvbW1pdCBpbiBhbiBpbmNvbXBsZXRlIHN0YXRlLCBzb21laG93LiBGb3IKICAgICAgICAgICAgLy8gbm93IEknbGwgZGlzYWJsZSB0aGUgd2FybmluZyB0aGF0IG1vc3Qgb2YgdGhlIGJ1Z3MgdGhhdCB3b3VsZCB0cmlnZ2VyCiAgICAgICAgICAgIC8vIGl0IGFyZSBlaXRoZXIgZXhjbHVzaXZlIHRvIGNvbmN1cnJlbnQgbW9kZSBvciBleGlzdCBpbiBib3RoLgogICAgICAgICAgICAoY3VycmVudDIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBFeHBlY3RlZCBzdGF0aWMgZmxhZyB3YXMgbWlzc2luZy4gUGxlYXNlIG5vdGlmeSB0aGUgUmVhY3QgdGVhbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgaWYgKGRpZFJlbmRlclRvb0Zld0hvb2tzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgZmV3ZXIgaG9va3MgdGhhbiBleHBlY3RlZC4gVGhpcyBtYXkgYmUgY2F1c2VkIGJ5IGFuIGFjY2lkZW50YWwgZWFybHkgcmV0dXJuIHN0YXRlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEaWRSZW5kZXJJZEhvb2soKSB7CiAgICAgICAgICB2YXIgZGlkUmVuZGVySWRIb29rID0gbG9jYWxJZENvdW50ZXIgIT09IDA7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICByZXR1cm4gZGlkUmVuZGVySWRIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0SG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KE1vdW50UGFzc2l2ZURldiB8IE1vdW50TGF5b3V0RGV2IHwgUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQyLmxhbmVzID0gcmVtb3ZlTGFuZXMoY3VycmVudDIubGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIb29rc0FmdGVyVGhyb3coKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vayA9IGhvb2submV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB7CiAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVF1ZXVlOiBudWxsLAogICAgICAgICAgICBxdWV1ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gaG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gaG9vazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudEhvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChuZXh0Q3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIG1vcmUgaG9va3MgdGhhbiBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIG5ld0hvb2sgPSB7CiAgICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRIb29rLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBiYXNlUXVldWU6IGN1cnJlbnRIb29rLmJhc2VRdWV1ZSwKICAgICAgICAgICAgICBxdWV1ZTogY3VycmVudEhvb2sucXVldWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gbmV3SG9vazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsYXN0RWZmZWN0OiBudWxsLAogICAgICAgICAgICBzdG9yZXM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhc2ljU3RhdGVSZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iID8gYWN0aW9uKHN0YXRlKSA6IGFjdGlvbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpbml0aWFsU3RhdGU7CiAgICAgICAgICBpZiAoaW5pdCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXQoaW5pdGlhbEFyZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbml0aWFsU3RhdGUgPSBpbml0aWFsQXJnOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IHJlZHVjZXIsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoUmVkdWNlckFjdGlvbi5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IGN1cnJlbnRIb29rOwogICAgICAgICAgdmFyIGJhc2VRdWV1ZSA9IGN1cnJlbnQyLmJhc2VRdWV1ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGJhc2VGaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIHZhciBwZW5kaW5nRmlyc3QgPSBwZW5kaW5nUXVldWUubmV4dDsKICAgICAgICAgICAgICBiYXNlUXVldWUubmV4dCA9IHBlbmRpbmdGaXJzdDsKICAgICAgICAgICAgICBwZW5kaW5nUXVldWUubmV4dCA9IGJhc2VGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLmJhc2VRdWV1ZSAhPT0gYmFzZVF1ZXVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgZXJyb3I6IEV4cGVjdGVkIHdvcmstaW4tcHJvZ3Jlc3MgcXVldWUgdG8gYmUgYSBjbG9uZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDIuYmFzZVF1ZXVlID0gYmFzZVF1ZXVlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGN1cnJlbnQyLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVGaXJzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVMYXN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lcywgdXBkYXRlTGFuZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVGaXJzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXModXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZS5oYXNFYWdlclN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gdXBkYXRlLmVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsICYmIHVwZGF0ZSAhPT0gZmlyc3QpOwogICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IG5ld0Jhc2VRdWV1ZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlUXVldWUgPSBuZXdCYXNlUXVldWVMYXN0OwogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBsYXN0SW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWRMYW5lID0gaW50ZXJsZWF2ZWQubGFuZTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgfSBlbHNlIGlmIChiYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgdmFyIGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobGFzdFJlbmRlclBoYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IGxhc3RSZW5kZXJQaGFzZVVwZGF0ZS5uZXh0OwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlKTsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbbmV3U3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpc0h5ZHJhdGluZzIgPSBnZXRJc0h5ZHJhdGluZygpOwogICAgICAgICAgaWYgKGlzSHlkcmF0aW5nMikgewogICAgICAgICAgICBpZiAoZ2V0U2VydmVyU25hcHNob3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBnZXRTZXJ2ZXJTbmFwc2hvdCwgd2hpY2ggaXMgcmVxdWlyZWQgZm9yIHNlcnZlci1yZW5kZXJlZCBjb250ZW50LiBXaWxsIHJldmVydCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNlcnZlclNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFNuYXBzaG90ICE9PSBnZXRTZXJ2ZXJTbmFwc2hvdCgpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNlcnZlclNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaW5zdCA9IHsKICAgICAgICAgICAgdmFsdWU6IG5leHRTbmFwc2hvdCwKICAgICAgICAgICAgZ2V0U25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gaW5zdDsKICAgICAgICAgIG1vdW50RWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZTbmFwc2hvdCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzbmFwc2hvdENoYW5nZWQgPSAhb2JqZWN0SXMocHJldlNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgaWYgKHNuYXBzaG90Q2hhbmdlZCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdCA9IGhvb2sucXVldWU7CiAgICAgICAgICB1cGRhdGVFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBpZiAoaW5zdC5nZXRTbmFwc2hvdCAhPT0gZ2V0U25hcHNob3QgfHwgc25hcHNob3RDaGFuZ2VkIHx8IC8vIENoZWNrIGlmIHRoZSBzdXNiY3JpYmUgZnVuY3Rpb24gY2hhbmdlZC4gV2UgY2FuIHNhdmUgc29tZSBtZW1vcnkgYnkKICAgICAgICAgIC8vIGNoZWNraW5nIHdoZXRoZXIgd2Ugc2NoZWR1bGVkIGEgc3Vic2NyaXB0aW9uIGVmZmVjdCBhYm92ZS4KICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzc0hvb2subWVtb2l6ZWRTdGF0ZS50YWcgJiBIYXNFZmZlY3QpIHsKICAgICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIHJlbmRlcmVkU25hcHNob3QpIHsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFN0b3JlQ29uc2lzdGVuY3k7CiAgICAgICAgICB2YXIgY2hlY2sgPSB7CiAgICAgICAgICAgIGdldFNuYXBzaG90LAogICAgICAgICAgICB2YWx1ZTogcmVuZGVyZWRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCk7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzdG9yZXMgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgIGlmIChzdG9yZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3Jlcy5wdXNoKGNoZWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdG9yZUluc3RhbmNlKGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSB7CiAgICAgICAgICBpbnN0LnZhbHVlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3Vic2NyaWJlVG9TdG9yZShmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB2YXIgaGFuZGxlU3RvcmVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShoYW5kbGVTdG9yZUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgewogICAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBpbnN0LnZhbHVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMocHJldlZhbHVlLCBuZXh0VmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpIHsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbml0aWFsU3RhdGUgPSBpbml0aWFsU3RhdGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlOwogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRSZWR1Y2VyOiBiYXNpY1N0YXRlUmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZQogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hTZXRTdGF0ZS5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hFZmZlY3QodGFnLCBjcmVhdGUsIGRlc3Ryb3ksIGRlcHMpIHsKICAgICAgICAgIHZhciBlZmZlY3QgPSB7CiAgICAgICAgICAgIHRhZywKICAgICAgICAgICAgY3JlYXRlLAogICAgICAgICAgICBkZXN0cm95LAogICAgICAgICAgICBkZXBzLAogICAgICAgICAgICAvLyBDaXJjdWxhcgogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICBsYXN0RWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgICAgZWZmZWN0Lm5leHQgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWZmZWN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9yZWYyID0gewogICAgICAgICAgICAgIGN1cnJlbnQ6IGluaXRpYWxWYWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBfcmVmMjsKICAgICAgICAgICAgcmV0dXJuIF9yZWYyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgcmV0dXJuIGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIHZvaWQgMCwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcHJldkVmZmVjdCA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGRlc3Ryb3kgPSBwcmV2RWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZFZmZlY3QuZGVwczsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoTW91bnRQYXNzaXZlRGV2IHwgUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoUGFzc2l2ZSwgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgSW5zZXJ0aW9uLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdChjcmVhdGUsIHJlZikgewogICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHJlZkNhbGxiYWNrID0gcmVmOwogICAgICAgICAgICB2YXIgX2luc3QgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmQ2FsbGJhY2soX2luc3QpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVmQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHJlZiAhPT0gbnVsbCAmJiByZWYgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gcmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFyZWZPYmplY3QuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBmaXJzdCBhcmd1bWVudCB0byBlaXRoZXIgYmUgYSByZWYgY2FsbGJhY2sgb3IgUmVhY3QuY3JlYXRlUmVmKCkgb2JqZWN0LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCAiYW4gb2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKHJlZk9iamVjdCkuam9pbigiLCAiKSArICJ9Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfaW5zdDIgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmT2JqZWN0LmN1cnJlbnQgPSBfaW5zdDI7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZSA6ICJudWxsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlZmZlY3REZXBzID0gZGVwcyAhPT0gbnVsbCAmJiBkZXBzICE9PSB2b2lkIDAgPyBkZXBzLmNvbmNhdChbcmVmXSkgOiBudWxsOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUsIHJlZiksIGVmZmVjdERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgfQogICAgICAgIHZhciB1cGRhdGVEZWJ1Z1ZhbHVlID0gbW91bnREZWJ1Z1ZhbHVlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbmV4dENyZWF0ZSgpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIG5leHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByZXNvbHZlZEN1cnJlbnRIb29rID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gcmVzb2x2ZWRDdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBzaG91bGREZWZlclZhbHVlID0gIWluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKHJlbmRlckxhbmVzKTsKICAgICAgICAgIGlmIChzaG91bGREZWZlclZhbHVlKSB7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXModmFsdWUsIHByZXZWYWx1ZSkpIHsKICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRMYW5lID0gY2xhaW1OZXh0VHJhbnNpdGlvbkxhbmUoKTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXZWYWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VTdGF0ZSkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFRyYW5zaXRpb24oc2V0UGVuZGluZywgY2FsbGJhY2ssIG9wdGlvbnMyKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGhpZ2hlckV2ZW50UHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSwgQ29udGludW91c0V2ZW50UHJpb3JpdHkpKTsKICAgICAgICAgIHNldFBlbmRpbmcodHJ1ZSk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldFBlbmRpbmcoZmFsc2UpOwogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbm93JDEgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICB2YXIgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlSXNOZXN0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzeW5jTmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gbmVzdGVkVXBkYXRlU2NoZWR1bGVkOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tbWl0VGltZSgpIHsKICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRDb21taXRUaW1lKCkgewogICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UHJvZmlsZXJUaW1lcihmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgaWYgKGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA8IDApIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZmliZXIsIG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwcm9maWxlclN0YXJ0VGltZTsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgZmliZXIuc2VsZkJhc2VEdXJhdGlvbiA9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAobGF5b3V0RWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIGxheW91dEVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHBhc3NpdmVFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydExheW91dEVmZmVjdFRpbWVyKCkgewogICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXJBY3R1YWxEdXJhdGlvbihmaWJlcikgewogICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgaWYgKENvbXBvbmVudCAmJiBDb21wb25lbnQuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5sYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQsCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldChpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbChvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkoX3N0YXRlKSkpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuc3RhdGU6IG11c3QgYmUgc2V0IHRvIGFuIG9iamVjdCBvciBudWxsIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldENoaWxkQ29udGV4dCgpOiBjaGlsZENvbnRleHRUeXBlcyBtdXN0IGJlIGRlZmluZWQgaW4gb3JkZXIgdG8gdXNlIGdldENoaWxkQ29udGV4dCgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGVyID0gY2xhc3NDb21wb25lbnRVcGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgc2V0KGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgewogICAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEluc3RhbmNlID0gZmFrZUludGVybmFsSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBwcm9wcykgewogICAgICAgICAgdmFyIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoImNvbnRleHRUeXBlIiBpbiBjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSAoCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgY29udGV4dFR5cGUgPT09IG51bGwgfHwgY29udGV4dFR5cGUgIT09IHZvaWQgMCAmJiBjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFICYmIGNvbnRleHRUeXBlLl9jb250ZXh0ID09PSB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIiOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byB1bmRlZmluZWQuIFRoaXMgY2FuIGJlIGNhdXNlZCBieSBhIHR5cG8gb3IgYnkgbWl4aW5nIHVwIG5hbWVkIGFuZCBkZWZhdWx0IGltcG9ydHMuIFRoaXMgY2FuIGFsc28gaGFwcGVuIGR1ZSB0byBhIGNpcmN1bGFyIGRlcGVuZGVuY3ksIHNvIHRyeSBtb3ZpbmcgdGhlIGNyZWF0ZUNvbnRleHQoKSBjYWxsIHRvIGEgc2VwYXJhdGUgZmlsZS4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dFR5cGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Qcm92aWRlciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuQ29uc3VtZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlZmluZXMgYW4gaW52YWxpZCBjb250ZXh0VHlwZS4gY29udGV4dFR5cGUgc2hvdWxkIHBvaW50IHRvIHRoZSBDb250ZXh0IG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVDb250ZXh0KCkuJXMiLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IGN0b3IuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGNvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgIT09IG51bGwgJiYgaW5zdGFuY2Uuc3RhdGUgIT09IHZvaWQgMCA/IGluc3RhbmNlLnN0YXRlIDogbnVsbDsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBzdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCJgJXNgIHVzZXMgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYnV0IGl0cyBpbml0aWFsIHN0YXRlIGlzICVzLiBUaGlzIGlzIG5vdCByZWNvbW1lbmRlZC4gSW5zdGVhZCwgZGVmaW5lIHRoZSBpbml0aWFsIHN0YXRlIGJ5IGFzc2lnbmluZyBhbiBvYmplY3QgdG8gYHRoaXMuc3RhdGVgIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBgJXNgLiBUaGlzIGVuc3VyZXMgdGhhdCBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBhcmd1bWVudHMgaGF2ZSBhIGNvbnNpc3RlbnQgc2hhcGUuIiwgY29tcG9uZW50TmFtZSwgaW5zdGFuY2Uuc3RhdGUgPT09IG51bGwgPyAibnVsbCIgOiAidW5kZWZpbmVkIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxVcGRhdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gImNvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJjb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICB2YXIgbmV3QXBpTmFtZSA9IHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiA/ICJnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSIgOiAiZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmFkZChfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbnNhZmUgbGVnYWN5IGxpZmVjeWNsZXMgd2lsbCBub3QgYmUgY2FsbGVkIGZvciBjb21wb25lbnRzIHVzaW5nIG5ldyBjb21wb25lbnQgQVBJcy5cblxuJXMgdXNlcyAlcyBidXQgYWxzbyBjb250YWlucyB0aGUgZm9sbG93aW5nIGxlZ2FjeSBsaWZlY3ljbGVzOiVzJXMlc1xuXG5UaGUgYWJvdmUgbGlmZWN5Y2xlcyBzaG91bGQgYmUgcmVtb3ZlZC4gTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTpcbmh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMiLCBfY29tcG9uZW50TmFtZSwgbmV3QXBpTmFtZSwgZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsTW91bnROYW1lIDogIiIsIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lIDogIiIsIGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxVcGRhdGVOYW1lIDogIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzTGVnYWN5Q29udGV4dENvbnN1bWVyKSB7CiAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IG9sZFN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5yZWZzID0ge307CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3Mod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50Mi5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDIubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZiB8fCB0YWcgPT09IFNpbXBsZU1lbW9Db21wb25lbnQpKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gY3VycmVudFNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gY3VycmVudFNvdXJjZS5sYW5lczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgJiYgc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgaWYgKChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSA9PT0gcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgJj0gfihMaWZlY3ljbGVFZmZlY3RNYXNrIHwgSW5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZUZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnRhZyA9IEluY29tcGxldGVDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmxhbmVzID0gcm9vdFJlbmRlckxhbmVzOwogICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93RXhjZXB0aW9uKHJvb3QzLCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHZhbHVlLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHZhbHVlOwogICAgICAgICAgICByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHVuY2F1Z2h0U3VzcGVuc2VFcnJvciA9IG5ldyBFcnJvcigiQSBjb21wb25lbnQgc3VzcGVuZGVkIHdoaWxlIHJlc3BvbmRpbmcgdG8gc3luY2hyb25vdXMgaW5wdXQuIFRoaXMgd2lsbCBjYXVzZSB0aGUgVUkgdG8gYmUgcmVwbGFjZWQgd2l0aCBhIGxvYWRpbmcgaW5kaWNhdG9yLiBUbyBmaXgsIHVwZGF0ZXMgdGhhdCBzdXNwZW5kIHNob3VsZCBiZSB3cmFwcGVkIHdpdGggc3RhcnRUcmFuc2l0aW9uLiIpOwogICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIHZhciBfc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICgoX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShfc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IoY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICByZW5kZXJEaWRFcnJvcih2YWx1ZSk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfZXJyb3JJbmZvLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MgJiYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgZXJyb3JJbmZvLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkQ2FjaGUoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDIuY2hpbGQsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IENvbXBvbmVudC5yZW5kZXI7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpICYmIENvbXBvbmVudC5jb21wYXJlID09PSBudWxsICYmIC8vIFNpbXBsZU1lbW9Db21wb25lbnQgY29kZXBhdGggZG9lc24ndCByZXNvbHZlIG91dGVyIHByb3BzIGVpdGhlci4KICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVzb2x2ZWRUeXBlLCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gbWVtbyBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKENvbXBvbmVudC50eXBlLCBudWxsLCBuZXh0UHJvcHMsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBfaW5uZXJQcm9wVHlwZXMgPSBfdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChfaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgIF9pbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgY29tcGFyZSA9IENvbXBvbmVudC5jb21wYXJlOwogICAgICAgICAgICBjb21wYXJlID0gY29tcGFyZSAhPT0gbnVsbCA/IGNvbXBhcmUgOiBzaGFsbG93RXF1YWw7CiAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50Mi5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgbmV4dFByb3BzKTsKICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIG91dGVyTWVtb1R5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBvdXRlck1lbW9UeXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQyLnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID09PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgaWYgKCFjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50MiwgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGN1cnJlbnQyLmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFN0YXRlIDogbnVsbDsKICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHNwYXduZWRDYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXh0QmFzZUxhbmVzOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2QmFzZUxhbmVzID0gcHJldlN0YXRlLmJhc2VMYW5lczsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZCYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IG5leHRCYXNlTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgbmV4dEJhc2VMYW5lcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUyID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTI7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lczIgPSBwcmV2U3RhdGUgIT09IG51bGwgPyBwcmV2U3RhdGUuYmFzZUxhbmVzIDogcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZTdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgX3N1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsICYmIHJlZiAhPT0gbnVsbCB8fCBjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5yZWYgIT09IHJlZikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hvdWxkRXJyb3Iod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wSW5zdGFuY2UgPSBuZXcgY3Rvcih3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcywgX2luc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgX2luc3RhbmNlLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKF9pbnN0YW5jZSwgc3RhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gbmV3IEVycm9yKCJTaW11bGF0ZWQgZXJyb3IgY29taW5nIGZyb20gRGV2VG9vbHMiKTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgd29ya0luUHJvZ3Jlc3MyKSwgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGU7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSXQgbG9va3MgbGlrZSAlcyBpcyByZWFzc2lnbmluZyBpdHMgb3duIGB0aGlzLnByb3BzYCB3aGlsZSByZW5kZXJpbmcuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgY2FuIGxlYWQgdG8gY29uZnVzaW5nIGJ1Z3MuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJhIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRVbml0T2ZXb3JrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGRpZENhcHR1cmVFcnJvciA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAocm9vdDMucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLnBlbmRpbmdDb250ZXh0LCByb290My5wZW5kaW5nQ29udGV4dCAhPT0gcm9vdDMuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRleHQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBjdXJyZW50IGZpYmVyLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV4dFByb3BzLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgIHZhciBvdmVycmlkZVN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IG5leHRDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGNhY2hlOiBuZXh0U3RhdGUuY2FjaGUsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbmV4dFN0YXRlLnBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXMsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0Q2hpbGRyZW4gIT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgX3JlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzICYgflBsYWNlbWVudCB8IEh5ZHJhdGluZzsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIGlmIChuZXh0Q2hpbGRyZW4gPT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIG5leHRQcm9wcyk7CiAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJldlByb3BzICE9PSBudWxsICYmIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByZXZQcm9wcykpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENvbnRlbnRSZXNldDsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZWYoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExhenlDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IGVsZW1lbnRUeXBlOwogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgdmFyIENvbXBvbmVudCA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFRhZyA9IHdvcmtJblByb2dyZXNzMi50YWcgPSByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpOwogICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRm9yd2FyZFJlZihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlTWVtb0NvbXBvbmVudCgKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICBDb21wb25lbnQsCiAgICAgICAgICAgICAgICByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudC50eXBlLCByZXNvbHZlZFByb3BzKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQgIT09IG51bGwgJiYgdHlwZW9mIENvbXBvbmVudCA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgdHlwZW9mIENvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gaGF2ZSBhIHJlbmRlciBtZXRob2QsIGJ1dCBkb2Vzbid0IGV4dGVuZCBSZWFjdC5Db21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIFJ1biB0aGVzZSBjaGVja3MgaW4gcHJvZHVjdGlvbiBvbmx5IGlmIHRoZSBmbGFnIGlzIG9mZi4KICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDAKICAgICAgICAgICkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMiA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gdmFsdWUuc3RhdGUgIT09IG51bGwgJiYgdmFsdWUuc3RhdGUgIT09IHZvaWQgMCA/IHZhbHVlLnN0YXRlIDogbnVsbDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHZhbHVlKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4obnVsbCwgd29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQpIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbiBjb21wb25lbnQuIiwgQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3duZXJOYW1lIHx8ICIiOwogICAgICAgICAgICAgIHZhciBkZWJ1Z1NvdXJjZSA9IHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgaWYgKGRlYnVnU291cmNlKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nS2V5ID0gZGVidWdTb3VyY2UuZmlsZU5hbWUgKyAiOiIgKyBkZWJ1Z1NvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBiZSBnaXZlbiByZWZzLiBBdHRlbXB0cyB0byBhY2Nlc3MgdGhpcyByZWYgd2lsbCBmYWlsLiBEaWQgeW91IG1lYW4gdG8gdXNlIFJlYWN0LmZvcndhcmRSZWYoKT8lcyIsIGluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdW5jdGlvbiBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTMgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIiwgX2NvbXBvbmVudE5hbWUzKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBjb250ZXh0VHlwZS4iLCBfY29tcG9uZW50TmFtZTQpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgU1VTUEVOREVEX01BUktFUiA9IHsKICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICB0cmVlQ29udGV4dDogbnVsbCwKICAgICAgICAgIHJldHJ5TGFuZTogTm9MYW5lCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgY2FjaGVQb29sOiBnZXRTdXNwZW5kZWRDYWNoZSgpLAogICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IG1lcmdlTGFuZXMocHJldk9mZnNjcmVlblN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKSwKICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICB0cmFuc2l0aW9uczogcHJldk9mZnNjcmVlblN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiByZW1vdmVMYW5lcyhjdXJyZW50Mi5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkU3VzcGVuZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChkaWRTdXNwZW5kIHx8IHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50MikpIHsKICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5EaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBkZWh5ZHJhdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmYWxsYmFja0ZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZGVoeWRyYXRlZCA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChfZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX25leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdGF0ZSA9IGN1cnJlbnQyLmNoaWxkLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLmNoaWxkTGFuZXMgPSBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50MiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4yID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gX3ByaW1hcnlDaGlsZEZyYWdtZW50MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IFtjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50XTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgIC8vIGNvbXBsZXRlZCwgZXZlbiB0aG91Z2ggaXQncyBpbiBhbiBpbmNvbnNpc3RlbnQgc3RhdGUuCiAgICAgICAgICAgIChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gTWFrZSBzdXJlIHdlJ3JlIG9uIHRoZSBzZWNvbmQgcGFzcywgaS5lLiB0aGUgcHJpbWFyeSBjaGlsZCBmcmFnbWVudCB3YXMKICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAvLyB3aGVuIERldlRvb2xzIGZvcmNlcyB1cyB0byBkaXNwbGF5IGEgZmFsbGJhY2s7IHdlIHNraXAgdGhlIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAvLyBwYXNzIGVudGlyZWx5IGFuZCBnbyBzdHJhaWdodCB0byByZW5kZXJpbmcgdGhlIGZhbGxiYWNrLiAoSW4gQ29uY3VycmVudAogICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgLy8gb25seSBjb2RlcGF0aC4pCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgcHJpbWFyeUNoaWxkUHJvcHMpOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIGZpYmVyTW9kZSk7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaHlkcmF0ZSBTdXNwZW5zZSBpbiBsZWdhY3kgbW9kZS4gU3dpdGNoIGZyb20gUmVhY3RET00uaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIpIHRvIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikucmVuZGVyKGVsZW1lbnQpIG9yIHJlbW92ZSB0aGUgU3VzcGVuc2UgY29tcG9uZW50cyBmcm9tIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgY29tcG9uZW50cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhTeW5jTGFuZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCFkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgIHdhcm5JZkh5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoCiAgICAgICAgICAgICAgICBjdXJyZW50MiwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoZW4gd2UgZGVsZXRlIGxlZ2FjeSBtb2RlLCB3ZSBzaG91bGQgbWFrZSB0aGlzIGVycm9yIGFyZ3VtZW50CiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAvLyBkZS1vcHQgdG8gY2xpZW50IHJlbmRlcmluZyBzaG91bGQgaGF2ZSBhbiBlcnJvciBtZXNzYWdlLgogICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIF9nZXRTdXNwZW5zZUluc3RhbmNlRiA9IGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICBzdGFjayA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5zdGFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICBpZiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIlRoZSBzZXJ2ZXIgY291bGQgbm90IGZpbmlzaCB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LCBsaWtlbHkgZHVlIHRvIGFuIGVycm9yIGR1cmluZyBzZXJ2ZXIgcmVuZGVyaW5nLiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUoZXJyb3IyLCBkaWdlc3QsIHN0YWNrKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBjYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dENoYW5nZWQyID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIGN1cnJlbnQyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICBpZiAoZGlkUmVjZWl2ZVVwZGF0ZSB8fCBoYXNDb250ZXh0Q2hhbmdlZDIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lID0gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lOwogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50MiwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudDIsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhpcyBTdXNwZW5zZSBib3VuZGFyeSByZWNlaXZlZCBhbiB1cGRhdGUgYmVmb3JlIGl0IGZpbmlzaGVkIGh5ZHJhdGluZy4gVGhpcyBjYXVzZWQgdGhlIGJvdW5kYXJ5IHRvIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiBUaGUgdXN1YWwgd2F5IHRvIGZpeCB0aGlzIGlzIHRvIHdyYXAgdGhlIG9yaWdpbmFsIHVwZGF0ZSBpbiBzdGFydFRyYW5zaXRpb24uIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeS5iaW5kKG51bGwsIGN1cnJlbnQyKTsKICAgICAgICAgICAgICByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShzdXNwZW5zZUluc3RhbmNlLCByZXRyeSk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZS50cmVlQ29udGV4dCk7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZTIgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZyB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIoZmliZXIsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZExhc3RDb250ZW50Um93KGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciByb3cgPSBmaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdyA9IHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXN0Q29udGVudFJvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXZlYWxPcmRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBVc2UgbG93ZXJjYXNlICIlcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZCI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignJXMgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09ICJjb2xsYXBzZWQiICYmIHRhaWxNb2RlICE9PSAiaGlkZGVuIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRTbG90LCBpbmRleDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQW5BcnJheSA9IGlzQXJyYXkoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkcmVuW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBfaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKHN0ZXAudmFsdWUsIF9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBfaSsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc2luZ2xlIHJvdyB3YXMgcGFzc2VkIHRvIGEgPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0iJXMiIC8+LiBUaGlzIGlzIG5vdCB1c2VmdWwgc2luY2UgaXQgbmVlZHMgbXVsdGlwbGUgcm93cy4gRGlkIHlvdSBtZWFuIHRvIHBhc3MgbXVsdGlwbGUgY2hpbGRyZW4gb3IgYW4gYXJyYXk/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUod29ya0luUHJvZ3Jlc3MyLCBpc0JhY2t3YXJkcywgdGFpbCwgbGFzdENvbnRlbnRSb3csIHRhaWxNb2RlKSB7CiAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHsKICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICByZW5kZXJpbmc6IG51bGwsCiAgICAgICAgICAgICAgcmVuZGVyaW5nU3RhcnRUaW1lOiAwLAogICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmlzQmFja3dhcmRzID0gaXNCYWNrd2FyZHM7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IDA7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSBsYXN0Q29udGVudFJvdzsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWxNb2RlID0gdGFpbE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgdmFyIHRhaWxNb2RlID0gbmV4dFByb3BzLnRhaWw7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4obmV3Q2hpbGRyZW4sIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG91bGRGb3JjZUZhbGxiYWNrID0gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBmaW5kTGFzdENvbnRlbnRSb3cod29ya0luUHJvZ3Jlc3MyLmNoaWxkKTsKICAgICAgICAgICAgICAgIHZhciB0YWlsOwogICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWlsID0gbGFzdENvbnRlbnRSb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJvdy5zaWJsaW5nID0gX3RhaWw7CiAgICAgICAgICAgICAgICAgIF90YWlsID0gcm93OwogICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjogewogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyB0YWlsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdm9pZCAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIGNvbnRleHQgPSBwcm92aWRlclR5cGUuX2NvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdQcm9wcy52YWx1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChwcm92aWRlclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3ZpZGVyUHJvcFR5cGVzLCBuZXdQcm9wcywgInByb3AiLCAiQ29udGV4dC5Qcm92aWRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IG9sZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcHMuY2hpbGRyZW4gPT09IG5ld1Byb3BzLmNoaWxkcmVuICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dC5fY29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZW5kZXIyID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuZGVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbnRleHQgY29uc3VtZXIgd2FzIHJlbmRlcmVkIHdpdGggbXVsdGlwbGUgY2hpbGRyZW4sIG9yIGEgY2hpbGQgdGhhdCBpc24ndCBhIGZ1bmN0aW9uLiBBIGNvbnRleHQgY29uc3VtZXIgZXhwZWN0cyBhIHNpbmdsZSBjaGlsZCB0aGF0IGlzIGEgZnVuY3Rpb24uIElmIHlvdSBkaWQgcGFzcyBhIGZ1bmN0aW9uLCBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlIGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gcmVuZGVyMihuZXdWYWx1ZSk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudDIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMpOwogICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW91bnRGaWJlcihjdXJyZW50Miwgb2xkV29ya0luUHJvZ3Jlc3MsIG5ld1dvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc3dhcCB0aGUgcm9vdCBmaWJlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBvbGRXb3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gb2xkV29ya0luUHJvZ3Jlc3Muc2libGluZzsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmV0dXJuID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgIGlmIChvbGRXb3JrSW5Qcm9ncmVzcyA9PT0gcmV0dXJuRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5jaGlsZCA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBwcmV2U2libGluZyA9IHJldHVybkZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAocHJldlNpYmxpbmcuc2libGluZyAhPT0gb2xkV29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByZXZpb3VzIHNpYmxpbmcuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZTaWJsaW5nLnNpYmxpbmcgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQyXTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHVwZGF0ZUxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZSh1cGRhdGVMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGhhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZExhbmVzID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgcHJpbWFyeUNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IChjdXJyZW50Mi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciBfaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ICYmIGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlICE9PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ICYmIC8vIElmIHRoaXMgaXMgdGhlIHNlY29uZCBwYXNzIG9mIGFuIGVycm9yIG9yIHN1c3BlbnNlIGJvdW5kYXJ5LCB0aGVyZQogICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY3VycmVudDIuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IHdvcmtJblByb2dyZXNzMi5pbmRleDsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExhenlDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gQ29tcG9uZW50ID8gdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIHVucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50ID8gX3VucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IHR5cGUgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHModHlwZSwgX3VucmVzb2x2ZWRQcm9wczIpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIF9yZXNvbHZlZFByb3BzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1vZGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUHJvZmlsZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfdHlwZTIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzKF90eXBlMiwgX3VucmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IF90eXBlMi5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlMikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMoX3R5cGUyLnR5cGUsIF9yZXNvbHZlZFByb3BzMyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX3R5cGUyLCBfcmVzb2x2ZWRQcm9wczMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudDIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczQgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczQgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IF9Db21wb25lbnQyID8gX3VucmVzb2x2ZWRQcm9wczQgOiByZXNvbHZlRGVmYXVsdFByb3BzKF9Db21wb25lbnQyLCBfdW5yZXNvbHZlZFByb3BzNCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQyLCBfcmVzb2x2ZWRQcm9wczQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZWYkMSh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWY7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhcHBlbmRBbGxDaGlsZHJlbjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lcjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbXBvbmVudCQxOwogICAgICAgIHZhciB1cGRhdGVIb3N0VGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuID0gZnVuY3Rpb24ocGFyZW50LCB3b3JrSW5Qcm9ncmVzczIsIG5lZWRzVmlzaWJpbGl0eVRvZ2dsZSwgaXNIaWRkZW4pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyID0gZnVuY3Rpb24oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBwcmVwYXJlVXBkYXRlKGluc3RhbmNlLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0KTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxID0gZnVuY3Rpb24oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICBpZiAob2xkVGV4dCAhPT0gbmV3VGV4dCkgewogICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBoYXNSZW5kZXJlZEFUYWlsRmFsbGJhY2spIHsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAocmVuZGVyU3RhdGUudGFpbE1vZGUpIHsKICAgICAgICAgICAgY2FzZSAiaGlkZGVuIjogewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIGxhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKHRhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZSA9IHRhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFpbE5vZGUgPSB0YWlsTm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJjb2xsYXBzZWQiOiB7CiAgICAgICAgICAgICAgdmFyIF90YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIF9sYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChfdGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChfdGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIF9sYXN0VGFpbE5vZGUgPSBfdGFpbE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfdGFpbE5vZGUgPSBfdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9sYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrICYmIHJlbmRlclN0YXRlLnRhaWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBidWJibGVQcm9wZXJ0aWVzKGNvbXBsZXRlZFdvcmspIHsKICAgICAgICAgIHZhciBkaWRCYWlsb3V0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGUgIT09IG51bGwgJiYgY29tcGxldGVkV29yay5hbHRlcm5hdGUuY2hpbGQgPT09IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIGlmICghZGlkQmFpbG91dCkgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgdHJlZUJhc2VEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhjaGlsZC5sYW5lcywgY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IGNoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIGFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdHJlZUJhc2VEdXJhdGlvbiArPSBjaGlsZC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uID0gYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZC5sYW5lcywgX2NoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuc3VidHJlZUZsYWdzOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIF9jaGlsZC5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgX3RyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIF9jaGlsZDIgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZDIubGFuZXMsIF9jaGlsZDIuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIF90cmVlQmFzZUR1cmF0aW9uICs9IF9jaGlsZDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIF9jaGlsZDIgPSBfY2hpbGQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IF90cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY2hpbGQzID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQzLmxhbmVzLCBfY2hpbGQzLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQzLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfY2hpbGQzLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICBfY2hpbGQzID0gX2NoaWxkMy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wbGV0ZWRXb3JrLmNoaWxkTGFuZXMgPSBuZXdDaGlsZExhbmVzOwogICAgICAgICAgcmV0dXJuIGRpZEJhaWxvdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKSB7CiAgICAgICAgICBpZiAoaGFzVW5oeWRyYXRlZFRhaWxOb2RlcygpICYmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyIHwgSW5jb21wbGV0ZSB8IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsICYmIG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICghd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQSBkZWh5ZHJhdGVkIHN1c3BlbnNlIGNvbXBvbmVudCB3YXMgY29tcGxldGVkIHdpdGhvdXQgYSBoeWRyYXRlZCBub2RlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpc1RpbWVkT3V0U3VzcGVuc2UgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChpc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoX2lzVGltZWRPdXRTdXNwZW5zZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9wcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gX3ByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDoKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciBmaWJlclJvb3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBpZiAoZmliZXJSb290LnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBmaWJlclJvb3QuY29udGV4dCA9IGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmICh3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY2xpZW50IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICFwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkIHx8IC8vIENoZWNrIGlmIHdlIHJldmVydGVkIHRvIGNsaWVudCByZW5kZXJpbmcgKGUuZy4gZHVlIHRvIGFuIGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSAhPT0gTm9GbGFncwogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Mi5yZWYgIT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghbmV3UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZSh0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGluc3RhbmNlLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBuZXdQcm9wczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgJiYgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld1RleHQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBtdXN0IGhhdmUgbmV3IHByb3BzIGZvciBuZXcgbW91bnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkMiA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkMikgewogICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGNyZWF0ZVRleHRJbnN0YW5jZShuZXdUZXh0LCBfcm9vdENvbnRhaW5lckluc3RhbmNlLCBfY3VycmVudEhvc3RDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgfHwgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCAmJiBjdXJyZW50Mi5tZW1vaXplZFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoID0gY29tcGxldGVEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKCFmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHREaWRUaW1lb3V0ID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2RGlkVGltZW91dCA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0ICE9PSBwcmV2RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuRmliZXIyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuRmliZXIyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNJbnZpc2libGVDaGlsZENvbnRleHQgPSBjdXJyZW50MiA9PT0gbnVsbCAmJiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudW5zdGFibGVfYXZvaWRUaGlzRmFsbGJhY2sgIT09IHRydWUgfHwgIWVuYWJsZVN1c3BlbnNlQXZvaWRUaGlzRmFsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNJbnZpc2libGVDaGlsZENvbnRleHQgfHwgaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcmVwYXJlUG9ydGFsTW91bnQod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKF9Db21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQWxyZWFkeSA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRUYWlsID0gcmVuZGVyU3RhdGUucmVuZGVyaW5nOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZFRhaWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbm5vdEJlU3VzcGVuZGVkID0gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgJiYgKGN1cnJlbnQyID09PSBudWxsIHx8IChjdXJyZW50Mi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKTsKICAgICAgICAgICAgICAgICAgaWYgKCFjYW5ub3RCZVN1c3BlbmRlZCkgewogICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RoZW5hYmxlcyA9IHN1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG5ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgICAgICAgICByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCAmJiBub3coKSA+IGdldFJlbmRlclRhcmdldFRpbWUoKSkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgX3N1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyZW5kZXJlZFRhaWwpOwogICAgICAgICAgICAgICAgICBpZiAoX3N1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX25ld1RoZW5hYmxlcyA9IF9zdXNwZW5kZWQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXdUaGVuYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IF9uZXdUaGVuYWJsZXM7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsID09PSBudWxsICYmIHJlbmRlclN0YXRlLnRhaWxNb2RlID09PSAiaGlkZGVuIiAmJiAhcmVuZGVyZWRUYWlsLmFsdGVybmF0ZSAmJiAhZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSB0aW1lIGl0IHRvb2sgdG8gcmVuZGVyIGxhc3Qgcm93IGlzIGdyZWF0ZXIgdGhhbiB0aGUgcmVtYWluaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gdGltZSB3ZSBoYXZlIHRvIHJlbmRlci4gU28gcmVuZGVyaW5nIG9uZSBtb3JlIHJvdyB3b3VsZCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICAvLyBleGNlZWQgaXQuCiAgICAgICAgICAgICAgICAgICAgbm93KCkgKiAyIC0gcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpICYmIHJlbmRlckxhbmVzMiAhPT0gT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gU29tZVJldHJ5TGFuZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLmlzQmFja3dhcmRzKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlcmVkVGFpbC5zaWJsaW5nID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcmVuZGVyU3RhdGUubGFzdDsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzU2libGluZy5zaWJsaW5nID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbmV4dDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBuZXh0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSBub3coKTsKICAgICAgICAgICAgICAgIG5leHQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHZhciBuZXh0SXNIaWRkZW4gPSBfbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9wcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIHByZXZJc0hpZGRlbiA9IF9wcmV2U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocHJldklzSGlkZGVuICE9PSBuZXh0SXNIaWRkZW4gJiYgLy8gTGVnYWN5SGlkZGVuIGRvZXNuJ3QgZG8gYW55IGhpZGluZyDigJQgaXQgb25seSBwcmUtcmVuZGVycy4KICAgICAgICAgICAgICAgICFlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghbmV4dElzSGlkZGVuIHx8ICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHN1YnRyZWVSZW5kZXJMYW5lcywgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgJiAoUGxhY2VtZW50IHwgVXBkYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICB2YXIgX2ZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmICgoX2ZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgIT09IE5vRmxhZ3MgJiYgKF9mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaHJldyBpbiBuZXdseSBtb3VudGVkIGRlaHlkcmF0ZWQgY29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfZmxhZ3MyID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChfZmxhZ3MyICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gX2ZsYWdzMiAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50MiwgaW50ZXJydXB0ZWRXb3JrLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKGludGVycnVwdGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IGludGVycnVwdGVkV29yay50eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICAgIGlmIChjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBpbnRlcnJ1cHRlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGludGVycnVwdGVkV29yay50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyhpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha1NldCA9IHR5cGVvZiBXZWFrU2V0ID09PSAiZnVuY3Rpb24iID8gV2Vha1NldCA6IFNldDsKICAgICAgICB2YXIgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIgPSBmdW5jdGlvbihjdXJyZW50MiwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50Mi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50Mik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQsIGN1cnJlbnQyKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyKGN1cnJlbnQyLCBpbnN0YW5jZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUF0dGFjaFJlZihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGN1cnJlbnQyKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgcmVmID0gY3VycmVudDIucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgJiYgY3VycmVudDIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50Mik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldFZhbCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZXR1cm4gdmFsdWUgZnJvbSBhIGNhbGxiYWNrIHJlZiBpbiAlcy4gQSBjYWxsYmFjayByZWYgc2hvdWxkIG5vdCByZXR1cm4gYSBmdW5jdGlvbi4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQyKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsRGVzdHJveShjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZm9jdXNlZEluc3RhbmNlSGFuZGxlID0gbnVsbDsKICAgICAgICB2YXIgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaXJzdENoaWxkKSB7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBwcmVwYXJlRm9yQ29tbWl0KHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfYmVnaW4oKTsKICAgICAgICAgIHZhciBzaG91bGRGaXJlID0gc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyOwogICAgICAgICAgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHNob3VsZEZpcmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIEJlZm9yZU11dGF0aW9uTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKChmbGFncyAmIFNuYXBzaG90KSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzbmFwc2hvdCA9IGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBwcmV2UHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzKGZpbmlzaGVkV29yay50eXBlLCBwcmV2UHJvcHMpLCBwcmV2U3RhdGUpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRpZFdhcm5TZXQgPSBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoc25hcHNob3QgPT09IHZvaWQgMCAmJiAhZGlkV2FyblNldC5oYXMoZmluaXNoZWRXb3JrLnR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuU2V0LmFkZChmaW5pc2hlZFdvcmsudHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKTogQSBzbmFwc2hvdCB2YWx1ZSAob3IgbnVsbCkgbXVzdCBiZSByZXR1cm5lZC4gWW91IGhhdmUgcmV0dXJuZWQgdW5kZWZpbmVkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlID0gc25hcHNob3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBjbGVhckNvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgdW5pdCBvZiB3b3JrIHRhZyBzaG91bGQgbm90IGhhdmUgc2lkZS1lZmZlY3RzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoZmxhZ3MsIGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZSAhPT0gbnVsbCA/IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgOiBudWxsOwogICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBmbGFncykgPT09IGZsYWdzKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVzdHJveSA9IGVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICAgICAgZWZmZWN0LmRlc3Ryb3kgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShmaW5pc2hlZFdvcmssIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChmbGFncywgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY3JlYXRlID0gZWZmZWN0LmNyZWF0ZTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdCh0cnVlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWZmZWN0LmRlc3Ryb3kgPSBjcmVhdGUoKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDAgJiYgdHlwZW9mIGRlc3Ryb3kgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaG9va05hbWUgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgTGF5b3V0KSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICAgICAgaG9va05hbWUgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChlZmZlY3QudGFnICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICAgICAgaG9va05hbWUgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgaG9va05hbWUgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGFkZGVuZHVtID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgWW91IHJldHVybmVkIG51bGwuIElmIHlvdXIgZWZmZWN0IGRvZXMgbm90IHJlcXVpcmUgY2xlYW4gdXAsIHJldHVybiB1bmRlZmluZWQgKG9yIG5vdGhpbmcpLiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVzdHJveS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICJcblxuSXQgbG9va3MgbGlrZSB5b3Ugd3JvdGUgIiArIGhvb2tOYW1lICsgIihhc3luYyAoKSA9PiAuLi4pIG9yIHJldHVybmVkIGEgUHJvbWlzZS4gSW5zdGVhZCwgd3JpdGUgdGhlIGFzeW5jIGZ1bmN0aW9uIGluc2lkZSB5b3VyIGVmZmVjdCBhbmQgY2FsbCBpdCBpbW1lZGlhdGVseTpcblxuIiArIGhvb2tOYW1lICsgIigoKSA9PiB7XG4gIGFzeW5jIGZ1bmN0aW9uIGZldGNoRGF0YSgpIHtcbiAgICAvLyBZb3UgY2FuIGF3YWl0IGhlcmVcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IE15QVBJLmdldERhdGEoc29tZUlkKTtcbiAgICAvLyAuLi5cbiAgfVxuICBmZXRjaERhdGEoKTtcbn0sIFtzb21lSWRdKTsgLy8gT3IgW10gaWYgZWZmZWN0IGRvZXNuJ3QgbmVlZCBwcm9wcyBvciBzdGF0ZVxuXG5MZWFybiBtb3JlIGFib3V0IGRhdGEgZmV0Y2hpbmcgd2l0aCBIb29rczogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2hvb2tzLWRhdGEtZmV0Y2hpbmciOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgWW91IHJldHVybmVkOiAiICsgZGVzdHJveTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIG11c3Qgbm90IHJldHVybiBhbnl0aGluZyBiZXNpZGVzIGEgZnVuY3Rpb24sIHdoaWNoIGlzIHVzZWQgZm9yIGNsZWFuLXVwLiVzIiwgaG9va05hbWUsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVFZmZlY3REdXJhdGlvbnMoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXNzaXZlRWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgdmFyIF9maW5pc2hlZFdvcmskbWVtb2l6ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBpZCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZS5pZCwgb25Qb3N0Q29tbWl0ID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLm9uUG9zdENvbW1pdDsKICAgICAgICAgICAgICAgICAgdmFyIGNvbW1pdFRpbWUyID0gZ2V0Q29tbWl0VGltZSgpOwogICAgICAgICAgICAgICAgICB2YXIgcGhhc2UgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlID09PSBudWxsID8gIm1vdW50IiA6ICJ1cGRhdGUiOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9ICJuZXN0ZWQtdXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvblBvc3RDb21taXQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBvblBvc3RDb21taXQoaWQsIHBoYXNlLCBwYXNzaXZlRWZmZWN0RHVyYXRpb24sIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaW5pc2hlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgICBvdXRlcjogd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDMucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IHBhc3NpdmVFZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IHBhc3NpdmVFZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RPbkZpYmVyKGZpbmlzaGVkUm9vdCwgY3VycmVudDIsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLmZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBjdXJyZW50Mi5tZW1vaXplZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhmaW5pc2hlZFdvcmsudHlwZSwgY3VycmVudDIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIHVwZGF0ZVF1ZXVlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIF91cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmIChfdXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay5jaGlsZC50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZ2V0UHVibGljSW5zdGFuY2UoZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgX3VwZGF0ZVF1ZXVlLCBfaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsICYmIGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgY29tbWl0TW91bnQoX2luc3RhbmNlMiwgdHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUyID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIG9uQ29tbWl0ID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vbkNvbW1pdCwgb25SZW5kZXIgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uUmVuZGVyOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGN1cnJlbnQyID09PSBudWxsID8gIm1vdW50IiA6ICJ1cGRhdGUiOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9ICJuZXN0ZWQtdXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvblJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUmVuZGVyKGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZmluaXNoZWRXb3JrLmFjdHVhbER1cmF0aW9uLCBmaW5pc2hlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiwgZmluaXNoZWRXb3JrLmFjdHVhbFN0YXJ0VGltZSwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uQ29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNvbW1pdChmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVucXVldWVQZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgICBvdXRlcjogd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICByb290My5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgdW5pdCBvZiB3b3JrIHRhZyBzaG91bGQgbm90IGhhdmUgc2lkZS1lZmZlY3RzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBSZWYpIHsKICAgICAgICAgICAgICAgIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNPbkZpYmVyKG5vZGUpIHsKICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24obm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChub2RlLCBub2RlLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzYWZlbHlBdHRhY2hSZWYobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4oZmluaXNoZWRXb3JrLCBpc0hpZGRlbikgewogICAgICAgICAgdmFyIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaGlkZUluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdW5oaWRlSW5zdGFuY2Uobm9kZS5zdGF0ZU5vZGUsIG5vZGUubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlVGV4dEluc3RhbmNlKF9pbnN0YW5jZTMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMywgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKG5vZGUudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgfHwgbm9kZS50YWcgPT09IExlZ2FjeUhpZGRlbkNvbXBvbmVudCkgJiYgbm9kZS5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIG5vZGUgIT09IGZpbmlzaGVkV29yaykgOwogICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbm9kZSkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgcmVmID0gZmluaXNoZWRXb3JrLnJlZjsKICAgICAgICAgIGlmIChyZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlVG9Vc2U7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIGluc3RhbmNlVG9Vc2UgPSBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghcmVmLmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmVmIG9iamVjdCBwcm92aWRlZCBmb3IgJXMuIFVzZSBlaXRoZXIgYSByZWYtc2V0dGVyIGZ1bmN0aW9uIG9yIFJlYWN0LmNyZWF0ZVJlZigpLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaWJlck11dGF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUucmV0dXJuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZpYmVyLnJldHVybiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhhbHRlcm5hdGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXRhY2hEZWxldGVkSW5zdGFuY2UoaG9zdEluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFBhcmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgfHwgZmliZXIudGFnID09PSBIb3N0UG9ydGFsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0U2libGluZyhmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHNpYmxpbmdzOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IGlzSG9zdFBhcmVudChub2RlLnJldHVybikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAobm9kZS50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgbm9kZS50YWcgIT09IEhvc3RUZXh0ICYmIG5vZGUudGFnICE9PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5mbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICAgICAgY29udGludWUgc2libGluZ3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkID09PSBudWxsIHx8IG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKG5vZGUuZmxhZ3MgJiBQbGFjZW1lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGdldEhvc3RQYXJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50RmliZXIuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQocGFyZW50KTsKICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyLmZsYWdzICY9IH5Db250ZW50UmVzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBiZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShmaW5pc2hlZFdvcmssIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB2YXIgX3BhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHZhciBfYmVmb3JlID0gZ2V0SG9zdFNpYmxpbmcoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGZpbmlzaGVkV29yaywgX2JlZm9yZSwgX3BhcmVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9zdCBwYXJlbnQgZmliZXIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnQsIHN0YXRlTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudCwgc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFwcGVuZENoaWxkKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUoY2hpbGQsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgd2hpbGUgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgdmFyIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGZpbmRQYXJlbnQ6IHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudC50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdFBhcmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIocm9vdDMsIHJldHVybkZpYmVyLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkZXRhY2hGaWJlck11dGF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgY2hpbGQpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpIHsKICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChkZWxldGVkRmliZXIpOwogICAgICAgICAgc3dpdGNoIChkZWxldGVkRmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIHByZXZIb3N0UGFyZW50SXNDb250YWluZXIgPSBob3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50SXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2hpbGQoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZIb3N0UGFyZW50ID0gaG9zdFBhcmVudDsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gX3ByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gX3ByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBkZWxldGVkRmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgdmFyIF9lZmZlY3QgPSBlZmZlY3QsIGRlc3Ryb3kgPSBfZWZmZWN0LmRlc3Ryb3ksIHRhZyA9IF9lZmZlY3QudGFnOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZEZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZGVsZXRlZEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZGVsZXRlZEZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBkZWxldGVkRmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHdha2VhYmxlcyA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh3YWtlYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAocmV0cnlDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID0gbmV3IFBvc3NpYmx5V2Vha1NldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdha2VhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHdha2VhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmVzb2x2ZVJldHJ5V2FrZWFibGUuYmluZChudWxsLCBmaW5pc2hlZFdvcmssIHdha2VhYmxlKTsKICAgICAgICAgICAgICBpZiAoIXJldHJ5Q2FjaGUuaGFzKHdha2VhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0cnlDYWNoZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Qcm9ncmVzc0xhbmVzICE9PSBudWxsICYmIGluUHJvZ3Jlc3NSb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKGluUHJvZ3Jlc3NSb290LCBpblByb2dyZXNzTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgZmluaXNoZWQgcm9vdCBhbmQgbGFuZXMgdG8gYmUgc2V0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FrZWFibGUudGhlbihyZXRyeSwgcmV0cnkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMpOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgbGFuZXMpIHsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBwYXJlbnRGaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY2hpbGRUb0RlbGV0ZSwgcGFyZW50RmliZXIsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkRlYnVnRmliZXIgPSBnZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5zdWJ0cmVlRmxhZ3MgJiBNdXRhdGlvbk1hc2spIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50RmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjaGlsZCk7CiAgICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihjaGlsZCwgcm9vdDMpOwogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZEZWJ1Z0ZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIGN1cnJlbnQyID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoSW5zZXJ0aW9uIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFJlZikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50MiwgY3VycmVudDIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQyLCBjdXJyZW50Mi5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgQ29udGVudFJlc2V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2U0ID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZTQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdQcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQyICE9PSBudWxsID8gY3VycmVudDIubWVtb2l6ZWRQcm9wcyA6IG5ld1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlKF9pbnN0YW5jZTQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgc2hvdWxkIGhhdmUgYSB0ZXh0IG5vZGUgaW5pdGlhbGl6ZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBuZXdUZXh0ID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFByb3BzIDogbmV3VGV4dDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2Um9vdFN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldlJvb3RTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5GaWJlciA9IGZpbmlzaGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuRmliZXIuZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuSW5zdGFuY2UgPSBvZmZzY3JlZW5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBvZmZzY3JlZW5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IGlzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUgIT09IG51bGwgJiYgb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmICghd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3dhc0hpZGRlbiA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IF93YXNIaWRkZW47CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgX29mZnNjcmVlbkluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBfbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfaXNIaWRkZW4gPSBfbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQm91bmRhcnkgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBfaXNIaWRkZW47CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChfaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIV93YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICgob2Zmc2NyZWVuQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5Cb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQm91bmRhcnkuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzY3JlZW5DaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5DaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKG9mZnNjcmVlbkNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4ob2Zmc2NyZWVuQm91bmRhcnksIF9pc0hpZGRlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoZmxhZ3MgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+UGxhY2VtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZsYWdzICYgSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+SHlkcmF0aW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSAoc3VidHJlZVJvb3QubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gT2Zmc2NyZWVuQ29tcG9uZW50ICYmIGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGlzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICBpZiAobmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHdhc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiAmJiAhcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oCiAgICAgICAgICAgICAgICAgICAgY2hpbGQsCiAgICAgICAgICAgICAgICAgICAgLy8gTmV3IHJvb3Q7IGJ1YmJsZSBiYWNrIHVwIHRvIGhlcmUgYW5kIHN0b3AuCiAgICAgICAgICAgICAgICAgICAgcm9vdDMsCiAgICAgICAgICAgICAgICAgICAgY29tbWl0dGVkTGFuZXMKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIocm9vdDMsIGN1cnJlbnQyLCBmaWJlciwgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZmliZXIsIGZpYmVyLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gT2Zmc2NyZWVuQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfYmVnaW4oZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MgJiYgZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50T25GaWJlcihyb290MywgZmliZXIsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhmaXJzdENoaWxkKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfYmVnaW4oKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKChuZXh0RWZmZWN0LmZsYWdzICYgQ2hpbGREZWxldGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gZmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaWJlclRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXJUb0RlbGV0ZTsKICAgICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihmaWJlclRvRGVsZXRlLCBmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZENoaWxkID0gcHJldmlvdXNGaWJlci5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGV0YWNoZWRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNGaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZFNpYmxpbmcgPSBkZXRhY2hlZENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQgPSBkZXRhY2hlZFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChkZXRhY2hlZENoaWxkICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihkZWxldGVkU3VidHJlZVJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpOwogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnQyLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChjdXJyZW50Mi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxLCBjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oY3VycmVudDIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxLCBjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUxheW91dEVmZmVjdE1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZmliZXIsIGZpYmVyLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZVBhc3NpdmVFZmZlY3RVbm1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDT01QT05FTlRfVFlQRSA9IDA7CiAgICAgICAgdmFyIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IDE7CiAgICAgICAgdmFyIFJPTEVfVFlQRSA9IDI7CiAgICAgICAgdmFyIFRFU1RfTkFNRV9UWVBFID0gMzsKICAgICAgICB2YXIgVEVYVF9UWVBFID0gNDsKICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wuZm9yKSB7CiAgICAgICAgICB2YXIgc3ltYm9sRm9yID0gU3ltYm9sLmZvcjsKICAgICAgICAgIENPTVBPTkVOVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5jb21wb25lbnQiKTsKICAgICAgICAgIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IuaGFzX3BzZXVkb19jbGFzcyIpOwogICAgICAgICAgUk9MRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5yb2xlIik7CiAgICAgICAgICBURVNUX05BTUVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IudGVzdF9pZCIpOwogICAgICAgICAgVEVYVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXh0Iik7CiAgICAgICAgfQogICAgICAgIHZhciBjb21taXRIb29rcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdCQxKCkgewogICAgICAgICAgewogICAgICAgICAgICBjb21taXRIb29rcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbW1pdEhvb2spIHsKICAgICAgICAgICAgICByZXR1cm4gY29tbWl0SG9vaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgZnVuY3Rpb24gaXNMZWdhY3lBY3RFbnZpcm9ubWVudChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHZhciBqZXN0SXNEZWZpbmVkID0gdHlwZW9mIGplc3QgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICByZXR1cm4gamVzdElzRGVmaW5lZCAmJiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgIT09IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAvLyAkRmxvd0V4cGVjdGVkRXJyb3Ig4oCTIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCBnbG9iYWwKICAgICAgICAgICAgICB0eXBlb2YgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UICE9PSAidW5kZWZpbmVkIiA/IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCA6IHZvaWQgMAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBjdXJyZW50IHRlc3RpbmcgZW52aXJvbm1lbnQgaXMgbm90IGNvbmZpZ3VyZWQgdG8gc3VwcG9ydCBhY3QoLi4uKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjZWlsID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDIubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9ycykgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMucHVzaC5hcHBseSh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgZXJyb3JzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYSkgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oYSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzY3JldGVVcGRhdGVzKGZuLCBhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiLCBjLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDIsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yKHJvb3QzLCB0aHJvd25WYWx1ZSkgewogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoZXJyb3JlZFdvcmsgPT09IG51bGwgfHwgZXJyb3JlZFdvcmsucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEZhdGFsRXJyb3JlZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZXJyb3JlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGVycm9yZWRXb3JrLCB0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICAgIGlmICh0aHJvd25WYWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdGhyb3duVmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB0aHJvd25WYWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGVycm9yZWRXb3JrLCB3YWtlYWJsZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudEVycm9yZWQoZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93RXhjZXB0aW9uKHJvb3QzLCBlcnJvcmVkV29yay5yZXR1cm4sIGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGNvbXBsZXRlVW5pdE9mV29yayhlcnJvcmVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKHlldEFub3RoZXJUaHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIHRocm93blZhbHVlID0geWV0QW5vdGhlclRocm93blZhbHVlOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyA9PT0gZXJyb3JlZFdvcmsgJiYgZXJyb3JlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gZXJyb3JlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBlcnJvcmVkV29yazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQ7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChwcmV2RGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BEaXNwYXRjaGVyKHByZXZEaXNwYXRjaGVyKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKSB7CiAgICAgICAgICBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gbm93KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobGFuZSkgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gbWVyZ2VMYW5lcyhsYW5lLCB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSBudWxsICYmIChpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcykgfHwgaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcykpKSB7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEod29ya0luUHJvZ3Jlc3NSb290LCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgIT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RFcnJvcmVkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckhhc05vdFN1c3BlbmRlZFlldCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BTeW5jKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCBhbiBpbmNvbXBsZXRlIHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wU3luYygpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BDb25jdXJyZW50KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50MiwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwodGltZUVsYXBzZWQgLyAxOTYwKSAqIDE5NjA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yTmVzdGVkVXBkYXRlcygpIHsKICAgICAgICAgIGlmIChuZXN0ZWRVcGRhdGVDb3VudCA+IE5FU1RFRF9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yIGNvbXBvbmVudERpZFVwZGF0ZS4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgbmVzdGVkIHVwZGF0ZXMgdG8gcHJldmVudCBpbmZpbml0ZSBsb29wcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA+IE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgICAgZXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgdXNlRWZmZWN0LCBidXQgdXNlRWZmZWN0IGVpdGhlciBkb2Vzbid0IGhhdmUgYSBkZXBlbmRlbmN5IGFycmF5LCBvciBvbmUgb2YgdGhlIGRlcGVuZGVuY2llcyBjaGFuZ2VzIG9uIGV2ZXJ5IHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKGZpYmVyLCBoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlRWZmZWN0c0luRGV2KGZpcnN0Q2hpbGQsIGZpYmVyRmxhZ3MsIGludm9rZUVmZmVjdEZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBzdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmltYXJ5U3VidHJlZUZsYWcgPSBjdXJyZW50Mi5zdWJ0cmVlRmxhZ3MgJiBmaWJlckZsYWdzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gc3VidHJlZVJvb3QgJiYgY3VycmVudDIuY2hpbGQgIT09IG51bGwgJiYgcHJpbWFyeVN1YnRyZWVGbGFnICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50MiA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQyLmZsYWdzICYgZmliZXJGbGFncykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlRWZmZWN0Rm4oY3VycmVudDIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDIgPSBjdXJyZW50Mi5zaWJsaW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDIgPSBzdWJ0cmVlUm9vdCA9IGN1cnJlbnQyLnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWc7CiAgICAgICAgICAgIGlmICh0YWcgIT09IEluZGV0ZXJtaW5hdGVDb21wb25lbnQgJiYgdGFnICE9PSBIb3N0Um9vdCAmJiB0YWcgIT09IENsYXNzQ29tcG9uZW50ICYmIHRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgdGFnICE9PSBGb3J3YXJkUmVmICYmIHRhZyAhPT0gTWVtb0NvbXBvbmVudCAmJiB0YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiUmVhY3RDb21wb25lbnQiOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2NvbXBvbmVudE5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBlcnJvcigiQ2FuJ3QgcGVyZm9ybSBhIFJlYWN0IHN0YXRlIHVwZGF0ZSBvbiBhIGNvbXBvbmVudCB0aGF0IGhhc24ndCBtb3VudGVkIHlldC4gVGhpcyBpbmRpY2F0ZXMgdGhhdCB5b3UgaGF2ZSBhIHNpZGUtZWZmZWN0IGluIHlvdXIgcmVuZGVyIGZ1bmN0aW9uIHRoYXQgYXN5bmNocm9ub3VzbHkgbGF0ZXIgY2FsbHMgdHJpZXMgdG8gdXBkYXRlIHRoZSBjb21wb25lbnQuIE1vdmUgdGhpcyB3b3JrIHRvIHVzZUVmZmVjdCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYmVnaW5Xb3JrJDE7CiAgICAgICAgewogICAgICAgICAgdmFyIGR1bW15RmliZXIgPSBudWxsOwogICAgICAgICAgYmVnaW5Xb3JrJDEgPSBmdW5jdGlvbihjdXJyZW50MiwgdW5pdE9mV29yaywgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5ID0gYXNzaWduRmliZXJQcm9wZXJ0aWVzSW5ERVYoZHVtbXlGaWJlciwgdW5pdE9mV29yayk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJlZ2luV29yayhjdXJyZW50MiwgdW5pdE9mV29yaywgbGFuZXMpOwogICAgICAgICAgICB9IGNhdGNoIChvcmlnaW5hbEVycm9yKSB7CiAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yV2hpbGVIeWRyYXRpbmdERVYoKSB8fCBvcmlnaW5hbEVycm9yICE9PSBudWxsICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yID09PSAib2JqZWN0IiAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvci50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50MiwgdW5pdE9mV29yayk7CiAgICAgICAgICAgICAgYXNzaWduRmliZXJQcm9wZXJ0aWVzSW5ERVYodW5pdE9mV29yaywgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkpOwogICAgICAgICAgICAgIGlmICh1bml0T2ZXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQcm9maWxlclRpbWVyKHVuaXRPZldvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobnVsbCwgYmVnaW5Xb3JrLCBudWxsLCBjdXJyZW50MiwgdW5pdE9mV29yaywgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChoYXNDYXVnaHRFcnJvcigpKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVwbGF5RXJyb3IgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcGxheUVycm9yID09PSAib2JqZWN0IiAmJiByZXBsYXlFcnJvciAhPT0gbnVsbCAmJiByZXBsYXlFcnJvci5fc3VwcHJlc3NMb2dnaW5nICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yID09PSAib2JqZWN0IiAmJiBvcmlnaW5hbEVycm9yICE9PSBudWxsICYmICFvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcpIHsKICAgICAgICAgICAgICAgICAgb3JpZ2luYWxFcnJvci5fc3VwcHJlc3NMb2dnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgb3JpZ2luYWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudDsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuQWJvdXRSZW5kZXJQaGFzZVVwZGF0ZXNJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNSZW5kZXJpbmcgJiYgIWdldElzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2VJbkRFVigpKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUgPSB3b3JrSW5Qcm9ncmVzcyAmJiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgIHZhciBkZWR1cGVLZXkgPSByZW5kZXJpbmdDb21wb25lbnROYW1lOwogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5oYXMoZGVkdXBlS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5hZGQoZGVkdXBlS2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0U3RhdGVDb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGEgY29tcG9uZW50IChgJXNgKSB3aGlsZSByZW5kZXJpbmcgYSBkaWZmZXJlbnQgY29tcG9uZW50IChgJXNgKS4gVG8gbG9jYXRlIHRoZSBiYWQgc2V0U3RhdGUoKSBjYWxsIGluc2lkZSBgJXNgLCBmb2xsb3cgdGhlIHN0YWNrIHRyYWNlIGFzIGRlc2NyaWJlZCBpbiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc2V0c3RhdGUtaW4tcmVuZGVyIiwgc2V0U3RhdGVDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlcikgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGR1cmluZyBhbiBleGlzdGluZyBzdGF0ZSB0cmFuc2l0aW9uIChzdWNoIGFzIHdpdGhpbiBgcmVuZGVyYCkuIFJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihzY2hlZHVsaW5nRmliZXIpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290Mywgc2NoZWR1bGluZ0ZpYmVyLCBsYW5lcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZha2VBY3RDYWxsYmFja05vZGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrJDEocHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50OwogICAgICAgICAgICBpZiAoYWN0UXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhY3RRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICByZXR1cm4gZmFrZUFjdENhbGxiYWNrTm9kZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbGJhY2skMShjYWxsYmFja05vZGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFja05vZGUgPT09IGZha2VBY3RDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhbmNlbENhbGxiYWNrKGNhbGxiYWNrTm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaXNMZWdhY3lBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgZmliZXIudGFnICE9PSBGb3J3YXJkUmVmICYmIGZpYmVyLnRhZyAhPT0gU2ltcGxlTWVtb0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkFuIHVwZGF0ZSB0byAlcyBpbnNpZGUgYSB0ZXN0IHdhcyBub3Qgd3JhcHBlZCBpbiBhY3QoLi4uKS5cblxuV2hlbiB0ZXN0aW5nLCBjb2RlIHRoYXQgY2F1c2VzIFJlYWN0IHN0YXRlIHVwZGF0ZXMgc2hvdWxkIGJlIHdyYXBwZWQgaW50byBhY3QoLi4uKTpcblxuYWN0KCgpID0+IHtcbiAgLyogZmlyZSBldmVudHMgdGhhdCB1cGRhdGUgc3RhdGUgKi9cbn0pO1xuLyogYXNzZXJ0IG9uIHRoZSBvdXRwdXQgKi9cblxuVGhpcyBlbnN1cmVzIHRoYXQgeW91J3JlIHRlc3RpbmcgdGhlIGJlaGF2aW9yIHRoZSB1c2VyIHdvdWxkIHNlZSBpbiB0aGUgYnJvd3Nlci4gTGVhcm4gbW9yZSBhdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd3JhcC10ZXN0cy13aXRoLWFjdCIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgaXNDb25jdXJyZW50QWN0RW52aXJvbm1lbnQoKSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBzdXNwZW5kZWQgcmVzb3VyY2UgZmluaXNoZWQgbG9hZGluZyBpbnNpZGUgYSB0ZXN0LCBidXQgdGhlIGV2ZW50IHdhcyBub3Qgd3JhcHBlZCBpbiBhY3QoLi4uKS5cblxuV2hlbiB0ZXN0aW5nLCBjb2RlIHRoYXQgcmVzb2x2ZXMgc3VzcGVuZGVkIGRhdGEgc2hvdWxkIGJlIHdyYXBwZWQgaW50byBhY3QoLi4uKTpcblxuYWN0KCgpID0+IHtcbiAgLyogZmluaXNoIGxvYWRpbmcgc3VzcGVuZGVkIGRhdGEgKi9cbn0pO1xuLyogYXNzZXJ0IG9uIHRoZSBvdXRwdXQgKi9cblxuVGhpcyBlbnN1cmVzIHRoYXQgeW91J3JlIHRlc3RpbmcgdGhlIGJlaGF2aW9yIHRoZSB1c2VyIHdvdWxkIHNlZSBpbiB0aGUgYnJvd3Nlci4gTGVhcm4gbW9yZSBhdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd3JhcC10ZXN0cy13aXRoLWFjdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChpc1J1bm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0ID0gaXNSdW5uaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVzb2x2ZUZhbWlseSA9IG51bGw7CiAgICAgICAgdmFyIGZhaWxlZEJvdW5kYXJpZXMgPSBudWxsOwogICAgICAgIHZhciBzZXRSZWZyZXNoSGFuZGxlciA9IGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVzb2x2ZUZhbWlseSA9IGhhbmRsZXI7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUpOwogICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkodHlwZSk7CiAgICAgICAgICAgIGlmIChmYW1pbHkgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmICh0eXBlICE9PSBudWxsICYmIHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UmVuZGVyID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlLnJlbmRlciAhPT0gY3VycmVudFJlbmRlcikgewogICAgICAgICAgICAgICAgICB2YXIgc3ludGhldGljVHlwZSA9IHsKICAgICAgICAgICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSwKICAgICAgICAgICAgICAgICAgICByZW5kZXI6IGN1cnJlbnRSZW5kZXIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUuZGlzcGxheU5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN5bnRoZXRpY1R5cGUuZGlzcGxheU5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50aGV0aWNUeXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhmaWJlciwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldlR5cGUgPSBmaWJlci5lbGVtZW50VHlwZTsKICAgICAgICAgICAgdmFyIG5leHRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICB2YXIgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSBmYWxzZTsKICAgICAgICAgICAgdmFyICQkdHlwZW9mTmV4dFR5cGUgPSB0eXBlb2YgbmV4dFR5cGUgPT09ICJvYmplY3QiICYmIG5leHRUeXBlICE9PSBudWxsID8gbmV4dFR5cGUuJCR0eXBlb2YgOiBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9NRU1PX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzQ29tcGFyZUZhbWlsaWVzKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZGYW1pbHkgPSByZXNvbHZlRmFtaWx5KHByZXZUeXBlKTsKICAgICAgICAgICAgICBpZiAocHJldkZhbWlseSAhPT0gdm9pZCAwICYmIHByZXZGYW1pbHkgPT09IHJlc29sdmVGYW1pbHkobmV4dFR5cGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIFdlYWtTZXQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcy5hZGQoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIHVwZGF0ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhbGVGYW1pbGllcyA9IHVwZGF0ZS5zdGFsZUZhbWlsaWVzLCB1cGRhdGVkRmFtaWxpZXMgPSB1cGRhdGUudXBkYXRlZEZhbWlsaWVzOwogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUm9vdCA9IGZ1bmN0aW9uKHJvb3QzLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyb290My5jb250ZXh0ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGZpYmVyLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZSwgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVzb2x2ZUZhbWlseSB0byBiZSBzZXQgZHVyaW5nIGhvdCByZWxvYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5lZWRzUmVuZGVyID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBuZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseShjYW5kaWRhdGVUeXBlKTsKICAgICAgICAgICAgICBpZiAoZmFtaWx5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmIChzdGFsZUZhbWlsaWVzLmhhcyhmYW1pbHkpKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWRGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBpZiAodGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMuaGFzKGZpYmVyKSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgZmFpbGVkQm91bmRhcmllcy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCkgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCB8fCBuZWVkc1JlbmRlcikgewogICAgICAgICAgICAgIHZhciBfcm9vdCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChfcm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKF9yb290LCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsICYmICFuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGNoaWxkLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShzaWJsaW5nLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgZmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgdHlwZXMgPSBuZXcgU2V0KGZhbWlsaWVzLm1hcChmdW5jdGlvbihmYW1pbHkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgcmV0dXJuIGhvc3RJbnN0YW5jZXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoZmliZXIsIHR5cGVzLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlLnJlbmRlcjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkaWRNYXRjaCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoY2FuZGlkYXRlVHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0eXBlcy5oYXMoY2FuZGlkYXRlVHlwZSkpIHsKICAgICAgICAgICAgICAgIGRpZE1hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZE1hdGNoKSB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoY2hpbGQsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoc2libGluZywgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZvdW5kSG9zdEluc3RhbmNlcyA9IGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIGlmIChmb3VuZEhvc3RJbnN0YW5jZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIHJlYWNoIHJvb3QgZmlyc3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ2hpbGRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgdmFyIGZvdW5kSG9zdEluc3RhbmNlcyA9IGZhbHNlOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgZm91bmRIb3N0SW5zdGFuY2VzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmaWJlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaWJlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZm91bmRIb3N0SW5zdGFuY2VzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzQmFkTWFwUG9seWZpbGw7CiAgICAgICAgewogICAgICAgICAgaGFzQmFkTWFwUG9seWZpbGwgPSBmYWxzZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBub25FeHRlbnNpYmxlT2JqZWN0ID0gT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHt9KTsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoW1tub25FeHRlbnNpYmxlT2JqZWN0LCBudWxsXV0pOwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbbm9uRXh0ZW5zaWJsZU9iamVjdF0pOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIEZpYmVyTm9kZSh0YWcsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKSB7CiAgICAgICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgICAgdGhpcy5lbGVtZW50VHlwZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnR5cGUgPSBudWxsOwogICAgICAgICAgdGhpcy5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgdGhpcy5yZXR1cm4gPSBudWxsOwogICAgICAgICAgdGhpcy5jaGlsZCA9IG51bGw7CiAgICAgICAgICB0aGlzLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICB0aGlzLnJlZiA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgIHRoaXMubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICB0aGlzLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgIHRoaXMubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICB0aGlzLm1vZGUgPSBtb2RlOwogICAgICAgICAgdGhpcy5mbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICB0aGlzLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICB0aGlzLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICB0aGlzLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYWN0dWFsRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLmFjdHVhbFN0YXJ0VGltZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMudHJlZUJhc2VEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB0aGlzLnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLl9kZWJ1Z1NvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z05lZWRzUmVtb3VudCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z0hvb2tUeXBlcyA9IG51bGw7CiAgICAgICAgICAgIGlmICghaGFzQmFkTWFwUG9seWZpbGwgJiYgdHlwZW9mIE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlRmliZXIgPSBmdW5jdGlvbih0YWcsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEZpYmVyTm9kZSh0YWcsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdCQxKENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTaW1wbGVGdW5jdGlvbkNvbXBvbmVudCh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIXNob3VsZENvbnN0cnVjdCQxKHR5cGUpICYmIHR5cGUuZGVmYXVsdFByb3BzID09PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5Q29tcG9uZW50VGFnKENvbXBvbmVudCkgewogICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHNob3VsZENvbnN0cnVjdCQxKENvbXBvbmVudCkgPyBDbGFzc0NvbXBvbmVudCA6IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIGlmIChDb21wb25lbnQgIT09IHZvaWQgMCAmJiBDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyICQkdHlwZW9mID0gQ29tcG9uZW50LiQkdHlwZW9mOwogICAgICAgICAgICBpZiAoJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUpIHsKICAgICAgICAgICAgICByZXR1cm4gRm9yd2FyZFJlZjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSkgewogICAgICAgICAgICAgIHJldHVybiBNZW1vQ29tcG9uZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudDIsIHBlbmRpbmdQcm9wcykgewogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzMiA9IGN1cnJlbnQyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyID0gY3JlYXRlRmliZXIoY3VycmVudDIudGFnLCBwZW5kaW5nUHJvcHMsIGN1cnJlbnQyLmtleSwgY3VycmVudDIubW9kZSk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9IGN1cnJlbnQyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQyLnR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBjdXJyZW50Mi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnU291cmNlID0gY3VycmVudDIuX2RlYnVnU291cmNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciA9IGN1cnJlbnQyLl9kZWJ1Z093bmVyOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdIb29rVHlwZXMgPSBjdXJyZW50Mi5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9IGN1cnJlbnQyOwogICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQyLnR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBjdXJyZW50Mi5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGN1cnJlbnQyLmNoaWxkTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50Mi5sYW5lczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQyLmRlcGVuZGVuY2llczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBjdXJyZW50RGVwZW5kZW5jaWVzID09PSBudWxsID8gbnVsbCA6IHsKICAgICAgICAgICAgbGFuZXM6IGN1cnJlbnREZXBlbmRlbmNpZXMubGFuZXMsCiAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgIH07CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2libGluZyA9IGN1cnJlbnQyLnNpYmxpbmc7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuaW5kZXggPSBjdXJyZW50Mi5pbmRleDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5yZWYgPSBjdXJyZW50Mi5yZWY7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDIuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gPSBjdXJyZW50Mi50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ID0gY3VycmVudDIuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhjdXJyZW50Mi50eXBlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhjdXJyZW50Mi50eXBlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IFN0YXRpY01hc2sgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDIuY2hpbGRMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50Mi50eXBlOwogICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDIuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUpIHsKICAgICAgICAgIHZhciBtb2RlOwogICAgICAgICAgaWYgKHRhZyA9PT0gQ29uY3VycmVudFJvb3QpIHsKICAgICAgICAgICAgbW9kZSA9IENvbmN1cnJlbnRNb2RlOwogICAgICAgICAgICBpZiAoaXNTdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtb2RlID0gTm9Nb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIG1vZGUgfD0gUHJvZmlsZU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXIoSG9zdFJvb3QsIG51bGwsIG51bGwsIG1vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyVGFnID0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSkgewogICAgICAgICAgICAgIGZpYmVyVGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZmliZXJUYWcgPSBIb3N0Q29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0VGFnOiBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQocGVuZGluZ1Byb3BzLmNoaWxkcmVuLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1vZGU7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9PRkZTQ1JFRU5fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xFR0FDWV9ISURERU5fVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NDT1BFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUNIRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFOgogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRQcm92aWRlcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dENvbnN1bWVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gRm9yd2FyZFJlZjsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTGF6eUNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSAiICsgKCJidXQgZ290OiAiICsgKHR5cGUgPT0gbnVsbCA/IHR5cGUgOiB0eXBlb2YgdHlwZSkgKyAiLiIgKyBpbmZvKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihmaWJlclRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSB0eXBlOwogICAgICAgICAgZmliZXIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBvd25lciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBlbGVtZW50LnByb3BzOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihGcmFnbWVudCwgZWxlbWVudHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1Byb2ZpbGVyIG11c3Qgc3BlY2lmeSBhbiAiaWQiIG9mIHR5cGUgYHN0cmluZ2AgYXMgYSBwcm9wLiBSZWNlaXZlZCB0aGUgdHlwZSBgJXNgIGluc3RlYWQuJywgdHlwZW9mIHBlbmRpbmdQcm9wcy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFByb2ZpbGVyLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSB8IFByb2ZpbGVNb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICBlZmZlY3REdXJhdGlvbjogMCwKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0RHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VMaXN0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKE9mZnNjcmVlbkNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkSW5zdGFuY2UgPSB7CiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHByaW1hcnlDaGlsZEluc3RhbmNlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UZXh0KGNvbnRlbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihEZWh5ZHJhdGVkRnJhZ21lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBkZWh5ZHJhdGVkTm9kZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RQb3J0YWwsIHBlbmRpbmdQcm9wcywgcG9ydGFsLmtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgICAgcGVuZGluZ0NoaWxkcmVuOiBudWxsLAogICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogcG9ydGFsLmltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICB0YXJnZXQgPSBjcmVhdGVGaWJlcihJbmRldGVybWluYXRlQ29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICB0YXJnZXQua2V5ID0gc291cmNlLmtleTsKICAgICAgICAgIHRhcmdldC5lbGVtZW50VHlwZSA9IHNvdXJjZS5lbGVtZW50VHlwZTsKICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICB0YXJnZXQuc3RhdGVOb2RlID0gc291cmNlLnN0YXRlTm9kZTsKICAgICAgICAgIHRhcmdldC5yZXR1cm4gPSBzb3VyY2UucmV0dXJuOwogICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgdGFyZ2V0LnNpYmxpbmcgPSBzb3VyY2Uuc2libGluZzsKICAgICAgICAgIHRhcmdldC5pbmRleCA9IHNvdXJjZS5pbmRleDsKICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgdGFyZ2V0LnBlbmRpbmdQcm9wcyA9IHNvdXJjZS5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRQcm9wcyA9IHNvdXJjZS5tZW1vaXplZFByb3BzOwogICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkU3RhdGUgPSBzb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHRhcmdldC5kZXBlbmRlbmNpZXMgPSBzb3VyY2UuZGVwZW5kZW5jaWVzOwogICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgIHRhcmdldC5mbGFncyA9IHNvdXJjZS5mbGFnczsKICAgICAgICAgIHRhcmdldC5zdWJ0cmVlRmxhZ3MgPSBzb3VyY2Uuc3VidHJlZUZsYWdzOwogICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICB0YXJnZXQubGFuZXMgPSBzb3VyY2UubGFuZXM7CiAgICAgICAgICB0YXJnZXQuY2hpbGRMYW5lcyA9IHNvdXJjZS5jaGlsZExhbmVzOwogICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxEdXJhdGlvbiA9IHNvdXJjZS5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgIHRhcmdldC5zZWxmQmFzZUR1cmF0aW9uID0gc291cmNlLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC50cmVlQmFzZUR1cmF0aW9uID0gc291cmNlLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQuX2RlYnVnU291cmNlID0gc291cmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHRhcmdldC5fZGVidWdPd25lciA9IHNvdXJjZS5fZGVidWdPd25lcjsKICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z0hvb2tUeXBlcyA9IHNvdXJjZS5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHRoaXMuZXZlbnRUaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9UaW1lc3RhbXApOwogICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMubXV0YWJsZVJlYWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlbWVudHMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5pZGVudGlmaWVyUHJlZml4ID0gaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHRoaXMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgVG90YWxMYW5lczsgX2krKykgewogICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgQ29uY3VycmVudFJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTGVnYWN5Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSk7CiAgICAgICAgICByb290My5jdXJyZW50ID0gdW5pbml0aWFsaXplZEZpYmVyOwogICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2luaXRpYWxTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBoeWRyYXRlMiwKICAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbCwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5tZW1vaXplZFN0YXRlID0gX2luaXRpYWxTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsKGNoaWxkcmVuLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICAgIGtleToga2V5ID09IG51bGwgPyBudWxsIDogIiIgKyBrZXksCiAgICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXJJbmZvLAogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgaWYgKCFwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldChwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjb21wb25lbnQpLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgYXBwZWFycyB0byBub3QgYmUgYSBSZWFjdENvbXBvbmVudC4gS2V5czogIiArIGtleXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggaXMgaW5zaWRlIFN0cmljdE1vZGUuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggcmVuZGVycyBTdHJpY3RNb2RlIGNoaWxkcmVuLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldmlvdXNGaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaW5pdGlhbENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgY2FsbGJhY2ssIGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgcm9vdDMuY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKG51bGwpOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwgPyBjYWxsYmFjayA6IG51bGw7CiAgICAgICAgICBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIyLCBlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIyLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wZW5kaW5nQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiBjdXJyZW50ICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50KSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgfTsKICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQkMSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgY3VycmVudCQxLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGNvbnRhaW5lckZpYmVyID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgaWYgKCFjb250YWluZXJGaWJlci5jaGlsZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoY29udGFpbmVyRmliZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgIHZhciBsYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290Myk7CiAgICAgICAgICAgICAgICBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByb290NCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290NCwgZmliZXIsIFN5bmNMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBTeW5jTGFuZTsKICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCAmJiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBoaWdoZXJQcmlvcml0eUxhbmUoc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUpIHsKICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkRXJyb3JJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRXJyb3IoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRFcnJvckltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkU3VzcGVuZEltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU3VzcGVuZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZFN1c3BlbmRJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wcyA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBzY2hlZHVsZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIHNldEVycm9ySGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlSW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBwYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5KHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShrZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aERlbGV0ZUltcGwob2JqW2tleV0sIHBhdGgsIGluZGV4MiArIDEpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGUgPSBmdW5jdGlvbihvYmosIHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZUltcGwgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgsIGluZGV4MikgewogICAgICAgICAgICB2YXIgb2xkS2V5ID0gb2xkUGF0aFtpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheSh1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uob2xkS2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZFtvbGRLZXldID0gY29weVdpdGhSZW5hbWVJbXBsKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBudW1iZXIgb3Igc3RyaW5nIGlzIGZpbmUgaGVyZQogICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICBvbGRQYXRoLAogICAgICAgICAgICAgICAgbmV3UGF0aCwKICAgICAgICAgICAgICAgIGluZGV4MiArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZSA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2FybigiY29weVdpdGhSZW5hbWUoKSBleHBlY3RzIHBhdGhzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld1BhdGgubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUGF0aFtpXSAhPT0gbmV3UGF0aFtpXSkgewogICAgICAgICAgICAgICAgICB3YXJuKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgdG8gYmUgdGhlIHNhbWUgZXhjZXB0IGZvciB0aGUgZGVlcGVzdCBrZXkiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29weVdpdGhSZW5hbWVJbXBsKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0SW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgaW5kZXgyLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaW5kZXgyID49IHBhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoU2V0SW1wbChvYmpba2V5XSwgcGF0aCwgaW5kZXgyICsgMSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBmdW5jdGlvbihvYmosIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFNldEltcGwob2JqLCBwYXRoLCAwLCB2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZpbmRIb29rID0gZnVuY3Rpb24oZmliZXIsIGlkKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SG9vazIgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudEhvb2syICE9PSBudWxsICYmIGlkID4gMCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rMiA9IGN1cnJlbnRIb29rMi5uZXh0OwogICAgICAgICAgICAgIGlkLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRIb29rMjsKICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoU2V0KGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhEZWxldGUoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24oe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoUmVuYW1lKGhvb2subWVtb2l6ZWRTdGF0ZSwgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wcyA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFNldChmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgcGF0aCkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aERlbGV0ZShmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoUmVuYW1lKGZpYmVyLm1lbW9pemVkUHJvcHMsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNjaGVkdWxlVXBkYXRlID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzZXRFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRFcnJvckltcGwpIHsKICAgICAgICAgICAgc2hvdWxkRXJyb3JJbXBsID0gbmV3U2hvdWxkRXJyb3JJbXBsOwogICAgICAgICAgfTsKICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZFN1c3BlbmRJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZFN1c3BlbmRJbXBsID0gbmV3U2hvdWxkU3VzcGVuZEltcGw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlQnlGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdEludG9EZXZUb29scyhkZXZUb29sc0NvbmZpZykgewogICAgICAgICAgdmFyIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlID0gZGV2VG9vbHNDb25maWcuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U7CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgICAgcmV0dXJuIGluamVjdEludGVybmFscyh7CiAgICAgICAgICAgIGJ1bmRsZVR5cGU6IGRldlRvb2xzQ29uZmlnLmJ1bmRsZVR5cGUsCiAgICAgICAgICAgIHZlcnNpb246IGRldlRvb2xzQ29uZmlnLnZlcnNpb24sCiAgICAgICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyUGFja2FnZU5hbWUsCiAgICAgICAgICAgIHJlbmRlcmVyQ29uZmlnOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlckNvbmZpZywKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGUsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzLAogICAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGgsCiAgICAgICAgICAgIHNldEVycm9ySGFuZGxlciwKICAgICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyLAogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSwKICAgICAgICAgICAgY3VycmVudERpc3BhdGNoZXJSZWY6IFJlYWN0Q3VycmVudERpc3BhdGNoZXIyLAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlQnlGaWJlciwKICAgICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlIHx8IGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UsCiAgICAgICAgICAgIC8vIFJlYWN0IFJlZnJlc2gKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoLAogICAgICAgICAgICBzY2hlZHVsZVJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUm9vdCwKICAgICAgICAgICAgc2V0UmVmcmVzaEhhbmRsZXIsCiAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gYXBwZW5kIG93bmVyIHN0YWNrcyB0byBlcnJvciBtZXNzYWdlcyBpbiBERVYgbW9kZS4KICAgICAgICAgICAgZ2V0Q3VycmVudEZpYmVyOiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scywKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBkZXRlY3QgcmVjb25jaWxlciB2ZXJzaW9uIHJhdGhlciB0aGFuIHJlbmRlcmVyIHZlcnNpb24KICAgICAgICAgICAgLy8gd2hpY2ggbWF5IG5vdCBtYXRjaCBmb3IgdGhpcmQgcGFydHkgcmVuZGVyZXJzLgogICAgICAgICAgICByZWNvbmNpbGVyVmVyc2lvbjogUmVhY3RWZXJzaW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3IgPSB0eXBlb2YgcmVwb3J0RXJyb3IgPT09ICJmdW5jdGlvbiIgPyAoCiAgICAgICAgICAvLyBJbiBtb2Rlcm4gYnJvd3NlcnMsIHJlcG9ydEVycm9yIHdpbGwgZGlzcGF0Y2ggYW4gZXJyb3IgZXZlbnQsCiAgICAgICAgICAvLyBlbXVsYXRpbmcgYW4gdW5jYXVnaHQgSmF2YVNjcmlwdCBlcnJvci4KICAgICAgICAgIHJlcG9ydEVycm9yCiAgICAgICAgKSA6IGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gUmVhY3RET01Sb290KGludGVybmFsUm9vdCkgewogICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgIH0KICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnJlbmRlciA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB1cGRhdGUgYW4gdW5tb3VudGVkIHJvb3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBkb2VzIG5vdCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gYSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRDb250YWluZXIoYXJndW1lbnRzWzFdKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgY29udGFpbmVyIHRvIHRoZSBzZWNvbmQgYXJndW1lbnQgb2Ygcm9vdC5yZW5kZXIoLi4uKS4gWW91IGRvbid0IG5lZWQgdG8gcGFzcyBpdCBhZ2FpbiBzaW5jZSB5b3UgYWxyZWFkeSBwYXNzZWQgaXQgdG8gY3JlYXRlIHRoZSByb290LiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBzZWNvbmQgYXJndW1lbnQgdG8gcm9vdC5yZW5kZXIoLi4uKSBidXQgaXQgb25seSBhY2NlcHRzIG9uZSBhcmd1bWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGUgcm9vdCBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCByb290LnVubW91bnQoKSB0byBlbXB0eSBhIHJvb3QncyBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4sIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICB9OwogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50KC4uLik6IGRvZXMgbm90IHN1cHBvcnQgYSBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJBdHRlbXB0ZWQgdG8gc3luY2hyb25vdXNseSB1bm1vdW50IGEgcm9vdCB3aGlsZSBSZWFjdCB3YXMgYWxyZWFkeSByZW5kZXJpbmcuIFJlYWN0IGNhbm5vdCBmaW5pc2ggdW5tb3VudGluZyB0aGUgcm9vdCB1bnRpbCB0aGUgY3VycmVudCByZW5kZXIgaGFzIGNvbXBsZXRlZCwgd2hpY2ggbWF5IGxlYWQgdG8gYSByYWNlIGNvbmRpdGlvbi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihudWxsLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1bm1hcmtDb250YWluZXJBc1Jvb3QoY29udGFpbmVyMik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290Mihjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY3JlYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9ICIiOwogICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG51bGw7CiAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmh5ZHJhdGUpIHsKICAgICAgICAgICAgICAgIHdhcm4oImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMocGFyZW50Q29tcG9uZW50KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gU3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSS4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QgPSByb290RWwgJiYgIWdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKTsKICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBhbm90aGVyIGNvcHkgb2YgUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBudWxsLCBjb250YWluZXIyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBudWxsOwogICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9yb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICB2YXIgaXNDb250YWluZXJSZWFjdFJvb3QgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyMi5wYXJlbnROb2RlLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMSk7CiAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocnVuV2l0aFByaW9yaXR5KTsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBNYXAucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIE1hcC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0ICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgU2V0IGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIFNldC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5jbGVhciAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oYmF0Y2hlZFVwZGF0ZXMkMSwgZGlzY3JldGVVcGRhdGVzLCBmbHVzaFN5bmMpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbCQxKGNoaWxkcmVuLCBjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lcjIsIG51bGwsIGtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIEludGVybmFscyA9IHsKICAgICAgICAgIHVzaW5nQ2xpZW50RW50cnlQb2ludDogZmFsc2UsCiAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgZm9yIGJldHRlciBtaW5pZmljYXRpb24uCiAgICAgICAgICBFdmVudHM6IFtnZXRJbnN0YW5jZUZyb21Ob2RlLCBnZXROb2RlRnJvbUluc3RhbmNlLCBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlLCBlbnF1ZXVlU3RhdGVSZXN0b3JlLCByZXN0b3JlU3RhdGVJZk5lZWRlZCwgYmF0Y2hlZFVwZGF0ZXMkMV0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QkMShjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBjcmVhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGh5ZHJhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMkMShmbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBSZWFjdCBjYW5ub3QgZmx1c2ggd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4gQ29uc2lkZXIgbW92aW5nIHRoaXMgY2FsbCB0byBhIHNjaGVkdWxlciB0YXNrIG9yIG1pY3JvIHRhc2suIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbHVzaFN5bmMoZm4pOwogICAgICAgIH0KICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUsCiAgICAgICAgICBidW5kbGVUeXBlOiAxLAogICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LWRvbSIKICAgICAgICB9KTsKICAgICAgICB7CiAgICAgICAgICBpZiAoIWZvdW5kRGV2VG9vbHMgJiYgY2FuVXNlRE9NICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGNoZWNrRENFKCk7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgbSA9IHJlcXVpcmVfcmVhY3RfZG9tKCk7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gbS5jcmVhdGVSb290OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gbS5oeWRyYXRlUm9vdDsKICAgIH0gZWxzZSB7CiAgICAgIGkgPSBtLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBmdW5jdGlvbihjLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5jcmVhdGVSb290KGMsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIGgsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmh5ZHJhdGVSb290KGMsIGgsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHZhciBpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIFJlYWN0MyA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gUmVhY3QzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4LnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhcyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bjsKICAgICAgICB2YXIgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSksIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgICAgaWYgKG1heWJlS2V5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1heWJlS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBtYXliZUtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQpIHsKICAgICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheShub2RlKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50KG5vZGUpKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEtleVNwcmVhZCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIGlzU3RhdGljQ2hpbGRyZW4sIHNvdXJjZSwgc2VsZikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpOwogICAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheSh0eXBlKSkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJhcnJheSI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIjwiICsgKGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJVbmtub3duIikgKyAiIC8+IjsKICAgICAgICAgICAgICAgIGluZm8gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBqc3hERVYodHlwZSwgcHJvcHMsIGtleSwgc291cmNlLCBzZWxmKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoY2hpbGRyZW5baV0sIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IFN0YXRpYyBjaGlsZHJlbiBzaG91bGQgYWx3YXlzIGJlIGFuIGFycmF5LiBZb3UgYXJlIGxpa2VseSBleHBsaWNpdGx5IGNhbGxpbmcgUmVhY3QuanN4cyBvciBSZWFjdC5qc3hERVYuIFVzZSB0aGUgQmFiZWwgdHJhbnNmb3JtIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3BzLCAia2V5IikpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wcykuZmlsdGVyKGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGsgIT09ICJrZXkiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7a2V5OiBzb21lS2V5LCAiICsga2V5cy5qb2luKCI6IC4uLiwgIikgKyAiOiAuLi59IiA6ICJ7a2V5OiBzb21lS2V5fSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0pIHsKICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7IiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie30iOwogICAgICAgICAgICAgICAgICBlcnJvcignQSBwcm9wcyBvYmplY3QgY29udGFpbmluZyBhICJrZXkiIHByb3AgaXMgYmVpbmcgc3ByZWFkIGludG8gSlNYOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIHsuLi5wcm9wc30gLz5cblJlYWN0IGtleXMgbXVzdCBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gSlNYIHdpdGhvdXQgdXNpbmcgc3ByZWFkOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIGtleT17c29tZUtleX0gey4uLnByb3BzfSAvPicsIGJlZm9yZUV4YW1wbGUsIGNvbXBvbmVudE5hbWUsIGFmdGVyRXhhbXBsZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb25TdGF0aWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYyh0eXBlLCBwcm9wcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqc3gzID0ganN4V2l0aFZhbGlkYXRpb25EeW5hbWljOwogICAgICAgIHZhciBqc3hzMyA9IGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljOwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuanN4ID0ganN4MzsKICAgICAgICBleHBvcnRzLmpzeHMgPSBqc3hzMzsKICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzCnZhciByZXF1aXJlX2pzeF9ydW50aW1lID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIHNyYy9tYWluLnRzeAp2YXIgaW1wb3J0X3JlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF9jbGllbnQgPSBfX3RvRVNNKHJlcXVpcmVfY2xpZW50KCksIDEpOwoKLy8gc3JjL1JlbWluZGVyQXBwLnRzeAp2YXIgaW1wb3J0X3JlYWN0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vc2hhcmVkL3NyYy91dGlscy5qcwp2YXIgdG9LZWJhYkNhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgIiQxLSQyIikudG9Mb3dlckNhc2UoKTsKdmFyIHRvQ2FtZWxDYXNlID0gKHN0cmluZykgPT4gc3RyaW5nLnJlcGxhY2UoCiAgL14oW0EtWl0pfFtccy1fXSsoXHcpL2csCiAgKG1hdGNoLCBwMSwgcDIpID0+IHAyID8gcDIudG9VcHBlckNhc2UoKSA6IHAxLnRvTG93ZXJDYXNlKCkKKTsKdmFyIHRvUGFzY2FsQ2FzZSA9IChzdHJpbmcpID0+IHsKICBjb25zdCBjYW1lbENhc2UgPSB0b0NhbWVsQ2FzZShzdHJpbmcpOwogIHJldHVybiBjYW1lbENhc2UuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYW1lbENhc2Uuc2xpY2UoMSk7Cn07CnZhciBtZXJnZUNsYXNzZXMgPSAoLi4uY2xhc3NlcykgPT4gY2xhc3Nlcy5maWx0ZXIoKGNsYXNzTmFtZSwgaW5kZXgsIGFycmF5KSA9PiB7CiAgcmV0dXJuIEJvb2xlYW4oY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUudHJpbSgpICE9PSAiIiAmJiBhcnJheS5pbmRleE9mKGNsYXNzTmFtZSkgPT09IGluZGV4Owp9KS5qb2luKCIgIikudHJpbSgpOwp2YXIgaGFzQTExeVByb3AgPSAocHJvcHMpID0+IHsKICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvcHMpIHsKICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoImFyaWEtIikgfHwgcHJvcCA9PT0gInJvbGUiIHx8IHByb3AgPT09ICJ0aXRsZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzCnZhciBpbXBvcnRfcmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIEljb24gPSAoMCwgaW1wb3J0X3JlYWN0LmZvcndhcmRSZWYpKAogICh7CiAgICBjb2xvciA9ICJjdXJyZW50Q29sb3IiLAogICAgc2l6ZSA9IDI0LAogICAgc3Ryb2tlV2lkdGggPSAyLAogICAgYWJzb2x1dGVTdHJva2VXaWR0aCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgY2hpbGRyZW4sCiAgICBpY29uTm9kZSwKICAgIC4uLnJlc3QKICB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkoCiAgICAic3ZnIiwKICAgIHsKICAgICAgcmVmLAogICAgICAuLi5kZWZhdWx0QXR0cmlidXRlcywKICAgICAgd2lkdGg6IHNpemUsCiAgICAgIGhlaWdodDogc2l6ZSwKICAgICAgc3Ryb2tlOiBjb2xvciwKICAgICAgc3Ryb2tlV2lkdGg6IGFic29sdXRlU3Ryb2tlV2lkdGggPyBOdW1iZXIoc3Ryb2tlV2lkdGgpICogMjQgLyBOdW1iZXIoc2l6ZSkgOiBzdHJva2VXaWR0aCwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoImx1Y2lkZSIsIGNsYXNzTmFtZSksCiAgICAgIC4uLiFjaGlsZHJlbiAmJiAhaGFzQTExeVByb3AocmVzdCkgJiYgeyAiYXJpYS1oaWRkZW4iOiAidHJ1ZSIgfSwKICAgICAgLi4ucmVzdAogICAgfSwKICAgIFsKICAgICAgLi4uaWNvbk5vZGUubWFwKChbdGFnLCBhdHRyc10pID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkodGFnLCBhdHRycykpLAogICAgICAuLi5BcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IGNoaWxkcmVuIDogW2NoaWxkcmVuXQogICAgXQogICkKKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgY3JlYXRlTHVjaWRlSWNvbiA9IChpY29uTmFtZSwgaWNvbk5vZGUpID0+IHsKICBjb25zdCBDb21wb25lbnQgPSAoMCwgaW1wb3J0X3JlYWN0Mi5mb3J3YXJkUmVmKSgKICAgICh7IGNsYXNzTmFtZSwgLi4ucHJvcHMgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0Mi5jcmVhdGVFbGVtZW50KShJY29uLCB7CiAgICAgIHJlZiwKICAgICAgaWNvbk5vZGUsCiAgICAgIGNsYXNzTmFtZTogbWVyZ2VDbGFzc2VzKAogICAgICAgIGBsdWNpZGUtJHt0b0tlYmFiQ2FzZSh0b1Bhc2NhbENhc2UoaWNvbk5hbWUpKX1gLAogICAgICAgIGBsdWNpZGUtJHtpY29uTmFtZX1gLAogICAgICAgIGNsYXNzTmFtZQogICAgICApLAogICAgICAuLi5wcm9wcwogICAgfSkKICApOwogIENvbXBvbmVudC5kaXNwbGF5TmFtZSA9IHRvUGFzY2FsQ2FzZShpY29uTmFtZSk7CiAgcmV0dXJuIENvbXBvbmVudDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYmVsbC5qcwp2YXIgX19pY29uTm9kZSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTAuMjY4IDIxYTIgMiAwIDAgMCAzLjQ2NCAwIiwga2V5OiAidnd2YnQ5IiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMy4yNjIgMTUuMzI2QTEgMSAwIDAgMCA0IDE3aDE2YTEgMSAwIDAgMCAuNzQtMS42NzNDMTkuNDEgMTMuOTU2IDE4IDEyLjQ5OSAxOCA4QTYgNiAwIDAgMCA2IDhjMCA0LjQ5OS0xLjQxMSA1Ljk1Ni0yLjczOCA3LjMyNiIsCiAgICAgIGtleTogIjExZzl2aSIKICAgIH0KICBdCl07CnZhciBCZWxsID0gY3JlYXRlTHVjaWRlSWNvbigiYmVsbCIsIF9faWNvbk5vZGUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9icmllZmNhc2UuanMKdmFyIF9faWNvbk5vZGUyID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiAyMFY0YTIgMiAwIDAgMC0yLTJoLTRhMiAyIDAgMCAwLTIgMnYxNiIsIGtleTogImplY3BwIiB9XSwKICBbInJlY3QiLCB7IHdpZHRoOiAiMjAiLCBoZWlnaHQ6ICIxNCIsIHg6ICIyIiwgeTogIjYiLCByeDogIjIiLCBrZXk6ICJpNmwycjQiIH1dCl07CnZhciBCcmllZmNhc2UgPSBjcmVhdGVMdWNpZGVJY29uKCJicmllZmNhc2UiLCBfX2ljb25Ob2RlMik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NhbGVuZGFyLmpzCnZhciBfX2ljb25Ob2RlMyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNOCAydjQiLCBrZXk6ICIxY21weW0iIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNiAydjQiLCBrZXk6ICI0bTgxdmsiIH1dLAogIFsicmVjdCIsIHsgd2lkdGg6ICIxOCIsIGhlaWdodDogIjE4IiwgeDogIjMiLCB5OiAiNCIsIHJ4OiAiMiIsIGtleTogIjFob3BjeSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgMTBoMTgiLCBrZXk6ICI4dG9lbjgiIH1dCl07CnZhciBDYWxlbmRhciA9IGNyZWF0ZUx1Y2lkZUljb24oImNhbGVuZGFyIiwgX19pY29uTm9kZTMpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGVjay5qcwp2YXIgX19pY29uTm9kZTQgPSBbWyJwYXRoIiwgeyBkOiAiTTIwIDYgOSAxN2wtNS01Iiwga2V5OiAiMWdtZjJjIiB9XV07CnZhciBDaGVjayA9IGNyZWF0ZUx1Y2lkZUljb24oImNoZWNrIiwgX19pY29uTm9kZTQpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXJpZ2h0LmpzCnZhciBfX2ljb25Ob2RlNSA9IFtbInBhdGgiLCB7IGQ6ICJtOSAxOCA2LTYtNi02Iiwga2V5OiAibXRoaHdxIiB9XV07CnZhciBDaGV2cm9uUmlnaHQgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGV2cm9uLXJpZ2h0IiwgX19pY29uTm9kZTUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jbG9jay5qcwp2YXIgX19pY29uTm9kZTYgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDZ2Nmw0IDIiLCBrZXk6ICJtbWs3eWciIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIxMCIsIGtleTogIjFtZ2xheSIgfV0KXTsKdmFyIENsb2NrID0gY3JlYXRlTHVjaWRlSWNvbigiY2xvY2siLCBfX2ljb25Ob2RlNik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nyb3duLmpzCnZhciBfX2ljb25Ob2RlNyA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTEuNTYyIDMuMjY2YS41LjUgMCAwIDEgLjg3NiAwTDE1LjM5IDguODdhMSAxIDAgMCAwIDEuNTE2LjI5NEwyMS4xODMgNS41YS41LjUgMCAwIDEgLjc5OC41MTlsLTIuODM0IDEwLjI0NmExIDEgMCAwIDEtLjk1Ni43MzRINS44MWExIDEgMCAwIDEtLjk1Ny0uNzM0TDIuMDIgNi4wMmEuNS41IDAgMCAxIC43OTgtLjUxOWw0LjI3NiAzLjY2NGExIDEgMCAwIDAgMS41MTYtLjI5NHoiLAogICAgICBrZXk6ICIxdmRjNTciCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNSAyMWgxNCIsIGtleTogIjExYXd1MyIgfV0KXTsKdmFyIENyb3duID0gY3JlYXRlTHVjaWRlSWNvbigiY3Jvd24iLCBfX2ljb25Ob2RlNyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2ZsYW1lLmpzCnZhciBfX2ljb25Ob2RlOCA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTIgM3ExIDQgNCA2LjV0MyA1LjVhMSAxIDAgMCAxLTE0IDAgNSA1IDAgMCAxIDEtMyAxIDEgMCAwIDAgNSAwYzAtMi0xLjUtMy0xLjUtNXEwLTIgMi41LTQiLAogICAgICBrZXk6ICIxc2xjaWgiCiAgICB9CiAgXQpdOwp2YXIgRmxhbWUgPSBjcmVhdGVMdWNpZGVJY29uKCJmbGFtZSIsIF9faWNvbk5vZGU4KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZ3JhZHVhdGlvbi1jYXAuanMKdmFyIF9faWNvbk5vZGU5ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMS40MiAxMC45MjJhMSAxIDAgMCAwLS4wMTktMS44MzhMMTIuODMgNS4xOGEyIDIgMCAwIDAtMS42NiAwTDIuNiA5LjA4YTEgMSAwIDAgMCAwIDEuODMybDguNTcgMy45MDhhMiAyIDAgMCAwIDEuNjYgMHoiLAogICAgICBrZXk6ICJqNzZqbDAiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMjIgMTB2NiIsIGtleTogIjFsdThmMyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTYgMTIuNVYxNmE2IDMgMCAwIDAgMTIgMHYtMy41Iiwga2V5OiAiMXI4bGVmIiB9XQpdOwp2YXIgR3JhZHVhdGlvbkNhcCA9IGNyZWF0ZUx1Y2lkZUljb24oImdyYWR1YXRpb24tY2FwIiwgX19pY29uTm9kZTkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9oZWFydC5qcwp2YXIgX19pY29uTm9kZTEwID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yIDkuNWE1LjUgNS41IDAgMCAxIDkuNTkxLTMuNjc2LjU2LjU2IDAgMCAwIC44MTggMEE1LjQ5IDUuNDkgMCAwIDEgMjIgOS41YzAgMi4yOS0xLjUgNC0zIDUuNWwtNS40OTIgNS4zMTNhMiAyIDAgMCAxLTMgLjAxOUw1IDE1Yy0xLjUtMS41LTMtMy4yLTMtNS41IiwKICAgICAga2V5OiAibXZyMWEwIgogICAgfQogIF0KXTsKdmFyIEhlYXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiaGVhcnQiLCBfX2ljb25Ob2RlMTApOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qcwp2YXIgX19pY29uTm9kZTExID0gWwogIFsicGF0aCIsIHsgZDogIk0xNSAyMXYtOGExIDEgMCAwIDAtMS0xaC00YTEgMSAwIDAgMC0xIDF2OCIsIGtleTogIjV3d2xyNSIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTMgMTBhMiAyIDAgMCAxIC43MDktMS41MjhsNy02YTIgMiAwIDAgMSAyLjU4MiAwbDcgNkEyIDIgMCAwIDEgMjEgMTB2OWEyIDIgMCAwIDEtMiAySDVhMiAyIDAgMCAxLTItMnoiLAogICAgICBrZXk6ICJyNm5zczEiCiAgICB9CiAgXQpdOwp2YXIgSG91c2UgPSBjcmVhdGVMdWNpZGVJY29uKCJob3VzZSIsIF9faWNvbk5vZGUxMSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Blbi5qcwp2YXIgX19pY29uTm9kZTEyID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMS4xNzQgNi44MTJhMSAxIDAgMCAwLTMuOTg2LTMuOTg3TDMuODQyIDE2LjE3NGEyIDIgMCAwIDAtLjUuODNsLTEuMzIxIDQuMzUyYS41LjUgMCAwIDAgLjYyMy42MjJsNC4zNTMtMS4zMmEyIDIgMCAwIDAgLjgzLS40OTd6IiwKICAgICAga2V5OiAiMWE4dXN1IgogICAgfQogIF0KXTsKdmFyIFBlbiA9IGNyZWF0ZUx1Y2lkZUljb24oInBlbiIsIF9faWNvbk5vZGUxMik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsYW5lLmpzCnZhciBfX2ljb25Ob2RlMTMgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTE3LjggMTkuMiAxNiAxMWwzLjUtMy41QzIxIDYgMjEuNSA0IDIxIDNjLTEtLjUtMyAwLTQuNSAxLjVMMTMgOCA0LjggNi4yYy0uNS0uMS0uOS4xLTEuMS41bC0uMy41Yy0uMi41LS4xIDEgLjMgMS4zTDkgMTJsLTIgM0g0bC0xIDEgMyAyIDIgMyAxLTF2LTNsMy0yIDMuNSA1LjNjLjMuNC44LjUgMS4zLjNsLjUtLjJjLjQtLjMuNi0uNy41LTEuMnoiLAogICAgICBrZXk6ICIxdjl3dDgiCiAgICB9CiAgXQpdOwp2YXIgUGxhbmUgPSBjcmVhdGVMdWNpZGVJY29uKCJwbGFuZSIsIF9faWNvbk5vZGUxMyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanMKdmFyIF9faWNvbk5vZGUxNCA9IFsKICBbInBhdGgiLCB7IGQ6ICJNNSAxMmgxNCIsIGtleTogIjFheXMwaCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDV2MTQiLCBrZXk6ICJzNjk5bGUiIH1dCl07CnZhciBQbHVzID0gY3JlYXRlTHVjaWRlSWNvbigicGx1cyIsIF9faWNvbk5vZGUxNCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlcGVhdC5qcwp2YXIgX19pY29uTm9kZTE1ID0gWwogIFsicGF0aCIsIHsgZDogIm0xNyAyIDQgNC00IDQiLCBrZXk6ICJubnRyeW0iIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDExdi0xYTQgNCAwIDAgMSA0LTRoMTQiLCBrZXk6ICI4NGJ1M2kiIH1dLAogIFsicGF0aCIsIHsgZDogIm03IDIyLTQtNCA0LTQiLCBrZXk6ICIxd3FoZmkiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yMSAxM3YxYTQgNCAwIDAgMS00IDRIMyIsIGtleTogIjFyeDM3ciIgfV0KXTsKdmFyIFJlcGVhdCA9IGNyZWF0ZUx1Y2lkZUljb24oInJlcGVhdCIsIF9faWNvbk5vZGUxNSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NlYXJjaC5qcwp2YXIgX19pY29uTm9kZTE2ID0gWwogIFsicGF0aCIsIHsgZDogIm0yMSAyMS00LjM0LTQuMzQiLCBrZXk6ICIxNGo3cmoiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjExIiwgY3k6ICIxMSIsIHI6ICI4Iiwga2V5OiAiNGVqOTd1IiB9XQpdOwp2YXIgU2VhcmNoID0gY3JlYXRlTHVjaWRlSWNvbigic2VhcmNoIiwgX19pY29uTm9kZTE2KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2hvcHBpbmctY2FydC5qcwp2YXIgX19pY29uTm9kZTE3ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjgiLCBjeTogIjIxIiwgcjogIjEiLCBrZXk6ICJqaW1vOG8iIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE5IiwgY3k6ICIyMSIsIHI6ICIxIiwga2V5OiAiMTM3MjN1IiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMi4wNSAyLjA1aDJsMi42NiAxMi40MmEyIDIgMCAwIDAgMiAxLjU4aDkuNzhhMiAyIDAgMCAwIDEuOTUtMS41N2wxLjY1LTcuNDNINS4xMiIsCiAgICAgIGtleTogIjl6aDUwNiIKICAgIH0KICBdCl07CnZhciBTaG9wcGluZ0NhcnQgPSBjcmVhdGVMdWNpZGVJY29uKCJzaG9wcGluZy1jYXJ0IiwgX19pY29uTm9kZTE3KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc3Rhci5qcwp2YXIgX19pY29uTm9kZTE4ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xMS41MjUgMi4yOTVhLjUzLjUzIDAgMCAxIC45NSAwbDIuMzEgNC42NzlhMi4xMjMgMi4xMjMgMCAwIDAgMS41OTUgMS4xNmw1LjE2Ni43NTZhLjUzLjUzIDAgMCAxIC4yOTQuOTA0bC0zLjczNiAzLjYzOGEyLjEyMyAyLjEyMyAwIDAgMC0uNjExIDEuODc4bC44ODIgNS4xNGEuNTMuNTMgMCAwIDEtLjc3MS41NmwtNC42MTgtMi40MjhhMi4xMjIgMi4xMjIgMCAwIDAtMS45NzMgMEw2LjM5NiAyMS4wMWEuNTMuNTMgMCAwIDEtLjc3LS41NmwuODgxLTUuMTM5YTIuMTIyIDIuMTIyIDAgMCAwLS42MTEtMS44NzlMMi4xNiA5Ljc5NWEuNTMuNTMgMCAwIDEgLjI5NC0uOTA2bDUuMTY1LS43NTVhMi4xMjIgMi4xMjIgMCAwIDAgMS41OTctMS4xNnoiLAogICAgICBrZXk6ICJyMDRzN3MiCiAgICB9CiAgXQpdOwp2YXIgU3RhciA9IGNyZWF0ZUx1Y2lkZUljb24oInN0YXIiLCBfX2ljb25Ob2RlMTgpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zdGV0aG9zY29wZS5qcwp2YXIgX19pY29uTm9kZTE5ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMSAydjIiLCBrZXk6ICIxNTM5eDQiIH1dLAogIFsicGF0aCIsIHsgZDogIk01IDJ2MiIsIGtleTogIjF5ZjFxOCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTUgM0g0YTIgMiAwIDAgMC0yIDJ2NGE2IDYgMCAwIDAgMTIgMFY1YTIgMiAwIDAgMC0yLTJoLTEiLCBrZXk6ICJyYjV0M3IiIH1dLAogIFsicGF0aCIsIHsgZDogIk04IDE1YTYgNiAwIDAgMCAxMiAwdi0zIiwga2V5OiAieDE4ZDR4IiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIyMCIsIGN5OiAiMTAiLCByOiAiMiIsIGtleTogInRzMXI1diIgfV0KXTsKdmFyIFN0ZXRob3Njb3BlID0gY3JlYXRlTHVjaWRlSWNvbigic3RldGhvc2NvcGUiLCBfX2ljb25Ob2RlMTkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmFzaC0yLmpzCnZhciBfX2ljb25Ob2RlMjAgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDExdjYiLCBrZXk6ICJuY28wb20iIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAxMXY2Iiwga2V5OiAib3V0djF1IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTkgNnYxNGEyIDIgMCAwIDEtMiAySDdhMiAyIDAgMCAxLTItMlY2Iiwga2V5OiAibWl5dHJjIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMyA2aDE4Iiwga2V5OiAiZDB3bTBqIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOCA2VjRhMiAyIDAgMCAxIDItMmg0YTIgMiAwIDAgMSAyIDJ2MiIsIGtleTogImU3OTFqaSIgfV0KXTsKdmFyIFRyYXNoMiA9IGNyZWF0ZUx1Y2lkZUljb24oInRyYXNoLTIiLCBfX2ljb25Ob2RlMjApOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy91c2Vycy5qcwp2YXIgX19pY29uTm9kZTIxID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiAyMXYtMmE0IDQgMCAwIDAtNC00SDZhNCA0IDAgMCAwLTQgNHYyIiwga2V5OiAiMXl5aXRxIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTYgMy4xMjhhNCA0IDAgMCAxIDAgNy43NDQiLCBrZXk6ICIxNmdyOGoiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yMiAyMXYtMmE0IDQgMCAwIDAtMy0zLjg3Iiwga2V5OiAia3NoZWdkIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICI5IiwgY3k6ICI3IiwgcjogIjQiLCBrZXk6ICJudWZrOCIgfV0KXTsKdmFyIFVzZXJzID0gY3JlYXRlTHVjaWRlSWNvbigidXNlcnMiLCBfX2ljb25Ob2RlMjEpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy94LmpzCnZhciBfX2ljb25Ob2RlMjIgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE4IDYgNiAxOCIsIGtleTogIjFibDVmOCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTYgNiAxMiAxMiIsIGtleTogImQ4Yms2diIgfV0KXTsKdmFyIFggPSBjcmVhdGVMdWNpZGVJY29uKCJ4IiwgX19pY29uTm9kZTIyKTsKCi8vIHNyYy9SZW1pbmRlckFwcC50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZSA9IF9fdG9FU00ocmVxdWlyZV9qc3hfcnVudGltZSgpLCAxKTsKdmFyIENPTE9SUyA9IHsKICAvLyBQcmltYXJ5IHNhZ2UgZ3JlZW4gcGFsZXR0ZQogIHByaW1hcnk6ICIjMkQ1QTNEIiwKICBwcmltYXJ5TGlnaHQ6ICIjNEE3QzU5IiwKICBwcmltYXJ5Qmc6ICIjRThGMEU4IiwKICBwcmltYXJ5U29mdDogIiNENEU1RDQiLAogIC8vIFNlbWFudGljIGNvbG9ycwogIHN1Y2Nlc3M6ICIjM0Q3QTVBIiwKICB3YXJuaW5nOiAiI0Q0QTU3NCIsCiAgZGFuZ2VyOiAiI0M5NzA3MCIsCiAgLy8gQmFja2dyb3VuZCBjb2xvcnMgLSBjcmVhbS9vZmYtd2hpdGUgdG9uZXMKICBiZzogIiNFOEU0REUiLAogIC8vIFdhcm0gY3JlYW0gYmFja2dyb3VuZAogIGNhcmQ6ICIjRkZGRkZGIiwKICBjYXJkQWx0OiAiI0Y4RjZGMyIsCiAgLy8gU2xpZ2h0bHkgd2FybSB3aGl0ZQogIC8vIFRleHQgY29sb3JzIC0gc29mdGVyIGJsYWNrcwogIHRleHRNYWluOiAiIzJDM0UyQyIsCiAgLy8gRGFyayBzYWdlIGZvciBtYWluIHRleHQKICB0ZXh0U2Vjb25kYXJ5OiAiIzVBNkI1QSIsCiAgdGV4dE11dGVkOiAiIzhBOTk4QSIsCiAgLy8gVUkgZWxlbWVudHMKICBib3JkZXI6ICIjRDhERUQ4IiwKICAvLyBWZXJ5IHNvZnQgYm9yZGVyCiAgaW5wdXRCZzogIiNGNUYzRjAiLAogIGdvbGQ6ICIjRDRBNTc0IiwKICAvLyBXYXJtIGdvbGQvdGFuCiAgYWNjZW50OiAiIzRBN0M1OSIsCiAgYWNjZW50TGlnaHQ6ICIjRThGMEU4IiwKICAvLyBJY29uIGJhY2tncm91bmRzIChjaXJjdWxhcikKICBpY29uQmc6ICIjRThGMEU4IiwKICBpY29uQmdBbHQ6ICIjRDRFNUQ0Igp9Owp2YXIgUFJJT1JJVFlfQ09MT1JTID0gewogIGxvdzogIiM2QjlCN0EiLAogIG1lZGl1bTogIiNENEE1NzQiLAogIGhpZ2g6ICIjRDQ5QTZBIiwKICB1cmdlbnQ6ICIjQzk3MDcwIgp9Owp2YXIgQ0FURUdPUllfQ09ORklHID0gewogIHdvcms6IHsgaWNvbjogQnJpZWZjYXNlLCBjb2xvcjogIiM0QTdDNTkiLCBiZzogIiNFOEYwRTgiLCBsYWJlbDogIldvcmsiIH0sCiAgZmFtaWx5OiB7IGljb246IFVzZXJzLCBjb2xvcjogIiNCODdBOUUiLCBiZzogIiNGNUU4RjAiLCBsYWJlbDogIkZhbWlseSIgfSwKICBoZWFsdGg6IHsgaWNvbjogU3RldGhvc2NvcGUsIGNvbG9yOiAiIzVBOUI3QSIsIGJnOiAiI0U4RjVGMCIsIGxhYmVsOiAiSGVhbHRoIiB9LAogIGVycmFuZHM6IHsgaWNvbjogU2hvcHBpbmdDYXJ0LCBjb2xvcjogIiNENEE1NzQiLCBiZzogIiNGNUYwRTgiLCBsYWJlbDogIkVycmFuZHMiIH0sCiAgZmluYW5jZTogeyBpY29uOiBCcmllZmNhc2UsIGNvbG9yOiAiIzdBNkI5QiIsIGJnOiAiI0YwRThGNSIsIGxhYmVsOiAiRmluYW5jZSIgfSwKICBzb2NpYWw6IHsgaWNvbjogSGVhcnQsIGNvbG9yOiAiI0M5NzA3MCIsIGJnOiAiI0Y1RThFOCIsIGxhYmVsOiAiU29jaWFsIiB9LAogIGxlYXJuaW5nOiB7IGljb246IEdyYWR1YXRpb25DYXAsIGNvbG9yOiAiIzVBOEI5QiIsIGJnOiAiI0U4RjBGNSIsIGxhYmVsOiAiTGVhcm5pbmciIH0sCiAgdHJhdmVsOiB7IGljb246IFBsYW5lLCBjb2xvcjogIiM2QjdBOUIiLCBiZzogIiNFOEVDRjUiLCBsYWJlbDogIlRyYXZlbCIgfSwKICBob21lOiB7IGljb246IEhvdXNlLCBjb2xvcjogIiM3QTlCNkIiLCBiZzogIiNFQ0Y1RTgiLCBsYWJlbDogIkhvbWUiIH0sCiAgb3RoZXI6IHsgaWNvbjogU3RhciwgY29sb3I6ICIjOEE5OThBIiwgYmc6ICIjRjBGMEYwIiwgbGFiZWw6ICJPdGhlciIgfQp9Owp2YXIgU1RPUkFHRV9LRVkgPSAiUkVNSU5ERVJfQVBQX0RBVEEiOwp2YXIgU1RBVFNfS0VZID0gIlJFTUlOREVSX0FQUF9TVEFUUyI7CnZhciBnZW5lcmF0ZUlkID0gKCkgPT4gYHJlbV8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7CnZhciBmb3JtYXREYXRlID0gKGRhdGVTdHIpID0+IHsKICBjb25zdCBkYXRlID0gbmV3IERhdGUoZGF0ZVN0cik7CiAgY29uc3QgdG9kYXkgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICBjb25zdCB0b21vcnJvdyA9IG5ldyBEYXRlKHRvZGF5KTsKICB0b21vcnJvdy5zZXREYXRlKHRvbW9ycm93LmdldERhdGUoKSArIDEpOwogIGlmIChkYXRlLnRvRGF0ZVN0cmluZygpID09PSB0b2RheS50b0RhdGVTdHJpbmcoKSkgcmV0dXJuICJUb2RheSI7CiAgaWYgKGRhdGUudG9EYXRlU3RyaW5nKCkgPT09IHRvbW9ycm93LnRvRGF0ZVN0cmluZygpKSByZXR1cm4gIlRvbW9ycm93IjsKICByZXR1cm4gZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcoImVuLVVTIiwgeyBtb250aDogInNob3J0IiwgZGF5OiAibnVtZXJpYyIgfSk7Cn07CnZhciBmb3JtYXRUaW1lID0gKHRpbWUpID0+IHsKICBpZiAoIXRpbWUpIHJldHVybiAiIjsKICBjb25zdCBbaCwgbV0gPSB0aW1lLnNwbGl0KCI6Iik7CiAgY29uc3QgaG91ciA9IHBhcnNlSW50KGgpOwogIHJldHVybiBgJHtob3VyICUgMTIgfHwgMTJ9OiR7bX0gJHtob3VyID49IDEyID8gIlBNIiA6ICJBTSJ9YDsKfTsKdmFyIGlzT3ZlcmR1ZSA9IChyKSA9PiAhci5jb21wbGV0ZWQgJiYgLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKGAke3IuZHVlRGF0ZX1UJHtyLmR1ZVRpbWUgfHwgIjIzOjU5In1gKSA8IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwp2YXIgZGV0ZWN0Q2F0ZWdvcnkgPSAodGV4dCkgPT4gewogIGNvbnN0IGxvd2VyID0gdGV4dC50b0xvd2VyQ2FzZSgpOwogIGlmICgvXGIobWVldGluZ3xlbWFpbHxyZXBvcnR8ZGVhZGxpbmV8cHJvamVjdHxjbGllbnR8Ym9zc3xvZmZpY2V8cHJlc2VudGF0aW9ufGNhbGwgd2l0aHxzeW5jfHN0YW5kdXB8cmV2aWV3fHN1Ym1pdHxwcm9wb3NhbClcYi8udGVzdChsb3dlcikpIHJldHVybiAid29yayI7CiAgaWYgKC9cYihtb218ZGFkfG1vdGhlcnxmYXRoZXJ8c2lzdGVyfGJyb3RoZXJ8ZmFtaWx5fGtpZHN8Y2hpbGRyZW58c29ufGRhdWdodGVyfHdpZmV8aHVzYmFuZHxncmFuZG1hfGdyYW5kcGF8cGFyZW50fGFubml2ZXJzYXJ5KVxiLy50ZXN0KGxvd2VyKSkgcmV0dXJuICJmYW1pbHkiOwogIGlmICgvXGIoZG9jdG9yfGRlbnRpc3R8Z3ltfHdvcmtvdXR8ZXhlcmNpc2V8bWVkaWNpbmV8cHJlc2NyaXB0aW9ufGFwcG9pbnRtZW50fHRoZXJhcHl8dml0YW1pbnxjaGVja3VwfGhvc3BpdGFsfGhlYWx0aClcYi8udGVzdChsb3dlcikpIHJldHVybiAiaGVhbHRoIjsKICBpZiAoL1xiKGJ1eXxncm9jZXJ5fHN0b3JlfHNob3B8cGljayB1cHxkcm9wIG9mZnxyZXR1cm58bWFpbHxwb3N0IG9mZmljZXxiYW5rfGRyeSBjbGVhbnxyZXBhaXIpXGIvLnRlc3QobG93ZXIpKSByZXR1cm4gImVycmFuZHMiOwogIGlmICgvXGIocGF5fGJpbGx8aW52b2ljZXx0YXh8YnVkZ2V0fGludmVzdG1lbnR8cmVudHxtb3J0Z2FnZXxpbnN1cmFuY2V8YWNjb3VudClcYi8udGVzdChsb3dlcikpIHJldHVybiAiZmluYW5jZSI7CiAgaWYgKC9cYihwYXJ0eXxkaW5uZXJ8bHVuY2h8Y29mZmVlfGZyaWVuZHxiaXJ0aGRheXxjZWxlYnJhdGlvbnxldmVudHxoYW5nb3V0fGNhdGNoIHVwKVxiLy50ZXN0KGxvd2VyKSkgcmV0dXJuICJzb2NpYWwiOwogIGlmICgvXGIoc3R1ZHl8Y2xhc3N8Y291cnNlfGJvb2t8cmVhZHxsZWFybnxob21ld29ya3xleGFtfHRlc3R8cHJhY3RpY2V8bGVzc29ufHR1dG9yaWFsKVxiLy50ZXN0KGxvd2VyKSkgcmV0dXJuICJsZWFybmluZyI7CiAgaWYgKC9cYihmbGlnaHR8aG90ZWx8dHJpcHx2YWNhdGlvbnx0cmF2ZWx8cGFja3xwYXNzcG9ydHxib29raW5nfHJlc2VydmF0aW9ufGFpcnBvcnQpXGIvLnRlc3QobG93ZXIpKSByZXR1cm4gInRyYXZlbCI7CiAgaWYgKC9cYihjbGVhbnxsYXVuZHJ5fGRpc2hlc3xmaXh8cmVwYWlyfGdhcmRlbnxsYXdufG9yZ2FuaXplfGRlY2x1dHRlcnxjb29rfHdhdGVyIHBsYW50cylcYi8udGVzdChsb3dlcikpIHJldHVybiAiaG9tZSI7CiAgcmV0dXJuICJvdGhlciI7Cn07CnZhciBkZXRlY3RQcmlvcml0eSA9ICh0ZXh0LCBkdWVEYXRlKSA9PiB7CiAgY29uc3QgbG93ZXIgPSB0ZXh0LnRvTG93ZXJDYXNlKCk7CiAgaWYgKC9cYih1cmdlbnR8YXNhcHxpbW1lZGlhdGVseXxjcml0aWNhbHxlbWVyZ2VuY3kpXGIvLnRlc3QobG93ZXIpKSByZXR1cm4gInVyZ2VudCI7CiAgaWYgKC9cYihpbXBvcnRhbnR8aGlnaCBwcmlvcml0eXxjcnVjaWFsfG11c3QpXGIvLnRlc3QobG93ZXIpKSByZXR1cm4gImhpZ2giOwogIGlmICgvXGIobG93IHByaW9yaXR5fHdoZW5ldmVyfG5vIHJ1c2h8ZXZlbnR1YWxseSlcYi8udGVzdChsb3dlcikpIHJldHVybiAibG93IjsKICBpZiAoZHVlRGF0ZSkgewogICAgY29uc3QgZHVlID0gbmV3IERhdGUoZHVlRGF0ZSk7CiAgICBjb25zdCB0b2RheSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogICAgY29uc3QgZGlmZkRheXMgPSBNYXRoLmNlaWwoKGR1ZS5nZXRUaW1lKCkgLSB0b2RheS5nZXRUaW1lKCkpIC8gKDFlMyAqIDYwICogNjAgKiAyNCkpOwogICAgaWYgKGRpZmZEYXlzIDw9IDApIHJldHVybiAidXJnZW50IjsKICAgIGlmIChkaWZmRGF5cyA8PSAxKSByZXR1cm4gImhpZ2giOwogICAgaWYgKGRpZmZEYXlzIDw9IDMpIHJldHVybiAibWVkaXVtIjsKICB9CiAgcmV0dXJuICJtZWRpdW0iOwp9Owp2YXIgcGFyc2VOYXR1cmFsTGFuZ3VhZ2UgPSAoaW5wdXQpID0+IHsKICBjb25zdCBsb3dlciA9IGlucHV0LnRvTG93ZXJDYXNlKCk7CiAgY29uc3QgdG9kYXkgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICBsZXQgY29uZmlkZW5jZSA9IDA7CiAgbGV0IGR1ZVRpbWU7CiAgY29uc3QgdGltZVBhdHRlcm5zID0gWwogICAgeyByZWdleDogL2F0IChcZHsxLDJ9KTooXGR7Mn0pXHMqKGFtfHBtKT8vaSwgaGFuZGxlcjogKG0pID0+IHsKICAgICAgbGV0IGggPSBwYXJzZUludChtWzFdKTsKICAgICAgY29uc3QgbWluID0gbVsyXTsKICAgICAgaWYgKG1bM10/LnRvTG93ZXJDYXNlKCkgPT09ICJwbSIgJiYgaCAhPT0gMTIpIGggKz0gMTI7CiAgICAgIGlmIChtWzNdPy50b0xvd2VyQ2FzZSgpID09PSAiYW0iICYmIGggPT09IDEyKSBoID0gMDsKICAgICAgcmV0dXJuIGAke2gudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke21pbn1gOwogICAgfSB9LAogICAgeyByZWdleDogL2F0IChcZHsxLDJ9KVxzKihhbXxwbSkvaSwgaGFuZGxlcjogKG0pID0+IHsKICAgICAgbGV0IGggPSBwYXJzZUludChtWzFdKTsKICAgICAgaWYgKG1bMl0udG9Mb3dlckNhc2UoKSA9PT0gInBtIiAmJiBoICE9PSAxMikgaCArPSAxMjsKICAgICAgaWYgKG1bMl0udG9Mb3dlckNhc2UoKSA9PT0gImFtIiAmJiBoID09PSAxMikgaCA9IDA7CiAgICAgIHJldHVybiBgJHtoLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06MDBgOwogICAgfSB9LAogICAgeyByZWdleDogLyhcZHsxLDJ9KShhbXxwbSkvaSwgaGFuZGxlcjogKG0pID0+IHsKICAgICAgbGV0IGggPSBwYXJzZUludChtWzFdKTsKICAgICAgaWYgKG1bMl0udG9Mb3dlckNhc2UoKSA9PT0gInBtIiAmJiBoICE9PSAxMikgaCArPSAxMjsKICAgICAgaWYgKG1bMl0udG9Mb3dlckNhc2UoKSA9PT0gImFtIiAmJiBoID09PSAxMikgaCA9IDA7CiAgICAgIHJldHVybiBgJHtoLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06MDBgOwogICAgfSB9CiAgXTsKICBmb3IgKGNvbnN0IHAgb2YgdGltZVBhdHRlcm5zKSB7CiAgICBjb25zdCBtYXRjaCA9IGlucHV0Lm1hdGNoKHAucmVnZXgpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIGR1ZVRpbWUgPSBwLmhhbmRsZXIobWF0Y2gpOwogICAgICBjb25maWRlbmNlICs9IDIwOwogICAgICBicmVhazsKICAgIH0KICB9CiAgbGV0IGR1ZURhdGUgPSB0b2RheS50b0lTT1N0cmluZygpLnNwbGl0KCJUIilbMF07CiAgaWYgKGxvd2VyLmluY2x1ZGVzKCJ0b2RheSIpKSB7CiAgICBjb25maWRlbmNlICs9IDIwOwogIH0gZWxzZSBpZiAobG93ZXIuaW5jbHVkZXMoInRvbmlnaHQiKSkgewogICAgZHVlVGltZSA9IGR1ZVRpbWUgfHwgIjIwOjAwIjsKICAgIGNvbmZpZGVuY2UgKz0gMjA7CiAgfSBlbHNlIGlmIChsb3dlci5pbmNsdWRlcygidG9tb3Jyb3ciKSkgewogICAgY29uc3QgdG9tID0gbmV3IERhdGUodG9kYXkpOwogICAgdG9tLnNldERhdGUodG9tLmdldERhdGUoKSArIDEpOwogICAgZHVlRGF0ZSA9IHRvbS50b0lTT1N0cmluZygpLnNwbGl0KCJUIilbMF07CiAgICBjb25maWRlbmNlICs9IDIwOwogIH0gZWxzZSBpZiAobG93ZXIuaW5jbHVkZXMoIm5leHQgd2VlayIpKSB7CiAgICBjb25zdCBuZXh0ID0gbmV3IERhdGUodG9kYXkpOwogICAgbmV4dC5zZXREYXRlKG5leHQuZ2V0RGF0ZSgpICsgNyk7CiAgICBkdWVEYXRlID0gbmV4dC50b0lTT1N0cmluZygpLnNwbGl0KCJUIilbMF07CiAgICBjb25maWRlbmNlICs9IDE1OwogIH0gZWxzZSBpZiAobG93ZXIuaW5jbHVkZXMoInRoaXMgd2Vla2VuZCIpKSB7CiAgICBjb25zdCBzYXQgPSBuZXcgRGF0ZSh0b2RheSk7CiAgICBzYXQuc2V0RGF0ZShzYXQuZ2V0RGF0ZSgpICsgKDYgLSBzYXQuZ2V0RGF5KCkpKTsKICAgIGR1ZURhdGUgPSBzYXQudG9JU09TdHJpbmcoKS5zcGxpdCgiVCIpWzBdOwogICAgY29uZmlkZW5jZSArPSAxNTsKICB9IGVsc2UgewogICAgY29uc3QgZGF5c01hdGNoID0gbG93ZXIubWF0Y2goL2luIChcZCspIGRheXM/Lyk7CiAgICBjb25zdCBob3Vyc01hdGNoID0gbG93ZXIubWF0Y2goL2luIChcZCspIGhvdXJzPy8pOwogICAgY29uc3Qgd2Vla3NNYXRjaCA9IGxvd2VyLm1hdGNoKC9pbiAoXGQrKSB3ZWVrcz8vKTsKICAgIGlmIChkYXlzTWF0Y2gpIHsKICAgICAgY29uc3QgZnV0ID0gbmV3IERhdGUodG9kYXkpOwogICAgICBmdXQuc2V0RGF0ZShmdXQuZ2V0RGF0ZSgpICsgcGFyc2VJbnQoZGF5c01hdGNoWzFdKSk7CiAgICAgIGR1ZURhdGUgPSBmdXQudG9JU09TdHJpbmcoKS5zcGxpdCgiVCIpWzBdOwogICAgICBjb25maWRlbmNlICs9IDE1OwogICAgfSBlbHNlIGlmIChob3Vyc01hdGNoKSB7CiAgICAgIGNvbnN0IGZ1dCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogICAgICBmdXQuc2V0SG91cnMoZnV0LmdldEhvdXJzKCkgKyBwYXJzZUludChob3Vyc01hdGNoWzFdKSk7CiAgICAgIGR1ZURhdGUgPSBmdXQudG9JU09TdHJpbmcoKS5zcGxpdCgiVCIpWzBdOwogICAgICBkdWVUaW1lID0gYCR7ZnV0LmdldEhvdXJzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke2Z1dC5nZXRNaW51dGVzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfWA7CiAgICAgIGNvbmZpZGVuY2UgKz0gMTU7CiAgICB9IGVsc2UgaWYgKHdlZWtzTWF0Y2gpIHsKICAgICAgY29uc3QgZnV0ID0gbmV3IERhdGUodG9kYXkpOwogICAgICBmdXQuc2V0RGF0ZShmdXQuZ2V0RGF0ZSgpICsgcGFyc2VJbnQod2Vla3NNYXRjaFsxXSkgKiA3KTsKICAgICAgZHVlRGF0ZSA9IGZ1dC50b0lTT1N0cmluZygpLnNwbGl0KCJUIilbMF07CiAgICAgIGNvbmZpZGVuY2UgKz0gMTU7CiAgICB9CiAgICBjb25zdCBkYXlzID0gWyJzdW5kYXkiLCAibW9uZGF5IiwgInR1ZXNkYXkiLCAid2VkbmVzZGF5IiwgInRodXJzZGF5IiwgImZyaWRheSIsICJzYXR1cmRheSJdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChsb3dlci5pbmNsdWRlcyhkYXlzW2ldKSB8fCBsb3dlci5pbmNsdWRlcyhgb24gJHtkYXlzW2ldfWApKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0ID0gbmV3IERhdGUodG9kYXkpOwogICAgICAgIGNvbnN0IGRpZmYgPSAoaSAtIHRvZGF5LmdldERheSgpICsgNykgJSA3IHx8IDc7CiAgICAgICAgdGFyZ2V0LnNldERhdGUodGFyZ2V0LmdldERhdGUoKSArIGRpZmYpOwogICAgICAgIGR1ZURhdGUgPSB0YXJnZXQudG9JU09TdHJpbmcoKS5zcGxpdCgiVCIpWzBdOwogICAgICAgIGNvbmZpZGVuY2UgKz0gMTU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CiAgbGV0IHJlY3VycmVuY2UgPSAibm9uZSI7CiAgbGV0IHJlY3VycmVuY2VJbnRlcnZhbDsKICBsZXQgcmVjdXJyZW5jZVVuaXQ7CiAgY29uc3QgY3VzdG9tUmVjdXJyZW5jZU1hdGNoID0gbG93ZXIubWF0Y2goL2V2ZXJ5XHMrKFxkKylccysoZGF5fGRheXN8d2Vla3x3ZWVrc3xtb250aHxtb250aHN8eWVhcnx5ZWFycykvaSk7CiAgaWYgKGN1c3RvbVJlY3VycmVuY2VNYXRjaCkgewogICAgY29uc3QgbnVtID0gcGFyc2VJbnQoY3VzdG9tUmVjdXJyZW5jZU1hdGNoWzFdKTsKICAgIGNvbnN0IHVuaXQgPSBjdXN0b21SZWN1cnJlbmNlTWF0Y2hbMl0udG9Mb3dlckNhc2UoKTsKICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IG51bTsKICAgIGlmICh1bml0LnN0YXJ0c1dpdGgoImRheSIpKSB7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gImRheXMiOwogICAgICByZWN1cnJlbmNlID0gbnVtID09PSAxID8gImRhaWx5IiA6ICJjdXN0b20iOwogICAgfSBlbHNlIGlmICh1bml0LnN0YXJ0c1dpdGgoIndlZWsiKSkgewogICAgICByZWN1cnJlbmNlVW5pdCA9ICJ3ZWVrcyI7CiAgICAgIHJlY3VycmVuY2UgPSBudW0gPT09IDEgPyAid2Vla2x5IiA6ICJjdXN0b20iOwogICAgfSBlbHNlIGlmICh1bml0LnN0YXJ0c1dpdGgoIm1vbnRoIikpIHsKICAgICAgcmVjdXJyZW5jZVVuaXQgPSAibW9udGhzIjsKICAgICAgcmVjdXJyZW5jZSA9IG51bSA9PT0gMSA/ICJtb250aGx5IiA6ICJjdXN0b20iOwogICAgfSBlbHNlIGlmICh1bml0LnN0YXJ0c1dpdGgoInllYXIiKSkgewogICAgICByZWN1cnJlbmNlVW5pdCA9ICJ5ZWFycyI7CiAgICAgIHJlY3VycmVuY2UgPSBudW0gPT09IDEgPyAieWVhcmx5IiA6ICJjdXN0b20iOwogICAgfQogICAgY29uZmlkZW5jZSArPSAxNTsKICB9IGVsc2UgaWYgKC9cYmV2ZXJ5XHMqZGF5XGJ8ZGFpbHkvaS50ZXN0KGxvd2VyKSkgewogICAgcmVjdXJyZW5jZSA9ICJkYWlseSI7CiAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAxOwogICAgcmVjdXJyZW5jZVVuaXQgPSAiZGF5cyI7CiAgICBjb25maWRlbmNlICs9IDEwOwogIH0gZWxzZSBpZiAoL1xiZXZlcnlccyp3ZWVrXGJ8d2Vla2x5L2kudGVzdChsb3dlcikpIHsKICAgIHJlY3VycmVuY2UgPSAid2Vla2x5IjsKICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDE7CiAgICByZWN1cnJlbmNlVW5pdCA9ICJ3ZWVrcyI7CiAgICBjb25maWRlbmNlICs9IDEwOwogIH0gZWxzZSBpZiAoL1xiZXZlcnlccyptb250aFxifG1vbnRobHkvaS50ZXN0KGxvd2VyKSkgewogICAgcmVjdXJyZW5jZSA9ICJtb250aGx5IjsKICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDE7CiAgICByZWN1cnJlbmNlVW5pdCA9ICJtb250aHMiOwogICAgY29uZmlkZW5jZSArPSAxMDsKICB9IGVsc2UgaWYgKC9cYmV2ZXJ5XHMqeWVhclxifHllYXJseXxhbm51YWxseS9pLnRlc3QobG93ZXIpKSB7CiAgICByZWN1cnJlbmNlID0gInllYXJseSI7CiAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAxOwogICAgcmVjdXJyZW5jZVVuaXQgPSAieWVhcnMiOwogICAgY29uZmlkZW5jZSArPSAxMDsKICB9IGVsc2UgaWYgKC9iaS0/d2Vla2x5fGV2ZXJ5IG90aGVyIHdlZWt8ZXZlcnkgMiB3ZWVrcy9pLnRlc3QobG93ZXIpKSB7CiAgICByZWN1cnJlbmNlID0gImN1c3RvbSI7CiAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAyOwogICAgcmVjdXJyZW5jZVVuaXQgPSAid2Vla3MiOwogICAgY29uZmlkZW5jZSArPSAxMjsKICB9IGVsc2UgaWYgKC9iaS0/bW9udGhseXxldmVyeSBvdGhlciBtb250aHxldmVyeSAyIG1vbnRocy9pLnRlc3QobG93ZXIpKSB7CiAgICByZWN1cnJlbmNlID0gImN1c3RvbSI7CiAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAyOwogICAgcmVjdXJyZW5jZVVuaXQgPSAibW9udGhzIjsKICAgIGNvbmZpZGVuY2UgKz0gMTI7CiAgfSBlbHNlIHsKICAgIGlmICgvXGJiaXJ0aGRheVxiL2kudGVzdChsb3dlcikpIHsKICAgICAgcmVjdXJyZW5jZSA9ICJ5ZWFybHkiOwogICAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAxOwogICAgICByZWN1cnJlbmNlVW5pdCA9ICJ5ZWFycyI7CiAgICAgIGNvbmZpZGVuY2UgKz0gMTA7CiAgICB9IGVsc2UgaWYgKC9cYmFubml2ZXJzYXJ5XGIvaS50ZXN0KGxvd2VyKSkgewogICAgICByZWN1cnJlbmNlID0gInllYXJseSI7CiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDE7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gInllYXJzIjsKICAgICAgY29uZmlkZW5jZSArPSAxMDsKICAgIH0gZWxzZSBpZiAoL1xiKG1lZGljYXRpb258bWVkaWNpbmV8dml0YW1pbnx2aXRhbWluc3xwaWxsfHBpbGxzfG1lZHMpXGIvaS50ZXN0KGxvd2VyKSAmJiByZWN1cnJlbmNlID09PSAibm9uZSIpIHsKICAgICAgcmVjdXJyZW5jZSA9ICJkYWlseSI7CiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDE7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gImRheXMiOwogICAgICBjb25maWRlbmNlICs9IDg7CiAgICB9IGVsc2UgaWYgKC9cYihyZW50fG1vcnRnYWdlKVxiL2kudGVzdChsb3dlcikgJiYgIS9wYWlkfHBheS4qb2ZmL2kudGVzdChsb3dlcikpIHsKICAgICAgcmVjdXJyZW5jZSA9ICJtb250aGx5IjsKICAgICAgcmVjdXJyZW5jZUludGVydmFsID0gMTsKICAgICAgcmVjdXJyZW5jZVVuaXQgPSAibW9udGhzIjsKICAgICAgY29uZmlkZW5jZSArPSA4OwogICAgfSBlbHNlIGlmICgvXGIocGF5Y2hlY2t8cGF5ZGF5fHNhbGFyeSlcYi9pLnRlc3QobG93ZXIpKSB7CiAgICAgIHJlY3VycmVuY2UgPSAiY3VzdG9tIjsKICAgICAgcmVjdXJyZW5jZUludGVydmFsID0gMjsKICAgICAgcmVjdXJyZW5jZVVuaXQgPSAid2Vla3MiOwogICAgICBjb25maWRlbmNlICs9IDY7CiAgICB9IGVsc2UgaWYgKC9cYihzdWJzY3JpcHRpb258cmVuZXdhbHxyZW5ldylcYi9pLnRlc3QobG93ZXIpKSB7CiAgICAgIHJlY3VycmVuY2UgPSAibW9udGhseSI7CiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDE7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gIm1vbnRocyI7CiAgICAgIGNvbmZpZGVuY2UgKz0gNjsKICAgIH0gZWxzZSBpZiAoL1xiKHRyYXNofGdhcmJhZ2V8cmVjeWNsaW5nfGJpbnMpXGIvaS50ZXN0KGxvd2VyKSkgewogICAgICByZWN1cnJlbmNlID0gIndlZWtseSI7CiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDE7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gIndlZWtzIjsKICAgICAgY29uZmlkZW5jZSArPSA4OwogICAgfSBlbHNlIGlmICgvXGJ3YXRlclxzKih0aGVccyopPyhwbGFudHM/fGZsb3dlcnM/fGdhcmRlbilcYi9pLnRlc3QobG93ZXIpKSB7CiAgICAgIHJlY3VycmVuY2UgPSAid2Vla2x5IjsKICAgICAgcmVjdXJyZW5jZUludGVydmFsID0gMTsKICAgICAgcmVjdXJyZW5jZVVuaXQgPSAid2Vla3MiOwogICAgICBjb25maWRlbmNlICs9IDY7CiAgICB9IGVsc2UgaWYgKC9cYihneW18d29ya291dHxleGVyY2lzZSlcYi9pLnRlc3QobG93ZXIpICYmIHJlY3VycmVuY2UgPT09ICJub25lIikgewogICAgICByZWN1cnJlbmNlID0gImN1c3RvbSI7CiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDI7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gImRheXMiOwogICAgICBjb25maWRlbmNlICs9IDU7CiAgICB9IGVsc2UgaWYgKC9cYmZlZWRccyoobXlccyopPyhjYXR8ZG9nfHBldHxmaXNofGJpcmQpXGIvaS50ZXN0KGxvd2VyKSkgewogICAgICByZWN1cnJlbmNlID0gImRhaWx5IjsKICAgICAgcmVjdXJyZW5jZUludGVydmFsID0gMTsKICAgICAgcmVjdXJyZW5jZVVuaXQgPSAiZGF5cyI7CiAgICAgIGNvbmZpZGVuY2UgKz0gODsKICAgIH0gZWxzZSBpZiAoL1xid2Fsa1xzKihteVxzKik/KGRvZ3xwdXBweSlcYi9pLnRlc3QobG93ZXIpKSB7CiAgICAgIHJlY3VycmVuY2UgPSAiZGFpbHkiOwogICAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAxOwogICAgICByZWN1cnJlbmNlVW5pdCA9ICJkYXlzIjsKICAgICAgY29uZmlkZW5jZSArPSA4OwogICAgfSBlbHNlIGlmICgvXGJvaWxccypjaGFuZ2VcYi9pLnRlc3QobG93ZXIpKSB7CiAgICAgIHJlY3VycmVuY2UgPSAiY3VzdG9tIjsKICAgICAgcmVjdXJyZW5jZUludGVydmFsID0gMzsKICAgICAgcmVjdXJyZW5jZVVuaXQgPSAibW9udGhzIjsKICAgICAgY29uZmlkZW5jZSArPSA2OwogICAgfSBlbHNlIGlmICgvXGJoYWlyY3V0XGIvaS50ZXN0KGxvd2VyKSkgewogICAgICByZWN1cnJlbmNlID0gIm1vbnRobHkiOwogICAgICByZWN1cnJlbmNlSW50ZXJ2YWwgPSAxOwogICAgICByZWN1cnJlbmNlVW5pdCA9ICJtb250aHMiOwogICAgICBjb25maWRlbmNlICs9IDU7CiAgICB9IGVsc2UgaWYgKC9cYmRlbnRpc3RcYi9pLnRlc3QobG93ZXIpICYmICEvYXBwb2ludG1lbnR8dG9tb3Jyb3d8dG9kYXkvaS50ZXN0KGxvd2VyKSkgewogICAgICByZWN1cnJlbmNlID0gImN1c3RvbSI7CiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbCA9IDY7CiAgICAgIHJlY3VycmVuY2VVbml0ID0gIm1vbnRocyI7CiAgICAgIGNvbmZpZGVuY2UgKz0gNTsKICAgIH0KICB9CiAgY29uc3QgY2F0ZWdvcnkgPSBkZXRlY3RDYXRlZ29yeShpbnB1dCk7CiAgaWYgKGNhdGVnb3J5ICE9PSAib3RoZXIiKSBjb25maWRlbmNlICs9IDE1OwogIGNvbnN0IHByaW9yaXR5ID0gZGV0ZWN0UHJpb3JpdHkoaW5wdXQsIGR1ZURhdGUpOwogIGlmIChwcmlvcml0eSAhPT0gIm1lZGl1bSIpIGNvbmZpZGVuY2UgKz0gMTA7CiAgbGV0IHRpdGxlID0gaW5wdXQucmVwbGFjZSgvXnJlbWluZFxzK21lXHMrKHRvXHMrKT8vZ2ksICIiKS5yZXBsYWNlKC9eZG9uJ3Rccytmb3JnZXRccysodG9ccyspPy9naSwgIiIpLnJlcGxhY2UoL15pXHMrbmVlZFxzK3RvXHMrL2dpLCAiIikucmVwbGFjZSgvXm5lZWRccyt0b1xzKy9naSwgIiIpLnJlcGxhY2UoL1xiZXZlcnlccytcZCtccytkYXlzP1xiL2dpLCAiIikucmVwbGFjZSgvXGJldmVyeVxzK1xkK1xzK3dlZWtzP1xiL2dpLCAiIikucmVwbGFjZSgvXGJldmVyeVxzK1xkK1xzK21vbnRocz9cYi9naSwgIiIpLnJlcGxhY2UoL1xiZXZlcnlccytcZCtccyt5ZWFycz9cYi9naSwgIiIpLnJlcGxhY2UoL1xiZXZlcnlccytvdGhlclxzKyhkYXl8d2Vla3xtb250aHx5ZWFyKVxiL2dpLCAiIikucmVwbGFjZSgvXGJldmVyeVxzKmRheVxiL2dpLCAiIikucmVwbGFjZSgvXGJldmVyeVxzKndlZWtcYi9naSwgIiIpLnJlcGxhY2UoL1xiZXZlcnlccyptb250aFxiL2dpLCAiIikucmVwbGFjZSgvXGJldmVyeVxzKnllYXJcYi9naSwgIiIpLnJlcGxhY2UoL1xiZGFpbHlcYi9naSwgIiIpLnJlcGxhY2UoL1xid2Vla2x5XGIvZ2ksICIiKS5yZXBsYWNlKC9cYm1vbnRobHlcYi9naSwgIiIpLnJlcGxhY2UoL1xieWVhcmx5XGIvZ2ksICIiKS5yZXBsYWNlKC9cYmFubnVhbGx5XGIvZ2ksICIiKS5yZXBsYWNlKC9cYmJpLT93ZWVrbHlcYi9naSwgIiIpLnJlcGxhY2UoL1xiYmktP21vbnRobHlcYi9naSwgIiIpLnJlcGxhY2UoL1xiYXRccytcZHsxLDJ9KDpcZHsyfSk/XHMqKGFtfHBtKT9cYi9naSwgIiIpLnJlcGxhY2UoL1xiXGR7MSwyfVxzKihhbXxwbSlcYi9naSwgIiIpLnJlcGxhY2UoL1xidG9kYXlcYi9naSwgIiIpLnJlcGxhY2UoL1xidG9tb3Jyb3dcYi9naSwgIiIpLnJlcGxhY2UoL1xidG9uaWdodFxiL2dpLCAiIikucmVwbGFjZSgvXGJuZXh0XHMrd2Vla1xiL2dpLCAiIikucmVwbGFjZSgvXGJ0aGlzXHMrd2Vla2VuZFxiL2dpLCAiIikucmVwbGFjZSgvXGJpblxzK1xkK1xzKyhkYXlzP3xob3Vycz98d2Vla3M/fG1vbnRocz8pXGIvZ2ksICIiKS5yZXBsYWNlKC9cYm9uXHMrKHN1bmRheXxtb25kYXl8dHVlc2RheXx3ZWRuZXNkYXl8dGh1cnNkYXl8ZnJpZGF5fHNhdHVyZGF5KVxiL2dpLCAiIikucmVwbGFjZSgvXGJ1cmdlbnRcYi9naSwgIiIpLnJlcGxhY2UoL1xiYXNhcFxiL2dpLCAiIikucmVwbGFjZSgvXGJpbW1lZGlhdGVseVxiL2dpLCAiIikucmVwbGFjZSgvXGJpbXBvcnRhbnRcYi9naSwgIiIpLnJlcGxhY2UoL1xiaGlnaFxzK3ByaW9yaXR5XGIvZ2ksICIiKS5yZXBsYWNlKC9cYmxvd1xzK3ByaW9yaXR5XGIvZ2ksICIiKS5yZXBsYWNlKC9cYm5vXHMrcnVzaFxiL2dpLCAiIikucmVwbGFjZSgvXHMrdG9ccyskL2dpLCAiIikucmVwbGFjZSgvXlxzKnRvXHMrL2dpLCAiIikucmVwbGFjZSgvXHMrL2csICIgIikudHJpbSgpOwogIGlmICh0aXRsZSAmJiB0aXRsZS5sZW5ndGggPiAwKSB7CiAgICB0aXRsZSA9IHRpdGxlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGl0bGUuc2xpY2UoMSk7CiAgICBjb25maWRlbmNlICs9IDI1OwogIH0KICByZXR1cm4gewogICAgdGl0bGU6IHRpdGxlIHx8IGlucHV0LAogICAgZHVlRGF0ZSwKICAgIGR1ZVRpbWUsCiAgICBwcmlvcml0eSwKICAgIGNhdGVnb3J5LAogICAgcmVjdXJyZW5jZSwKICAgIHJlY3VycmVuY2VJbnRlcnZhbCwKICAgIHJlY3VycmVuY2VVbml0LAogICAgY29uZmlkZW5jZTogTWF0aC5taW4oY29uZmlkZW5jZSwgMTAwKQogIH07Cn07CnZhciBjYWxjTGV2ZWwgPSAocHRzKSA9PiB7CiAgbGV0IGx2bCA9IDEsIG5lZWRlZCA9IDEwMCwgdG90YWwgPSAwOwogIHdoaWxlIChwdHMgPj0gdG90YWwgKyBuZWVkZWQpIHsKICAgIHRvdGFsICs9IG5lZWRlZDsKICAgIGx2bCsrOwogICAgbmVlZGVkID0gbHZsICogMTAwOwogIH0KICByZXR1cm4geyBsZXZlbDogbHZsLCB4cFRvTmV4dDogbmVlZGVkIC0gKHB0cyAtIHRvdGFsKSwgcHJvZ3Jlc3M6IChwdHMgLSB0b3RhbCkgLyBuZWVkZWQgKiAxMDAgfTsKfTsKdmFyIERFRkFVTFRfQUNISUVWRU1FTlRTID0gWwogIHsgaWQ6ICJmaXJzdCIsIG5hbWU6ICJGaXJzdCBTdGVwIiwgaWNvbjogIlx1ezFGM0FGfSIsIHVubG9ja2VkOiBmYWxzZSB9LAogIHsgaWQ6ICJzdHJlYWszIiwgbmFtZTogIk9uIEZpcmUiLCBpY29uOiAiXHV7MUY1MjV9IiwgdW5sb2NrZWQ6IGZhbHNlIH0sCiAgeyBpZDogInN0cmVhazciLCBuYW1lOiAiV2VlayBXYXJyaW9yIiwgaWNvbjogIlx1MjZBMSIsIHVubG9ja2VkOiBmYWxzZSB9LAogIHsgaWQ6ICJjb21wbGV0ZTEwIiwgbmFtZTogIkdldHRpbmcgU3RhcnRlZCIsIGljb246ICJcdTJCNTAiLCB1bmxvY2tlZDogZmFsc2UgfSwKICB7IGlkOiAiY29tcGxldGU1MCIsIG5hbWU6ICJQcm9kdWN0aXZlIiwgaWNvbjogIlx1ezFGM0M2fSIsIHVubG9ja2VkOiBmYWxzZSB9Cl07CnZhciBQUk9HUkVTU0lPTl9UQVNLUyA9IFsKICAvLyA9PT0gQURESU5HIFJFTUlOREVSUyAoVGFza3MgMS01KSA9PT0KICB7CiAgICBpZDogImZpcnN0X3JlbWluZGVyIiwKICAgIG5hbWU6ICJHZXR0aW5nIFN0YXJ0ZWQiLAogICAgZGVzY3JpcHRpb246ICJBZGQgeW91ciBmaXJzdCByZW1pbmRlciIsCiAgICBpY29uOiAiXHV7MUYzQUZ9IiwKICAgIHBvaW50czogMTUsCiAgICBjaGVjazogKHJlbWluZGVycykgPT4gcmVtaW5kZXJzLmxlbmd0aCA+PSAxCiAgfSwKICB7CiAgICBpZDogImFkZF9iaXJ0aGRheSIsCiAgICBuYW1lOiAiQmlydGhkYXkgVHJhY2tlciIsCiAgICBkZXNjcmlwdGlvbjogIkFkZCBhIGJpcnRoZGF5IHJlbWluZGVyIChpbmNsdWRlICdiaXJ0aGRheScgaW4gdGl0bGUpIiwKICAgIGljb246ICJcdXsxRjM4Mn0iLAogICAgcG9pbnRzOiAxNSwKICAgIGNoZWNrOiAocmVtaW5kZXJzKSA9PiByZW1pbmRlcnMuc29tZSgocikgPT4gL2JpcnRoZGF5L2kudGVzdChyLnRpdGxlKSkKICB9LAogIHsKICAgIGlkOiAiYWRkX3dvcmsiLAogICAgbmFtZTogIlN0YXkgUHJvZmVzc2lvbmFsIiwKICAgIGRlc2NyaXB0aW9uOiAiQWRkIGEgd29yayByZW1pbmRlciAobWVldGluZywgZGVhZGxpbmUsIHByb2plY3QpIiwKICAgIGljb246ICJcdXsxRjRCQ30iLAogICAgcG9pbnRzOiAxNSwKICAgIGNoZWNrOiAocmVtaW5kZXJzKSA9PiByZW1pbmRlcnMuc29tZSgocikgPT4gci5jYXRlZ29yeSA9PT0gIndvcmsiKQogIH0sCiAgewogICAgaWQ6ICJhZGRfZmFtaWx5IiwKICAgIG5hbWU6ICJGYW1pbHkgTWF0dGVycyIsCiAgICBkZXNjcmlwdGlvbjogIkFkZCBhIGZhbWlseSByZW1pbmRlciAoY2FsbCBtb20sIHZpc2l0IGdyYW5kbWEpIiwKICAgIGljb246ICJcdXsxRjQ2OH1cdTIwMERcdXsxRjQ2OX1cdTIwMERcdXsxRjQ2N30iLAogICAgcG9pbnRzOiAxNSwKICAgIGNoZWNrOiAocmVtaW5kZXJzKSA9PiByZW1pbmRlcnMuc29tZSgocikgPT4gci5jYXRlZ29yeSA9PT0gImZhbWlseSIpCiAgfSwKICB7CiAgICBpZDogImFkZF9yZWN1cnJpbmciLAogICAgbmFtZTogIkhhYml0IEJ1aWxkZXIiLAogICAgZGVzY3JpcHRpb246ICJBZGQgYSByZWN1cnJpbmcgcmVtaW5kZXIgKGRhaWx5LCB3ZWVrbHksIGV0Yy4pIiwKICAgIGljb246ICJcdXsxRjUwNH0iLAogICAgcG9pbnRzOiAyMCwKICAgIGNoZWNrOiAocmVtaW5kZXJzKSA9PiByZW1pbmRlcnMuc29tZSgocikgPT4gci5yZWN1cnJlbmNlICE9PSAibm9uZSIpCiAgfSwKICAvLyA9PT0gTUFSSyBDT01QTEVURSBUQVNLUyAoVGFza3MgNi04KSA9PT0KICB7CiAgICBpZDogImZpcnN0X2NvbXBsZXRlIiwKICAgIG5hbWU6ICJUYXNrIE1hc3RlciIsCiAgICBkZXNjcmlwdGlvbjogIk1hcmsgeW91ciBmaXJzdCByZW1pbmRlciBhcyBjb21wbGV0ZSIsCiAgICBpY29uOiAiXHUyNzA1IiwKICAgIHBvaW50czogMjAsCiAgICBjaGVjazogKF8sIHN0YXRzKSA9PiBzdGF0cy5jb21wbGV0ZWRBbGxUaW1lID49IDEKICB9LAogIHsKICAgIGlkOiAiY29tcGxldGVfMyIsCiAgICBuYW1lOiAiT24gYSBSb2xsIiwKICAgIGRlc2NyaXB0aW9uOiAiTWFyayAzIHJlbWluZGVycyBhcyBjb21wbGV0ZSIsCiAgICBpY29uOiAiXHV7MUYzQjN9IiwKICAgIHBvaW50czogMjUsCiAgICBjaGVjazogKF8sIHN0YXRzKSA9PiBzdGF0cy5jb21wbGV0ZWRBbGxUaW1lID49IDMKICB9LAogIHsKICAgIGlkOiAiY29tcGxldGVfNSIsCiAgICBuYW1lOiAiSGlnaCBGaXZlIiwKICAgIGRlc2NyaXB0aW9uOiAiTWFyayA1IHJlbWluZGVycyBhcyBjb21wbGV0ZSIsCiAgICBpY29uOiAiXHV7MUY1OTB9XHVGRTBGIiwKICAgIHBvaW50czogMzAsCiAgICBjaGVjazogKF8sIHN0YXRzKSA9PiBzdGF0cy5jb21wbGV0ZWRBbGxUaW1lID49IDUKICB9LAogIC8vID09PSBBRFZBTkNFRCBUQVNLUyAoVGFza3MgOS0xMikgPT09CiAgewogICAgaWQ6ICJhZGRfaGVhbHRoIiwKICAgIG5hbWU6ICJIZWFsdGggRmlyc3QiLAogICAgZGVzY3JpcHRpb246ICJBZGQgYSBoZWFsdGggcmVtaW5kZXIgKGRvY3Rvciwgdml0YW1pbnMsIGV4ZXJjaXNlKSIsCiAgICBpY29uOiAiXHV7MUY0OEF9IiwKICAgIHBvaW50czogMTUsCiAgICBjaGVjazogKHJlbWluZGVycykgPT4gcmVtaW5kZXJzLnNvbWUoKHIpID0+IHIuY2F0ZWdvcnkgPT09ICJoZWFsdGgiKQogIH0sCiAgewogICAgaWQ6ICJhZGRfYmlsbCIsCiAgICBuYW1lOiAiQmlsbCBUcmFja2VyIiwKICAgIGRlc2NyaXB0aW9uOiAiQWRkIGEgYmlsbC9wYXltZW50IHJlbWluZGVyIChyZW50LCB1dGlsaXRpZXMpIiwKICAgIGljb246ICJcdXsxRjRCMH0iLAogICAgcG9pbnRzOiAxNSwKICAgIGNoZWNrOiAocmVtaW5kZXJzKSA9PiByZW1pbmRlcnMuc29tZSgocikgPT4gci5jYXRlZ29yeSA9PT0gImZpbmFuY2UiIHx8IC9iaWxsfHJlbnR8cGF5fG1vcnRnYWdlfGluc3VyYW5jZS9pLnRlc3Qoci50aXRsZSkpCiAgfSwKICB7CiAgICBpZDogInN0YXJ0X3N0cmVhayIsCiAgICBuYW1lOiAiU3RyZWFrIFN0YXJ0ZXIiLAogICAgZGVzY3JpcHRpb246ICJCdWlsZCBhIDItZGF5IHN0cmVhayBieSBtYXJraW5nIHJlbWluZGVycyBjb21wbGV0ZSBkYWlseSIsCiAgICBpY29uOiAiXHV7MUY1MjV9IiwKICAgIHBvaW50czogMzAsCiAgICBjaGVjazogKF8sIHN0YXRzKSA9PiBzdGF0cy5jdXJyZW50U3RyZWFrID49IDIgfHwgc3RhdHMubG9uZ2VzdFN0cmVhayA+PSAyCiAgfSwKICB7CiAgICBpZDogIndlZWtfc3RyZWFrIiwKICAgIG5hbWU6ICJXZWVrIFdhcnJpb3IiLAogICAgZGVzY3JpcHRpb246ICJNYWludGFpbiBhIDctZGF5IHN0cmVhayIsCiAgICBpY29uOiAiXHUyNkExIiwKICAgIHBvaW50czogMTAwLAogICAgY2hlY2s6IChfLCBzdGF0cykgPT4gc3RhdHMuY3VycmVudFN0cmVhayA+PSA3IHx8IHN0YXRzLmxvbmdlc3RTdHJlYWsgPj0gNwogIH0KXTsKdmFyIHBlcnNpc3RTdGF0ZSA9IChyZW1pbmRlcnMsIHN0YXRzKSA9PiB7CiAgY29uc3Qgc3RhdGUgPSB7IHJlbWluZGVycywgc3RhdHMsIHNhdmVkQXQ6IERhdGUubm93KCkgfTsKICBpZiAod2luZG93Lm9wZW5haT8uc2V0V2lkZ2V0U3RhdGUpIHsKICAgIHRyeSB7CiAgICAgIHdpbmRvdy5vcGVuYWkuc2V0V2lkZ2V0U3RhdGUoc3RhdGUpOwogICAgICBjb25zb2xlLmxvZygiW1BlcnNpc3RdIFNhdmVkIHRvIHdpZGdldCBzdGF0ZSIpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLmVycm9yKCJbUGVyc2lzdF0gV2lkZ2V0IHN0YXRlIGVycm9yOiIsIGUpOwogICAgfQogIH0KICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVksIEpTT04uc3RyaW5naWZ5KHJlbWluZGVycykpOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RBVFNfS0VZLCBKU09OLnN0cmluZ2lmeShzdGF0cykpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoIltQZXJzaXN0XSBsb2NhbFN0b3JhZ2UgZXJyb3I6IiwgZSk7CiAgfQogIGlmICh3aW5kb3cub3BlbmFpPy5jYWxsVG9vbCkgewogICAgdHJ5IHsKICAgICAgd2luZG93Lm9wZW5haS5jYWxsVG9vbCgic2F2ZV9yZW1pbmRlcnMiLCBzdGF0ZSkuY2F0Y2goKGUpID0+IHsKICAgICAgICBjb25zb2xlLmxvZygiW1BlcnNpc3RdIGNhbGxUb29sIG5vdCBhdmFpbGFibGUgb3IgZmFpbGVkOiIsIGUpOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9Cn07CnZhciBsb2FkSW5pdGlhbFN0YXRlID0gKGluaXRpYWxEYXRhMikgPT4gewogIGNvbnN0IGRlZmF1bHRTdGF0cyA9IHsKICAgIHRvdGFsUG9pbnRzOiAwLAogICAgY3VycmVudFN0cmVhazogMCwKICAgIGxvbmdlc3RTdHJlYWs6IDAsCiAgICBjb21wbGV0ZWRBbGxUaW1lOiAwLAogICAgbGV2ZWw6IDEsCiAgICBhY2hpZXZlbWVudHM6IFsuLi5ERUZBVUxUX0FDSElFVkVNRU5UU10sCiAgICBjb21wbGV0ZWRUYXNrczogW10KICB9OwogIGlmIChpbml0aWFsRGF0YTI/LnJlbWluZGVycyAmJiBBcnJheS5pc0FycmF5KGluaXRpYWxEYXRhMi5yZW1pbmRlcnMpKSB7CiAgICBjb25zb2xlLmxvZygiW0xvYWRdIFVzaW5nIGluaXRpYWxEYXRhIGZyb20gc2VydmVyOiIsIGluaXRpYWxEYXRhMi5yZW1pbmRlcnMubGVuZ3RoLCAicmVtaW5kZXJzIik7CiAgICByZXR1cm4gewogICAgICByZW1pbmRlcnM6IGluaXRpYWxEYXRhMi5yZW1pbmRlcnMsCiAgICAgIHN0YXRzOiBpbml0aWFsRGF0YTIuc3RhdHMgfHwgZGVmYXVsdFN0YXRzCiAgICB9OwogIH0KICB0cnkgewogICAgY29uc3Qgd2lkZ2V0U3RhdGUgPSB3aW5kb3cub3BlbmFpPy53aWRnZXRTdGF0ZTsKICAgIGlmICh3aWRnZXRTdGF0ZT8ucmVtaW5kZXJzICYmIEFycmF5LmlzQXJyYXkod2lkZ2V0U3RhdGUucmVtaW5kZXJzKSkgewogICAgICBjb25zb2xlLmxvZygiW0xvYWRdIFVzaW5nIHdpZGdldCBzdGF0ZToiLCB3aWRnZXRTdGF0ZS5yZW1pbmRlcnMubGVuZ3RoLCAicmVtaW5kZXJzIik7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVtaW5kZXJzOiB3aWRnZXRTdGF0ZS5yZW1pbmRlcnMsCiAgICAgICAgc3RhdHM6IHdpZGdldFN0YXRlLnN0YXRzIHx8IGRlZmF1bHRTdGF0cwogICAgICB9OwogICAgfQogIH0gY2F0Y2ggKGUpIHsKICB9CiAgdHJ5IHsKICAgIGNvbnN0IHNhdmVkUmVtaW5kZXJzID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVkpOwogICAgY29uc3Qgc2F2ZWRTdGF0cyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUQVRTX0tFWSk7CiAgICBpZiAoc2F2ZWRSZW1pbmRlcnMpIHsKICAgICAgY29uc3QgcmVtaW5kZXJzID0gSlNPTi5wYXJzZShzYXZlZFJlbWluZGVycyk7CiAgICAgIGNvbnNvbGUubG9nKCJbTG9hZF0gVXNpbmcgbG9jYWxTdG9yYWdlOiIsIHJlbWluZGVycy5sZW5ndGgsICJyZW1pbmRlcnMiKTsKICAgICAgcmV0dXJuIHsKICAgICAgICByZW1pbmRlcnMsCiAgICAgICAgc3RhdHM6IHNhdmVkU3RhdHMgPyBKU09OLnBhcnNlKHNhdmVkU3RhdHMpIDogZGVmYXVsdFN0YXRzCiAgICAgIH07CiAgICB9CiAgfSBjYXRjaCAoZSkgewogIH0KICBjb25zb2xlLmxvZygiW0xvYWRdIE5vIHNhdmVkIGRhdGEgZm91bmQsIHN0YXJ0aW5nIGZyZXNoIik7CiAgcmV0dXJuIHsgcmVtaW5kZXJzOiBbXSwgc3RhdHM6IGRlZmF1bHRTdGF0cyB9Owp9OwpmdW5jdGlvbiBSZW1pbmRlckFwcCh7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSkgewogIGNvbnN0IGluaXRpYWwgPSAoMCwgaW1wb3J0X3JlYWN0My51c2VNZW1vKSgoKSA9PiBsb2FkSW5pdGlhbFN0YXRlKGluaXRpYWxEYXRhMiksIFtdKTsKICBjb25zdCBbcmVtaW5kZXJzLCBzZXRSZW1pbmRlcnNdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKGluaXRpYWwucmVtaW5kZXJzKTsKICBjb25zdCBbc3RhdHMsIHNldFN0YXRzXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKShpbml0aWFsLnN0YXRzKTsKICBjb25zdCBbaW5wdXQsIHNldElucHV0XSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3BhcnNlZCwgc2V0UGFyc2VkXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBpbnB1dFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVJlZikobnVsbCk7CiAgY29uc3QgW2VkaXRpbmcsIHNldEVkaXRpbmddID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFtzZWFyY2gsIHNldFNlYXJjaF0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtmaWx0ZXJDYXRlZ29yeSwgc2V0RmlsdGVyQ2F0ZWdvcnldID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKCJhbGwiKTsKICBjb25zdCBbZmlsdGVyU3RhdHVzLCBzZXRGaWx0ZXJTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKCJhbGwiKTsKICBjb25zdCBbc29ydEZpZWxkLCBzZXRTb3J0RmllbGRdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKCJkdWVEYXRlIik7CiAgY29uc3QgW3NvcnRBc2MsIHNldFNvcnRBc2NdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKHRydWUpOwogIGNvbnN0IFt0b2FzdCwgc2V0VG9hc3RdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFthY2hpZXZlbWVudCwgc2V0QWNoaWV2ZW1lbnRdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgcGVyc2lzdFN0YXRlKHJlbWluZGVycywgc3RhdHMpOwogIH0sIFtyZW1pbmRlcnMsIHN0YXRzXSk7CiAgKDAsIGltcG9ydF9yZWFjdDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAodG9hc3QpIHsKICAgICAgY29uc3QgdCA9IHNldFRpbWVvdXQoKCkgPT4gc2V0VG9hc3QobnVsbCksIDNlMyk7CiAgICAgIHJldHVybiAoKSA9PiBjbGVhclRpbWVvdXQodCk7CiAgICB9CiAgfSwgW3RvYXN0XSk7CiAgKDAsIGltcG9ydF9yZWFjdDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoYWNoaWV2ZW1lbnQpIHsKICAgICAgY29uc3QgdCA9IHNldFRpbWVvdXQoKCkgPT4gc2V0QWNoaWV2ZW1lbnQobnVsbCksIDRlMyk7CiAgICAgIHJldHVybiAoKSA9PiBjbGVhclRpbWVvdXQodCk7CiAgICB9CiAgfSwgW2FjaGlldmVtZW50XSk7CiAgKDAsIGltcG9ydF9yZWFjdDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaW5wdXQubGVuZ3RoID4gMikgewogICAgICBzZXRQYXJzZWQocGFyc2VOYXR1cmFsTGFuZ3VhZ2UoaW5wdXQpKTsKICAgIH0gZWxzZSB7CiAgICAgIHNldFBhcnNlZChudWxsKTsKICAgIH0KICB9LCBbaW5wdXRdKTsKICAoMCwgaW1wb3J0X3JlYWN0My51c2VFZmZlY3QpKCgpID0+IHsKICAgIGNvbnN0IG5vdGlmeSA9ICgpID0+IHsKICAgICAgaWYgKHdpbmRvdy5vcGVuYWk/Lm5vdGlmeUludHJpbnNpY0hlaWdodCkgd2luZG93Lm9wZW5haS5ub3RpZnlJbnRyaW5zaWNIZWlnaHQoKTsKICAgIH07CiAgICBub3RpZnkoKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCBub3RpZnkpOwogICAgcmV0dXJuICgpID0+IHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCBub3RpZnkpOwogIH0sIFtyZW1pbmRlcnMsIHBhcnNlZCwgZWRpdGluZ10pOwogIGNvbnN0IGZpbHRlcmVkID0gKDAsIGltcG9ydF9yZWFjdDMudXNlTWVtbykoKCkgPT4gewogICAgbGV0IGYgPSBbLi4ucmVtaW5kZXJzXTsKICAgIGlmIChzZWFyY2gpIHsKICAgICAgY29uc3QgcSA9IHNlYXJjaC50b0xvd2VyQ2FzZSgpOwogICAgICBmID0gZi5maWx0ZXIoKHIpID0+IHIudGl0bGUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxKSB8fCByLmNhdGVnb3J5LmluY2x1ZGVzKHEpKTsKICAgIH0KICAgIGlmIChmaWx0ZXJDYXRlZ29yeSAhPT0gImFsbCIpIGYgPSBmLmZpbHRlcigocikgPT4gci5jYXRlZ29yeSA9PT0gZmlsdGVyQ2F0ZWdvcnkpOwogICAgaWYgKGZpbHRlclN0YXR1cyA9PT0gInBlbmRpbmciKSBmID0gZi5maWx0ZXIoKHIpID0+ICFyLmNvbXBsZXRlZCAmJiAhaXNPdmVyZHVlKHIpKTsKICAgIGVsc2UgaWYgKGZpbHRlclN0YXR1cyA9PT0gImNvbXBsZXRlZCIpIGYgPSBmLmZpbHRlcigocikgPT4gci5jb21wbGV0ZWQpOwogICAgZWxzZSBpZiAoZmlsdGVyU3RhdHVzID09PSAib3ZlcmR1ZSIpIGYgPSBmLmZpbHRlcigocikgPT4gaXNPdmVyZHVlKHIpKTsKICAgIGYuc29ydCgoYSwgYikgPT4gewogICAgICBpZiAoc29ydEZpZWxkID09PSAiZHVlRGF0ZSIpIHJldHVybiAobmV3IERhdGUoYS5kdWVEYXRlKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShiLmR1ZURhdGUpLmdldFRpbWUoKSkgKiAoc29ydEFzYyA/IDEgOiAtMSk7CiAgICAgIGlmIChzb3J0RmllbGQgPT09ICJjYXRlZ29yeSIpIHJldHVybiBhLmNhdGVnb3J5LmxvY2FsZUNvbXBhcmUoYi5jYXRlZ29yeSkgKiAoc29ydEFzYyA/IDEgOiAtMSk7CiAgICAgIGNvbnN0IG9yZGVyID0geyB1cmdlbnQ6IDAsIGhpZ2g6IDEsIG1lZGl1bTogMiwgbG93OiAzIH07CiAgICAgIHJldHVybiAob3JkZXJbYS5wcmlvcml0eV0gLSBvcmRlcltiLnByaW9yaXR5XSkgKiAoc29ydEFzYyA/IDEgOiAtMSk7CiAgICB9KTsKICAgIHJldHVybiBmOwogIH0sIFtyZW1pbmRlcnMsIHNlYXJjaCwgZmlsdGVyQ2F0ZWdvcnksIGZpbHRlclN0YXR1cywgc29ydEZpZWxkLCBzb3J0QXNjXSk7CiAgY29uc3QgZ3JvdXBlZEJ5Q2F0ZWdvcnkgPSAoMCwgaW1wb3J0X3JlYWN0My51c2VNZW1vKSgoKSA9PiB7CiAgICBjb25zdCBncm91cHMgPSB7IHdvcms6IFtdLCBmYW1pbHk6IFtdLCBoZWFsdGg6IFtdLCBlcnJhbmRzOiBbXSwgZmluYW5jZTogW10sIHNvY2lhbDogW10sIGxlYXJuaW5nOiBbXSwgdHJhdmVsOiBbXSwgaG9tZTogW10sIG90aGVyOiBbXSB9OwogICAgZmlsdGVyZWQuZm9yRWFjaCgocikgPT4gZ3JvdXBzW3IuY2F0ZWdvcnldLnB1c2gocikpOwogICAgcmV0dXJuIGdyb3VwczsKICB9LCBbZmlsdGVyZWRdKTsKICBjb25zdCBvdmVyZHVlQ291bnQgPSByZW1pbmRlcnMuZmlsdGVyKGlzT3ZlcmR1ZSkubGVuZ3RoOwogIGNvbnN0IHRvZGF5Q291bnQgPSByZW1pbmRlcnMuZmlsdGVyKChyKSA9PiAhci5jb21wbGV0ZWQgJiYgci5kdWVEYXRlID09PSAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCkuc3BsaXQoIlQiKVswXSkubGVuZ3RoOwogIGNvbnN0IGxldmVsSW5mbyA9IGNhbGNMZXZlbChzdGF0cy50b3RhbFBvaW50cyk7CiAgY29uc3QgcHJvY2Vzc2VkVGFza3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0My51c2VSZWYpKG5ldyBTZXQoc3RhdHMuY29tcGxldGVkVGFza3MgfHwgW10pKTsKICAoMCwgaW1wb3J0X3JlYWN0My51c2VFZmZlY3QpKCgpID0+IHsKICAgIGNvbnN0IGN1cnJlbnRDb21wbGV0ZWQgPSBzdGF0cy5jb21wbGV0ZWRUYXNrcyB8fCBbXTsKICAgIGN1cnJlbnRDb21wbGV0ZWQuZm9yRWFjaCgoaWQpID0+IHByb2Nlc3NlZFRhc2tzUmVmLmN1cnJlbnQuYWRkKGlkKSk7CiAgICBjb25zb2xlLmxvZygiW1Byb2dyZXNzaW9uXSBDaGVja2luZyB0YXNrcy4gQ3VycmVudCBjb21wbGV0ZWQ6IiwgY3VycmVudENvbXBsZXRlZCk7CiAgICBjb25zb2xlLmxvZygiW1Byb2dyZXNzaW9uXSBSZW1pbmRlcnMgY291bnQ6IiwgcmVtaW5kZXJzLmxlbmd0aCk7CiAgICBjb25zb2xlLmxvZygiW1Byb2dyZXNzaW9uXSBTdGF0czoiLCB7IGNvbXBsZXRlZEFsbFRpbWU6IHN0YXRzLmNvbXBsZXRlZEFsbFRpbWUsIGN1cnJlbnRTdHJlYWs6IHN0YXRzLmN1cnJlbnRTdHJlYWsgfSk7CiAgICBsZXQgbmV4dFRhc2tJbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IFBST0dSRVNTSU9OX1RBU0tTLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICghcHJvY2Vzc2VkVGFza3NSZWYuY3VycmVudC5oYXMoUFJPR1JFU1NJT05fVEFTS1NbaV0uaWQpKSB7CiAgICAgICAgbmV4dFRhc2tJbmRleCA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IG5leHRUYXNrID0gUFJPR1JFU1NJT05fVEFTS1NbbmV4dFRhc2tJbmRleF07CiAgICBpZiAoIW5leHRUYXNrIHx8IHByb2Nlc3NlZFRhc2tzUmVmLmN1cnJlbnQuaGFzKG5leHRUYXNrLmlkKSkgewogICAgICBjb25zb2xlLmxvZygiW1Byb2dyZXNzaW9uXSBBbGwgdGFza3MgY29tcGxldGVkIG9yIG5vIG5leHQgdGFzayIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zb2xlLmxvZyhgW1Byb2dyZXNzaW9uXSBOZXh0IHRhc2sgdG8gY29tcGxldGU6ICIke25leHRUYXNrLmlkfSJgKTsKICAgIGNvbnN0IGlzQ29tcGxldGUgPSBuZXh0VGFzay5jaGVjayhyZW1pbmRlcnMsIHN0YXRzKTsKICAgIGNvbnNvbGUubG9nKGBbUHJvZ3Jlc3Npb25dIFRhc2sgIiR7bmV4dFRhc2suaWR9IjogY2hlY2s9JHtpc0NvbXBsZXRlfWApOwogICAgaWYgKGlzQ29tcGxldGUpIHsKICAgICAgcHJvY2Vzc2VkVGFza3NSZWYuY3VycmVudC5hZGQobmV4dFRhc2suaWQpOwogICAgICBjb25zb2xlLmxvZyhgW1Byb2dyZXNzaW9uXSBUYXNrICIke25leHRUYXNrLmlkfSIgQ09NUExFVEVEISArJHtuZXh0VGFzay5wb2ludHN9IHB0c2ApOwogICAgICBzZXRTdGF0cygocHJldikgPT4gKHsKICAgICAgICAuLi5wcmV2LAogICAgICAgIHRvdGFsUG9pbnRzOiBwcmV2LnRvdGFsUG9pbnRzICsgbmV4dFRhc2sucG9pbnRzLAogICAgICAgIGNvbXBsZXRlZFRhc2tzOiBbLi4uLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWy4uLnByZXYuY29tcGxldGVkVGFza3MgfHwgW10sIG5leHRUYXNrLmlkXSldCiAgICAgIH0pKTsKICAgICAgc2V0VG9hc3QoYFx1ezFGMzg5fSAiJHtuZXh0VGFzay5uYW1lfSIgY29tcGxldGUhICske25leHRUYXNrLnBvaW50c30gcHRzYCk7CiAgICB9CiAgfSwgW3JlbWluZGVycy5sZW5ndGgsIHN0YXRzLmNvbXBsZXRlZEFsbFRpbWUsIHN0YXRzLmN1cnJlbnRTdHJlYWssIHN0YXRzLmxvbmdlc3RTdHJlYWtdKTsKICBjb25zdCBnZXRDdXJyZW50UHJvZ3Jlc3Npb25UYXNrID0gKCkgPT4gewogICAgY29uc3QgY29tcGxldGVkVGFza3MgPSBzdGF0cy5jb21wbGV0ZWRUYXNrcyB8fCBbXTsKICAgIGZvciAoY29uc3QgdGFzayBvZiBQUk9HUkVTU0lPTl9UQVNLUykgewogICAgICBpZiAoIWNvbXBsZXRlZFRhc2tzLmluY2x1ZGVzKHRhc2suaWQpKSB7CiAgICAgICAgY29uc29sZS5sb2coYFtIaW50XSBOZXh0IHRhc2s6ICIke3Rhc2suaWR9ImApOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0ZXh0OiB0YXNrLmRlc2NyaXB0aW9uLAogICAgICAgICAgaWNvbjogdGFzay5pY29uLAogICAgICAgICAgcG9pbnRzOiB0YXNrLnBvaW50cywKICAgICAgICAgIG5hbWU6IHRhc2submFtZQogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHRleHQ6IGAke01hdGgucm91bmQobGV2ZWxJbmZvLnByb2dyZXNzKX0lIHRvIExldmVsICR7bGV2ZWxJbmZvLmxldmVsICsgMX1gLAogICAgICBpY29uOiAiXHV7MUY0NTF9IiwKICAgICAgcG9pbnRzOiAwLAogICAgICBuYW1lOiAiQWxsIFRhc2tzIENvbXBsZXRlISIKICAgIH07CiAgfTsKICBjb25zdCBoaW50ID0gZ2V0Q3VycmVudFByb2dyZXNzaW9uVGFzaygpOwogIGNvbnN0IGNvbXBsZXRlZFRhc2tDb3VudCA9IChzdGF0cy5jb21wbGV0ZWRUYXNrcyB8fCBbXSkubGVuZ3RoOwogIGNvbnN0IHRvdGFsVGFza0NvdW50ID0gUFJPR1JFU1NJT05fVEFTS1MubGVuZ3RoOwogIGNvbnNvbGUubG9nKCJbUmVuZGVyXSBjb21wbGV0ZWRUYXNrQ291bnQ6IiwgY29tcGxldGVkVGFza0NvdW50LCAiaGludDoiLCBoaW50Py5uYW1lKTsKICBjb25zdCBmb3JtYXRSZWN1cnJlbmNlID0gKHIpID0+IHsKICAgIGlmIChyLnJlY3VycmVuY2UgPT09ICJub25lIikgcmV0dXJuICIiOwogICAgaWYgKHIucmVjdXJyZW5jZSA9PT0gImRhaWx5IikgcmV0dXJuICJEYWlseSI7CiAgICBpZiAoci5yZWN1cnJlbmNlID09PSAid2Vla2x5IikgcmV0dXJuICJXZWVrbHkiOwogICAgaWYgKHIucmVjdXJyZW5jZSA9PT0gIm1vbnRobHkiKSByZXR1cm4gIk1vbnRobHkiOwogICAgaWYgKHIucmVjdXJyZW5jZSA9PT0gInllYXJseSIpIHJldHVybiAiWWVhcmx5IjsKICAgIGlmIChyLnJlY3VycmVuY2UgPT09ICJjdXN0b20iICYmIHIucmVjdXJyZW5jZUludGVydmFsICYmIHIucmVjdXJyZW5jZVVuaXQpIHsKICAgICAgcmV0dXJuIGBFdmVyeSAke3IucmVjdXJyZW5jZUludGVydmFsfSAke3IucmVjdXJyZW5jZVVuaXR9YDsKICAgIH0KICAgIHJldHVybiAiIjsKICB9OwogIGNvbnN0IGNyZWF0ZUZyb21QYXJzZWQgPSAoKSA9PiB7CiAgICBpZiAoIXBhcnNlZCB8fCAhcGFyc2VkLnRpdGxlLnRyaW0oKSkgewogICAgICBzZXRUb2FzdCgiVHlwZSBzb21ldGhpbmcgdG8gY3JlYXRlIGEgcmVtaW5kZXIiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbmV3UmVtaW5kZXIgPSB7CiAgICAgIGlkOiBnZW5lcmF0ZUlkKCksCiAgICAgIHRpdGxlOiBwYXJzZWQudGl0bGUsCiAgICAgIGR1ZURhdGU6IHBhcnNlZC5kdWVEYXRlLAogICAgICBkdWVUaW1lOiBwYXJzZWQuZHVlVGltZSwKICAgICAgcHJpb3JpdHk6IHBhcnNlZC5wcmlvcml0eSwKICAgICAgY2F0ZWdvcnk6IHBhcnNlZC5jYXRlZ29yeSwKICAgICAgcmVjdXJyZW5jZTogcGFyc2VkLnJlY3VycmVuY2UsCiAgICAgIHJlY3VycmVuY2VJbnRlcnZhbDogcGFyc2VkLnJlY3VycmVuY2VJbnRlcnZhbCwKICAgICAgcmVjdXJyZW5jZVVuaXQ6IHBhcnNlZC5yZWN1cnJlbmNlVW5pdCwKICAgICAgY29tcGxldGVkOiBmYWxzZSwKICAgICAgY3JlYXRlZEF0OiAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCksCiAgICAgIHBvaW50c0F3YXJkZWQ6IDAKICAgIH07CiAgICBzZXRSZW1pbmRlcnMoKHByZXYpID0+IFsuLi5wcmV2LCBuZXdSZW1pbmRlcl0pOwogICAgc2V0SW5wdXQoIiIpOwogICAgc2V0UGFyc2VkKG51bGwpOwogICAgY29uc3QgcmVjdXJyZW5jZVRleHQgPSBmb3JtYXRSZWN1cnJlbmNlKHBhcnNlZCk7CiAgICBjb25zdCBtc2cgPSByZWN1cnJlbmNlVGV4dCA/IGBDcmVhdGVkICR7cmVjdXJyZW5jZVRleHQudG9Mb3dlckNhc2UoKX0gcmVtaW5kZXIhYCA6IGBDcmVhdGVkISBBdXRvLWNhdGVnb3JpemVkIGFzICR7Q0FURUdPUllfQ09ORklHW3BhcnNlZC5jYXRlZ29yeV0ubGFiZWx9YDsKICAgIHNldFRvYXN0KG1zZyk7CiAgfTsKICBjb25zdCBoYW5kbGVLZXlEb3duID0gKGUpID0+IHsKICAgIGlmIChlLmtleSA9PT0gIkVudGVyIiAmJiBwYXJzZWQpIHsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBjcmVhdGVGcm9tUGFyc2VkKCk7CiAgICB9CiAgfTsKICBjb25zdCB1cGRhdGVSZW1pbmRlciA9ICh1cGRhdGVkKSA9PiB7CiAgICBzZXRSZW1pbmRlcnMoKHByZXYpID0+IHByZXYubWFwKChyKSA9PiByLmlkID09PSB1cGRhdGVkLmlkID8gdXBkYXRlZCA6IHIpKTsKICAgIHNldEVkaXRpbmcobnVsbCk7CiAgICBzZXRUb2FzdCgiVXBkYXRlZCEiKTsKICB9OwogIGNvbnN0IGNvbXBsZXRlID0gKHIpID0+IHsKICAgIGNvbnN0IGVhcmx5ID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKGAke3IuZHVlRGF0ZX1UJHtyLmR1ZVRpbWUgfHwgIjIzOjU5In1gKSA+IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogICAgbGV0IHB0cyA9IDEwICsgKGVhcmx5ID8gNSA6IDApICsgKHIucHJpb3JpdHkgPT09ICJ1cmdlbnQiID8gMTUgOiAwKSArIHN0YXRzLmN1cnJlbnRTdHJlYWsgKiAyOwogICAgY29uc3QgdXBkYXRlZCA9IHsgLi4uciwgY29tcGxldGVkOiB0cnVlLCBjb21wbGV0ZWRBdDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpLCBwb2ludHNBd2FyZGVkOiBwdHMgfTsKICAgIGlmIChyLnJlY3VycmVuY2UgIT09ICJub25lIikgewogICAgICBjb25zdCBuZXh0ID0gbmV3IERhdGUoci5kdWVEYXRlKTsKICAgICAgY29uc3QgaW50ZXJ2YWwgPSByLnJlY3VycmVuY2VJbnRlcnZhbCB8fCAxOwogICAgICBpZiAoci5yZWN1cnJlbmNlID09PSAiZGFpbHkiKSBuZXh0LnNldERhdGUobmV4dC5nZXREYXRlKCkgKyAxKTsKICAgICAgZWxzZSBpZiAoci5yZWN1cnJlbmNlID09PSAid2Vla2x5IikgbmV4dC5zZXREYXRlKG5leHQuZ2V0RGF0ZSgpICsgNyk7CiAgICAgIGVsc2UgaWYgKHIucmVjdXJyZW5jZSA9PT0gIm1vbnRobHkiKSBuZXh0LnNldE1vbnRoKG5leHQuZ2V0TW9udGgoKSArIDEpOwogICAgICBlbHNlIGlmIChyLnJlY3VycmVuY2UgPT09ICJ5ZWFybHkiKSBuZXh0LnNldEZ1bGxZZWFyKG5leHQuZ2V0RnVsbFllYXIoKSArIDEpOwogICAgICBlbHNlIGlmIChyLnJlY3VycmVuY2UgPT09ICJjdXN0b20iICYmIHIucmVjdXJyZW5jZVVuaXQpIHsKICAgICAgICBpZiAoci5yZWN1cnJlbmNlVW5pdCA9PT0gImRheXMiKSBuZXh0LnNldERhdGUobmV4dC5nZXREYXRlKCkgKyBpbnRlcnZhbCk7CiAgICAgICAgZWxzZSBpZiAoci5yZWN1cnJlbmNlVW5pdCA9PT0gIndlZWtzIikgbmV4dC5zZXREYXRlKG5leHQuZ2V0RGF0ZSgpICsgaW50ZXJ2YWwgKiA3KTsKICAgICAgICBlbHNlIGlmIChyLnJlY3VycmVuY2VVbml0ID09PSAibW9udGhzIikgbmV4dC5zZXRNb250aChuZXh0LmdldE1vbnRoKCkgKyBpbnRlcnZhbCk7CiAgICAgICAgZWxzZSBpZiAoci5yZWN1cnJlbmNlVW5pdCA9PT0gInllYXJzIikgbmV4dC5zZXRGdWxsWWVhcihuZXh0LmdldEZ1bGxZZWFyKCkgKyBpbnRlcnZhbCk7CiAgICAgIH0KICAgICAgY29uc3QgbmV4dERhdGVTdHIgPSBuZXh0LnRvSVNPU3RyaW5nKCkuc3BsaXQoIlQiKVswXTsKICAgICAgY29uc3Qgc2hvdWxkQ3JlYXRlTmV4dCA9ICFyLmVuZERhdGUgfHwgbmV4dERhdGVTdHIgPD0gci5lbmREYXRlOwogICAgICBpZiAoc2hvdWxkQ3JlYXRlTmV4dCkgewogICAgICAgIGNvbnN0IG5ld1IgPSB7IC4uLnIsIGlkOiBnZW5lcmF0ZUlkKCksIGR1ZURhdGU6IG5leHREYXRlU3RyLCBjb21wbGV0ZWQ6IGZhbHNlLCBjb21wbGV0ZWRBdDogdm9pZCAwLCBjcmVhdGVkQXQ6ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkudG9JU09TdHJpbmcoKSwgcG9pbnRzQXdhcmRlZDogMCB9OwogICAgICAgIHNldFJlbWluZGVycygocHJldikgPT4gWy4uLnByZXYubWFwKCh4KSA9PiB4LmlkID09PSByLmlkID8gdXBkYXRlZCA6IHgpLCBuZXdSXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0UmVtaW5kZXJzKChwcmV2KSA9PiBwcmV2Lm1hcCgoeCkgPT4geC5pZCA9PT0gci5pZCA/IHVwZGF0ZWQgOiB4KSk7CiAgICAgICAgc2V0VG9hc3QoIlJlY3VycmluZyBzZXJpZXMgY29tcGxldGUhIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHNldFJlbWluZGVycygocHJldikgPT4gcHJldi5tYXAoKHgpID0+IHguaWQgPT09IHIuaWQgPyB1cGRhdGVkIDogeCkpOwogICAgfQogICAgY29uc3QgbmV3U3RhdHMgPSB7IC4uLnN0YXRzLCB0b3RhbFBvaW50czogc3RhdHMudG90YWxQb2ludHMgKyBwdHMsIGNvbXBsZXRlZEFsbFRpbWU6IHN0YXRzLmNvbXBsZXRlZEFsbFRpbWUgKyAxLCBjdXJyZW50U3RyZWFrOiBzdGF0cy5jdXJyZW50U3RyZWFrICsgMSB9OwogICAgaWYgKG5ld1N0YXRzLmN1cnJlbnRTdHJlYWsgPiBuZXdTdGF0cy5sb25nZXN0U3RyZWFrKSBuZXdTdGF0cy5sb25nZXN0U3RyZWFrID0gbmV3U3RhdHMuY3VycmVudFN0cmVhazsKICAgIG5ld1N0YXRzLmxldmVsID0gY2FsY0xldmVsKG5ld1N0YXRzLnRvdGFsUG9pbnRzKS5sZXZlbDsKICAgIGlmICghbmV3U3RhdHMuYWNoaWV2ZW1lbnRzWzBdLnVubG9ja2VkICYmIG5ld1N0YXRzLmNvbXBsZXRlZEFsbFRpbWUgPj0gMSkgewogICAgICBuZXdTdGF0cy5hY2hpZXZlbWVudHNbMF0udW5sb2NrZWQgPSB0cnVlOwogICAgICBzZXRBY2hpZXZlbWVudChuZXdTdGF0cy5hY2hpZXZlbWVudHNbMF0pOwogICAgICBwdHMgKz0gNTA7CiAgICB9CiAgICBpZiAoIW5ld1N0YXRzLmFjaGlldmVtZW50c1sxXS51bmxvY2tlZCAmJiBuZXdTdGF0cy5jdXJyZW50U3RyZWFrID49IDMpIHsKICAgICAgbmV3U3RhdHMuYWNoaWV2ZW1lbnRzWzFdLnVubG9ja2VkID0gdHJ1ZTsKICAgICAgc2V0QWNoaWV2ZW1lbnQobmV3U3RhdHMuYWNoaWV2ZW1lbnRzWzFdKTsKICAgICAgcHRzICs9IDUwOwogICAgfQogICAgaWYgKCFuZXdTdGF0cy5hY2hpZXZlbWVudHNbMl0udW5sb2NrZWQgJiYgbmV3U3RhdHMuY3VycmVudFN0cmVhayA+PSA3KSB7CiAgICAgIG5ld1N0YXRzLmFjaGlldmVtZW50c1syXS51bmxvY2tlZCA9IHRydWU7CiAgICAgIHNldEFjaGlldmVtZW50KG5ld1N0YXRzLmFjaGlldmVtZW50c1syXSk7CiAgICAgIHB0cyArPSA1MDsKICAgIH0KICAgIGlmICghbmV3U3RhdHMuYWNoaWV2ZW1lbnRzWzNdLnVubG9ja2VkICYmIG5ld1N0YXRzLmNvbXBsZXRlZEFsbFRpbWUgPj0gMTApIHsKICAgICAgbmV3U3RhdHMuYWNoaWV2ZW1lbnRzWzNdLnVubG9ja2VkID0gdHJ1ZTsKICAgICAgc2V0QWNoaWV2ZW1lbnQobmV3U3RhdHMuYWNoaWV2ZW1lbnRzWzNdKTsKICAgICAgcHRzICs9IDUwOwogICAgfQogICAgaWYgKCFuZXdTdGF0cy5hY2hpZXZlbWVudHNbNF0udW5sb2NrZWQgJiYgbmV3U3RhdHMuY29tcGxldGVkQWxsVGltZSA+PSA1MCkgewogICAgICBuZXdTdGF0cy5hY2hpZXZlbWVudHNbNF0udW5sb2NrZWQgPSB0cnVlOwogICAgICBzZXRBY2hpZXZlbWVudChuZXdTdGF0cy5hY2hpZXZlbWVudHNbNF0pOwogICAgICBwdHMgKz0gNTA7CiAgICB9CiAgICBzZXRTdGF0cyhuZXdTdGF0cyk7CiAgICBzZXRUb2FzdChgKyR7cHRzfSBwb2ludHMhYCk7CiAgfTsKICBjb25zdCB1bmNvbXBsZXRlID0gKHIpID0+IHsKICAgIHNldFJlbWluZGVycygocHJldikgPT4gcHJldi5tYXAoKHgpID0+IHguaWQgPT09IHIuaWQgPyB7IC4uLnIsIGNvbXBsZXRlZDogZmFsc2UsIGNvbXBsZXRlZEF0OiB2b2lkIDAgfSA6IHgpKTsKICAgIHNldFN0YXRzKChzKSA9PiAoeyAuLi5zLCB0b3RhbFBvaW50czogTWF0aC5tYXgoMCwgcy50b3RhbFBvaW50cyAtIHIucG9pbnRzQXdhcmRlZCksIGNvbXBsZXRlZEFsbFRpbWU6IE1hdGgubWF4KDAsIHMuY29tcGxldGVkQWxsVGltZSAtIDEpIH0pKTsKICB9OwogIGNvbnN0IFtzbm9vemVQb3B1cCwgc2V0U25vb3plUG9wdXBdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IHNub296ZSA9IChyLCBtaW5zKSA9PiB7CiAgICBjb25zdCBub3cgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICAgIGNvbnN0IG5ld1RpbWUgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpICsgbWlucyAqIDYwICogMWUzKTsKICAgIHNldFJlbWluZGVycygocHJldikgPT4gcHJldi5tYXAoKHgpID0+IHguaWQgPT09IHIuaWQgPyB7CiAgICAgIC4uLnIsCiAgICAgIGR1ZURhdGU6IG5ld1RpbWUudG9JU09TdHJpbmcoKS5zcGxpdCgiVCIpWzBdLAogICAgICBkdWVUaW1lOiBgJHtuZXdUaW1lLmdldEhvdXJzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke25ld1RpbWUuZ2V0TWludXRlcygpLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1gCiAgICB9IDogeCkpOwogICAgbGV0IGR1cmF0aW9uVGV4dCA9IGAke21pbnN9IG1pbnV0ZXNgOwogICAgaWYgKG1pbnMgPj0gNjApIHsKICAgICAgY29uc3QgaG91cnMgPSBNYXRoLmZsb29yKG1pbnMgLyA2MCk7CiAgICAgIGR1cmF0aW9uVGV4dCA9IGhvdXJzID09PSAxID8gIjEgaG91ciIgOiBgJHtob3Vyc30gaG91cnNgOwogICAgfQogICAgaWYgKG1pbnMgPj0gMTQ0MCkgewogICAgICBjb25zdCBkYXlzID0gTWF0aC5mbG9vcihtaW5zIC8gMTQ0MCk7CiAgICAgIGR1cmF0aW9uVGV4dCA9IGRheXMgPT09IDEgPyAiMSBkYXkiIDogYCR7ZGF5c30gZGF5c2A7CiAgICB9CiAgICBzZXRUb2FzdChgXHV7MUY0QTR9IFNub296ZWQgZm9yICR7ZHVyYXRpb25UZXh0fWApOwogICAgc2V0U25vb3plUG9wdXAobnVsbCk7CiAgfTsKICBjb25zdCBkZWwgPSAoaWQpID0+IHsKICAgIHNldFJlbWluZGVycygocHJldikgPT4gcHJldi5maWx0ZXIoKHIpID0+IHIuaWQgIT09IGlkKSk7CiAgICBzZXRUb2FzdCgiRGVsZXRlZCIpOwogIH07CiAgY29uc3QgcmVzZXRQcm9ncmVzcyA9ICgpID0+IHsKICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFNUT1JBR0VfS0VZKTsKICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFNUQVRTX0tFWSk7CiAgICBwcm9jZXNzZWRUYXNrc1JlZi5jdXJyZW50LmNsZWFyKCk7CiAgICBzZXRSZW1pbmRlcnMoW10pOwogICAgc2V0U3RhdHMoewogICAgICB0b3RhbFBvaW50czogMCwKICAgICAgY3VycmVudFN0cmVhazogMCwKICAgICAgbG9uZ2VzdFN0cmVhazogMCwKICAgICAgY29tcGxldGVkQWxsVGltZTogMCwKICAgICAgbGV2ZWw6IDEsCiAgICAgIGFjaGlldmVtZW50czogWy4uLkRFRkFVTFRfQUNISUVWRU1FTlRTXSwKICAgICAgY29tcGxldGVkVGFza3M6IFtdCiAgICB9KTsKICAgIHNldFRvYXN0KCJQcm9ncmVzcyByZXNldCEgU3RhcnQgZnJlc2guIik7CiAgICBjb25zb2xlLmxvZygiW1Jlc2V0XSBBbGwgcHJvZ3Jlc3MgY2xlYXJlZCIpOwogIH07CiAgY29uc3QgQ2F0ZWdvcnlJY29uID0gKHsgY2F0LCBzaXplID0gMzIgfSkgPT4gewogICAgY29uc3QgY29uZmlnID0gQ0FURUdPUllfQ09ORklHW2NhdF07CiAgICBjb25zdCBJY29uMiA9IGNvbmZpZy5pY29uOwogICAgY29uc3QgaWNvblNpemUgPSBzaXplICogMC41OwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgd2lkdGg6IHNpemUsCiAgICAgIGhlaWdodDogc2l6ZSwKICAgICAgYm9yZGVyUmFkaXVzOiAiNTAlIiwKICAgICAgYmFja2dyb3VuZENvbG9yOiBjb25maWcuYmcsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgZmxleFNocmluazogMAogICAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoSWNvbjIsIHsgc2l6ZTogaWNvblNpemUsIGNvbG9yOiBjb25maWcuY29sb3IgfSkgfSk7CiAgfTsKICBjb25zdCBpbnB1dFN0eWxlID0geyBib3hTaXppbmc6ICJib3JkZXItYm94IiB9OwogIGNvbnN0IGNhcmRTaGFkb3cgPSAiMCAycHggOHB4IHJnYmEoMCwwLDAsMC4wNCkiOwogIGNvbnN0IGNhcmRSYWRpdXMgPSAyMDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udEZhbWlseTogJy1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgIlNlZ29lIFVJIiwgUm9ib3RvLCBzYW5zLXNlcmlmJywgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmcsIG1pbkhlaWdodDogIjEwMCUiLCBwYWRkaW5nOiAxNiwgZm9udFdlaWdodDogNDAwIH0sIGNoaWxkcmVuOiBbCiAgICB0b2FzdCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICB0b3A6IDE2LAogICAgICByaWdodDogMTYsCiAgICAgIHBhZGRpbmc6ICIxNHB4IDI0cHgiLAogICAgICBib3JkZXJSYWRpdXM6IDUwLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICBjb2xvcjogIiNmZmYiLAogICAgICBmb250V2VpZ2h0OiA1MDAsCiAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgekluZGV4OiAxZTMsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDIwcHggcmdiYSg0NSw5MCw2MSwwLjMpIgogICAgfSwgY2hpbGRyZW46IHRvYXN0IH0pLAogICAgYWNoaWV2ZW1lbnQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgIHRvcDogIjUwJSIsCiAgICAgIGxlZnQ6ICI1MCUiLAogICAgICB0cmFuc2Zvcm06ICJ0cmFuc2xhdGUoLTUwJSwtNTAlKSIsCiAgICAgIHBhZGRpbmc6IDMyLAogICAgICBib3JkZXJSYWRpdXM6IDI0LAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3hTaGFkb3c6ICIwIDE2cHggNDhweCByZ2JhKDAsMCwwLDAuMTUpIiwKICAgICAgekluZGV4OiAxMDAxLAogICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiCiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiA1NiB9LCBjaGlsZHJlbjogYWNoaWV2ZW1lbnQuaWNvbiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDMiLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgbWFyZ2luOiAiMTJweCAwIDRweCIsIGZvbnRTaXplOiAxOCwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiQWNoaWV2ZW1lbnQgVW5sb2NrZWQhIiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgZm9udFdlaWdodDogNTAwLCBtYXJnaW46IDAsIGZvbnRTaXplOiAxNiB9LCBjaGlsZHJlbjogYWNoaWV2ZW1lbnQubmFtZSB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgYm9yZGVyUmFkaXVzOiBjYXJkUmFkaXVzLAogICAgICBwYWRkaW5nOiAiMTZweCAyMHB4IiwKICAgICAgbWFyZ2luQm90dG9tOiAxMiwKICAgICAgY29sb3I6ICIjZmZmIiwKICAgICAgYm94U2hhZG93OiAiMCA0cHggMTZweCByZ2JhKDQ1LDkwLDYxLDAuMikiCiAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgd2lkdGg6IDM2LAogICAgICAgICAgaGVpZ2h0OiAzNiwKICAgICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMTUpIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiCiAgICAgICAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQmVsbCwgeyBzaXplOiAxOCB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTgsIGZvbnRXZWlnaHQ6IDYwMCwgbGV0dGVyU3BhY2luZzogIi0wLjNweCIgfSwgY2hpbGRyZW46ICJTbWFydCBSZW1pbmRlcnMiIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCwgZm9udFNpemU6IDEzIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjEyKSIsCiAgICAgICAgICBwYWRkaW5nOiAiNnB4IDE0cHgiLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MAogICAgICAgIH0sIHRpdGxlOiAiWW91ciBjdXJyZW50IGxldmVsIiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ3Jvd24sIHsgc2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMuZ29sZCB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIkxldmVsICIsCiAgICAgICAgICAgIGxldmVsSW5mby5sZXZlbAogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjEyKSIsCiAgICAgICAgICBwYWRkaW5nOiAiNnB4IDE0cHgiLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MAogICAgICAgIH0sIHRpdGxlOiAiVG90YWwgcG9pbnRzIGVhcm5lZCIsIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFN0YXIsIHsgc2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMuZ29sZCB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgc3RhdHMudG90YWxQb2ludHMsCiAgICAgICAgICAgICIgcHRzIgogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBzdGF0cy5jdXJyZW50U3RyZWFrID4gMCA/ICJyZ2JhKDIxMiwxNjUsMTE2LDAuMykiIDogInJnYmEoMjU1LDI1NSwyNTUsMC4xMikiLAogICAgICAgICAgcGFkZGluZzogIjZweCAxNHB4IiwKICAgICAgICAgIGJvcmRlclJhZGl1czogNTAKICAgICAgICB9LCB0aXRsZTogIkRheXMgaW4gYSByb3ciLCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShGbGFtZSwgeyBzaXplOiAxNCwgY29sb3I6IHN0YXRzLmN1cnJlbnRTdHJlYWsgPiAwID8gQ09MT1JTLmdvbGQgOiAicmdiYSgyNTUsMjU1LDI1NSwwLjUpIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgc3RhdHMuY3VycmVudFN0cmVhaywKICAgICAgICAgICAgIiBkYXkgc3RyZWFrIgogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KQogICAgXSB9KSB9KSwKICAgIGhpbnQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiBjYXJkUmFkaXVzLAogICAgICBwYWRkaW5nOiAiMTZweCAyMHB4IiwKICAgICAgbWFyZ2luQm90dG9tOiAxMiwKICAgICAgYm94U2hhZG93OiBjYXJkU2hhZG93CiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDE0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgd2lkdGg6IDQ4LAogICAgICAgICAgaGVpZ2h0OiA0OCwKICAgICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pY29uQmcsCiAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgIGZvbnRTaXplOiAyNAogICAgICAgIH0sIGNoaWxkcmVuOiBoaW50Lmljb24gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpbkJvdHRvbTogMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICBoaW50Lm5hbWUsCiAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgaGludC5wb2ludHMgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA0MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgIlx1MjAyMiArIiwKICAgICAgICAgICAgICBoaW50LnBvaW50cywKICAgICAgICAgICAgICAiIHB0cyIKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBoaW50LnRleHQgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICBmb250U2l6ZTogMTIsCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmRBbHQsCiAgICAgICAgICBwYWRkaW5nOiAiNHB4IDEwcHgiLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MAogICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBjb21wbGV0ZWRUYXNrQ291bnQsCiAgICAgICAgICAiLyIsCiAgICAgICAgICB0b3RhbFRhc2tDb3VudAogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxNCwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgaGVpZ2h0OiA2LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5QmcsIGJvcmRlclJhZGl1czogNTAsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgaGVpZ2h0OiAiMTAwJSIsCiAgICAgICAgICB3aWR0aDogYCR7Y29tcGxldGVkVGFza0NvdW50IC8gdG90YWxUYXNrQ291bnQgKiAxMDB9JWAsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MCwKICAgICAgICAgIHRyYW5zaXRpb246ICJ3aWR0aCAwLjNzIGVhc2UiCiAgICAgICAgfSB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6IHJlc2V0UHJvZ3Jlc3MsCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLAogICAgICAgICAgICAgIGJhY2tncm91bmQ6ICJub25lIiwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBwYWRkaW5nOiAiNHB4IDhweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MCwKICAgICAgICAgICAgICBvcGFjaXR5OiAwLjYKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGl0bGU6ICJSZXNldCBhbGwgcHJvZ3Jlc3MiLAogICAgICAgICAgICBjaGlsZHJlbjogIlJlc2V0IgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIGNvbXBsZXRlZFRhc2tDb3VudCA9PT0gdG90YWxUYXNrQ291bnQgJiYgdG90YWxUYXNrQ291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgIGJvcmRlclJhZGl1czogY2FyZFJhZGl1cywKICAgICAgcGFkZGluZzogIjE2cHggMjBweCIsCiAgICAgIG1hcmdpbkJvdHRvbTogMTIsCiAgICAgIHRleHRBbGlnbjogImNlbnRlciIsCiAgICAgIGJveFNoYWRvdzogY2FyZFNoYWRvdwogICAgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI0IH0sIGNoaWxkcmVuOiAiXHV7MUYzQzZ9IiB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgbWFyZ2luTGVmdDogMTAsIGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNTAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiQWxsIHRhc2tzIGNvbXBsZXRlISBZb3UncmUgYSByZW1pbmRlciBtYXN0ZXIhIiB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgIGJvcmRlclJhZGl1czogY2FyZFJhZGl1cywKICAgICAgcGFkZGluZzogMjAsCiAgICAgIG1hcmdpbkJvdHRvbTogMTIsCiAgICAgIGJveFNoYWRvdzogY2FyZFNoYWRvdwogICAgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiwgbWFyZ2luQm90dG9tOiAxNCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgIHdpZHRoOiA0MCwKICAgICAgICAgIGhlaWdodDogNDAsCiAgICAgICAgICBib3JkZXJSYWRpdXM6ICI1MCUiLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaWNvbkJnLAogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIKICAgICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQbHVzLCB7IHNpemU6IDIwLCBjb2xvcjogQ09MT1JTLnByaW1hcnkgfSkgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJDcmVhdGUgTmV3IFRhc2siIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAiVHlwZSBuYXR1cmFsbHkgdG8gYWRkIGEgcmVtaW5kZXIiIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgewogICAgICAgICAgICByZWY6IGlucHV0UmVmLAogICAgICAgICAgICB0eXBlOiAidGV4dCIsCiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiVHJ5OiAnQ2FsbCBtb20gdG9tb3Jyb3cgM3BtJyBvciAnUGF5IHJlbnQgRnJpZGF5IHVyZ2VudCciLAogICAgICAgICAgICB2YWx1ZTogaW5wdXQsCiAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0SW5wdXQoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICBvbktleURvd246IGhhbmRsZUtleURvd24sCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgLi4uaW5wdXRTdHlsZSwKICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgIHBhZGRpbmc6ICIxNHB4IDU0cHggMTRweCAxOHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDUwLAogICAgICAgICAgICAgIGJvcmRlcjogYDJweCBzb2xpZCAke3BhcnNlZCA/IENPTE9SUy5wcmltYXJ5TGlnaHQgOiBDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgICAgICAgICBmb250U2l6ZTogMTUsCiAgICAgICAgICAgICAgb3V0bGluZTogIm5vbmUiLAogICAgICAgICAgICAgIHRyYW5zaXRpb246ICJib3JkZXItY29sb3IgMC4ycyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgcGFyc2VkICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogY3JlYXRlRnJvbVBhcnNlZCwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICByaWdodDogNiwKICAgICAgICAgICAgICB0b3A6ICI1MCUiLAogICAgICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zbGF0ZVkoLTUwJSkiLAogICAgICAgICAgICAgIHdpZHRoOiA0MCwKICAgICAgICAgICAgICBoZWlnaHQ6IDQwLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICBjb2xvcjogIiNmZmYiLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgYm94U2hhZG93OiAiMCAycHggOHB4IHJnYmEoNDUsOTAsNjEsMC4zKSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hldnJvblJpZ2h0LCB7IHNpemU6IDIwIH0pCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pLAogICAgICBwYXJzZWQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxNiwgcGFkZGluZzogMTYsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmRBbHQsIGJvcmRlclJhZGl1czogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogcGFyc2VkLnRpdGxlIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIHBhZGRpbmc6ICI0cHggMTBweCIsIGJvcmRlclJhZGl1czogNTAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgcGFyc2VkLmNvbmZpZGVuY2UsCiAgICAgICAgICAgICIlIG1hdGNoIgogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4V3JhcDogIndyYXAiLCBnYXA6IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYsIHBhZGRpbmc6ICI2cHggMTJweCIsIGJvcmRlclJhZGl1czogNTAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2FsZW5kYXIsIHsgc2l6ZTogMTQgfSksCiAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgZm9ybWF0RGF0ZShwYXJzZWQuZHVlRGF0ZSksCiAgICAgICAgICAgIHBhcnNlZC5kdWVUaW1lICYmIGAgJHtmb3JtYXRUaW1lKHBhcnNlZC5kdWVUaW1lKX1gCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiwgcGFkZGluZzogIjZweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA1MCwgZm9udFNpemU6IDEzLCBiYWNrZ3JvdW5kQ29sb3I6IENBVEVHT1JZX0NPTkZJR1twYXJzZWQuY2F0ZWdvcnldLmJnLCBjb2xvcjogQ0FURUdPUllfQ09ORklHW3BhcnNlZC5jYXRlZ29yeV0uY29sb3IgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDYXRlZ29yeUljb24sIHsgY2F0OiBwYXJzZWQuY2F0ZWdvcnksIHNpemU6IDIwIH0pLAogICAgICAgICAgICAiICIsCiAgICAgICAgICAgIENBVEVHT1JZX0NPTkZJR1twYXJzZWQuY2F0ZWdvcnldLmxhYmVsCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA1MCwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA1MDAsIGJhY2tncm91bmRDb2xvcjogYCR7UFJJT1JJVFlfQ09MT1JTW3BhcnNlZC5wcmlvcml0eV19MjBgLCBjb2xvcjogUFJJT1JJVFlfQ09MT1JTW3BhcnNlZC5wcmlvcml0eV0sIHRleHRUcmFuc2Zvcm06ICJjYXBpdGFsaXplIiB9LCBjaGlsZHJlbjogcGFyc2VkLnByaW9yaXR5IH0pLAogICAgICAgICAgcGFyc2VkLnJlY3VycmVuY2UgIT09ICJub25lIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0LCBwYWRkaW5nOiAiNnB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDUwLCBmb250U2l6ZTogMTMsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmljb25CZywgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShSZXBlYXQsIHsgc2l6ZTogMTMgfSksCiAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgZm9ybWF0UmVjdXJyZW5jZShwYXJzZWQpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiBjYXJkUmFkaXVzLAogICAgICBwYWRkaW5nOiAiMTRweCAyMHB4IiwKICAgICAgbWFyZ2luQm90dG9tOiAxMiwKICAgICAgYm94U2hhZG93OiBjYXJkU2hhZG93LAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGdhcDogMTIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBmbGV4V3JhcDogIndyYXAiCiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIG92ZXJkdWVDb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICI2cHggMTRweCIsIGJvcmRlclJhZGl1czogNTAsIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNTAwLCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5kYW5nZXJ9MTVgLCBjb2xvcjogQ09MT1JTLmRhbmdlciB9LCBjaGlsZHJlbjogWwogICAgICAgICAgb3ZlcmR1ZUNvdW50LAogICAgICAgICAgIiBvdmVyZHVlIgogICAgICAgIF0gfSksCiAgICAgICAgdG9kYXlDb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICI2cHggMTRweCIsIGJvcmRlclJhZGl1czogNTAsIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNTAwLCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5nb2xkfTIwYCwgY29sb3I6IENPTE9SUy5nb2xkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICB0b2RheUNvdW50LAogICAgICAgICAgIiB0b2RheSIKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBwYWRkaW5nOiAiNnB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDUwLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDUwMCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaWNvbkJnLCBjb2xvcjogQ09MT1JTLnByaW1hcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIHJlbWluZGVycy5maWx0ZXIoKHIpID0+ICFyLmNvbXBsZXRlZCkubGVuZ3RoLAogICAgICAgICAgIiBwZW5kaW5nIgogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luTGVmdDogImF1dG8iLCBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShTZWFyY2gsIHsgc2l6ZTogMTYsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogMTIsIHRvcDogIjUwJSIsIHRyYW5zZm9ybTogInRyYW5zbGF0ZVkoLTUwJSkiIH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgdHlwZTogInRleHQiLCBwbGFjZWhvbGRlcjogIlNlYXJjaCIsIHZhbHVlOiBzZWFyY2gsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0U2VhcmNoKGUudGFyZ2V0LnZhbHVlKSwgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZSwgd2lkdGg6IDEzMCwgcGFkZGluZzogIjEwcHggMTRweCAxMHB4IDM2cHgiLCBib3JkZXJSYWRpdXM6IDUwLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgZm9udFNpemU6IDE0LCBvdXRsaW5lOiAibm9uZSIgfSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNlbGVjdCIsIHsgdmFsdWU6IGZpbHRlckNhdGVnb3J5LCBvbkNoYW5nZTogKGUpID0+IHNldEZpbHRlckNhdGVnb3J5KGUudGFyZ2V0LnZhbHVlKSwgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZSwgcGFkZGluZzogIjEwcHggMTZweCIsIGJvcmRlclJhZGl1czogNTAsIGJvcmRlcjogIm5vbmUiLCBmb250U2l6ZTogMTQsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsIGN1cnNvcjogInBvaW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAiYWxsIiwgY2hpbGRyZW46ICJBbGwiIH0pLAogICAgICAgICAgT2JqZWN0LmVudHJpZXMoQ0FURUdPUllfQ09ORklHKS5tYXAoKFtrLCB2XSkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogaywgY2hpbGRyZW46IHYubGFiZWwgfSwgaykpCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic2VsZWN0IiwgeyB2YWx1ZTogZmlsdGVyU3RhdHVzLCBvbkNoYW5nZTogKGUpID0+IHNldEZpbHRlclN0YXR1cyhlLnRhcmdldC52YWx1ZSksIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUsIHBhZGRpbmc6ICIxMHB4IDE2cHgiLCBib3JkZXJSYWRpdXM6IDUwLCBib3JkZXI6ICJub25lIiwgZm9udFNpemU6IDE0LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBjdXJzb3I6ICJwb2ludGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogImFsbCIsIGNoaWxkcmVuOiAiQWxsIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJwZW5kaW5nIiwgY2hpbGRyZW46ICJQZW5kaW5nIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJjb21wbGV0ZWQiLCBjaGlsZHJlbjogIkRvbmUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogIm92ZXJkdWUiLCBjaGlsZHJlbjogIk92ZXJkdWUiIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBib3JkZXJSYWRpdXM6IGNhcmRSYWRpdXMsIGJveFNoYWRvdzogY2FyZFNoYWRvdywgb3ZlcmZsb3c6ICJoaWRkZW4iIH0sIGNoaWxkcmVuOiBmaWx0ZXJlZC5sZW5ndGggPT09IDAgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJjZW50ZXIiLCBwYWRkaW5nOiA0OCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgIHdpZHRoOiA2NCwKICAgICAgICBoZWlnaHQ6IDY0LAogICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaWNvbkJnLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgbWFyZ2luOiAiMCBhdXRvIDE2cHgiCiAgICAgIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEJlbGwsIHsgc2l6ZTogMjgsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJwIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIG1hcmdpbjogMCwgZm9udFdlaWdodDogNTAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiTm8gcmVtaW5kZXJzIHlldCIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgbWFyZ2luVG9wOiA2LCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIlR5cGUgYWJvdmUgdG8gY3JlYXRlIHlvdXIgZmlyc3Qgb25lISIgfSkKICAgIF0gfSkgOiBmaWx0ZXJlZC5tYXAoKHIsIGkpID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcGFkZGluZzogIjE2cHggMjBweCIsCiAgICAgIGJvcmRlckJvdHRvbTogaSA8IGZpbHRlcmVkLmxlbmd0aCAtIDEgPyBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gIDogIm5vbmUiLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IHIuY29tcGxldGVkID8gQ09MT1JTLmNhcmRBbHQgOiBDT0xPUlMuY2FyZCwKICAgICAgb3BhY2l0eTogci5jb21wbGV0ZWQgPyAwLjcgOiAxCiAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxNCB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICJidXR0b24iLAogICAgICAgIHsKICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHIuY29tcGxldGVkID8gdW5jb21wbGV0ZShyKSA6IGNvbXBsZXRlKHIpLAogICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgd2lkdGg6IDI4LAogICAgICAgICAgICBoZWlnaHQ6IDI4LAogICAgICAgICAgICBib3JkZXJSYWRpdXM6ICI1MCUiLAogICAgICAgICAgICBib3JkZXI6IGAycHggc29saWQgJHtyLmNvbXBsZXRlZCA/IENPTE9SUy5zdWNjZXNzIDogQ09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHIuY29tcGxldGVkID8gQ09MT1JTLnN1Y2Nlc3MgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICBmbGV4U2hyaW5rOiAwCiAgICAgICAgICB9LAogICAgICAgICAgY2hpbGRyZW46IHIuY29tcGxldGVkICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hlY2ssIHsgc2l6ZTogMTQsIGNvbG9yOiAiI2ZmZiIgfSkKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2F0ZWdvcnlJY29uLCB7IGNhdDogci5jYXRlZ29yeSwgc2l6ZTogNDAgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIG1pbldpZHRoOiAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4LCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDUwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgdGV4dERlY29yYXRpb246IHIuY29tcGxldGVkID8gImxpbmUtdGhyb3VnaCIgOiAibm9uZSIgfSwgY2hpbGRyZW46IHIudGl0bGUgfSksCiAgICAgICAgICBpc092ZXJkdWUocikgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjNweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA1MCwgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA1MDAsIGJhY2tncm91bmRDb2xvcjogYCR7Q09MT1JTLmRhbmdlcn0xNWAsIGNvbG9yOiBDT0xPUlMuZGFuZ2VyIH0sIGNoaWxkcmVuOiAiT3ZlcmR1ZSIgfSksCiAgICAgICAgICByLnJlY3VycmVuY2UgIT09ICJub25lIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImlubGluZS1mbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgcGFkZGluZzogIjNweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA1MCwgZm9udFNpemU6IDExLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pY29uQmcsIGNvbG9yOiBDT0xPUlMucHJpbWFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlcGVhdCwgeyBzaXplOiAxMSB9KSwKICAgICAgICAgICAgIiAiLAogICAgICAgICAgICBmb3JtYXRSZWN1cnJlbmNlKHIpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBpc092ZXJkdWUocikgPyBDT0xPUlMuZGFuZ2VyIDogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luVG9wOiA0LCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2xvY2ssIHsgc2l6ZTogMTMgfSksCiAgICAgICAgICAiICIsCiAgICAgICAgICBmb3JtYXREYXRlKHIuZHVlRGF0ZSksCiAgICAgICAgICByLmR1ZVRpbWUgJiYgYCBhdCAke2Zvcm1hdFRpbWUoci5kdWVUaW1lKX1gLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjNweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA1MCwgZm9udFNpemU6IDExLCBiYWNrZ3JvdW5kQ29sb3I6IGAke1BSSU9SSVRZX0NPTE9SU1tyLnByaW9yaXR5XX0xNWAsIGNvbG9yOiBQUklPUklUWV9DT0xPUlNbci5wcmlvcml0eV0sIHRleHRUcmFuc2Zvcm06ICJjYXBpdGFsaXplIiB9LCBjaGlsZHJlbjogci5wcmlvcml0eSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAhci5jb21wbGV0ZWQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTbm9vemVQb3B1cChyKSwKICAgICAgICAgICAgdGl0bGU6ICJTbm9vemUiLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHdpZHRoOiAzNiwKICAgICAgICAgICAgICBoZWlnaHQ6IDM2LAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYgfSwgY2hpbGRyZW46ICJcdXsxRjRBNH0iIH0pCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAhci5jb21wbGV0ZWQgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRFZGl0aW5nKHIpLAogICAgICAgICAgICB0aXRsZTogIkVkaXQiLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHdpZHRoOiAzNiwKICAgICAgICAgICAgICBoZWlnaHQ6IDM2LAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFBlbiwgeyBzaXplOiAxNiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSkKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gZGVsKHIuaWQpLAogICAgICAgICAgICB0aXRsZTogIkRlbGV0ZSIsCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgd2lkdGg6IDM2LAogICAgICAgICAgICAgIGhlaWdodDogMzYsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAiNTAlIiwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5kYW5nZXJ9MTBgLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJhc2gyLCB7IHNpemU6IDE2LCBjb2xvcjogQ09MT1JTLmRhbmdlciB9KQogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KQogICAgXSB9KSB9LCByLmlkKSkgfSksCiAgICBzbm9vemVQb3B1cCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHBvc2l0aW9uOiAiZml4ZWQiLCB0b3A6IDAsIGxlZnQ6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiA5OTksIHBhZGRpbmc6IDE2IH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBib3JkZXJSYWRpdXM6IDI0LCB3aWR0aDogIjEwMCUiLCBtYXhXaWR0aDogMzIwLCBwYWRkaW5nOiAyOCwgdGV4dEFsaWduOiAiY2VudGVyIiwgYm94U2hhZG93OiAiMCAxNnB4IDQ4cHggcmdiYSgwLDAsMCwwLjE1KSIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgIHdpZHRoOiA2NCwKICAgICAgICBoZWlnaHQ6IDY0LAogICAgICAgIGJvcmRlclJhZGl1czogIjUwJSIsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaWNvbkJnLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgbWFyZ2luOiAiMCBhdXRvIDE2cHgiLAogICAgICAgIGZvbnRTaXplOiAzMgogICAgICB9LCBjaGlsZHJlbjogIlx1ezFGNEE0fSIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgzIiwgeyBzdHlsZTogeyBtYXJnaW46ICIwIDAgOHB4IiwgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJTbm9vemUgUmVtaW5kZXIiIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiMCAwIDI0cHgiLCBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbGluZUhlaWdodDogMS40IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgJyInLAogICAgICAgIHNub296ZVBvcHVwLnRpdGxlLAogICAgICAgICciJwogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLCBnYXA6IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gc25vb3plKHNub296ZVBvcHVwLCAxNSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjE0cHggMjBweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MCwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pY29uQmcsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgIGZvbnRTaXplOiAxNSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA1MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICBnYXA6IDEwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDbG9jaywgeyBzaXplOiAxOCB9KSwKICAgICAgICAgICAgICAiIDE1IG1pbnV0ZXMiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNub296ZShzbm9vemVQb3B1cCwgNjApLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6ICIxNHB4IDIwcHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNTAsCiAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaWNvbkJnLAogICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICBmb250U2l6ZTogMTUsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgZ2FwOiAxMAogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2xvY2ssIHsgc2l6ZTogMTggfSksCiAgICAgICAgICAgICAgIiAxIGhvdXIiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNub296ZShzbm9vemVQb3B1cCwgMTQ0MCksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjE0cHggMjBweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA1MCwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pY29uQmcsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgIGZvbnRTaXplOiAxNSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA1MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICBnYXA6IDEwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDYWxlbmRhciwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgICAgICAiIDEgZGF5IgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICJidXR0b24iLAogICAgICAgIHsKICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFNub296ZVBvcHVwKG51bGwpLAogICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgbWFyZ2luVG9wOiAyMCwKICAgICAgICAgICAgcGFkZGluZzogIjEycHggMjhweCIsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogNTAsCiAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICAgICAgICBmb250U2l6ZTogMTQsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDUwMCwKICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkCiAgICAgICAgICB9LAogICAgICAgICAgY2hpbGRyZW46ICJDYW5jZWwiCiAgICAgICAgfQogICAgICApCiAgICBdIH0pIH0pLAogICAgZWRpdGluZyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHBvc2l0aW9uOiAiZml4ZWQiLCB0b3A6IDAsIGxlZnQ6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiA5OTksIHBhZGRpbmc6IDE2LCBvdmVyZmxvd1k6ICJhdXRvIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAyNCwgd2lkdGg6ICIxMDAlIiwgbWF4V2lkdGg6IDQyMCwgcGFkZGluZzogMjQsIG1heEhlaWdodDogIjkwdmgiLCBvdmVyZmxvd1k6ICJhdXRvIiwgYm94U2hhZG93OiAiMCAxNnB4IDQ4cHggcmdiYSgwLDAsMCwwLjE1KSIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgbWFyZ2luQm90dG9tOiAyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgyIiwgeyBzdHlsZTogeyBtYXJnaW46IDAsIGZvbnRTaXplOiAxOCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiRWRpdCBSZW1pbmRlciIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRFZGl0aW5nKG51bGwpLCBzdHlsZTogeyB3aWR0aDogMzYsIGhlaWdodDogMzYsIGJvcmRlclJhZGl1czogIjUwJSIsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFgsIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0pIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA1MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiYmxvY2siLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJUaXRsZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IHR5cGU6ICJ0ZXh0IiwgdmFsdWU6IGVkaXRpbmcudGl0bGUsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RWRpdGluZyh7IC4uLmVkaXRpbmcsIHRpdGxlOiBlLnRhcmdldC52YWx1ZSB9KSwgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZSwgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogMTQsIGJvcmRlclJhZGl1czogMTQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBmb250U2l6ZTogMTUgfSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiAxMiwgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA1MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiYmxvY2siLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJDYXRlZ29yeSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzZWxlY3QiLCB7IHZhbHVlOiBlZGl0aW5nLmNhdGVnb3J5LCBvbkNoYW5nZTogKGUpID0+IHNldEVkaXRpbmcoeyAuLi5lZGl0aW5nLCBjYXRlZ29yeTogZS50YXJnZXQudmFsdWUgfSksIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUsIHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6IDE0LCBib3JkZXJSYWRpdXM6IDE0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgZm9udFNpemU6IDE0IH0sIGNoaWxkcmVuOiBPYmplY3QuZW50cmllcyhDQVRFR09SWV9DT05GSUcpLm1hcCgoW2ssIHZdKSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiBrLCBjaGlsZHJlbjogdi5sYWJlbCB9LCBrKSkgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA1MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiYmxvY2siLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJQcmlvcml0eSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic2VsZWN0IiwgeyB2YWx1ZTogZWRpdGluZy5wcmlvcml0eSwgb25DaGFuZ2U6IChlKSA9PiBzZXRFZGl0aW5nKHsgLi4uZWRpdGluZywgcHJpb3JpdHk6IGUudGFyZ2V0LnZhbHVlIH0pLCBzdHlsZTogeyAuLi5pbnB1dFN0eWxlLCB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAxNCwgYm9yZGVyUmFkaXVzOiAxNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsIGZvbnRTaXplOiAxNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAibG93IiwgY2hpbGRyZW46ICJMb3ciIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAibWVkaXVtIiwgY2hpbGRyZW46ICJNZWRpdW0iIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAiaGlnaCIsIGNoaWxkcmVuOiAiSGlnaCIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJ1cmdlbnQiLCBjaGlsZHJlbjogIlVyZ2VudCIgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMTYsIHBhZGRpbmc6IDE2LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkQWx0LCBib3JkZXJSYWRpdXM6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDUwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4LCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAyOCwgaGVpZ2h0OiAyOCwgYm9yZGVyUmFkaXVzOiAiNTAlIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaWNvbkJnLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUmVwZWF0LCB7IHNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnByaW1hcnkgfSkgfSksCiAgICAgICAgICAiUmVwZWF0IFNldHRpbmdzIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBkaXNwbGF5OiAiYmxvY2siLCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46ICJGcmVxdWVuY3kiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICJzZWxlY3QiLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IGVkaXRpbmcucmVjdXJyZW5jZSA9PT0gImN1c3RvbSIgPyAiY3VzdG9tIiA6IGVkaXRpbmcucmVjdXJyZW5jZSwKICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGUudGFyZ2V0LnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gImN1c3RvbSIpIHsKICAgICAgICAgICAgICAgICAgc2V0RWRpdGluZyh7IC4uLmVkaXRpbmcsIHJlY3VycmVuY2U6ICJjdXN0b20iLCByZWN1cnJlbmNlSW50ZXJ2YWw6IGVkaXRpbmcucmVjdXJyZW5jZUludGVydmFsIHx8IDIsIHJlY3VycmVuY2VVbml0OiBlZGl0aW5nLnJlY3VycmVuY2VVbml0IHx8ICJkYXlzIiB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHNldEVkaXRpbmcoeyAuLi5lZGl0aW5nLCByZWN1cnJlbmNlOiB2YWwsIHJlY3VycmVuY2VJbnRlcnZhbDogdm9pZCAwLCByZWN1cnJlbmNlVW5pdDogdm9pZCAwIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZSwgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogMTIsIGJvcmRlclJhZGl1czogMTIsIGJvcmRlcjogIm5vbmUiLCBmb250U2l6ZTogMTQsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQgfSwKICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogIm5vbmUiLCBjaGlsZHJlbjogIk9uZS10aW1lIChubyByZXBlYXQpIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJkYWlseSIsIGNoaWxkcmVuOiAiRGFpbHkiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogIndlZWtseSIsIGNoaWxkcmVuOiAiV2Vla2x5IiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJtb250aGx5IiwgY2hpbGRyZW46ICJNb250aGx5IiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJ5ZWFybHkiLCBjaGlsZHJlbjogIlllYXJseSIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAiY3VzdG9tIiwgY2hpbGRyZW46ICJDdXN0b20gaW50ZXJ2YWwuLi4iIH0pCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICBlZGl0aW5nLnJlY3VycmVuY2UgPT09ICJjdXN0b20iICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDEwLCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgZGlzcGxheTogImJsb2NrIiwgbWFyZ2luQm90dG9tOiA2IH0sIGNoaWxkcmVuOiAiRXZlcnkiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHlwZTogIm51bWJlciIsCiAgICAgICAgICAgICAgICBtaW46ICIxIiwKICAgICAgICAgICAgICAgIG1heDogIjM2NSIsCiAgICAgICAgICAgICAgICB2YWx1ZTogZWRpdGluZy5yZWN1cnJlbmNlSW50ZXJ2YWwgfHwgMiwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RWRpdGluZyh7IC4uLmVkaXRpbmcsIHJlY3VycmVuY2VJbnRlcnZhbDogcGFyc2VJbnQoZS50YXJnZXQudmFsdWUpIHx8IDEgfSksCiAgICAgICAgICAgICAgICBzdHlsZTogeyAuLi5pbnB1dFN0eWxlLCB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiAibm9uZSIsIGZvbnRTaXplOiAxNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJibG9jayIsIG1hcmdpbkJvdHRvbTogNiB9LCBjaGlsZHJlbjogIlVuaXQiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAic2VsZWN0IiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWx1ZTogZWRpdGluZy5yZWN1cnJlbmNlVW5pdCB8fCAiZGF5cyIsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEVkaXRpbmcoeyAuLi5lZGl0aW5nLCByZWN1cnJlbmNlVW5pdDogZS50YXJnZXQudmFsdWUgfSksCiAgICAgICAgICAgICAgICBzdHlsZTogeyAuLi5pbnB1dFN0eWxlLCB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiAibm9uZSIsIGZvbnRTaXplOiAxNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCB9LAogICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogImRheXMiLCBjaGlsZHJlbjogIkRheXMiIH0pLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAid2Vla3MiLCBjaGlsZHJlbjogIldlZWtzIiB9KSwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogIm1vbnRocyIsIGNoaWxkcmVuOiAiTW9udGhzIiB9KSwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogInllYXJzIiwgY2hpbGRyZW46ICJZZWFycyIgfSkKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pLAogICAgICAgIGVkaXRpbmcucmVjdXJyZW5jZSAhPT0gIm5vbmUiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgZGlzcGxheTogImJsb2NrIiwgbWFyZ2luQm90dG9tOiA2IH0sIGNoaWxkcmVuOiAiU3RhcnQgRGF0ZSIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyB0eXBlOiAiZGF0ZSIsIHZhbHVlOiBlZGl0aW5nLmR1ZURhdGUsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RWRpdGluZyh7IC4uLmVkaXRpbmcsIGR1ZURhdGU6IGUudGFyZ2V0LnZhbHVlIH0pLCBzdHlsZTogeyAuLi5pbnB1dFN0eWxlLCB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiAxMiwgYm9yZGVyOiAibm9uZSIsIGZvbnRTaXplOiAxNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCB9IH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJibG9jayIsIG1hcmdpbkJvdHRvbTogNiB9LCBjaGlsZHJlbjogIkVuZCBEYXRlIChvcHRpb25hbCkiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJpbnB1dCIsIHsgdHlwZTogImRhdGUiLCB2YWx1ZTogZWRpdGluZy5lbmREYXRlIHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldEVkaXRpbmcoeyAuLi5lZGl0aW5nLCBlbmREYXRlOiBlLnRhcmdldC52YWx1ZSB8fCB2b2lkIDAgfSksIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUsIHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6IDEyLCBib3JkZXJSYWRpdXM6IDEyLCBib3JkZXI6ICJub25lIiwgZm9udFNpemU6IDE0LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkIH0gfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIGVkaXRpbmcucmVjdXJyZW5jZSA9PT0gIm5vbmUiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDEyLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDUwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJibG9jayIsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkRhdGUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IHR5cGU6ICJkYXRlIiwgdmFsdWU6IGVkaXRpbmcuZHVlRGF0ZSwgb25DaGFuZ2U6IChlKSA9PiBzZXRFZGl0aW5nKHsgLi4uZWRpdGluZywgZHVlRGF0ZTogZS50YXJnZXQudmFsdWUgfSksIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUsIHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6IDE0LCBib3JkZXJSYWRpdXM6IDE0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgZm9udFNpemU6IDE0IH0gfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA1MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiYmxvY2siLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJUaW1lIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyB0eXBlOiAidGltZSIsIHZhbHVlOiBlZGl0aW5nLmR1ZVRpbWUgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RWRpdGluZyh7IC4uLmVkaXRpbmcsIGR1ZVRpbWU6IGUudGFyZ2V0LnZhbHVlIHx8IHZvaWQgMCB9KSwgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZSwgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogMTQsIGJvcmRlclJhZGl1czogMTQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBmb250U2l6ZTogMTQgfSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgZWRpdGluZy5yZWN1cnJlbmNlICE9PSAibm9uZSIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDUwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJibG9jayIsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIlJlbWluZGVyIFRpbWUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyB0eXBlOiAidGltZSIsIHZhbHVlOiBlZGl0aW5nLmR1ZVRpbWUgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RWRpdGluZyh7IC4uLmVkaXRpbmcsIGR1ZVRpbWU6IGUudGFyZ2V0LnZhbHVlIHx8IHZvaWQgMCB9KSwgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZSwgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogMTQsIGJvcmRlclJhZGl1czogMTQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBmb250U2l6ZTogMTQgfSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldEVkaXRpbmcobnVsbCksIHN0eWxlOiB7IGZsZXg6IDEsIHBhZGRpbmc6IDE2LCBib3JkZXJSYWRpdXM6IDUwLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA1MDAsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIkNhbmNlbCIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB1cGRhdGVSZW1pbmRlcihlZGl0aW5nKSwgc3R5bGU6IHsgZmxleDogMSwgcGFkZGluZzogMTYsIGJvcmRlclJhZGl1czogNTAsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBjb2xvcjogIiNmZmYiLCBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDUwMCwgY3Vyc29yOiAicG9pbnRlciIsIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSg0NSw5MCw2MSwwLjMpIiB9LCBjaGlsZHJlbjogIlNhdmUiIH0pCiAgICAgIF0gfSkKICAgIF0gfSkgfSkKICBdIH0pOwp9CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZTIgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBFcnJvckJvdW5kYXJ5ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3Q0LmRlZmF1bHQuQ29tcG9uZW50IHsKICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgc3VwZXIocHJvcHMpOwogICAgdGhpcy5zdGF0ZSA9IHsgaGFzRXJyb3I6IGZhbHNlIH07CiAgfQogIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IpIHsKICAgIHJldHVybiB7IGhhc0Vycm9yOiB0cnVlLCBlcnJvciB9OwogIH0KICBjb21wb25lbnREaWRDYXRjaChlcnJvciwgZXJyb3JJbmZvKSB7CiAgICBjb25zb2xlLmVycm9yKCJXaWRnZXQgRXJyb3IgQm91bmRhcnkgY2F1Z2h0IGVycm9yOiIsIGVycm9yLCBlcnJvckluZm8pOwogICAgdHJ5IHsKICAgICAgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZXZlbnQ6ICJjcmFzaCIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGVycm9yOiBlcnJvcj8ubWVzc2FnZSB8fCAiVW5rbm93biBlcnJvciIsCiAgICAgICAgICAgIHN0YWNrOiBlcnJvcj8uc3RhY2ssCiAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8/LmNvbXBvbmVudFN0YWNrCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goKGUpID0+IGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byByZXBvcnQgY3Jhc2giLCBlKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLnN0YXRlLmhhc0Vycm9yKSB7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMjAsIHRleHRBbGlnbjogImNlbnRlciIsIGZvbnRGYW1pbHk6ICJzYW5zLXNlcmlmIiwgY29sb3I6ICIjREMyNjI2Iiwgd29yZEJyZWFrOiAiYnJlYWstd29yZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IGNoaWxkcmVuOiAiU29tZXRoaW5nIHdlbnQgd3JvbmcuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgicCIsIHsgY2hpbGRyZW46ICJQbGVhc2UgdHJ5IHJlZnJlc2hpbmcgdGhlIHBhZ2UuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRldGFpbHMiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTAsIHRleHRBbGlnbjogImxlZnQiLCBmb250U2l6ZTogIjEycHgiLCBjb2xvcjogIiM2NjYiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3VtbWFyeSIsIHsgY2hpbGRyZW46ICJEZWJ1ZyBFcnJvciBEZXRhaWxzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgicHJlIiwgeyBzdHlsZTogeyB3aGl0ZVNwYWNlOiAicHJlLXdyYXAiLCBiYWNrZ3JvdW5kOiAiI2Y1ZjVmNSIsIHBhZGRpbmc6IDEwLCBib3JkZXJSYWRpdXM6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgdGhpcy5zdGF0ZS5lcnJvcj8udG9TdHJpbmcoKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJyIiwge30pLAogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy5zdGFjawogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuOwogIH0KfTsKdmFyIGdldEh5ZHJhdGlvbkRhdGEgPSAoKSA9PiB7CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFN0YXJ0aW5nIGh5ZHJhdGlvbiBjaGVjay4uLiIpOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFdpbmRvdyBpcyB1bmRlZmluZWQiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc3Qgb2EgPSB3aW5kb3cub3BlbmFpOwogIGlmICghb2EpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSB3aW5kb3cub3BlbmFpIG5vdCBmb3VuZCwgcmVuZGVyaW5nIHdpdGggZGVmYXVsdHMiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgZm91bmQ6IiwgT2JqZWN0LmtleXMob2EpKTsKICBjb25zdCBjYW5kaWRhdGVzID0gWwogICAgb2EudG9vbE91dHB1dCwKICAgIG9hLnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCwKICAgIG9hLnRvb2xJbnB1dAogIF07CiAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIEZvdW5kIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE5vIGRhdGEgZm91bmQgaW4gYW55IGNhbmRpZGF0ZSBzb3VyY2UiKTsKICByZXR1cm4ge307Cn07CmNvbnNvbGUubG9nKCJbTWFpbl0gUmVtaW5kZXIgQXBwIG1haW4udHN4IGxvYWRpbmcuLi4iKTsKZnVuY3Rpb24gQXBwKHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KSB7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFJlbWluZGVyQXBwLCB7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSk7Cn0KdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZW1pbmRlci1hcHAtcm9vdCIpIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0cmF2ZWwtY2hlY2tsaXN0LXJvb3QiKTsKaWYgKCFjb250YWluZXIpIHsKICB0aHJvdyBuZXcgRXJyb3IoInJlbWluZGVyLWFwcC1yb290IGVsZW1lbnQgbm90IGZvdW5kIik7Cn0KdmFyIHJvb3QgPSAoMCwgaW1wb3J0X2NsaWVudC5jcmVhdGVSb290KShjb250YWluZXIpOwp2YXIgcmVuZGVyQXBwID0gKGRhdGEpID0+IHsKICByb290LnJlbmRlcigKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKGltcG9ydF9yZWFjdDQuZGVmYXVsdC5TdHJpY3RNb2RlLCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShFcnJvckJvdW5kYXJ5LCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShBcHAsIHsgaW5pdGlhbERhdGE6IGRhdGEgfSwgRGF0ZS5ub3coKSkgfSkgfSkKICApOwp9Owp2YXIgaW5pdGlhbERhdGEgPSBnZXRIeWRyYXRpb25EYXRhKCk7CnJlbmRlckFwcChpbml0aWFsRGF0YSk7CndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJvcGVuYWk6c2V0X2dsb2JhbHMiLCAoZXYpID0+IHsKICBjb25zdCBnbG9iYWxzID0gZXY/LmRldGFpbD8uZ2xvYmFsczsKICBpZiAoZ2xvYmFscykgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIExhdGUgZXZlbnQgcmVjZWl2ZWQ6IiwgZ2xvYmFscyk7CiAgICBjb25zdCBjYW5kaWRhdGVzID0gWwogICAgICBnbG9iYWxzLnRvb2xPdXRwdXQsCiAgICAgIGdsb2JhbHMuc3RydWN0dXJlZENvbnRlbnQsCiAgICAgIGdsb2JhbHMucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy50b29sSW5wdXQKICAgIF07CiAgICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICAgIGlmIChjYW5kaWRhdGUgJiYgdHlwZW9mIGNhbmRpZGF0ZSA9PT0gIm9iamVjdCIgJiYgT2JqZWN0LmtleXMoY2FuZGlkYXRlKS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFJlLXJlbmRlcmluZyB3aXRoIGxhdGUgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICAgIHJlbmRlckFwcChjYW5kaWRhdGUpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KfSk7Ci8qISBCdW5kbGVkIGxpY2Vuc2UgaW5mb3JtYXRpb246CgpyZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpzY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHNjaGVkdWxlci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpyZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCiAgKCoqCiAgICogQ2hlY2tzIGlmIGFuIGV2ZW50IGlzIHN1cHBvcnRlZCBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gZW52aXJvbm1lbnQuCiAgICoKICAgKiBOT1RFOiBUaGlzIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5IGZvciBub24tZ2VuZXJpYyBldmVudHMgc3VjaCBhcyBgY2hhbmdlYCwKICAgKiBgcmVzZXRgLCBgbG9hZGAsIGBlcnJvcmAsIGFuZCBgc2VsZWN0YC4KICAgKgogICAqIEJvcnJvd3MgZnJvbSBNb2Rlcm5penIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lU3VmZml4IEV2ZW50IG5hbWUsIGUuZy4gImNsaWNrIi4KICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQuCiAgICogQGludGVybmFsCiAgICogQGxpY2Vuc2UgTW9kZXJuaXpyIDMuMC4wcHJlIChDdXN0b20gQnVpbGQpIHwgTUlUCiAgICopCgpyZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vc2hhcmVkL3NyYy91dGlscy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9iZWxsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnJpZWZjYXNlLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2FsZW5kYXIuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGVjay5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZXZyb24tcmlnaHQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jbG9jay5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nyb3duLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZmxhbWUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ncmFkdWF0aW9uLWNhcC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2hlYXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaG91c2UuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wZW4uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbGFuZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yZXBlYXQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zZWFyY2guanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zaG9wcGluZy1jYXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc3Rhci5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3N0ZXRob3Njb3BlLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3VzZXJzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMveC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Reminder App] Failed to load:', err);
          const root = document.getElementById('reminder-app-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load app</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
